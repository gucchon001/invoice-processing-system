"""
è¨­å®šãƒ»ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ãƒšãƒ¼ã‚¸ - ãƒ¦ãƒ¼ã‚¶ãƒ¼è¨­å®šã€ãƒ‡ãƒ¼ã‚¿è¡¨ç¤º
"""

import streamlit as st
import sys
from pathlib import Path
import pandas as pd

# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ«ãƒ¼ãƒˆã‚’Pythonãƒ‘ã‚¹ã«è¿½åŠ 
project_root = Path(__file__).parent.parent.parent  # src/ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª
sys.path.insert(0, str(project_root))

try:
    from infrastructure.auth.oauth_handler import get_current_user
    from infrastructure.database.database import get_database
    from infrastructure.ui.aggrid_helper import get_aggrid_manager
    from utils.log_config import get_logger
    
    logger = get_logger(__name__)
    
except ImportError as e:
    st.error(f"ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ: {e}")
    st.stop()


def render_dashboard_page():
    """å‡¦ç†çŠ¶æ³ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ç”»é¢ï¼ˆag-gridå®Ÿè£…ç‰ˆï¼‰"""
    st.markdown("## ğŸ“Š å‡¦ç†çŠ¶æ³ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰")
    
    st.info("ğŸ“‹ ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ãŸè«‹æ±‚æ›¸ã®å‡¦ç†çŠ¶æ³ã‚’ç¢ºèªãƒ»ç·¨é›†ã§ãã¾ã™ã€‚")
    
    # ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±å–å¾—
    user_info = get_current_user()
    user_email = user_info.get('email', '') if user_info else ''
    
    if not user_email:
        st.error("ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ãŒå–å¾—ã§ãã¾ã›ã‚“ã€‚å†ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚")
        return
    
    # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰è«‹æ±‚æ›¸ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
    try:
        with st.spinner("ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­..."):
            database = get_database()
            invoices_data = database.get_invoices(user_email)
            
        if not invoices_data:
            st.info("ğŸ“„ ã¾ã è«‹æ±‚æ›¸ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ã€ŒğŸ“¤ è«‹æ±‚æ›¸å‡¦ç†ã€ã‹ã‚‰ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚")
            
            # ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒšãƒ¼ã‚¸ã¸ã®ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ
            if st.button("ğŸ“¤ è«‹æ±‚æ›¸ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰", type="primary", use_container_width=True):
                st.session_state.main_menu = "ğŸ“¤ è«‹æ±‚æ›¸å‡¦ç†"
                st.rerun()
            return
        
        # ag-gridã§ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤ºãƒ»ç·¨é›†
        render_invoice_aggrid(invoices_data)
        
    except Exception as e:
        logger.error(f"ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼: {e}")
        st.error(f"ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {e}")
        
        # ãƒ‡ãƒ¼ã‚¿æ›´æ–°ãƒœã‚¿ãƒ³
        if st.button("ğŸ”„ å†è©¦è¡Œ", use_container_width=True):
            st.rerun()


def render_invoice_aggrid(invoices_data):
    """ag-gridã‚’ä½¿ç”¨ã—ãŸè«‹æ±‚æ›¸ãƒ‡ãƒ¼ã‚¿ã®è¡¨ç¤ºãƒ»ç·¨é›†"""
    st.markdown("### ğŸ“‹ è«‹æ±‚æ›¸ä¸€è¦§ (ag-grid)")
    
    try:
        # ag-gridãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼å–å¾—
        aggrid_manager = get_aggrid_manager()
        
        if not aggrid_manager:
            st.error("ag-gridãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ")
            return
        
        # ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ å¤‰æ›
        df = pd.DataFrame(invoices_data)
        
        if df.empty:
            st.info("è¡¨ç¤ºã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“")
            return
        
        # ag-gridã§ãƒ‡ãƒ¼ã‚¿è¡¨ç¤º
        response = aggrid_manager.display_invoice_grid(df)
        
        # é¸æŠã•ã‚ŒãŸè¡Œã®å‡¦ç†
        selected_rows = response['selected_rows']
        if selected_rows:
            st.subheader("ğŸ“ é¸æŠã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿")
            selected_df = pd.DataFrame(selected_rows)
            st.dataframe(selected_df, use_container_width=True)
            
            # å‰Šé™¤ãƒœã‚¿ãƒ³
            if st.button("ğŸ—‘ï¸ é¸æŠè¡Œã‚’å‰Šé™¤", type="secondary"):
                delete_selected_invoices(selected_rows)
        
        # ãƒ‡ãƒ¼ã‚¿æ›´æ–°ã®å‡¦ç†
        updated_data = response['data']
        if updated_data is not None and not updated_data.equals(df):
            st.info("ãƒ‡ãƒ¼ã‚¿ãŒæ›´æ–°ã•ã‚Œã¾ã—ãŸ")
            # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ä¿å­˜
            update_invoices_in_database(updated_data)
            
    except Exception as e:
        logger.error(f"ag-gridè¡¨ç¤ºã‚¨ãƒ©ãƒ¼: {e}")
        st.error(f"ãƒ‡ãƒ¼ã‚¿è¡¨ç¤ºä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {e}")


def delete_selected_invoices(selected_rows):
    """é¸æŠã•ã‚ŒãŸè«‹æ±‚æ›¸ã‚’å‰Šé™¤"""
    try:
        database = get_database()
        
        for row in selected_rows:
            invoice_id = row.get('id')
            if invoice_id:
                database.delete_invoice(invoice_id)
        
        st.success(f"âœ… {len(selected_rows)}ä»¶ã®è«‹æ±‚æ›¸ã‚’å‰Šé™¤ã—ã¾ã—ãŸ")
        st.rerun()
        
    except Exception as e:
        logger.error(f"è«‹æ±‚æ›¸å‰Šé™¤ã‚¨ãƒ©ãƒ¼: {e}")
        st.error(f"å‰Šé™¤ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {e}")


def update_invoices_in_database(updated_data):
    """æ›´æ–°ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã‚’ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ä¿å­˜"""
    try:
        database = get_database()
        
        # ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ ã‹ã‚‰è¾æ›¸ãƒªã‚¹ãƒˆã«å¤‰æ›
        records = updated_data.to_dict('records')
        
        for record in records:
            invoice_id = record.get('id')
            if invoice_id:
                database.update_invoice(invoice_id, record)
        
        st.success("âœ… ãƒ‡ãƒ¼ã‚¿ã®æ›´æ–°ãŒå®Œäº†ã—ã¾ã—ãŸ")
        
    except Exception as e:
        logger.error(f"ãƒ‡ãƒ¼ã‚¿æ›´æ–°ã‚¨ãƒ©ãƒ¼: {e}")
        st.error(f"ãƒ‡ãƒ¼ã‚¿æ›´æ–°ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {e}")


def render_settings_page():
    """ãƒ¡ãƒ¼ãƒ«è¨­å®šç”»é¢"""
    st.markdown("## âš™ï¸ ãƒ¡ãƒ¼ãƒ«è¨­å®š")
    
    st.info("ğŸ“§ é€šçŸ¥è¨­å®šã‚’ç®¡ç†ã§ãã¾ã™ã€‚")
    
    # é€šçŸ¥è¨­å®š
    st.markdown("### ğŸ“¬ é€šçŸ¥è¨­å®š")
    
    notify_success = st.checkbox(
        "âœ… å‡¦ç†å®Œäº†æ™‚ã«ãƒ¡ãƒ¼ãƒ«ã§é€šçŸ¥ã™ã‚‹",
        value=True,
        help="è«‹æ±‚æ›¸ã® AI å‡¦ç†ãŒå®Œäº†ã—ãŸéš›ã«ãƒ¡ãƒ¼ãƒ«é€šçŸ¥ã‚’é€ä¿¡ã—ã¾ã™",
        key="email_notify_success"
    )
    
    notify_error = st.checkbox(
        "âŒ ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿæ™‚ã«ãƒ¡ãƒ¼ãƒ«ã§é€šçŸ¥ã™ã‚‹",
        value=True,
        help="å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸéš›ã«ãƒ¡ãƒ¼ãƒ«é€šçŸ¥ã‚’é€ä¿¡ã—ã¾ã™",
        key="email_notify_error"
    )
    
    # ä¿å­˜ãƒœã‚¿ãƒ³
    if st.button("ğŸ’¾ è¨­å®šã‚’ä¿å­˜", type="primary", use_container_width=True):
        save_notification_settings(notify_success, notify_error)


def save_notification_settings(notify_success, notify_error):
    """é€šçŸ¥è¨­å®šã‚’ä¿å­˜"""
    try:
        # ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±å–å¾—
        user_info = get_current_user()
        user_email = user_info.get('email', '') if user_info else ''
        
        if not user_email:
            st.error("ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ãŒå–å¾—ã§ãã¾ã›ã‚“")
            return
        
        # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«è¨­å®šã‚’ä¿å­˜
        database = get_database()
        settings = {
            'user_email': user_email,
            'notify_success': notify_success,
            'notify_error': notify_error
        }
        
        # è¨­å®šä¿å­˜ï¼ˆãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¹ã‚­ãƒ¼ãƒã«å¿œã˜ã¦å®Ÿè£…ï¼‰
        # database.save_user_settings(settings)
        
        st.success("âœ… è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ")
        
        # TODO: å®Ÿéš›ã®è¨­å®šä¿å­˜å‡¦ç†ã‚’å®Ÿè£…
        logger.info(f"é€šçŸ¥è¨­å®šä¿å­˜: {user_email} - æˆåŠŸé€šçŸ¥:{notify_success}, ã‚¨ãƒ©ãƒ¼é€šçŸ¥:{notify_error}")
        
    except Exception as e:
        logger.error(f"è¨­å®šä¿å­˜ã‚¨ãƒ©ãƒ¼: {e}")
        st.error(f"è¨­å®šã®ä¿å­˜ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {e}") 