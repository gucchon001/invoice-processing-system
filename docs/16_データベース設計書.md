# 🗄️ データベース設計書

**作成日**: 2025年1月24日  
**バージョン**: 1.0  
**対象システム**: 請求書処理自動化システム  
**データベース**: Supabase PostgreSQL

## 📊 概要

請求書処理自動化システムのデータベース設計書です。本システムはSupabase PostgreSQLを使用し、ユーザー管理、請求書データ管理、OCRテスト管理、ルールベース検証を統合したスキーマを提供します。

## 🏗️ データベース全体構成

### 主要テーブルグループ

1. **ユーザー管理系**
   - `users` - ユーザー情報
   - `user_preferences` - ユーザー設定

2. **請求書処理系** 
   - `invoices` - 請求書メインテーブル
   - `invoice_line_items` - 請求書明細
   - `payment_masters` - 支払マスタ

3. **OCRテスト系**
   - `ocr_test_sessions` - OCRテストセッション
   - `ocr_test_results` - OCRテスト結果
   - `ocr_test_line_items` - OCRテスト明細

4. **ルール検証系**
   - `accounting_rules` - 経理ルール
   - `rule_check_sessions` - ルールチェックセッション
   - `rule_check_results` - ルールチェック結果

5. **決済系**
   - `card_statements` - カード明細

## 📋 テーブル設計詳細

### 1. **users（ユーザーテーブル）**

```sql
CREATE TABLE public.users (
    email VARCHAR(255) PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    role VARCHAR(20) DEFAULT 'user' CHECK (role IN ('user', 'admin'))
);
```

| カラム名 | データ型 | 制約 | 説明 |
|----------|----------|------|------|
| email | VARCHAR(255) | PK, NOT NULL | ユーザーメールアドレス（主キー） |
| name | VARCHAR(100) | NOT NULL | ユーザー名 |
| role | VARCHAR(20) | DEFAULT 'user' | ユーザー権限（user/admin） |

**設計意図**:
- メールアドレスを主キーとして、Google OAuth認証と連携
- ロールベースアクセス制御（RBAC）をサポート

### 2. **invoices（請求書テーブル）**

```sql
CREATE TABLE public.invoices (
    id SERIAL PRIMARY KEY,
    user_email VARCHAR(255) NOT NULL REFERENCES users(email),
    status VARCHAR(50) DEFAULT 'uploaded',
    file_name VARCHAR(255) NOT NULL,
    gdrive_file_id VARCHAR(255),
    uploaded_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    issuer_name VARCHAR(255),
    recipient_name VARCHAR(255),
    main_invoice_number VARCHAR(255),
    receipt_number VARCHAR(255),
    t_number VARCHAR(50),
    issue_date DATE,
    due_date DATE,
    currency VARCHAR(10) DEFAULT 'JPY',
    total_amount_tax_included DECIMAL(15,2),
    total_amount_tax_excluded DECIMAL(15,2),
    key_info JSONB,
    line_items JSONB,
    final_accounting_info JSONB,
    extracted_data JSONB,
    raw_response JSONB,
    is_valid BOOLEAN DEFAULT TRUE,
    validation_errors TEXT[],
    validation_warnings TEXT[],
    completeness_score DECIMAL(5,2),
    processing_time DECIMAL(8,2),
    file_path VARCHAR(500),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT timezone('Asia/Tokyo', NOW()),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT timezone('Asia/Tokyo', NOW())
);
```

**主要カラム**:

| カラム名 | データ型 | 制約 | 説明 |
|----------|----------|------|------|
| id | SERIAL | PK | 請求書ID |
| user_email | VARCHAR(255) | FK, NOT NULL | 作成ユーザー |
| status | VARCHAR(50) | DEFAULT 'uploaded' | 処理状況 |
| file_name | VARCHAR(255) | NOT NULL | ファイル名 |
| gdrive_file_id | VARCHAR(255) | | Google DriveファイルID |
| issuer_name | VARCHAR(255) | | 発行者名 |
| main_invoice_number | VARCHAR(255) | | 請求書番号 |
| total_amount_tax_included | DECIMAL(15,2) | | 税込合計金額 |
| extracted_data | JSONB | | AI抽出データ（JSON） |
| is_valid | BOOLEAN | DEFAULT TRUE | 検証状況 |
| completeness_score | DECIMAL(5,2) | | 完全性スコア（0-100） |
| processing_time | DECIMAL(8,2) | | 処理時間（秒） |

**設計意図**:
- JSONB型でAI抽出データの柔軟な保存をサポート
- 検証結果とスコアリングによる品質管理
- Google Drive連携によるファイル管理

### 3. **invoice_line_items（請求書明細テーブル）**

```sql
CREATE TABLE public.invoice_line_items (
    id SERIAL PRIMARY KEY,
    invoice_id INTEGER NOT NULL REFERENCES invoices(id) ON DELETE CASCADE,
    line_number INTEGER NOT NULL,
    item_description TEXT,
    quantity DECIMAL(10,2),
    unit_price DECIMAL(15,2),
    amount DECIMAL(15,2),
    tax_rate DECIMAL(5,2),
    created_at TIMESTAMP DEFAULT timezone('Asia/Tokyo', NOW()),
    updated_at TIMESTAMP DEFAULT timezone('Asia/Tokyo', NOW())
);
```

**設計意図**:
- 請求書の明細データを正規化して管理
- CASCADE削除による整合性保証

### 4. **ocr_test_sessions（OCRテストセッション）**

```sql
CREATE TABLE ocr_test_sessions (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    session_name VARCHAR(255) NOT NULL,
    folder_id VARCHAR(255) NOT NULL,
    total_files INTEGER NOT NULL DEFAULT 0,
    processed_files INTEGER NOT NULL DEFAULT 0,
    success_files INTEGER NOT NULL DEFAULT 0,
    failed_files INTEGER NOT NULL DEFAULT 0,
    average_completeness DECIMAL(5,2),
    success_rate DECIMAL(5,2),
    processing_duration DECIMAL(10,2),
    created_by VARCHAR(255) NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

**設計意図**:
- UUIDによるセッション管理
- バッチ処理の実行履歴と統計情報管理

## 🔍 インデックス戦略

### パフォーマンス最適化インデックス

```sql
-- 基本検索インデックス
CREATE INDEX idx_invoices_user_email ON invoices(user_email);
CREATE INDEX idx_invoices_status ON invoices(status);
CREATE INDEX idx_invoices_uploaded_at ON invoices(uploaded_at);
CREATE INDEX idx_invoices_issuer_name ON invoices(issuer_name);
CREATE INDEX idx_invoices_invoice_number ON invoices(main_invoice_number);

-- JSON検索用GINインデックス
CREATE INDEX idx_invoices_extracted_data_gin ON invoices USING GIN (extracted_data);
CREATE INDEX idx_invoices_key_info_gin ON invoices USING GIN (key_info);

-- 複合インデックス
CREATE INDEX idx_invoices_user_status_date ON invoices(user_email, status, uploaded_at);
```

### インデックス設計方針
- **ユーザー別データアクセス**: Row Level Security対応
- **JSON検索**: GINインデックスによる高速JSON検索
- **時系列データ**: 日付範囲検索の最適化

## 🔒 セキュリティ設計

### Row Level Security (RLS)

```sql
-- RLS有効化
ALTER TABLE invoices ENABLE ROW LEVEL SECURITY;

-- ユーザー別データアクセス制御
CREATE POLICY "Users can view their own invoices" 
ON invoices FOR ALL 
USING (auth.email() = user_email);
```

### セキュリティ原則
1. **データ分離**: ユーザー単位での完全なデータ分離
2. **認証連携**: Supabase認証とGoogle OAuth連携
3. **最小権限**: 必要最小限のアクセス権限

## 📊 データ品質管理

### 検証システム
- **completeness_score**: データ完全性スコア（0-100）
- **validation_errors**: 検証エラー配列
- **validation_warnings**: 検証警告配列
- **is_valid**: 全体検証状況フラグ

### AI処理メタデータ
- **processing_time**: AI処理時間計測
- **raw_response**: 生のAI応答保存
- **gemini_model**: 使用AIモデル記録

## 🔄 データフロー

### 主要データフロー

1. **請求書アップロード**
```
PDF → Google Drive → AI抽出 → invoices INSERT → invoice_line_items INSERT
```

2. **OCRテスト**
```
Drive Folder → Batch Processing → ocr_test_sessions → ocr_test_results
```

3. **ダッシュボード表示**
```
User Auth → invoices SELECT → ag-Grid Display
```

## 📈 パフォーマンス要件

### 応答時間目標
- **単一請求書取得**: 100ms以内
- **ユーザー請求書一覧**: 500ms以内
- **OCRテスト結果集計**: 1秒以内

### データ容量想定
- **年間請求書数**: 120,000件
- **平均ファイルサイズ**: 500KB
- **データベースサイズ**: 5GB/年

## 🔧 運用・保守

### バックアップ戦略
- **自動日次バックアップ**: Supabase自動機能
- **ポイントインタイム復旧**: 7日間保持
- **重要データエクスポート**: 月次手動実行

### 監視項目
- **テーブルサイズ**: 容量監視
- **インデックス使用率**: 性能監視
- **スロークエリ**: 性能問題検出

## 🚀 今後の拡張計画

### Phase 3: 機能拡張
- **パーティショニング**: 年次テーブル分割
- **レプリケーション**: 読み取り専用レプリカ
- **データウェアハウス**: 分析用データマート

### Phase 4: 最適化
- **マテリアライズドビュー**: 集計クエリ高速化
- **キャッシュ層**: Redisキャッシュ導入
- **データアーカイブ**: 古いデータの自動アーカイブ

---

**最終更新**: 2025年1月24日  
**承認者**: データベース管理者  
**レビュー予定**: 2025年2月24日 