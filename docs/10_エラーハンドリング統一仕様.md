# エラーハンドリング統一仕様書

**バージョン**: 2.0  
**作成日**: 2025-01-XX  
**最終更新**: 2025-01-XX  
**更新内容**: GAS実データ分析結果を反映した実践的エラーハンドリング設計

## 1. 概要

### 1.1. 目的
請求書処理自動化システムにおいて、AIプロンプト処理とワークフロー全体で発生する可能性のあるエラーを統一的に管理し、ユーザーフレンドリーで運用可能なエラーハンドリングシステムを提供する。

### 1.2. 設計原則（GASパターン適用）
- **透明性**: エラー原因と対処法を明確に提示
- **復旧可能性**: 可能な限り自動復旧または手動修正手順を提供
- **ログ完全性**: 全エラーを詳細にログ記録し、分析可能な形で保存
- **ユーザビリティ**: 技術者以外でも理解できるエラーメッセージ
- **段階的処理**: 部分成功も許容し、可能な範囲で処理を継続

## 2. エラー分類体系（実データパターン分析結果）

### 2.1. Level 1: 重要度分類
- **CRITICAL**: システム停止レベル（即座対応必要）
- **ERROR**: 処理失敗（要対応、代替手段検討）
- **WARNING**: 注意喚起（処理継続可能、要監視）
- **INFO**: 情報提供（処理成功、特記事項あり）

### 2.2. Level 2: カテゴリ分類

#### 2.2.1. データ入力エラー（INPUT_ERROR）
```yaml
category: "INPUT_ERROR"
description: "入力データの形式や内容に関するエラー"
common_patterns:
  - file_format_invalid: "PDFファイル破損・読み取り不可"
  - ocr_extraction_failed: "OCR抽出完全失敗"
  - required_field_missing: "必須フィールド（企業名、金額等）欠損"
  - currency_invalid: "通貨情報不正・未対応通貨"
  - amount_format_error: "金額フォーマット異常（文字列混入等）"
  - date_format_error: "日付フォーマット不正"
  - json_structure_broken: "明細JSONフォーマット異常"
```

#### 2.2.2. AI処理エラー（AI_PROCESSING_ERROR）
```yaml
category: "AI_PROCESSING_ERROR"
description: "AIプロンプト処理に関するエラー"
common_patterns:
  - confidence_threshold_not_met: "確信度閾値未達（照合失敗）"
  - multiple_candidates_tie: "複数候補同スコア（判定不可）"
  - prompt_execution_timeout: "AIプロンプト実行タイムアウト"
  - response_format_invalid: "AI応答JSONフォーマット不正"
  - semantic_matching_failed: "セマンティック照合完全失敗"
  - currency_conversion_failed: "通貨換算失敗（レート取得不可）"
```

#### 2.2.3. データベースエラー（DATABASE_ERROR）
```yaml
category: "DATABASE_ERROR"
description: "Supabaseデータベース操作に関するエラー"
common_patterns:
  - connection_timeout: "データベース接続タイムアウト"
  - duplicate_entry: "重複エントリ挿入試行"
  - foreign_key_violation: "外部キー制約違反"
  - master_data_inconsistency: "マスタデータ不整合"
  - transaction_rollback: "トランザクション自動ロールバック"
```

#### 2.2.4. システム統合エラー（INTEGRATION_ERROR）
```yaml
category: "INTEGRATION_ERROR"
description: "外部システム連携に関するエラー"
common_patterns:
  - gemini_api_quota_exceeded: "Gemini API利用制限超過"
  - file_storage_failed: "ファイルストレージ保存失敗"
  - email_notification_failed: "メール通知送信失敗"
  - backup_creation_failed: "バックアップ作成失敗"
```

## 3. GAS実データから特定した頻出エラーパターン

### 3.1. 高頻度エラーパターン（実データ分析結果）

#### パターン1: 金額情報null/不正
```yaml
error_pattern: "amount_null_or_invalid"
frequency: "約5%（実データより）"
example_cases:
  - "Yahoo! JAPAN広告_2025-06_1.pdf": "金額情報null"
  - "負値金額": "-39.62 USD"（OpenAI返金ケース）
handling_strategy:
  - null金額: WARNING扱い、手動確認フラグ
  - 負値金額: INFO扱い、返金・調整として処理継続
  - 極端金額: 閾値外（100万円超）でWARNING
```

#### パターン2: 企業名表記揺れ
```yaml
error_pattern: "company_name_variation"
frequency: "約15%（実データより）"
example_cases:
  - "Gamma" vs "GAMMA"
  - "Yahoo! JAPAN" vs "Yahoo! JAPAN広告"
  - "Microsoft Ireland Operations Limited" vs "日本マイクロソフト株式会社"
handling_strategy:
  - 確信度75%以上: 自動処理継続
  - 確信度50-74%: WARNING + 手動確認推奨
  - 確信度50%未満: ERROR + 手動介入必須
```

#### パターン3: 重複処理
```yaml
error_pattern: "duplicate_processing"
frequency: "約8%（同一ファイル複数処理）"
example_cases:
  - "Canva Pty. Ltd._2025-05_1.pdf" → "_2.pdf"
  - "株式会社GIG_2025-05_1.pdf" → "_3.pdf", "_4.pdf"
handling_strategy:
  - ファイル名パターン検出
  - ユニークID重複チェック
  - 警告表示＋既存データとの統合確認
```

#### パターン4: 通貨・金額不整合
```yaml
error_pattern: "currency_amount_mismatch"
frequency: "約12%（外貨取引）"
example_cases:
  - "USD 220" vs "JPY換算値不明"
  - "税込・税抜の混在"
handling_strategy:
  - リアルタイム為替レート取得
  - 税率自動判定（10%, 8%, 非課税）
  - 換算失敗時は元通貨で処理継続＋手動確認フラグ
```

## 4. 統一エラーハンドリング実装仕様

### 4.1. エラーレスポンス標準フォーマット

```json
{
  "success": false,
  "error": {
    "code": "AI_PROCESSING_001",
    "category": "AI_PROCESSING_ERROR",
    "level": "ERROR",
    "message": "確信度閾値未達により企業名照合に失敗しました",
    "details": {
      "confidence_score": 0.68,
      "threshold": 0.75,
      "candidates": [
        {"name": "候補企業名1", "score": 0.68},
        {"name": "候補企業名2", "score": 0.65}
      ]
    },
    "suggested_actions": [
      "マスタデータに新規企業を登録してください",
      "企業名表記の確認を行ってください"
    ],
    "recovery_possible": true,
    "manual_intervention_required": true,
    "timestamp": "2025-01-XX 10:30:45",
    "correlation_id": "proc_20250130_103045_001"
  },
  "partial_results": {
    "extracted_data": {
      "issuer_name": "抽出された企業名",
      "amount": 123456,
      "currency": "JPY"
    }
  }
}
```

### 4.2. プロンプト内エラーハンドリング統一記述

```yaml
error_handling_template: |
  # エラーハンドリング（全プロンプト共通）
  
  ## 処理失敗時の対応
  以下の条件で処理継続不可と判断した場合は、即座にエラー情報を返却：
  
  ### 即座失敗ケース
  - 入力データの必須フィールド欠損（企業名、金額）
  - JSONフォーマット完全破損
  - 確信度が閾値を大幅に下回る（50%未満）
  
  ### 警告付き継続ケース
  - 確信度が閾値をわずかに下回る（閾値-10%以内）
  - 通貨換算失敗（元通貨で処理継続）
  - 日付形式軽微な不正（推定日付で処理）
  
  ## エラー出力フォーマット
  ```json
  {
    "success": false,
    "error_code": "適切なエラーコード",
    "error_message": "ユーザーフレンドリーなメッセージ",
    "confidence_score": 0.XX,
    "processing_details": "詳細な処理内容",
    "suggested_actions": ["推奨対処法1", "推奨対処法2"],
    "partial_results": "部分的に取得できたデータ（あれば）"
  }
  ```
```

### 4.3. ワークフロー統合エラーハンドリング

```python
class UnifiedErrorHandler:
    """統一エラーハンドリングクラス"""
    
    def __init__(self):
        self.error_codes = {
            # AI処理エラー
            "AI_001": "企業名照合確信度不足",
            "AI_002": "複数候補同スコア判定不可",
            "AI_003": "明細セマンティック照合失敗",
            
            # データエラー
            "DATA_001": "必須フィールド欠損",
            "DATA_002": "金額フォーマット異常",
            "DATA_003": "日付フォーマット異常",
            
            # システムエラー
            "SYS_001": "データベース接続失敗",
            "SYS_002": "外部API呼び出し失敗",
            "SYS_003": "ファイル処理失敗"
        }
    
    def handle_ai_processing_error(self, confidence_score, threshold, candidates):
        """AI処理エラーの統一ハンドリング"""
        if confidence_score < threshold * 0.5:
            level = "ERROR"
            recovery_possible = False
        elif confidence_score < threshold:
            level = "WARNING" 
            recovery_possible = True
        
        return {
            "code": "AI_001",
            "level": level,
            "confidence_score": confidence_score,
            "recovery_possible": recovery_possible,
            "suggested_actions": self._get_recovery_actions("AI_001")
        }
    
    def _get_recovery_actions(self, error_code):
        """エラーコードに応じた復旧アクション"""
        recovery_map = {
            "AI_001": [
                "マスタデータの企業名表記を確認してください",
                "新規企業の場合はマスタ登録を行ってください",
                "請求書の企業名表記に誤りがないか確認してください"
            ],
            "DATA_001": [
                "請求書PDFの再アップロードを試してください",
                "OCR処理結果を手動で補完してください"
            ]
        }
        return recovery_map.get(error_code, ["システム管理者に連絡してください"])
```

## 5. 運用監視とアラート設定

### 5.1. エラー発生率監視

```yaml
monitoring_thresholds:
  daily_error_rate:
    warning: 15%    # 日次エラー率15%超でWARNING
    critical: 25%   # 日次エラー率25%超でCRITICAL
  
  specific_error_patterns:
    ai_confidence_low: 
      threshold: 20%  # AI確信度不足が20%超
      action: "プロンプト調整検討"
    
    duplicate_processing:
      threshold: 10%  # 重複処理が10%超
      action: "ファイル管理プロセス見直し"
    
    currency_conversion_fail:
      threshold: 5%   # 通貨換算失敗が5%超
      action: "為替レートAPI接続確認"
```

### 5.2. 自動復旧メカニズム

```yaml
auto_recovery_rules:
  confidence_threshold_adjustment:
    condition: "AI確信度不足が連続3件"
    action: "一時的に閾値を5%下げて再処理"
    
  master_data_auto_update:
    condition: "新規企業名が5件以上検出"
    action: "管理者承認後マスタデータ一括更新"
    
  retry_with_backoff:
    condition: "API呼び出し失敗"
    action: "指数バックオフで最大3回リトライ"
```

## 6. ユーザー向けエラー表示

### 6.1. Streamlitアプリでのエラー表示

```python
def display_error_friendly(error_info):
    """ユーザーフレンドリーなエラー表示"""
    
    if error_info["level"] == "ERROR":
        st.error(f"❌ {error_info['message']}")
    elif error_info["level"] == "WARNING":
        st.warning(f"⚠️ {error_info['message']}")
    
    # 復旧アクション表示
    if error_info.get("suggested_actions"):
        st.info("💡 **推奨対処法:**")
        for action in error_info["suggested_actions"]:
            st.write(f"• {action}")
    
    # 部分結果がある場合は表示
    if error_info.get("partial_results"):
        with st.expander("部分的に取得できたデータ"):
            st.json(error_info["partial_results"])
```

## 7. ログ記録と分析

### 7.1. 統一ログフォーマット

```json
{
  "timestamp": "2025-01-XX 10:30:45.123",
  "correlation_id": "proc_20250130_103045_001",
  "level": "ERROR",
  "category": "AI_PROCESSING_ERROR",
  "error_code": "AI_001",
  "message": "企業名照合確信度不足",
  "context": {
    "file_name": "20250605_KT-1912.pdf",
    "issuer_name": "抽出された企業名",
    "confidence_score": 0.68,
    "threshold": 0.75
  },
  "processing_time_ms": 2341,
  "user_action": "manual_review_required",
  "resolution_status": "pending"
}
```

## 8. まとめ

本統一仕様により、以下を実現：
- **実データに基づく現実的**なエラーハンドリング
- **段階的復旧**による処理継続性の向上
- **透明性の高い**エラー情報提供
- **運用負荷軽減**のための自動化機能

GAS実装で得られた知見を活用し、より堅牢で運用しやすいシステムを構築する。 