# システム仕様書

**作成日**: 2025年1月24日  
**バージョン**: 1.2  
**対象システム**: 請求書処理自動化システム  
**最終更新**: 2025年8月1日

**v1.2更新内容**: 実装状況反映、要件定義書との整合性確保  
**v1.1更新内容**: 古いUUID版テーブル定義を削除、最新設計書への参照に統一

## 1. 概要

### 1.1 システム目的
請求書処理自動化システムは、PDFファイルからのデータ抽出、データベース保存、検索・編集機能を提供する統合システムです。

### 1.2 アーキテクチャ設計思想
- **3層アーキテクチャ**: UI・ビジネスロジック・データアクセスの明確な分離
- **統一ワークフロー**: テスト・本番で同一処理エンジン使用
- **アダプターパターン**: 多様な入力ソースへの柔軟対応
- **責務分離**: 各層の独立性確保による保守性向上

## 2. アーキテクチャ分離設計

### 2.1 システム全体構成
```
┌─────────────────────────────────────────────────┐
│                 UI層（プレゼンテーション）          │
├─────────────────────────────────────────────────┤
│  ┌─────────────────┐  ┌──────────────────────┐  │
│  │ Streamlit UI    │  │ セッション状態管理     │  │
│  │ - タブ制御      │  │ - 進行状況追跡        │  │
│  │ - ファイル受付   │  │ - エラー表示         │  │
│  │ - 結果表示      │  │ - 設定保持           │  │
│  └─────────────────┘  └──────────────────────┘  │
├─────────────────────────────────────────────────┤
│                ビジネスロジック層                   │
├─────────────────────────────────────────────────┤
│  ┌─────────────────┐  ┌──────────────────────┐  │
│  │ 統合ワークフロー  │  │ アダプターシステム     │  │
│  │ - AI処理制御    │  │ - 入力ソース抽象化    │  │
│  │ - 検証ロジック   │  │ - ファイル変換       │  │
│  │ - エラー処理    │  │ - 出力フォーマット   │  │
│  └─────────────────┘  └──────────────────────┘  │
│  ┌─────────────────┐  ┌──────────────────────┐  │
│  │ AI処理エンジン   │  │ 検証・変換エンジン    │  │
│  │ - Gemini API   │  │ - データ正規化       │  │
│  │ - プロンプト管理 │  │ - 照合処理           │  │
│  │ - レスポンス解析 │  │ - フォーマット変換   │  │
│  └─────────────────┘  └──────────────────────┘  │
├─────────────────────────────────────────────────┤
│               データアクセス層                     │
├─────────────────────────────────────────────────┤
│  ┌─────────────────┐  ┌──────────────────────┐  │
│  │ データベース管理  │  │ 外部サービス連携      │  │
│  │ - Supabase接続  │  │ - Google Drive API  │  │
│  │ - CRUD操作      │  │ - Gmail API         │  │
│  │ - RLS制御       │  │ - OAuth認証         │  │
│  │ - トランザクション│  │ - ファイルダウンロード│  │
│  └─────────────────┘  └──────────────────────┘  │
└─────────────────────────────────────────────────┘
```

### 2.2 層間インターフェース設計

#### 2.2.1 UI層 ↔ ビジネスロジック層
```python
# UI層からの呼び出し
workflow = UnifiedProcessingWorkflow()
result = await workflow.process_uploaded_files(
    files_data,
    mode=ProcessingMode.UPLOAD,
    prompt_key="invoice_extractor",
    validation_config=config
)

# ビジネスロジック層からの応答
class WorkflowResult:
    success: bool
    processed_files: List[ProcessedFile]
    errors: List[WorkflowError]
    summary: ProcessingSummary
```

#### 2.2.2 ビジネスロジック層 ↔ データアクセス層
```python
# ビジネスロジック層からの呼び出し
db_manager = DatabaseManager()
invoice_id = await db_manager.save_invoice_data(
    invoice_data,
    user_id="user@example.com"
)

# データアクセス層からの応答
class DatabaseResult:
    success: bool
    record_id: Optional[str]
    affected_rows: int
    errors: List[DatabaseError]
```

### 2.3 責務分離原則

#### 2.3.1 UI層の責務
- **表示制御**: コンポーネント描画・レイアウト
- **入力受付**: ファイルアップロード・設定入力
- **状態管理**: セッション状態・進行状況
- **エラー表示**: ユーザー向けメッセージ

#### 2.3.2 ビジネスロジック層の責務
- **処理制御**: ワークフロー実行・順序制御
- **データ変換**: AI結果→DB形式変換
- **検証処理**: データ整合性・ビジネスルール
- **エラーハンドリング**: 例外処理・リトライ

#### 2.3.3 データアクセス層の責務
- **永続化**: データベース保存・更新
- **検索**: 条件検索・データ取得
- **接続管理**: コネクション・トランザクション
- **セキュリティ**: RLS・認証制御

## 3. 統合ワークフロー仕様

### 3.1 処理フロー
```
┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│ 入力アダプター │ -> │ AI処理エンジン │ -> │ 検証エンジン │
└─────────────┘    └─────────────┘    └─────────────┘
        │                   │                   │
        v                   v                   v
┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│ファイル正規化 │    │ Gemini API │    │ データ照合   │
└─────────────┘    └─────────────┘    └─────────────┘
                                              │
                                              v
                                    ┌─────────────┐
                                    │ DB保存エンジン│
                                    └─────────────┘
```

### 3.2 処理モード
- **UPLOAD**: 本番データ処理・DB保存 ✅ **実装済み**
- **OCR_TEST**: テスト処理・精度検証 ✅ **実装済み**  
- **VALIDATION**: 検証のみ実行 ⚠️ **部分実装**
- **BATCH**: バッチ処理モード ⚠️ **部分実装**

**実装状況**: UnifiedWorkflowEngineでUPLOAD・OCR_TESTモードは完全実装、VALIDATION・BATCHモードは基本機能のみ

### 3.3 アダプターシステム
```python
# 基底クラス
class BaseInputAdapter:
    async def convert_to_file_data(self, source) -> List[FileData]
    def validate_source(self, source) -> bool

# 実装クラス
class LocalFileAdapter(BaseInputAdapter)      # Streamlit uploads
class GoogleDriveAdapter(BaseInputAdapter)    # Drive files
class GmailAdapter(BaseInputAdapter)          # Email attachments
```

## 4. データベース設計

### 4.1 テーブル構成

**🔗 最新のデータベース設計**: → **[19_テーブル設計詳細仕様書.md](19_テーブル設計詳細仕様書.md)** を参照

**主要テーブル**:
- **invoices**: 請求書メインテーブル（28カラム）
- **invoice_line_items**: 請求書明細テーブル
- **users**: ユーザー管理テーブル
- **ocr_test_sessions**: OCRテストセッション
- **payment_masters**: 支払マスタ

**設計原則**:
- SERIAL ID（auto-increment）採用
- JSONB型によるAI抽出データの柔軟格納
- RLS（Row Level Security）によるマルチテナント対応
- タイムゾーン対応（Asia/Tokyo）

### 4.2 RLS（Row Level Security）
```sql
-- ユーザー別データ分離
ALTER TABLE invoices ENABLE ROW LEVEL SECURITY;
CREATE POLICY user_invoices_policy ON invoices
FOR ALL USING (auth.email() = user_id);
```

## 5. テスト仕様

### 5.1 アーキテクチャ分離テスト

#### 5.1.1 データベース層独立テスト
- **テスト目的**: UI・ビジネスロジック層非依存での動作確認
- **テスト方法**: ダイレクトDB接続によるCRUD操作
- **確認項目**: トランザクション・RLS・パフォーマンス

#### 5.1.2 ビジネスロジック層独立テスト
- **テスト目的**: UI層非依存での処理確認
- **テスト方法**: モックデータによるワークフロー実行
- **確認項目**: データ変換・検証・エラーハンドリング

#### 5.1.3 UI層独立テスト
- **テスト目的**: バックエンド非依存での表示確認
- **テスト方法**: モックサービスによるUI操作
- **確認項目**: 表示・入力受付・状態管理

### 5.2 統合テスト
- **エンドツーエンド**: ファイルアップロード→DB保存
- **エラー伝播**: 各層エラーの適切な伝播
- **パフォーマンス**: 統合による性能影響確認

## 6. 運用・保守

### 6.1 モニタリング
- **処理状況**: ワークフロー実行状況
- **エラー率**: 各層でのエラー発生率
- **パフォーマンス**: 処理時間・リソース使用量

### 6.2 ログ出力
```python
# 層別ログ出力
logger.info(f"UI: ファイルアップロード開始 - {filename}")
logger.info(f"BL: AI処理開始 - {prompt_key}")
logger.info(f"DA: データベース保存完了 - {invoice_id}")
```

---

## 改訂履歴
- 2025-01-23: アーキテクチャ分離設計追加
- 2025-01-23: 統合ワークフロー仕様詳細化
- 2025-01-23: テスト仕様・運用指針追加# #   <ؕ�  ���R_j�����N�v 2 . 0 �[�_	�
 
 # # #   ���ck��S_j��
 -   * * �v�v* * :   Y�ij0���h��n0q} Nh0�V���[�_
 -   * * _j��* * :   � / �QJ P Y ,   \ 
 -   * * i�(u�0�0�0�0�0* * :   A I �b�Q�_n0�0�0�0i<��0�0�0�0
 
 # # #   �0�0�0i<�ck��S_j��
 -   * * �v�v* * :   �b�Q�0�0�0n0�T�T
Nh0teT'`�x�O
 -   * * _j��* * :   ����e�NёM�n0��Ri<�h0ck��S
 -   * * Y���S_�[�_* * :   U S D / E U R I{g0n0�m��z0 % ��Ri<�
 
 # # #   J S T Bf���[�_
 -   * * �v�v* * :   �e,gBf��g0n0 N��W0_0Bf;R�{t
 -   * * �e_* * :   �0�0�0�0�0�0U T C �OX[  +   �0�0�0�0�0�0�0�0J S T h�:y
 -   * * �[a�* * :   hQ�0�0�0�0�0�0�0�0�0�0�0�0
 
 - - - 
 * * _j�����R�e* * :   2 0 2 5 t^7 g2 4 �e    
 * * �[ň�[�N* * :   ���ck��S�0�0�0i<��0�0�0�0J S T Bf���[�_
 
 