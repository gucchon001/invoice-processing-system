# 請求書処理自動化システム 外部インターフェース仕様書

**バージョン:** 1.2
**作成日:** 2025/07/17

## 1. 概要
本ドキュメントは、請求書処理自動化システムが連携する外部サービス（API）の仕様を定義する。

## 2. Gemini API

### 2.1. 目的
請求書PDFやカード明細PDFから、構造化されたテキスト情報（JSON）を抽出する。また、企業名の表記揺れ吸収や、複数候補からの内容特定といった、高度な自然言語処理を担う。

### 2.2. 利用モデル
* **`gemini-1.5-flash`**

### 2.3. インターフェース
* **エンドポイント:** `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent`
* **リクエスト形式:**
    * `contents`: プロンプトと、Base64エンコードされたPDFデータを含む。
    * `generationConfig`: `response_mime_type`を`application/json`に指定。
* **レスポンス形式:**
    * AIによって生成されたJSON文字列。
* **認証:** APIキー認証。APIキーはGCPのSecret ManagerまたはStreamlitのSecrets管理で安全に管理する。

## 3. Supabase API

### 3.1. 目的
アプリケーションの主要なデータ（請求書情報、支払マスタ、ユーザー情報など）を永続化するためのバックエンドとして利用する。

### 3.2. インターフェース
* **ライブラリ:** Python用クライアントライブラリ `supabase-py` を使用する。
* **主な操作:**
    * `select()`: データの参照
    * `insert()`: 新規データの追加
    * `update()`: 既存データの更新
    * `delete()`: データの削除
* **認証:** SupabaseプロジェクトのURLと匿名キー（anon key）を使用。これらはStreamlitのSecrets管理で安全に管理する。

## 4. Google Drive API

### 4.1. 目的
ユーザーがアップロードした請求書PDFの原本を、永続的なストレージとして保管する。

### 4.2. インターフェース
* **ライブラリ:** Python用クライアントライブラリ `google-api-python-client` を使用する。
* **主な操作:**
    * `files.create()`: ファイルのアップロード
    * `files.get()`: ファイルのメタデータ取得（URLなど）
* **認証:** サービスアカウント認証。GCPで作成したサービスアカウントのキーファイル（JSON）をStreamlitのSecrets管理で安全に管理する。

## 5. Google Sheets API

### 5.1. 目的
管理者が承認した最終的な仕訳データを、freee連携用の中間ファイルとして指定のGoogleスプレッドシートに書き出す。

### 5.2. インターフェース
* **ライブラリ:** `gspread` または `google-api-python-client` を使用する。
* **主な操作:**
    * `spreadsheets.values.append()`: 指定したシートの最終行にデータを追記する。
* **認証:** サービスアカウント認証。（Google Drive APIと共通）

## 6. Google OAuth 2.0 (ユーザー認証)

### 6.1. 目的
Streamlitアプリケーションに、ユーザーが自身のGoogleアカウントでログインできるようにする。

### 6.2. 開発・本番統一認証仕様（streamlit-oauth）

#### 6.2.1. 統一方針
**開発環境・本番環境ともに `streamlit-oauth` を使用** し、同一のコードベースで認証システムを構築する。

#### 6.2.2. 開発環境実装仕様

* **ライブラリ:** `streamlit-oauth` (最新安定版)
* **認証プロバイダー:** Google OAuth 2.0
* **実装例:**
    ```python
    import streamlit as st
    from streamlit_oauth import OAuth2Component
    import requests
    
    # OAuth設定
    oauth2 = OAuth2Component(
        client_id=st.secrets["auth"]["client_id"],
        client_secret=st.secrets["auth"]["client_secret"],
        authorize_endpoint="https://accounts.google.com/o/oauth2/auth",
        token_endpoint="https://oauth2.googleapis.com/token",
        refresh_token_endpoint="https://oauth2.googleapis.com/token",
        revoke_token_endpoint="https://oauth2.googleapis.com/revoke",
    )
    
    def check_authentication():
        """認証状態をチェック"""
        if 'auth_code' not in st.session_state:
            return None
        return st.session_state['auth_code']
    
    def get_user_info(token):
        """ユーザー情報を取得"""
        headers = {'Authorization': f'Bearer {token["access_token"]}'}
        response = requests.get(
            'https://www.googleapis.com/oauth2/v2/userinfo',
            headers=headers
        )
        return response.json() if response.status_code == 200 else None
    
    def main():
        st.title("請求書処理システム")
        
        # 認証チェック
        if 'auth_code' not in st.session_state:
            # ログインボタン表示
            st.info("🔐 Googleアカウントでログインしてください")
            result = oauth2.authorize_button(
                "Googleでログイン",
                redirect_uri=st.secrets["auth"]["redirect_uri"],
                scope="openid email profile"
            )
            
            if result and 'token' in result:
                st.session_state['auth_code'] = result['token']
                st.success("ログインしました！")
                st.rerun()
        else:
            # ログイン済みの処理
            user_info = get_user_info(st.session_state['auth_code'])
            if user_info:
                st.write(f"ようこそ、{user_info['name']}さん！")
                st.write(f"Email: {user_info['email']}")
                
                # ログアウト
                if st.button("ログアウト"):
                    del st.session_state['auth_code']
                    st.rerun()
            else:
                st.error("ユーザー情報の取得に失敗しました")
                del st.session_state['auth_code']
                st.rerun()
    ```

#### 6.2.3. 開発環境設定

* **必要なライブラリインストール:**
    ```bash
    pip install streamlit-oauth requests
    ```

* **Streamlit設定 (`.streamlit/secrets.toml`):**
    ```toml
    [auth]
    client_id = "123456789-abcdef.apps.googleusercontent.com"
    client_secret = "GOCSPX-your-google-client-secret"
    redirect_uri = "http://localhost:8501/oauth/callback"
    cookie_secret = "development_secret_32_chars_minimum"
    ```

#### 6.2.4. GCP設定（開発・本番共通）

* **OAuth同意画面の設定:**
    * アプリケーション名: "請求書処理自動化システム"
    * 承認済みドメイン: `localhost` (開発用), `your-domain.run.app` (本番用)
    * スコープ: `openid`, `email`, `profile`
    * テストユーザー: 開発チームのメールアドレスを追加

* **OAuth 2.0クライアントIDの設定:**
    * アプリケーションの種類: "ウェブアプリケーション"
    * **承認済みのリダイレクトURI:**
        * `http://localhost:8501/oauth/callback` (開発環境)
        * `http://localhost:8502/oauth/callback` (開発環境・複数ポート)
        * `https://your-app-domain.run.app/oauth/callback` (本番環境)

#### 6.2.5. セットアップ手順

1. **依存関係インストール:**
    ```bash
    pip install streamlit streamlit-oauth requests
    ```

2. **GCP設定:**
    * OAuth同意画面とクライアントIDを作成
    * リダイレクトURIに `http://localhost:8501/oauth/callback` を追加

3. **ローカル設定:**
    ```bash
    mkdir -p .streamlit
    # .streamlit/secrets.toml を作成し、認証情報を設定
    ```

4. **動作確認:**
    ```bash
    streamlit run app.py
    # http://localhost:8501 で OAuth フローを確認
    ```

#### 6.2.6. 環境別設定の切り替え

* **開発環境用 secrets.toml:**
    ```toml
    [auth]
    redirect_uri = "http://localhost:8501/oauth/callback"
    ```

* **本番環境用 secrets.toml:**
    ```toml
    [auth]  
    redirect_uri = "https://your-app-domain.run.app/oauth/callback"
    ```

### 6.3. 本番環境における認証仕様（決定版）

#### 6.3.1. 基本方針
本番環境では **`streamlit-oauth`** ライブラリを使用したGoogle OAuth 2.0認証を実装する。

#### 6.3.2. ライブラリ仕様
* **ライブラリ:** `streamlit-oauth` (最新安定版)
* **認証プロバイダー:** Google
* **認証フロー:** OAuth 2.0 Authorization Code Flow
* **セッション管理:** Streamlit Session State

#### 6.3.3. 実装仕様
```python
import streamlit as st
from streamlit_oauth import OAuth2Component

# OAuth設定
oauth2 = OAuth2Component(
    client_id=st.secrets["auth"]["client_id"],
    client_secret=st.secrets["auth"]["client_secret"],
    authorize_endpoint="https://accounts.google.com/o/oauth2/auth",
    token_endpoint="https://oauth2.googleapis.com/token",
    refresh_token_endpoint="https://oauth2.googleapis.com/token",
    revoke_token_endpoint="https://oauth2.googleapis.com/revoke",
)

# 認証状態チェック関数
def check_authentication():
    if 'token' not in st.session_state:
        return None
    return st.session_state['token']

# ユーザー情報取得関数
def get_user_info(token):
    # Google UserInfo APIを呼び出し
    # ユーザー情報（email, name, picture）を取得
    pass
```

#### 6.3.4. 本番環境設定
* **GCP OAuth 2.0クライアント設定:**
    * **承認済みのリダイレクトURI:** 
        * `https://your-app-domain.run.app/oauth/callback`
        * 複数環境対応: staging/production各環境のURL
    * **承認済みの JavaScript 生成元:** 
        * `https://your-app-domain.run.app`

* **Streamlit Secrets設定 (本番環境):**
    ```toml
    [auth]
    client_id = "本番用クライアントID"
    client_secret = "本番用クライアントシークレット"
    redirect_uri = "https://your-app-domain.run.app/oauth/callback"
    cookie_secret = "本番用セキュアランダム文字列（32文字以上）"
    session_max_age = 28800  # 8時間
    ```

#### 6.3.5. セキュリティ仕様
* **セッション管理:**
    * セッション有効期限: 8時間
    * 自動ログアウト機能
    * CSRF保護
* **トークン管理:**
    * アクセストークンはメモリ内のみ保持
    * リフレッシュトークンは使用しない（セキュリティ強化）
* **HTTPS強制:** 本番環境では全通信をHTTPS化

#### 6.3.6. エラーハンドリング
* **認証失敗時:**
    * ユーザーフレンドリーなエラーメッセージ表示
    * 管理者へのアラート通知
    * ログ記録（個人情報除外）
* **セッション期限切れ時:**
    * 自動リダイレクトでの再認証
    * 作業中データの一時保存（可能な範囲）

#### 6.3.7. フォールバック対応
* **streamlit-oauth不具合時の対応:**
    * **代替案1:** GCP Identity-Aware Proxy (IAP) への切り替え
    * **代替案2:** カスタム認証実装
    * **緊急対応:** 一時的な IP 制限 + 簡易認証

#### 6.3.8. デプロイ時の注意事項
* **環境変数チェック:** 認証関連のシークレットが正しく設定されているか確認
* **リダイレクトURI更新:** デプロイ先URLに合わせてGCP設定を更新
* **動作確認:** ログイン・ログアウト・セッション継続の動作テスト実施

## 7. Google Slides API (経理ルールチェック)

### 7.1. 目的
経理ハンドブック（Google Slides）から経理ルールを自動抽出し、請求書処理の準拠性チェックに使用する。

### 7.2. 対象プレゼンテーション
* **URL:** https://docs.google.com/presentation/d/1oIjB0Dv7yXVw_3NqUdrBuaa5-rI2ZL5K9dTGYMqV04o/edit
* **タイトル:** トモノカイ 経理ルールブック
* **形式:** Google Slides

### 7.3. インターフェース
* **ライブラリ:** Python用クライアントライブラリ `google-api-python-client` を使用
* **API バージョン:** v1
* **主な操作:**
    * `presentations.get()`: プレゼンテーション全体の取得
    * `presentations.pages.get()`: 特定ページ（スライド）の取得
* **認証:** サービスアカウント認証（Google Drive APIと共通）

### 7.4. データ抽出仕様
* **抽出対象:**
    * 勘定科目の適正な使い分けルール
    * 支払期日の計算ルール
    * 申請タイトルの命名規則
    * 金額・税率の妥当性基準
    * 承認ワークフローの要件
* **AI解析:**
    * 各スライドのテキスト・画像を Gemini API で解析
    * 経理ルールを構造化データ（JSON）として抽出
    * `accounting_rules` テーブルに保存
* **更新頻度:** 管理者による手動実行（月次想定）

### 7.5. エラーハンドリング
* **アクセス権限エラー:** プレゼンテーションへの読み取り権限が必要
* **ネットワークエラー:** リトライ処理の実装
* **API制限:** Rate Limiting への対応