# 請求書処理自動化システム テスト設計書

**バージョン:** 1.0
**作成日:** 2025/07/17

## 1. テスト概要

### 1.1. 目的
本システムが、要件定義書および仕様書に記載された機能・非機能要件をすべて満たし、安定して動作することを確認する。また、デグレード（機能後退）が発生していないことを保証する。

### 1.2. 対象範囲
* Streamlitで構築されたWebアプリケーションの全機能
* Pythonで記述されたバックエンドの全ビジネスロジック
* 外部API（Gemini, Supabase, Google Drive, Google Sheets）との連携部分

## 2. テスト方針

### 2.1. テストレベル
* **単体テスト (Unit Test):**
    * **対象:** Pythonで記述された個々の関数（日付計算、データ整形など）。
    * **目的:** 各関数が、特定の入力に対して期待通りの出力を返すことを確認する。
    * **ツール:** `pytest`
* **結合テスト (Integration Test):**
    * **対象:** 複数のモジュールや外部APIが連携する機能（AIによる情報抽出、仕訳提案ロジック全体など）。
    * **目的:** モジュール間のデータの受け渡しや、API連携が正しく行われることを確認する。
* **システムテスト (System Test):**
    * **対象:** アプリケーション全体。
    * **目的:** ユーザーの視点から、要件定義通りの機能がすべて実装され、正常に動作することを確認する。
* **受け入れテスト (UAT - User Acceptance Test):**
    * **対象:** アプリケーション全体。
    * **目的:** 実際の業務担当者（管理者、一般ユーザー）が、実データを用いてシステムを操作し、業務上の要求を満たしているかを最終確認する。

### 2.2. テストタイプ
* **機能テスト:** 仕様書通りに機能が動作するかを確認する。
* **非機能テスト（回帰テスト）:** コード修正によって、既存の機能に不具合（デグレード）が発生していないかを確認する。

## 3. テスト環境
* **開発環境:** 開発者のローカルPC
* **ステージング環境:** 本番環境とほぼ同じ構成の検証用環境（Google Cloud Run, Supabaseの別プロジェクト）。受け入れテストはここで行う。
* **本番環境:** 実際にユーザーが利用する環境。

## 4. テスト項目・テストケース
「機能拡張テストシナリオ」をベースに、より詳細なテストケースを作成する。

| テスト項目 | テストケース（例） | 期待される結果 |
| :--- | :--- | :--- |
| **ユーザー認証** | ・一般ユーザーでログインする<br>・管理者でログインする<br>・ログアウトする<br>・セッション期限切れをテストする<br>・不正なアクセストークンでアクセスする<br>・OAuth認証フローをテストする | ・サイドバーのメニューが役割に応じて正しく表示される<br>・セッションが正しく管理される<br>・期限切れ時に自動的にログイン画面にリダイレクトされる<br>・不正アクセスが適切に拒否される<br>・Google OAuthで正常にログインできる |
| **請求書アップロード** | ・単一のPDFをアップロードする<br>・複数のPDFを同時にアップロードする<br>・PDF以外のファイルをアップロードしようとする | ・ファイルがGoogle Driveに保存され、DBにレコードが作成される<br>・複数レコードが作成される<br>・エラーメッセージが表示され、アップロードが拒否される |
| **仕訳提案ロジック** | ・支払マスタに1件のみ該当する請求書を処理する<br>・複数候補があり、「追加条件」で絞り込める請求書を処理する<br>・複数候補があり、「追加条件」では決まらずAI判断が必要な請求書を処理する<br>・支払マスタに存在しない請求書を処理する | ・正しい仕訳が提案される<br>・「追加条件」に基づいた正しい仕訳が提案される<br>・AIが明細内容を解釈し、正しい仕訳を提案する<br>・ステータスが「要確認（マスタ不一致）」となる |
| **個別処理ルール** | ・「支払日ルール: 翌々月10日営業日」が設定された取引先を処理する<br>・「仕訳提案: スキップ」が設定された取引先を処理する | ・支払期日が正しく計算される<br>・仕訳提案が行われず、ステータスが「要確認（手動処理）」などになる |
| **データ編集・削除** | ・ダッシュボードのセルを直接編集し、保存されることを確認する<br>・単一のレコードをチェックして削除する<br>・複数のレコードをチェックして一括削除する | ・編集内容がDBに反映される<br>・対象レコードがDBから削除される<br>・対象の複数レコードがDBから削除される |
| **データ書き出し** | ・「freee連携シートへ書き出し」ボタンをクリックする | ・`status`が`approved`のデータのみが、指定のスプレッドシートに書き出される<br>・書き出し後、DBの`status`が`exported`に更新される |

## 5. テスト実施体制
* **単体・結合テスト:** 開発リード（Gemini）
* **システム・受け入れテスト:** プロダクトオーナー（佐久間 舞）