# 請求書処理自動化システム 要件定義書 (最終版)

**バージョン:** 2.5
**作成日:** 2025/07/17

## 1. 概要

### 1.1. 背景と目的
現行のGoogle Apps Script（GAS）ベースの請求書処理システムは、Googleサービスとのシームレスな連携により、請求書処理の自動化に成功している。しかし、運用において以下の課題が顕在化している。

* **管理の複雑化:** メンバーごとにスプレッドシートを配布・管理する必要があり、ユーザー数の増加に伴い、管理者の負担が増大している。
* **拡張性の限界:** より高度なUI/UXや、将来的なデータ分析機能の追加を考えた際に、GASの制約がボトルネックとなる可能性がある。

本プロジェクトの目的は、これらの課題を解決するため、システム基盤を**PythonおよびStreamlit**に移管することである。これにより、**管理を一元化**し、**優れたユーザー体験**と**高い拡張性**を持つ、持続可能な請求書処理プラットフォームを構築する。

### 1.2. 新システムのコンセプト
**「役割に応じた機能が、一つのWebアプリケーションで完結する」**

メンバーは個別のスプレッドシートを使うのではなく、各自のアカウントで単一のWebアプリケーションにログインする。**サイドバー**で役割（一般ユーザー/管理者）に応じたメニューが切り替わり、請求書のアップロードからマスターデータの管理まで、すべての操作をシームレスに行うことができる。

## 2. 利用ユーザーと役割

| 役割 | 説明 |
| :--- | :--- |
| **一般ユーザー** | 各部門の担当者。自身が担当する請求書をアップロードし、処理状況を確認する。支払マスタにない取引先の場合は、新規登録を申請する。 |
| **管理者** | 経理担当者。全ユーザーの処理状況を横断的に確認・管理し、支払マスタのメンテナンスやユーザーからの申請を承認する。 |

## 3. 機能要件

### 3.1. ユーザー認証
* ユーザーは自身のGoogleアカウントでシステムにログインできる（OAuth認証）。
* ログインしたユーザーに応じて、表示・操作できるデータが制限される。

### 3.2. 請求書アップロード機能
* ユーザーは、直感的で分かりやすいUIを通じて、請求書PDFをアップロードできる。
* 複数ファイルの同時アップロードに対応する。
* （推奨）ドラッグ＆ドロップでのアップロードに対応する。

### 3.3. データ処理・表示ダッシュボード
* アップロードされた請求書は、バックエンドで自動的にAIによる情報抽出、支払マスタとの照合、仕訳提案が実行される。
* ユーザーは、自身がアップロードした請求書の一覧と、現在の処理ステータス（例：処理中, AI提案済み, 要確認, 転記済み）をダッシュボードで確認できる。
* 一覧は、フィルタリングやソートが可能である。

### 3.4. 仕訳データの編集・確認機能
* ユーザーは、ダッシュボード上の各請求書データを選択し、AIによって提案された仕訳内容を詳細に確認・修正できる。
* Excelのように、テーブルのセルを直接編集したり、プルダウンから項目を選択したりできる。
* 複数行を選択して一括で削除する機能を持つ。
* 修正内容を確定すると、データが保存され、ステータスが更新される。

### 3.5. 支払マスタ管理機能（管理者向け）
* 管理者は、Webアプリケーション上の専用画面から「支払マスタ」を閲覧、検索、編集（追加・修正・削除）できる。
* 特に、「追加条件」や「個別処理ルール」といった、システムの動作を制御する重要な項目を安全にメンテナンスできる。

### 3.6. 支払マスタ新規登録ワークフロー
* **ユーザーによる申請:** 請求書の照合の結果、支払マスタに該当がない場合、ユーザーはUI上のボタンから新規マスタの登録を申請できる。
* **管理者による承認:** 申請されたマスタは「承認待ち」ステータスで登録される。管理者は内容を確認し、承認することで初めてシステムで有効となる。

### 3.7. freee連携シートへの書き出し機能（管理者向け）
* 管理者は、ユーザーによって確認・承認された仕訳データを、**ボタン一つで指定のGoogleスプレッドシートに書き出す**ことができる。このシートは、会計システム（freee）へのインポート用データとして利用される。

### 3.8. 個別処理ルールの適用
* 支払マスタに定義された「個別処理ルール」に基づき、システムは標準とは異なる特殊な処理を実行する。
    * **支払期日の特別計算:** `支払日ルール: 翌々月10日営業日` のようなルールに基づき、支払期日を動的に計算する。
    * **申請タイトルの自動フォーマット:** `申請タイトル: 前払い(期間)` のようなルールに基づき、申請タイトルを特定の形式に整形する。
    * **処理のスキップ:** `仕訳提案: スキップ` のようなルールに基づき、特定の取引先の自動処理を意図的に停止し、手動確認を促す。

### 3.9. 外貨換算機能
* 請求書が外貨（USDなど）で記載されている場合、システムは事前に取り込まれたカード利用明細データと自動で照合する。
* 照合に成功した場合、日本円での支払額と適用レートを自動で計算し、仕訳データに反映させる。
* 照合に失敗した場合や、後から明細をアップロードした場合は、ユーザーが手動で再照合を実行できるボタンを提供する。

### 3.10. メールの自動取り込み機能
* 特定のメールアドレスに届いた請求書PDFを、システムが自動で検知し、担当者を割り当ててアップロード処理を実行する。

### 3.11. ユーザー向けメール設定機能
* ユーザーは、自身の通知設定（処理完了時、エラー発生時など）をWebアプリケーション上で管理できる。
* 自身が担当者として割り当てられているメールの自動処理ルールを確認できる。

### 3.12. ログ閲覧機能（管理者向け）
* システム全体の動作状況を管理者がリアルタイムで把握し、エラー発生時に迅速な原因究明を可能にする。
* Webアプリケーション上の専用画面で、バックエンドで出力される処理ログを時系列で閲覧・検索・フィルタリングできる。

### 3.13. 経理ルール準拠チェック機能（管理者向け）
* **目的:** 請求書処理内容が経理ハンドブック（Google Slides）に定義されたルールに準拠しているかを自動的にチェックする。
* **対象データ:** 承認待ちまたは承認済みの請求書データ
* **チェック項目:**
    * 勘定科目の適切性
    * 支払期日の妥当性
    * 申請タイトルの形式
    * 金額・税率の整合性
    * 承認ワークフローの適正性
* **機能詳細:**
    * **自動取得:** Google Slides APIを通じて最新の経理ハンドブックを取得
    * **ルール解析:** AIによる経理ルールの構造化・抽出
    * **照合処理:** 各請求書データと経理ルールを自動照合
    * **結果表示:** 準拠状況をダッシュボード形式で表示
    * **不整合検出:** ルール違反項目のハイライト表示と修正提案
* **アクセス権限:** 管理者のみ利用可能
* **実行タイミング:** 
    * 管理者による手動実行
    * freee連携前の最終チェックとして自動実行（オプション）

## 4. 非機能要件

| 項目 | 要件 |
| :--- | :--- |
| **ユーザビリティ** | マニュアルを読まなくても、直感的に操作できるシンプルなUI/UXを提供する。 |
| **パフォーマンス** | 大量の請求書データを扱っても、ダッシュボードの表示や検索が遅延なく快適に行えること。 |
| **セキュリティ** | ユーザーごとにデータが完全に分離され、他人の請求書データを閲覧・操作できないこと。管理者の権限が適切に設定されていること。 |
| **拡張性** | 将来的に、請求書データの分析・可視化ダッシュボードや、新しい個別処理ルールを追加できるような、柔軟なアーキテクチャであること。 |

## 5. システム構成図（案）

\`\`\`
+----------------+      +-------------------------+      +-------------------+
|                |      |                         |      |                   |
|   ユーザー      | <=>  |  Streamlit フロントエンド  | <=>  |  Python バックエンド  |
| (ブラウザ)      |      |  (UI, ダッシュボード)     |      |  (ビジネスロジック)   |
|                |      |                         |      |                   |
+----------------+      +-------------------------+      +----------+--------+
                                                                    |
                               +------------------------------------+------------------------------------+
                               |                                    |                                    |
                               v                                    v                                    v
                      +----------+--------+               +----------+--------+               +----------+--------+
                      |                   |               |                   |               |                   |
                      |     データベース      |               |     Gemini API    |               |   Google Drive    |
                      | (Supabase)        |               | (情報抽出)        |               | (PDFストレージ)     |
                      |                   |               |                   |               |                   |
                      +-------------------+               +-------------------+               +-------------------+
\`\`\`
 
 # #     R_jNv 2 . 0 [_	
 
 # # #   F R - 1 5   ckS_j
 -   * * *QHQ^* * :   ؚ
 -   * * i* * :   Yij0hn0Rq} N
 -   * * s0}* * :   
     -   / Q    J P Y   x0n0R	Yc
     -   \ $     U S D   x0n0R	Yc
     -   000000OX[Bfn0000q} N
 -   * * SeQWn* * :   hQf0n0hL0ckSU000
 
 # # #   F R - 1 6   000i<ckS_j
 -   * * *QHQ^* * :   ؚ
 -   * * i* * :   A I bQ000n0TT
N
 -   * * s0}* * : 
     -   eNёMn0Ri<
     -   YS_g0n0mz0 % Ri<
     -   000teT'`0000
 -   * * SeQWn* * :   i<000L0iRk0iQ1XJTU000
 
 # # #   F R - 1 7   J S T Bf[_
 -   * * *QHQ^* * :   -N
 -   * * i* * :   e,gBfg0n0q} NBf;R{t
 -   * * s0}* * : 
     -   000000:   U T C OX[
     -   00000000:   J S T h:y
     -   0000000n0 N'`xO
 -   * * SeQWn* * :   hQBf;RL0J S T g0 Nh:yU000
 
 - - - 
 * * _jRe* * :   2 0 2 5 t^7 g2 4 e    
 * * [ňrl* * :     [N  -   ckS000i<J S T [_ 
 