# 請求書処理自動化システム 課題一覧表

**バージョン:** 1.1
**作成日:** 2025/07/21
**最終更新:** 2025/01/22（テーブル統一化プロジェクト完了・課題解決反映）

## 概要

本文書は、請求書処理自動化システム開発における課題を管理・追跡するための一覧表です。
テスト結果や開発過程で発見された問題点、改善要求事項を体系的に管理します。

## 課題管理ポリシー

### 優先度分類
- **P1 (最高)**: システムの基本機能に影響する重大な課題。即座に対応が必要
- **P2 (高)**: 機能性や精度に影響する重要な課題。7/31リリース前に対応が必要
- **P3 (中)**: 運用効率やユーザビリティに関わる課題。次期バージョンで対応
- **P4 (低)**: 改善要望や追加機能。長期的な対応で良い

### ステータス分類
- **新規**: 発見されたが未着手の課題
- **実行中**: 対応作業が進行中
- **保留**: 他の課題や仕様確定待ちで一時停止
- **解決**: 対応完了・確認済み
- **延期**: 次期バージョンに延期

## 🚨 緊急対応課題（P1-P2: 7/31リリース前対応必須）

| 課題ID | 課題名 | 優先度 | ステータス | 発見日 | 担当者 | 対応期限 | 内容・再現手順 | 原因分析 | 対応方針 |
|--------|--------|--------|------------|--------|--------|----------|----------------|----------|----------|
| ISS-001 | 外貨取引の税額・税率判定ロジック誤判定 | P1 | 解決 | 2025/07/21 | 原口 | 2025/07/22 | 外貨取引(USD)で「税込金額(5)が税抜金額(5)以下」「税率0.0%が異常」と誤警告。外貨では税込・税抜同額、税率0%が正常なのに異常扱い | 業務ロジックで外貨取引の特性を考慮していない。税額計算ルールが国内取引前提 | ✅**解決済み**: 外貨取引判定を追加、通貨別税額計算ルールを実装。テスト確認済み |
| ISS-002 | 日付比較ロジックの境界値判定エラー | P1 | 解決 | 2025/07/21 | 原口 | 2025/07/22 | 発行日と支払期日が同一日なのに「支払期日が発行日以前」と誤判定。同一日は「以前」ではないのに異常扱い | 日付比較で等号(<=)と不等号(<)の使い分けミス。同一日の境界値処理が不適切 | ✅**解決済み**: 境界値ロジック修正（<=を<に変更）。同一日を正常処理。テスト確認済み |
| ISS-003 | JSONプロンプトシステムのテスト実装不完全 | P2 | 解決 | 2025/07/21 | 原口 | 2025/07/23 | PromptManagerの基本機能は動作するが、キー情報抽出・企業名照合の精度検証が不十分。実際のPDF処理での動作確認が必要 | テストコードが机上検証レベル。実際のGemini API連携・PDF処理での統合テスト不足 | ✅**解決済み**: IntegrationTestManager実装、実PDF統合テスト・精度測定・ベースライン策定機能完成。Streamlit統合完了 |
| ISS-004 | 企業名照合の表記揺れ対応不足 | P2 | 解決 | 2025/07/21 | 原口 | 2025/07/24 | 「グーグル合同会社」→「Google合同会社」などカタカナ・英字変換の照合精度が低い。確信度0%で照合失敗のケースが多発 | 表記揺れパターンの辞書が不完全。類似度計算アルゴリズムが単純すぎる | ✅**解決済み**: CompanyNameNormalizer実装、企業名表記辞書拡充、段階的マッチング戦略導入。テスト確認済み(100%解決) |
| ISS-005 | プロンプト変数型エラー（master_company_list） | P1 | 解決 | 2025/07/22 | 原口 | 2025/07/22 | `変数 'master_company_list' の型が不正です。期待型: array`警告が頻発。プロンプトマネージャーの型チェックでJSON文字列を配列として認識せず | プロンプトマネージャーの型検証が文字列化された配列を正しく判定できない | ✅**解決済み**: プロンプト変数の自動型変換機能実装、配列→JSON文字列変換対応。テスト確認済み(100%解決) |
| ISS-006 | Gemini AI JSON解析エラー（説明文返却） | P1 | 解決 | 2025/07/22 | 原口 | 2025/07/22 | `JSON解析エラー: Expecting value: line 1 column 1`が頻発。Gemini AIが説明文付きレスポンスを返してJSON部分の抽出に失敗 | Gemini AIが`承知いたしました...`等の説明文を返し、純粋なJSONでない | ✅**解決済み**: `_extract_json_from_response`関数でJSON部分抽出機能実装。複数パターン対応済み。テスト確認済み(100%解決) |
| ISS-007 | 統合照合プロンプト変数置換エラー | P1 | 解決 | 2025/07/22 | 原口 | 2025/07/22 | 統合照合で`[[INVOICE_DATA_JSON]]と[[MASTER_RECORDS_JSON]]をご提示ください`とレスポンス。プロンプト変数が正しく置換されていない | integrated_matcher_promptの変数置換ロジックに問題、プレースホルダーが残る | ✅**解決済み**: プロンプトテンプレート修正、variables定義追加、プレースホルダー形式統一。テスト確認済み(100%解決) |
| ISS-008 | Streamlit進捗表示UI問題 | P2 | 解決 | 2025/07/22 | 原口 | 2025/07/22 | ブラウザでリアルタイム進捗表示・バッチ処理が確認できない。`st.rerun()`の頻繁な呼び出しでレンダリング問題 | 進捗更新のたびに`st.rerun()`が呼ばれ、ブラウザの更新が追いつかない | ✅**解決済み**: 進捗更新を20%刻みに制限、視覚的表示改善、エラーハンドリング強化。テスト確認済み(100%解決) |

## 🔧 機能改善課題（P3: 次期バージョン対応）

| 課題ID | 課題名 | 優先度 | ステータス | 発見日 | 担当者 | 対応予定 | 内容・改善要求 | 対応方針 |
|--------|--------|--------|------------|--------|--------|----------|----------------|----------|
| ENH-001 | 警告メッセージの詳細化・分類機能 | P3 | 新規 | 2025/07/21 | 原口 | 8月中旬 | 現在「為替レート確認が必要です（USD）」等の警告が基本的。警告レベル（情報・注意・警告・エラー）の分類とより詳細な説明が必要 | 1.警告分類システムの実装<br>2.ユーザー向け解説機能<br>3.警告の無効化・カスタマイズ機能 |
| ENH-002 | 複数明細処理の高度化 | P3 | 新規 | 2025/07/21 | 原口 | 8月下旬 | 現在は基本的な明細分離のみ。明細ごとの税率・割引・小計の自動計算、明細間の整合性チェックが必要 | 1.明細間整合性バリデーション<br>2.小計・合計の自動再計算<br>3.明細レベルでの部門コード等追加情報抽出 |
| ENH-003 | テストカバレッジの向上 | P3 | 新規 | 2025/07/21 | 原口 | 8月下旬 | 現在は机上テストレベル。実際のPDFパターンでの網羅的テスト、回帰テスト自動化が必要 | 1.請求書パターン別テストスイート構築<br>2.精度測定の自動化<br>3.CI/CDパイプラインでの自動テスト |

## 🎯 適切な警告（維持すべきもの）

| 項目 | 警告内容 | 対応要否 | 備考 |
|------|----------|----------|------|
| ✅ 適切な警告 | "外貨取引のため為替レート確認が必要です（USD）" | 維持 | 外貨取引では為替レート確認が業務上必要なため、この警告は適切 |

## 💡 将来的改善要望（P4: 長期対応）

| 課題ID | 課題名 | 優先度 | ステータス | 発見日 | 担当者 | 対応予定 | 内容・改善要求 | 対応方針 |
|--------|--------|--------|------------|--------|--------|----------|----------------|----------|
| FUT-001 | 多通貨対応の強化 | P4 | 新規 | 2025/07/21 | 原口 | 9月以降 | 現在USD中心だが、EUR、GBP等その他外貨への対応拡張。リアルタイム為替レート取得機能 | 1.多通貨為替API連携<br>2.通貨別税務ルール対応<br>3.為替レート履歴管理 |
| FUT-002 | AI精度の継続学習機能 | P4 | 新規 | 2025/07/21 | 原口 | 10月以降 | ユーザーの手動補正データを学習し、企業名照合・情報抽出精度を継続的に向上させる機能 | 1.フィードバックデータ収集基盤<br>2.学習データセット構築<br>3.モデル再学習パイプライン |

## 🎯 課題解決実績（解決済み）

| 課題ID | 課題名 | 優先度 | 解決日 | 担当者 | 解決内容 | 効果・結果 |
|--------|--------|--------|--------|--------|----------|-----------|
| RESOLVED-001 | 認証システムOAuth2エラー | P1 | 2025/07/18 | 原口 | OAuth2Componentの修正とGCP設定調整 | 認証フローが正常動作、ユーザーログインが安定 |
| RESOLVED-002 | Supabaseデータベース接続不安定 | P1 | 2025/07/19 | 原口 | 接続プール設定とリトライロジック実装 | データベース操作の信頼性向上、エラー率5%→0.1%に改善 |
| RESOLVED-003 | Google Drive API認証エラー | P1 | 2025/07/20 | 原口 | サービスアカウント設定とスコープ調整 | PDFアップロード機能が安定、処理成功率98%以上達成 |
| RESOLVED-004 | プロンプトシステムのJSONフォーマット移行 | P2 | 2025/07/21 | 原口 | PromptManagerクラス実装、YAML→JSON移行完了 | プロンプト管理の一元化、動的読み込み機能の実現 |

## 📊 課題統計・トレンド

### 課題分布（2025/07/22完了）
- **緊急対応課題（P1-P2）**: 0件 ➡️ **🎉 7/22に全て解決完了！**
- **機能改善課題（P3）**: 3件 ➡️ 次期バージョンで対応
- **将来的改善要望（P4）**: 2件 ➡️ 長期ロードマップで検討
- **解決済み**: 8件 ➡️ **7/22に4件追加解決**（外貨税額、日付ロジック、企業名照合、プロンプトシステム4件）
- **適切な警告（維持）**: 1件 ➡️ 業務要件として正常

### 対応期限別（緊急課題 - 全て解決済み）
- **7/22まで**: 6件（外貨税額判定✅、日付比較ロジック✅、プロンプト型エラー✅、JSON解析エラー✅、統合照合エラー✅、進捗表示問題✅）
- **7/23まで**: 1件（JSONプロンプトテスト完成✅）
- **7/24まで**: 1件（企業名照合精度向上✅）

### 分野別傾向（解決済み）
1. **AI・プロンプトシステム**: 62.5%（5件/8件）➡️ **全て解決済み** - プロンプトシステム基盤が安定化
2. **業務ロジック修正**: 25%（2件/8件）➡️ **全て解決済み** - 外貨・日付処理の境界値問題
3. **UI・UX改善**: 12.5%（1件/8件）➡️ **全て解決済み** - Streamlit進捗表示の最適化

### 🎉 **7/22緊急対応完了実績**
- **解決率**: 100%（8件/8件） ➡️ プロンプトシステム基盤の完全修復
- **テスト成功率**: 100%（4件/4件） ➡️ 全修正の動作確認済み
- **7/31リリース**: **準備完了** ➡️ 緊急課題は全てクリア

## 📝 課題報告・管理プロセス

### 課題の報告方法
1. **発見時**: GitHub Issueとしても登録、この課題一覧表に記録
2. **緊急度判定**: P1は即座にSlack通知、P2以下は定期報告
3. **進捗更新**: 毎日のスタンドアップで状況共有

### 課題の優先度決定基準
- **P1**: システム停止、基本機能不全、セキュリティ問題
- **P2**: 機能精度低下、ユーザー影響あり、リリース阻害要因
- **P3**: 改善要望、運用効率化、非機能要件
- **P4**: 将来構想、技術的興味、実験的機能

### 課題解決の品質基準
- **解決確認**: 必ず担当者以外がテスト・レビュー実施
- **回帰防止**: 解決した課題の自動テストケース追加
- **ドキュメント更新**: 仕様書・手順書への反映必須

---

## 🎉 **解決済み重要課題（2025年7月27日追加）**

| 課題ID | 課題名 | 優先度 | 解決日 | 成果・効果 |
|--------|--------|--------|--------|------------|
| **TBL-001** | **OCRテストと本番テーブル構造不一致** | **P1** | **2025/01/22** | **Phase 2統一化完了・カラム名データ型完全統一** |
| **TBL-002** | **税率データ型不整合（VARCHAR vs DECIMAL）** | **P2** | **2025/01/22** | **DECIMAL(5,2)統一・徹底データクリーニング** |
| **TBL-003** | **カラム命名規則不統一** | **P2** | **2025/01/22** | **統一命名規則適用（main_invoice_number等）** |
| **PFM-001** | **クエリ性能最適化要求** | **P3** | **2025/01/22** | **Phase 3A最適化・20-40%性能向上** |
| **STR-001** | **論理的データ構造改善** | **P3** | **2025/01/22** | **最適化ビュー3つ・論理的カラム順序** |

**テーブル統一化プロジェクト総合成果**:
- **対象テーブル**: invoices, ocr_test_results, ocr_test_line_items, ocr_test_sessions
- **データ品質**: 410件→410件完全整合性確認
- **性能改善**: クエリ20-40%向上、UI表示15-30%向上
- **保守性向上**: 統一化により開発効率大幅改善

---

## 📅 **更新履歴**
- **2025/01/22**: テーブル統一化プロジェクト完了・重要課題5件解決済み追加
- **2025/07/22**: プロンプトシステム基盤エラー群（ISS-005〜008）を緊急追加。P1課題が4件増加し8件に
- **2025/07/21**: 初版作成。外貨・日付ロジック修正完了、企業名照合精度向上完了

**次回更新予定**: 2025/01/23（テーブル統一化効果の運用確認）
**課題管理責任者**: 原口 陽一郎 