# ğŸ“¦ ã‚¯ãƒ©ã‚¹å›³

**ä½œæˆæ—¥**: 2025å¹´1æœˆ24æ—¥  
**ãƒãƒ¼ã‚¸ãƒ§ãƒ³**: 3.1  
**å¯¾è±¡ã‚·ã‚¹ãƒ†ãƒ **: è«‹æ±‚æ›¸å‡¦ç†è‡ªå‹•åŒ–ã‚·ã‚¹ãƒ†ãƒ   
**æœ€çµ‚æ›´æ–°**: 2025å¹´8æœˆ1æ—¥ - å®Ÿè£…çŠ¶æ³åæ˜ ãƒ»Gmailé€£æºæ©Ÿèƒ½çŠ¶æ³ä¿®æ­£

**v3.1æ›´æ–°å†…å®¹**: å®Ÿè£…çŠ¶æ³æ­£ç¢ºåæ˜ ãƒ»Gmailé€£æºæ©Ÿèƒ½ã‚’å®Ÿè£…äºˆå®šã«å¤‰æ›´ãƒ»å¤–è²¨æ›ç®—ã‚«ãƒ¼ãƒ‰æ˜ç´°é€£æºæœªå®Ÿè£…çŠ¶æ³åæ˜ ãƒ»ã‚¢ãƒ€ãƒ—ã‚¿ãƒ¼ãƒ‘ã‚¿ãƒ¼ãƒ³åŸºåº•ã‚¯ãƒ©ã‚¹æœªå®Ÿè£…çŠ¶æ³åæ˜   
**v3.0æ›´æ–°å†…å®¹**: 40ã‚«ãƒ©ãƒ æ–°æ©Ÿèƒ½å¯¾å¿œãƒ»å¤–è²¨æ›ç®—ãƒ»æ‰¿èªãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãƒ»freeeé€£æºã‚¯ãƒ©ã‚¹è¿½åŠ 
**v2.0æ›´æ–°å†…å®¹**: é‡è¤‡å‰Šé™¤ãƒ»ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«çµ±åˆãƒ»é€šè²¨æ­£è¦åŒ–æ©Ÿèƒ½å¯¾å¿œ
- PromptSelectorå‰Šé™¤ï¼ˆUnifiedPromptManagerã«çµ±åˆï¼‰
- UnifiedWorkflowEngineã«ãƒ‡ãƒ¼ã‚¿æ¤œè¨¼ã‚¹ãƒ†ãƒƒãƒ—è¿½åŠ 
- InvoiceValidatorã«é€šè²¨æ­£è¦åŒ–æ©Ÿèƒ½è¿½åŠ 
- ã‚·ãƒ³ã‚°ãƒ«ãƒˆãƒ³ãƒ‘ã‚¿ãƒ¼ãƒ³ã®é©ç”¨

## ğŸ“Š æ¦‚è¦

æœ¬ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯è«‹æ±‚æ›¸å‡¦ç†è‡ªå‹•åŒ–ã‚·ã‚¹ãƒ†ãƒ ã®å…¨ã‚¯ãƒ©ã‚¹æ§‹é€ ã‚’UMLã‚¯ãƒ©ã‚¹å›³ã§å¯è¦–åŒ–ã—ã€å„ã‚¯ãƒ©ã‚¹ã®å±æ€§ã€ãƒ¡ã‚½ãƒƒãƒ‰ã€é–¢ä¿‚æ€§ã‚’è©³ç´°ã«å®šç¾©ã—ã¾ã™ã€‚

**ğŸ‰ 2025å¹´7æœˆ28æ—¥æ›´æ–°**: **40ã‚«ãƒ©ãƒ æ–°æ©Ÿèƒ½å¯¾å¿œ**ã«ã‚ˆã‚Šã€å¤–è²¨æ›ç®—ãƒ»æ‰¿èªãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãƒ»freeeé€£æºã®3ã¤ã®æ–°æ©Ÿèƒ½ã‚¯ãƒ©ã‚¹ãŒè¿½åŠ ã•ã‚Œã¾ã—ãŸã€‚  

**ğŸ“‹ 2025å¹´8æœˆ1æ—¥å®Ÿè£…çŠ¶æ³åæ˜ **: å„ã‚¯ãƒ©ã‚¹ã®å®Ÿè£…çŠ¶æ³ã‚’ç¾åœ¨ã®ã‚³ãƒ¼ãƒ‰ã¨ç…§åˆã—ã€Gmailé€£æºæ©Ÿèƒ½ã‚’ã€Œå®Ÿè£…äºˆå®šã€ã€å¤–è²¨æ›ç®—ã®ã‚«ãƒ¼ãƒ‰æ˜ç´°é€£æºã‚’ã€Œæœªå®Ÿè£…ï¼ˆAPIã®ã¿ï¼‰ã€ã€ã‚¢ãƒ€ãƒ—ã‚¿ãƒ¼ãƒ‘ã‚¿ãƒ¼ãƒ³åŸºåº•ã‚¯ãƒ©ã‚¹ã‚’ã€Œæœªå®Ÿè£…ã€ã¨ã—ã¦æ­£ç¢ºã«åæ˜ ã—ã¾ã—ãŸã€‚

### ğŸš¨ **é‡è¦ãªå®Ÿè£…çŠ¶æ³**
| **æ©Ÿèƒ½** | **è¨­è¨ˆæ›¸è¨˜è¼‰** | **å®Ÿéš›ã®å®Ÿè£…** | **çŠ¶æ³** |
|---------|-------------|-------------|----------|
| **Gmailé€£æºæ©Ÿèƒ½** | å®Œå…¨å®Ÿè£… | âŒ **GmailIntegrationServiceæœªå®Ÿè£…** | **å®Ÿè£…äºˆå®š** |
| **BaseInputAdapter** | å®Œå…¨å®Ÿè£… | âŒ **åŸºåº•ã‚¯ãƒ©ã‚¹æœªå®Ÿè£…** | **è¨­è¨ˆã®ã¿** |
| **å¤–è²¨æ›ç®—ã‚«ãƒ¼ãƒ‰æ˜ç´°** | ã‚«ãƒ¼ãƒ‰æ˜ç´°é€£æº | âš ï¸ **Exchange Rate APIã®ã¿** | **éƒ¨åˆ†å®Ÿè£…** |
| **ãã®ä»–40ã‚«ãƒ©ãƒ æ©Ÿèƒ½** | å®Œå…¨å®Ÿè£… | âœ… **å®Ÿè£…æ¸ˆã¿** | **å®Ÿè£…æ¸ˆã¿** |

## ğŸ“‘ ç›®æ¬¡

1. [å…¨ä½“ã‚¯ãƒ©ã‚¹æ§‹æˆ](#å…¨ä½“ã‚¯ãƒ©ã‚¹æ§‹æˆ)
2. [ãƒ—ãƒ¬ã‚¼ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³å±¤](#ãƒ—ãƒ¬ã‚¼ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³å±¤)
3. [ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯å±¤](#ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯å±¤)
4. [ã‚¤ãƒ³ãƒ•ãƒ©ã‚¹ãƒˆãƒ©ã‚¯ãƒãƒ£å±¤](#ã‚¤ãƒ³ãƒ•ãƒ©ã‚¹ãƒˆãƒ©ã‚¯ãƒãƒ£å±¤)
5. [ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«å±¤](#ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«å±¤)
6. [ç¶™æ‰¿ãƒ»å®Ÿè£…é–¢ä¿‚](#ç¶™æ‰¿å®Ÿè£…é–¢ä¿‚)
7. [ãƒ‡ã‚¶ã‚¤ãƒ³ãƒ‘ã‚¿ãƒ¼ãƒ³](#ãƒ‡ã‚¶ã‚¤ãƒ³ãƒ‘ã‚¿ãƒ¼ãƒ³)

---

## ğŸ—ï¸ å…¨ä½“ã‚¯ãƒ©ã‚¹æ§‹æˆ

### ã‚·ã‚¹ãƒ†ãƒ å…¨ä½“ã®ã‚¯ãƒ©ã‚¹é–¢ä¿‚å›³

```mermaid
classDiagram
    %% ãƒ—ãƒ¬ã‚¼ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³å±¤
    class StreamlitApp {
        +main()
        +initialize_session_state()
        +render_sidebar()
        +handle_navigation()
    }
    
    class InvoiceProcessingPage {
        +render_unified_invoice_processing_page()
        +render_production_upload_content()
        +render_ocr_test_content()
        +execute_unified_upload_processing()
        +execute_unified_ocr_test()
        %% â˜…v3.1 ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚° - Helperé–¢æ•°è¿½åŠ â˜…
        +_get_current_user_id() str
        +_create_progress_callback() callable
        +_initialize_processing_session() void
        +_get_unified_engine() UnifiedWorkflowEngine
        +_display_processing_info() void
        +_display_processing_success() void
    }
    
    class TestPages {
        +render_integrated_workflow_test_page()
        +execute_integrated_workflow()
        +render_workflow_progress()
        +render_workflow_result()
    }
    
    class SettingsPage {
        +render_dashboard_page()
        +render_invoice_aggrid()
    }
    
    %% ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯å±¤
    class UnifiedWorkflowEngine {
        -ai_service: GeminiAPIManager
        -storage_service: GoogleDriveManager
        -database_service: DatabaseManager
        -progress_callback: Callable
        -progress_history: List[WorkflowProgress]
        -prompt_manager: UnifiedPromptManager
        -prompt_selector: PromptSelector
        +__init__(ai_service, storage_service, database_service, progress_callback)
        +process_single_file(pdf_file_data, filename, user_id, mode) WorkflowResult
        +process_uploaded_files(uploaded_files, user_id, mode) Dict
        +process_batch_files(files_data, user_id, mode) Dict
        +process_ocr_test_from_drive(folder_id, user_id, max_files) Dict
        +_unified_file_upload(pdf_file_data, filename) Dict
        +_unified_ai_extraction(pdf_file_data, filename) Dict
        +_unified_data_validation(extracted_data, filename) Dict â˜…NEWâ˜…
        +_unified_database_save(file_info, validated_data, filename, user_id, mode) str
        +_notify_progress(status, step, progress_percent, message, details)
        +get_progress_history() List[WorkflowProgress]
        +reset_progress()
    }
    
    class UnifiedPromptManager {
        -prompts_dir: str
        -prompts_cache: Dict
        -default_prompts: Dict
        +__init__(prompts_dir)
        +get_prompt_by_key(key) Dict
        +format_prompt_for_gemini(prompt_key, variables) Tuple[str, str]
        +validate_prompt_compatibility(prompt_key, operation_type) Tuple[bool, List]
        +get_recommended_prompt(mode) str â˜…çµ±åˆâ˜…
        +get_prompt_compatibility_score(prompt_key, mode) float â˜…çµ±åˆâ˜…
        +_load_prompts()
        +_cache_prompt(key, content)
        +_evaluate_prompt_suitability(prompt_data, mode) float â˜…çµ±åˆâ˜…
    }
    
    class PromptSelector {
        -prompt_manager: UnifiedPromptManager
        +__init__(prompt_manager)
        +get_recommended_prompt(mode) str
        +get_prompt_compatibility_score(prompt_key, mode) float
        +_evaluate_prompt_suitability(prompt_data, mode) float
        %% NOTE: UnifiedPromptManagerã«çµ±åˆæ¸ˆã¿ï¼ˆå¾Œæ–¹äº’æ›æ€§ã®ãŸã‚ä¿æŒï¼‰
    }
    
    %% PromptSelectorçµ±åˆæ¸ˆã¿ - UnifiedPromptManagerã«çµ±åˆ
    
    class InvoiceValidator {
        +validate_invoice_data(invoice_data, strict_mode) Dict
        +calculate_completeness_score(invoice_data) float
        +_validate_required_fields(data) List[str]
        +_validate_amounts(data) List[str]
        +_normalize_currency_code(currency) str â˜…NEWâ˜…
        +_validate_dates(data) List[str]
        +_check_foreign_currency_tax(data) List[str] â˜…NEWâ˜…
        +_validate_data_types(data) List[str]
        +_validate_business_rules(data) List[str]
    }
    
    %% 40ã‚«ãƒ©ãƒ æ–°æ©Ÿèƒ½ã‚µãƒ¼ãƒ“ã‚¹å±¤ â˜…v3.0 NEWâ˜…
    class CurrencyConversionService {
        -exchange_api: ExchangeRateAPI
        -cache_ttl: int
        -rate_cache: Dict[str, Dict]
        +__init__(api_key, cache_ttl)
        +convert_to_jpy(amount, from_currency) Dict â˜…v3.0 NEWâ˜…
        +get_current_rate(from_currency, to_currency) float â˜…v3.0 NEWâ˜…
        +get_cached_rate(currency_pair) Optional[float] â˜…v3.0 NEWâ˜…
        +validate_currency_code(currency) bool â˜…v3.0 NEWâ˜…
        +_fetch_rate_from_api(from_currency, to_currency) float
        +_cache_rate(currency_pair, rate, timestamp) void
        +_is_cache_valid(currency_pair) bool
        %% âš ï¸ ã‚«ãƒ¼ãƒ‰æ˜ç´°é€£æºæœªå®Ÿè£…ï¼ˆExchange Rate APIã®ã¿ï¼‰
    }
    
    class ApprovalControlService {
        -approval_rules: Dict[str, ApprovalRule]
        -notification_service: NotificationAPI
        -approver_config: Dict
        +__init__(rules_config, notification_service)
        +evaluate_approval_requirement(invoice_data) Dict â˜…v3.0 NEWâ˜…
        +assign_approver(approval_level) str â˜…v3.0 NEWâ˜…
        +approve_invoice(invoice_id, approver_email, comment) bool â˜…v3.0 NEWâ˜…
        +reject_invoice(invoice_id, reject_reason, approver_email) bool â˜…v3.0 NEWâ˜…
        +send_approval_notification(approver_info, invoice_summary) bool â˜…v3.0 NEWâ˜…
        +_check_approval_rules(invoice_data) Dict
        +_determine_approval_level(amount, vendor, category) str
        +_update_approval_status(invoice_id, status, approver) bool
    }
    
    class FreeeIntegrationService {
        -freee_api: FreeeAPI
        -oauth_config: Dict
        -account_mapping: Dict[str, str]
        +__init__(oauth_config, account_mapping)
        +process_approved_invoice(invoice_data) Dict â˜…v3.0 NEWâ˜…
        +create_journal_entry(invoice_data) str â˜…v3.0 NEWâ˜…
        +map_expense_category(category) str â˜…v3.0 NEWâ˜…
        +generate_batch_id() str â˜…v3.0 NEWâ˜…
        +validate_freee_connection() bool â˜…v3.0 NEWâ˜…
        +_prepare_journal_data(invoice_data, account_mapping) Dict
        +_authenticate_freee_api() bool
        +_handle_freee_errors(error) None
    }
    
    %% ã‚¤ãƒ³ãƒ•ãƒ©ã‚¹ãƒˆãƒ©ã‚¯ãƒãƒ£å±¤
    class DatabaseManager {
        -client: SupabaseClient
        -connection_config: Dict
        +__init__(url, key)
        +insert_invoice(invoice_data) Dict
        +get_invoices(user_email) List[Dict]
        +check_tables_exist() Dict
        +get_sample_data() Dict
        +_execute_query(query, params) Any
        +_handle_rls_policy(user_email) bool
    }
    
    class GeminiAPIManager {
        -api_key: str
        -model_name: str
        -client: GenerativeAI
        +__init__(api_key, model_name)
        +analyze_pdf_content(pdf_data, prompt) Dict
        +generate_text(prompt) str
        +validate_api_connection() bool
        +_prepare_pdf_for_analysis(pdf_data) Any
        +_parse_json_response(response) Dict
    }
    
    class GoogleDriveManager {
        -service_account_info: Dict
        -default_folder_id: str
        -credentials: Credentials
        +__init__(service_account_info, default_folder_id)
        +upload_file(file_content, filename, folder_id, mime_type) Dict
        +download_file(file_id) bytes
        +list_files(folder_id, file_type) List[Dict]
        +get_file_info(file_id) Dict
        +_authenticate() Credentials
        +_handle_timeout(timeout_seconds) Any
    }
    
    class AgGridManager {
        +create_basic_grid(data, columns) Any
        +get_selected_rows(grid_response) List[Dict]
        +display_invoice_data(invoice_data) Any
        +_configure_grid_options() Dict
        +_setup_column_definitions(columns) List[Dict]
    }
    
    %% ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«å±¤
    class WorkflowResult {
        +success: bool
        +invoice_id: Optional[str]
        +extracted_data: Optional[Dict]
        +file_info: Optional[Dict]
        +error_message: Optional[str]
        +processing_time: float
        +progress_history: List[WorkflowProgress]
        +__init__(**kwargs)
        +to_dict() Dict
        +is_successful() bool
    }
    
    class WorkflowProgress {
        +status: WorkflowStatus
        +step: str
        +progress_percent: int
        +message: str
        +timestamp: datetime
        +details: Optional[Dict]
        +__init__(status, step, progress_percent, message, timestamp, details)
        +to_dict() Dict
        +format_timestamp() str
    }
    
    class WorkflowStatus {
        <<enumeration>>
        UPLOADING
        PROCESSING
        SAVING
        COMPLETED
        FAILED
    }
    
    %% é–¢ä¿‚æ€§
    StreamlitApp --> InvoiceProcessingPage
    StreamlitApp --> TestPages
    StreamlitApp --> SettingsPage
    
    InvoiceProcessingPage --> UnifiedWorkflowEngine
    TestPages --> UnifiedWorkflowEngine
    
    UnifiedWorkflowEngine --> DatabaseManager
    UnifiedWorkflowEngine --> GeminiAPIManager
    UnifiedWorkflowEngine --> GoogleDriveManager
    UnifiedWorkflowEngine --> UnifiedPromptManager
    UnifiedWorkflowEngine --> InvoiceValidator
    
    %% 40ã‚«ãƒ©ãƒ æ–°æ©Ÿèƒ½ã‚µãƒ¼ãƒ“ã‚¹é–¢ä¿‚ â˜…v3.0 NEWâ˜…
    UnifiedWorkflowEngine --> CurrencyConversionService
    UnifiedWorkflowEngine --> ApprovalControlService
    UnifiedWorkflowEngine --> FreeeIntegrationService
    
    %% Gmailé€£æºæ©Ÿèƒ½ âš ï¸ å®Ÿè£…äºˆå®šï¼ˆæœªå®Ÿè£…ï¼‰
    %% UnifiedWorkflowEngine -.-> GmailIntegrationService : å®Ÿè£…äºˆå®š
    
    UnifiedWorkflowEngine ..> WorkflowResult : creates
    UnifiedWorkflowEngine ..> WorkflowProgress : emits
    
    %% æ–°æ©Ÿèƒ½ã‚µãƒ¼ãƒ“ã‚¹é–“ã®é–¢ä¿‚ â˜…v3.0 NEWâ˜…
    CurrencyConversionService --> ExchangeRateAPI : uses
    ApprovalControlService --> NotificationAPI : uses
    FreeeIntegrationService --> FreeeAPI : uses
    
    %% â˜…v3.1 NEWâ˜… å®Ÿè£…äºˆå®šã‚¯ãƒ©ã‚¹ï¼ˆGmailé€£æºæ©Ÿèƒ½ï¼‰
    class GmailIntegrationService {
        <<å®Ÿè£…äºˆå®š>>
        -gmail_api: GmailAPI
        -oauth_config: Dict
        -attachment_cache: Dict
        +__init__(oauth_config) âš ï¸ å®Ÿè£…äºˆå®š
        +authenticate_gmail() bool âš ï¸ å®Ÿè£…äºˆå®š
        +fetch_attachments(message_id) List âš ï¸ å®Ÿè£…äºˆå®š
        +process_gmail_invoice(attachment_data) Dict âš ï¸ å®Ÿè£…äºˆå®š
        +sync_gmail_attachments() List âš ï¸ å®Ÿè£…äºˆå®š
        %% ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ã¿å®Ÿè£…æ¸ˆã¿
    }
    
    %% â˜…v3.1 NEWâ˜… å®Ÿè£…äºˆå®šã‚¯ãƒ©ã‚¹ï¼ˆã‚¢ãƒ€ãƒ—ã‚¿ãƒ¼ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼‰
    class BaseInputAdapter {
        <<å®Ÿè£…äºˆå®š>>
        <<abstract>>
        +get_files(config) List[FileData] âš ï¸ å®Ÿè£…äºˆå®š
        +validate_input(config) bool âš ï¸ å®Ÿè£…äºˆå®š
        +get_metadata(file_data) Dict âš ï¸ å®Ÿè£…äºˆå®š
    }
    
    class LocalFileAdapter {
        <<å®Ÿè£…äºˆå®š>>
        +get_files(config) List[FileData] âš ï¸ å®Ÿè£…äºˆå®š
        +validate_input(config) bool âš ï¸ å®Ÿè£…äºˆå®š
        +get_metadata(file_data) Dict âš ï¸ å®Ÿè£…äºˆå®š
    }
    
    class GoogleDriveAdapter {
        <<å®Ÿè£…äºˆå®š>>
        +get_files(config) List[FileData] âš ï¸ å®Ÿè£…äºˆå®š
        +validate_input(config) bool âš ï¸ å®Ÿè£…äºˆå®š
        +get_metadata(file_data) Dict âš ï¸ å®Ÿè£…äºˆå®š
    }
    
    %% å®Ÿè£…äºˆå®šé–¢ä¿‚
    BaseInputAdapter <|.. LocalFileAdapter
    BaseInputAdapter <|.. GoogleDriveAdapter
    
    %% PromptSelector --> UnifiedPromptManagerï¼ˆçµ±åˆã«ã‚ˆã‚Šå‰Šé™¤ï¼‰
    SettingsPage --> AgGridManager
    SettingsPage --> DatabaseManager
    
    WorkflowProgress --> WorkflowStatus
```

---

## ğŸ“± ãƒ—ãƒ¬ã‚¼ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³å±¤

### Streamlitã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³æ§‹æˆ

```mermaid
classDiagram
    class StreamlitApp {
        +session_state: Dict
        +config: Dict
        +main()
        +initialize_session_state()
        +setup_page_config()
        +render_sidebar()
        +handle_navigation()
        +load_css_styles()
    }
    
    class InvoiceProcessingPage {
        +render_unified_invoice_processing_page()
        +render_production_upload_content()
        +render_ocr_test_content()
        +execute_unified_upload_processing(uploaded_files, prompt_key, include_validation, save_to_db)
        +execute_unified_ocr_test(folder_id, prompt_key, max_files, test_mode, include_validation)
        +render_unified_upload_results(include_validation)
        +render_ocr_test_results(include_validation)
        +render_basic_ocr_results(results, include_validation)
    }
    
    class TestPages {
        +render_database_test_page()
        +render_gemini_test_page()
        +render_google_drive_test_page()
        +render_aggrid_test_page()
        +render_integrated_workflow_test_page()
        +execute_integrated_workflow(uploaded_file, user_id)
        +render_workflow_progress()
        +render_workflow_result()
        +render_workflow_explanation()
        +run_additional_db_tests()
        +run_pdf_analysis(uploaded_file)
        +run_drive_upload_test(uploaded_file, folder_id)
    }
    
    class SettingsPage {
        +render_dashboard_page()
        +render_invoice_aggrid(invoices_data)
        +handle_grid_selection(selected_rows)
        +handle_grid_edit(edited_data)
        +export_to_excel(data)
    }
    
    class Sidebar {
        +render_navigation_menu()
        +render_user_info()
        +render_system_status()
        +handle_menu_selection()
    }
    
    StreamlitApp --> InvoiceProcessingPage
    StreamlitApp --> TestPages
    StreamlitApp --> SettingsPage
    StreamlitApp --> Sidebar
```

### ãƒšãƒ¼ã‚¸ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆè©³ç´°

```mermaid
classDiagram
    class BasePageComponent {
        <<abstract>>
        #user_info: Dict
        #session_state: Dict
        +render() void
        +handle_user_input() void
        +display_error(message) void
        +display_success(message) void
        +get_current_user() Dict
    }
    
    class InvoiceProcessingPage {
        -workflow_engine: UnifiedWorkflowEngine
        -prompt_selector: PromptSelector
        +render_file_uploader() UploadedFile[]
        +validate_uploaded_files(files) bool
        +show_processing_progress(progress) void
        +display_batch_results(results) void
    }
    
    class TestPages {
        -test_managers: Dict[str, TestManager]
        +run_database_tests() Dict
        +run_api_tests() Dict
        +run_integration_tests() Dict
        +generate_test_report(results) str
    }
    
    class SettingsPage {
        -aggrid_manager: AgGridManager
        -database_manager: DatabaseManager
        +load_user_data() List[Dict]
        +apply_filters(filter_params) List[Dict]
        +handle_bulk_operations(operation, selected_rows) bool
    }
    
    BasePageComponent <|-- InvoiceProcessingPage
    BasePageComponent <|-- TestPages
    BasePageComponent <|-- SettingsPage
```

---

## ğŸ§  ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯å±¤

### çµ±ä¸€ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚¨ãƒ³ã‚¸ãƒ³è©³ç´°

```mermaid
classDiagram
    class UnifiedWorkflowEngine {
        -ai_service: GeminiAPIManager
        -storage_service: GoogleDriveManager
        -database_service: DatabaseManager
        -progress_callback: Optional[Callable]
        -prompt_manager: UnifiedPromptManager
        -prompt_selector: PromptSelector
        -progress_history: List[WorkflowProgress]
        
        +__init__(ai_service, storage_service, database_service, progress_callback)
        +process_single_file(pdf_file_data: bytes, filename: str, user_id: str, mode: str) WorkflowResult
        +process_batch_files(files_data: List[Dict], user_id: str, mode: str) Dict[str, Any]
        +_unified_file_upload(pdf_file_data: bytes, filename: str) Dict[str, Any]
        +_unified_ai_extraction(pdf_file_data: bytes, filename: str) Dict[str, Any]
        +_unified_database_save(file_info: Dict, extracted_data: Dict, filename: str, user_id: str, mode: str) str
        +_notify_progress(status: WorkflowStatus, step: str, progress_percent: int, message: str, details: Optional[Dict])
        +get_progress_history() List[WorkflowProgress]
        +reset_progress() void
    }
    
    class WorkflowExecutor {
        <<interface>>
        +execute(input_data) Any
        +validate_input(input_data) bool
        +handle_error(error) void
    }
    
    class BatchProcessor {
        -max_concurrent: int
        -timeout_seconds: int
        +process_concurrent(tasks: List[Task]) List[Result]
        +manage_concurrency(task_queue: Queue) void
        +handle_batch_errors(errors: List[Exception]) void
    }
    
    UnifiedWorkflowEngine --|> WorkflowExecutor
    UnifiedWorkflowEngine --> BatchProcessor
```

### ã‚µãƒ¼ãƒ“ã‚¹å±¤ã‚¯ãƒ©ã‚¹ç¾¤

```mermaid
classDiagram
    class UnifiedPromptManager {
        -prompts_dir: str
        -prompts_cache: Dict[str, Dict]
        -cache_ttl: int
        
        +__init__(prompts_dir: str)
        +get_prompt_by_key(key: str) Optional[Dict]
        +format_prompt_for_gemini(prompt_key: str, variables: Dict) Tuple[str, str]
        +validate_prompt_compatibility(prompt_key: str, operation_type: str) Tuple[bool, List[str]]
        +reload_prompts() void
        +_load_prompts() void
        +_cache_prompt(key: str, content: Dict) void
        +_is_cache_valid(key: str) bool
    }
    
    class PromptSelector {
        -prompt_manager: UnifiedPromptManager
        -default_mappings: Dict[str, str]
        -compatibility_matrix: Dict[str, Dict[str, float]]
        
        +__init__(prompt_manager: UnifiedPromptManager)
        +get_recommended_prompt(mode: str) Optional[str]
        +get_prompt_compatibility_score(prompt_key: str, mode: str) float
        +update_compatibility_matrix(learning_data: Dict) void
        +_evaluate_prompt_suitability(prompt_data: Dict, mode: str) float
        +_apply_machine_learning_recommendations(mode: str) str
    }
    
    class InvoiceValidator {
        -validation_rules: Dict[str, Callable]
        -strict_mode_rules: Dict[str, Callable]
        
        +validate_invoice_data(invoice_data: Dict, strict_mode: bool = False) Dict[str, Any]
        +calculate_completeness_score(invoice_data: Dict) float
        +add_custom_validation_rule(name: str, rule: Callable) void
        +_validate_required_fields(data: Dict) List[str]
        +_validate_data_types(data: Dict) List[str]
        +_validate_business_rules(data: Dict) List[str]
        +_validate_amount_consistency(data: Dict) List[str]
        +_validate_date_logic(data: Dict) List[str]
    }
    
    class WorkflowDisplayManager {
        -display_config: Dict
        
        +display_batch_results(results: Dict) void
        +display_single_result(result: WorkflowResult) void
        +format_progress_display(progress: WorkflowProgress) str
        +generate_summary_report(results: List[Dict]) str
        +_format_error_messages(errors: List[str]) str
        +_create_success_metrics(results: Dict) Dict
    }
    
    UnifiedPromptManager <-- PromptSelector
    InvoiceValidator ..> ValidationResult : creates
    WorkflowDisplayManager ..> DisplayResult : creates
```

---

## ğŸ”§ ã‚¤ãƒ³ãƒ•ãƒ©ã‚¹ãƒˆãƒ©ã‚¯ãƒãƒ£å±¤

### ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å±¤

```mermaid
classDiagram
    class DatabaseManager {
        -client: SupabaseClient
        -connection_config: Dict[str, str]
        -timeout_seconds: int
        -retry_config: RetryConfig
        
        +__init__(url: str, key: str)
        +insert_invoice(invoice_data: Dict) Dict[str, Any]
        +get_invoices(user_email: str) List[Dict]
        +update_invoice(invoice_id: int, updates: Dict) bool
        +delete_invoice(invoice_id: int) bool
        +check_tables_exist() Dict[str, bool]
        +get_sample_data() Dict[str, List]
        +execute_raw_query(query: str, params: Dict) Any
        +_execute_query(query: str, params: Dict) Any
        +_handle_rls_policy(user_email: str) bool
        +_retry_on_failure(operation: Callable, max_retries: int) Any
    }
    
    class ConnectionPool {
        -pool_size: int
        -connections: List[Connection]
        +get_connection() Connection
        +release_connection(conn: Connection) void
        +health_check() bool
    }
    
    class QueryBuilder {
        -table_name: str
        -conditions: List[str]
        +select(columns: List[str]) QueryBuilder
        +where(condition: str) QueryBuilder
        +order_by(column: str, direction: str) QueryBuilder
        +limit(count: int) QueryBuilder
        +build() str
    }
    
    DatabaseManager --> ConnectionPool
    DatabaseManager --> QueryBuilder
```

### AIå‡¦ç†å±¤

```mermaid
classDiagram
    class GeminiAPIManager {
        -api_key: str
        -model_name: str
        -client: GenerativeAI
        -request_timeout: int
        -max_retries: int
        
        +__init__(api_key: str, model_name: str = "Gemini API")
        +analyze_pdf_content(pdf_data: bytes, prompt: str) Dict[str, Any]
        +generate_text(prompt: str) str
        +validate_api_connection() bool
        +get_model_info() Dict[str, Any]
        +_prepare_pdf_for_analysis(pdf_data: bytes) Any
        +_parse_json_response(response: str) Dict[str, Any]
        +_handle_api_errors(error: Exception) None
        +_implement_rate_limiting() void
    }
    
    class AIResponseParser {
        +parse_invoice_data(response: str) Dict[str, Any]
        +extract_json_from_text(text: str) Dict[str, Any]
        +validate_response_structure(data: Dict) bool
        +_clean_response_text(text: str) str
        +_handle_malformed_json(text: str) Dict[str, Any]
    }
    
    class PromptBuilder {
        +build_invoice_extraction_prompt(context: Dict) str
        +build_ocr_test_prompt(test_config: Dict) str
        +add_context_variables(prompt: str, variables: Dict) str
        +_sanitize_input(text: str) str
    }
    
    GeminiAPIManager --> AIResponseParser
    GeminiAPIManager --> PromptBuilder
```

### ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸å±¤

```mermaid
classDiagram
    class GoogleDriveManager {
        -service_account_info: Dict[str, str]
        -default_folder_id: str
        -credentials: Credentials
        -timeout_seconds: int
        
        +__init__(service_account_info: Dict, default_folder_id: str)
        +upload_file(file_content: bytes, filename: str, folder_id: Optional[str], mime_type: str) Optional[Dict]
        +download_file(file_id: str) Optional[bytes]
        +list_files(folder_id: str, file_type: Optional[str]) List[Dict]
        +get_file_info(file_id: str) Optional[Dict]
        +delete_file(file_id: str) bool
        +create_folder(folder_name: str, parent_folder_id: Optional[str]) Optional[Dict]
        +_authenticate() Credentials
        +_handle_timeout(timeout_seconds: int) ContextManager
        +_retry_on_quota_exceeded(operation: Callable) Any
    }
    
    class FileValidator {
        +validate_file_type(file_content: bytes, expected_type: str) bool
        +validate_file_size(file_content: bytes, max_size_mb: int) bool
        +scan_for_malware(file_content: bytes) bool
        +_check_file_signature(file_content: bytes) str
    }
    
    class StorageQuotaManager {
        -quota_limits: Dict[str, int]
        +check_quota_usage() Dict[str, float]
        +predict_quota_exhaustion() Optional[datetime]
        +optimize_storage_usage() Dict[str, Any]
    }
    
    GoogleDriveManager --> FileValidator
    GoogleDriveManager --> StorageQuotaManager
```

### UIæ‹¡å¼µå±¤

```mermaid
classDiagram
    class AgGridManager {
        -grid_config: Dict[str, Any]
        -theme: str
        
        +create_basic_grid(data: List[Dict], columns: Optional[List[str]]) Any
        +get_selected_rows(grid_response: Any) List[Dict]
        +display_invoice_data(invoice_data: List[Dict]) Any
        +apply_filters(grid_response: Any, filters: Dict) Any
        +export_to_excel(data: List[Dict], filename: str) bytes
        +_configure_grid_options() Dict[str, Any]
        +_setup_column_definitions(columns: List[str]) List[Dict]
        +_apply_styling(grid_config: Dict) Dict
    }
    
    class ValidationDisplay {
        +display_validation_results(validation_data: Dict) void
        +show_error_summary(errors: List[str]) void
        +show_warning_summary(warnings: List[str]) void
        +display_completeness_score(score: float) void
        +_format_validation_message(message: str, level: str) str
    }
    
    class BatchValidationDisplay {
        +display_batch_summary(batch_results: Dict) void
        +display_file_results(file_results: List[Dict]) void
        +show_batch_statistics(stats: Dict) void
        +generate_batch_report(results: Dict) str
    }
    
    ValidationDisplay <|-- BatchValidationDisplay
```

### å¤–éƒ¨APIå±¤ï¼ˆ40ã‚«ãƒ©ãƒ æ–°æ©Ÿèƒ½å¯¾å¿œï¼‰ â˜…v3.0 NEWâ˜…

```mermaid
classDiagram
    class ExchangeRateAPI {
        -api_key: str
        -base_url: str
        -request_timeout: int
        
        +__init__(api_key: str, base_url: str)
        +get_current_rate(from_currency: str, to_currency: str) Dict â˜…v3.0 NEWâ˜…
        +get_historical_rates(date: str, currencies: List[str]) Dict â˜…v3.0 NEWâ˜…
        +get_supported_currencies() List[str] â˜…v3.0 NEWâ˜…
        +validate_currency_code(currency: str) bool â˜…v3.0 NEWâ˜…
        +_make_api_request(endpoint: str, params: Dict) Dict
        +_handle_rate_api_errors(error: Exception) None
        +_parse_rate_response(response: Dict) Dict
    }
    
    class NotificationAPI {
        -slack_webhook: str
        -teams_webhook: str
        -email_config: Dict
        
        +__init__(slack_webhook: str, teams_webhook: str, email_config: Dict)
        +send_slack_notification(message: str, channel: str) bool â˜…v3.0 NEWâ˜…
        +send_teams_notification(message: str, channel: str) bool â˜…v3.0 NEWâ˜…
        +send_email_notification(to: str, subject: str, body: str) bool â˜…v3.0 NEWâ˜…
        +send_approval_notification(approver_info: Dict, invoice_summary: Dict) bool â˜…v3.0 NEWâ˜…
        +send_rejection_notification(applicant_info: Dict, rejection_reason: str) bool â˜…v3.0 NEWâ˜…
        +_format_approval_message(invoice_summary: Dict) str
        +_format_rejection_message(rejection_reason: str) str
        +_handle_notification_errors(error: Exception) None
    }
    
    class FreeeAPI {
        -client_id: str
        -client_secret: str
        -oauth_token: str
        -base_url: str
        
        +__init__(client_id: str, client_secret: str)
        +authenticate_oauth() bool â˜…v3.0 NEWâ˜…
        +create_journal_entry(journal_data: Dict) Dict â˜…v3.0 NEWâ˜…
        +get_account_items() List[Dict] â˜…v3.0 NEWâ˜…
        +get_company_info() Dict â˜…v3.0 NEWâ˜…
        +validate_journal_data(journal_data: Dict) bool â˜…v3.0 NEWâ˜…
        +refresh_oauth_token() bool â˜…v3.0 NEWâ˜…
        +_make_authenticated_request(endpoint: str, method: str, data: Dict) Dict
        +_handle_freee_api_errors(error: Exception) None
        +_format_journal_entry(invoice_data: Dict, account_mapping: Dict) Dict
    }
    
    %% â˜…v3.1 NEWâ˜… å®Ÿè£…äºˆå®šã‚¯ãƒ©ã‚¹ï¼ˆGmail APIï¼‰
    class GmailAPI {
        <<å®Ÿè£…äºˆå®š>>
        -access_token: str
        -refresh_token: str
        -client_config: Dict
        
        +__init__(client_config) âš ï¸ å®Ÿè£…äºˆå®š
        +authenticate_oauth() bool âš ï¸ å®Ÿè£…äºˆå®š
        +list_messages(query) List[Dict] âš ï¸ å®Ÿè£…äºˆå®š
        +get_message(message_id) Dict âš ï¸ å®Ÿè£…äºˆå®š
        +get_attachments(message_id) List[Dict] âš ï¸ å®Ÿè£…äºˆå®š
        +download_attachment(attachment_id) bytes âš ï¸ å®Ÿè£…äºˆå®š
        +_make_authenticated_request(endpoint, method, data) Dict
        +_handle_gmail_api_errors(error) None
    }
    
    %% å¤–éƒ¨APIé–“ã®é–¢ä¿‚
    CurrencyConversionService --> ExchangeRateAPI : uses
    ApprovalControlService --> NotificationAPI : uses
    FreeeIntegrationService --> FreeeAPI : uses
    GmailIntegrationService -.-> GmailAPI : å®Ÿè£…äºˆå®š
```

---

## ğŸ“Š ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«å±¤

### ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãƒ¢ãƒ‡ãƒ«

```mermaid
classDiagram
    class WorkflowResult {
        +success: bool
        +invoice_id: Optional[str]
        +extracted_data: Optional[Dict[str, Any]]
        +file_info: Optional[Dict[str, Any]]
        +error_message: Optional[str]
        +processing_time: float
        +progress_history: List[WorkflowProgress]
        
        +__init__(**kwargs)
        +to_dict() Dict[str, Any]
        +is_successful() bool
        +get_error_details() Optional[Dict]
        +get_processing_summary() Dict[str, Any]
    }
    
    class WorkflowProgress {
        +status: WorkflowStatus
        +step: str
        +progress_percent: int
        +message: str
        +timestamp: datetime
        +details: Optional[Dict[str, Any]]
        
        +__init__(status: WorkflowStatus, step: str, progress_percent: int, message: str, timestamp: datetime, details: Optional[Dict])
        +to_dict() Dict[str, Any]
        +format_timestamp(format_str: str) str
        +is_error_state() bool
        +get_elapsed_time(start_time: datetime) float
    }
    
    class WorkflowStatus {
        <<enumeration>>
        UPLOADING = "uploading"
        PROCESSING = "processing"
        SAVING = "saving"
        COMPLETED = "completed"
        FAILED = "failed"
        
        +value: str
        +is_terminal_state() bool
        +get_next_valid_states() List[WorkflowStatus]
    }
    
    class ProcessingMode {
        <<enumeration>>
        UPLOAD = "upload"
        OCR_TEST = "ocr_test"
        BATCH = "batch"
        VALIDATION = "validation"
        SINGLE = "single"
        
        +value: str
        +get_default_config() Dict[str, Any]
        +is_test_mode() bool
    }
    
    WorkflowProgress --> WorkflowStatus
    WorkflowResult --> WorkflowProgress
```

### ãƒ“ã‚¸ãƒã‚¹ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£

```mermaid
classDiagram
    class Invoice {
        +id: Optional[int]
        +user_email: str
        +file_name: str
        +gdrive_file_id: Optional[str]
        +issuer_name: Optional[str]
        +recipient_name: Optional[str]
        +main_invoice_number: Optional[str]
        +total_amount_tax_included: Optional[Decimal]
        +extracted_data: Optional[Dict]
        +is_valid: bool
        +completeness_score: Optional[Decimal]
        +created_at: datetime
        
        +__init__(**kwargs)
        +to_dict() Dict[str, Any]
        +validate() Tuple[bool, List[str]]
        +calculate_completeness() float
        +update_extracted_data(data: Dict) void
    }
    
    class InvoiceLineItem {
        +id: Optional[int]
        +invoice_id: int
        +line_number: int
        +item_description: Optional[str]
        +quantity: Optional[Decimal]
        +unit_price: Optional[Decimal]
        +amount: Optional[Decimal]
        +tax_rate: Optional[Decimal]
        
        +__init__(**kwargs)
        +validate_amounts() bool
        +calculate_total() Decimal
        +to_dict() Dict[str, Any]
    }
    
    class User {
        +email: str
        +name: str
        +role: str
        
        +__init__(email: str, name: str, role: str = "user")
        +is_admin() bool
        +can_access_resource(resource: str) bool
        +to_dict() Dict[str, Any]
    }
    
    class OCRTestSession {
        +id: str
        +session_name: str
        +folder_id: str
        +total_files: int
        +success_files: int
        +success_rate: Decimal
        +created_by: str
        +created_at: datetime
        
        +__init__(**kwargs)
        +calculate_success_rate() Decimal
        +is_completed() bool
        +get_summary() Dict[str, Any]
    }
    
    %% 40ã‚«ãƒ©ãƒ æ–°æ©Ÿèƒ½ãƒ¢ãƒ‡ãƒ« â˜…v3.0 NEWâ˜…
    class CurrencyConversion {
        +id: Optional[int]
        +invoice_id: int
        +from_currency: str
        +to_currency: str
        +exchange_rate: Decimal
        +original_amount: Decimal
        +converted_amount: Decimal
        +conversion_date: datetime
        +rate_source: str
        +card_statement_id: Optional[int] %% âš ï¸ å¸¸ã«Nullï¼ˆã‚«ãƒ¼ãƒ‰æ˜ç´°é€£æºæœªå®Ÿè£…ï¼‰
        
        +__init__(**kwargs) â˜…v3.0 NEWâ˜…
        +calculate_converted_amount() Decimal â˜…v3.0 NEWâ˜…
        +validate_rate() bool â˜…v3.0 NEWâ˜…
        +to_dict() Dict[str, Any] â˜…v3.0 NEWâ˜…
        %% âš ï¸ ã‚«ãƒ¼ãƒ‰æ˜ç´°ãƒãƒƒãƒãƒ³ã‚°æ©Ÿèƒ½æœªå®Ÿè£…
    }
    
    class ApprovalWorkflow {
        +id: Optional[int]
        +invoice_id: int
        +approval_status: str
        +required_approval_level: str
        +current_approver: Optional[str]
        +approved_by: Optional[str]
        +approved_at: Optional[datetime]
        +rejection_reason: Optional[str]
        +approval_history: List[Dict]
        
        +__init__(**kwargs) â˜…v3.0 NEWâ˜…
        +can_approve(user_role: str) bool â˜…v3.0 NEWâ˜…
        +approve(approver_email: str, comment: str) bool â˜…v3.0 NEWâ˜…
        +reject(approver_email: str, reason: str) bool â˜…v3.0 NEWâ˜…
        +get_approval_status() str â˜…v3.0 NEWâ˜…
        +add_approval_step(step_info: Dict) void â˜…v3.0 NEWâ˜…
    }
    
    class FreeeIntegration {
        +id: Optional[int]
        +invoice_id: int
        +freee_transaction_id: Optional[str]
        +journal_number: Optional[str]
        +account_mapping: Dict
        +integration_status: str
        +exported_at: Optional[datetime]
        +freee_batch_id: str
        +error_message: Optional[str]
        
        +__init__(**kwargs) â˜…v3.0 NEWâ˜…
        +mark_as_exported(transaction_id: str, journal_number: str) void â˜…v3.0 NEWâ˜…
        +mark_as_failed(error_message: str) void â˜…v3.0 NEWâ˜…
        +retry_integration() bool â˜…v3.0 NEWâ˜…
        +get_integration_status() str â˜…v3.0 NEWâ˜…
        +to_dict() Dict[str, Any] â˜…v3.0 NEWâ˜…
    }
    
    %% æ—¢å­˜ã®é–¢ä¿‚æ€§
    Invoice --> InvoiceLineItem : contains
    User --> Invoice : creates
    User --> OCRTestSession : executes
    
    %% â˜…v3.1 NEWâ˜… å®Ÿè£…äºˆå®šãƒ¢ãƒ‡ãƒ«ï¼ˆGmailé€£æºç”¨ï¼‰
    class GmailIntegration {
        <<å®Ÿè£…äºˆå®š>>
        +id: Optional[int]
        +invoice_id: int
        +gmail_message_id: Optional[str] âœ… ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å®Ÿè£…æ¸ˆã¿
        +attachment_id: Optional[str] âœ… ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å®Ÿè£…æ¸ˆã¿
        +sender_email: Optional[str] âœ… ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å®Ÿè£…æ¸ˆã¿
        +subject: Optional[str] âš ï¸ å®Ÿè£…äºˆå®š
        +received_at: Optional[datetime] âš ï¸ å®Ÿè£…äºˆå®š
        +processing_status: str âš ï¸ å®Ÿè£…äºˆå®š
        
        +__init__(**kwargs) âš ï¸ å®Ÿè£…äºˆå®š
        +mark_as_processed() void âš ï¸ å®Ÿè£…äºˆå®š
        +get_gmail_metadata() Dict âš ï¸ å®Ÿè£…äºˆå®š
        +to_dict() Dict[str, Any] âš ï¸ å®Ÿè£…äºˆå®š
        %% ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ã¿å®Ÿè£…æ¸ˆã¿ãƒ»æ©Ÿèƒ½ã¯æœªå®Ÿè£…
    }
    
    %% 40ã‚«ãƒ©ãƒ æ–°æ©Ÿèƒ½ãƒ¢ãƒ‡ãƒ«é–¢ä¿‚ â˜…v3.0 NEWâ˜…
    Invoice --> CurrencyConversion : has
    Invoice --> ApprovalWorkflow : has
    Invoice --> FreeeIntegration : has
    Invoice -.-> GmailIntegration : å®Ÿè£…äºˆå®š
```

---

## ğŸ”— ç¶™æ‰¿ãƒ»å®Ÿè£…é–¢ä¿‚

### ã‚µãƒ¼ãƒ“ã‚¹ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹

```mermaid
classDiagram
    class APIService {
        <<interface>>
        +connect() bool
        +disconnect() void
        +health_check() bool
        +handle_error(error: Exception) void
    }
    
    class StorageService {
        <<interface>>
        +upload(content: bytes, metadata: Dict) str
        +download(resource_id: str) bytes
        +delete(resource_id: str) bool
        +list_resources(criteria: Dict) List[Dict]
    }
    
    class AIService {
        <<interface>>
        +analyze(content: bytes, prompt: str) Dict
        +validate_connection() bool
        +get_model_info() Dict
    }
    
    class DatabaseService {
        <<interface>>
        +create(entity: Dict) str
        +read(entity_id: str) Dict
        +update(entity_id: str, updates: Dict) bool
        +delete(entity_id: str) bool
        +query(criteria: Dict) List[Dict]
    }
    
    %% å®Ÿè£…ã‚¯ãƒ©ã‚¹
    class GeminiAPIManager {
        +connect() bool
        +disconnect() void
        +health_check() bool
        +handle_error(error: Exception) void
        +analyze(content: bytes, prompt: str) Dict
        +validate_connection() bool
        +get_model_info() Dict
    }
    
    class GoogleDriveManager {
        +connect() bool
        +disconnect() void
        +health_check() bool
        +handle_error(error: Exception) void
        +upload(content: bytes, metadata: Dict) str
        +download(resource_id: str) bytes
        +delete(resource_id: str) bool
        +list_resources(criteria: Dict) List[Dict]
    }
    
    class DatabaseManager {
        +connect() bool
        +disconnect() void
        +health_check() bool
        +handle_error(error: Exception) void
        +create(entity: Dict) str
        +read(entity_id: str) Dict
        +update(entity_id: str, updates: Dict) bool
        +delete(entity_id: str) bool
        +query(criteria: Dict) List[Dict]
    }
    
    APIService <|.. GeminiAPIManager
    APIService <|.. GoogleDriveManager
    APIService <|.. DatabaseManager
    
    AIService <|.. GeminiAPIManager
    StorageService <|.. GoogleDriveManager
    DatabaseService <|.. DatabaseManager
```

### ä¾‹å¤–éšå±¤

```mermaid
classDiagram
    class WorkflowException {
        <<abstract>>
        +message: str
        +error_code: str
        +context: Dict
        +__init__(message: str, error_code: str, context: Dict)
        +to_dict() Dict
        +get_user_friendly_message() str
    }
    
    class FileUploadException {
        +file_name: str
        +file_size: int
        +__init__(message: str, file_name: str, file_size: int)
    }
    
    class AIProcessingException {
        +model_name: str
        +api_response: Optional[str]
        +__init__(message: str, model_name: str, api_response: Optional[str])
    }
    
    class DatabaseException {
        +table_name: str
        +operation: str
        +__init__(message: str, table_name: str, operation: str)
    }
    
    class ValidationException {
        +field_errors: List[str]
        +business_rule_violations: List[str]
        +__init__(message: str, field_errors: List[str], business_rule_violations: List[str])
    }
    
    WorkflowException <|-- FileUploadException
    WorkflowException <|-- AIProcessingException
    WorkflowException <|-- DatabaseException
    WorkflowException <|-- ValidationException
```

---

## ğŸ¨ ãƒ‡ã‚¶ã‚¤ãƒ³ãƒ‘ã‚¿ãƒ¼ãƒ³

### Factoryãƒ‘ã‚¿ãƒ¼ãƒ³

```mermaid
classDiagram
    class ServiceFactory {
        <<abstract>>
        +create_service(service_type: str, config: Dict) APIService
        +get_available_services() List[str]
    }
    
    class APIServiceFactory {
        -service_registry: Dict[str, Type]
        +create_service(service_type: str, config: Dict) APIService
        +register_service(name: str, service_class: Type) void
        +get_available_services() List[str]
    }
    
    class WorkflowEngineFactory {
        +create_engine(engine_type: str, services: Dict) WorkflowEngine
        +create_unified_engine(ai_service: AIService, storage_service: StorageService, db_service: DatabaseService) UnifiedWorkflowEngine
    }
    
    ServiceFactory <|-- APIServiceFactory
    APIServiceFactory --> GeminiAPIManager : creates
    APIServiceFactory --> GoogleDriveManager : creates
    APIServiceFactory --> DatabaseManager : creates
    WorkflowEngineFactory --> UnifiedWorkflowEngine : creates
```

### Observerãƒ‘ã‚¿ãƒ¼ãƒ³

```mermaid
classDiagram
    class ProgressObserver {
        <<interface>>
        +update(progress: WorkflowProgress) void
    }
    
    class ProgressSubject {
        -observers: List[ProgressObserver]
        +attach(observer: ProgressObserver) void
        +detach(observer: ProgressObserver) void
        +notify(progress: WorkflowProgress) void
    }
    
    class UIProgressObserver {
        -ui_component: Any
        +update(progress: WorkflowProgress) void
        +_update_progress_bar(percent: int) void
        +_show_status_message(message: str) void
    }
    
    class LoggingProgressObserver {
        -logger: Logger
        +update(progress: WorkflowProgress) void
        +_log_progress_event(progress: WorkflowProgress) void
    }
    
    class MetricsProgressObserver {
        -metrics_collector: MetricsCollector
        +update(progress: WorkflowProgress) void
        +_record_performance_metrics(progress: WorkflowProgress) void
    }
    
    ProgressObserver <|.. UIProgressObserver
    ProgressObserver <|.. LoggingProgressObserver
    ProgressObserver <|.. MetricsProgressObserver
    
    ProgressSubject --> ProgressObserver
    UnifiedWorkflowEngine --|> ProgressSubject
```

### Strategyãƒ‘ã‚¿ãƒ¼ãƒ³

```mermaid
classDiagram
    class ValidationStrategy {
        <<interface>>
        +validate(data: Dict) ValidationResult
        +get_strategy_name() str
    }
    
    class StrictValidationStrategy {
        +validate(data: Dict) ValidationResult
        +get_strategy_name() str
        +_validate_all_required_fields(data: Dict) List[str]
        +_validate_business_rules(data: Dict) List[str]
    }
    
    class LenientValidationStrategy {
        +validate(data: Dict) ValidationResult
        +get_strategy_name() str
        +_validate_critical_fields_only(data: Dict) List[str]
    }
    
    class OCRTestValidationStrategy {
        +validate(data: Dict) ValidationResult
        +get_strategy_name() str
        +_calculate_ocr_accuracy_score(data: Dict) float
        +_identify_ocr_specific_errors(data: Dict) List[str]
    }
    
    class ValidationContext {
        -strategy: ValidationStrategy
        +set_strategy(strategy: ValidationStrategy) void
        +execute_validation(data: Dict) ValidationResult
    }
    
    ValidationStrategy <|.. StrictValidationStrategy
    ValidationStrategy <|.. LenientValidationStrategy
    ValidationStrategy <|.. OCRTestValidationStrategy
    ValidationContext --> ValidationStrategy
    InvoiceValidator --> ValidationContext
```

### Builderãƒ‘ã‚¿ãƒ¼ãƒ³

```mermaid
classDiagram
    class WorkflowBuilder {
        <<interface>>
        +set_ai_service(service: AIService) WorkflowBuilder
        +set_storage_service(service: StorageService) WorkflowBuilder
        +set_database_service(service: DatabaseService) WorkflowBuilder
        +set_progress_callback(callback: Callable) WorkflowBuilder
        +build() UnifiedWorkflowEngine
    }
    
    class UnifiedWorkflowEngineBuilder {
        -ai_service: Optional[AIService]
        -storage_service: Optional[StorageService]
        -database_service: Optional[DatabaseService]
        -progress_callback: Optional[Callable]
        -validation_config: Dict
        
        +set_ai_service(service: AIService) UnifiedWorkflowEngineBuilder
        +set_storage_service(service: StorageService) UnifiedWorkflowEngineBuilder
        +set_database_service(service: DatabaseService) UnifiedWorkflowEngineBuilder
        +set_progress_callback(callback: Callable) UnifiedWorkflowEngineBuilder
        +set_validation_config(config: Dict) UnifiedWorkflowEngineBuilder
        +build() UnifiedWorkflowEngine
        +_validate_required_services() void
    }
    
    class WorkflowDirector {
        +construct_production_workflow() UnifiedWorkflowEngine
        +construct_test_workflow() UnifiedWorkflowEngine
        +construct_ocr_test_workflow() UnifiedWorkflowEngine
    }
    
    WorkflowBuilder <|.. UnifiedWorkflowEngineBuilder
    WorkflowDirector --> UnifiedWorkflowEngineBuilder
    UnifiedWorkflowEngineBuilder --> UnifiedWorkflowEngine : creates
```

---

## ğŸ”§ ä¾å­˜æ€§æ³¨å…¥

### DIã‚³ãƒ³ãƒ†ãƒŠæ§‹æˆ

```mermaid
classDiagram
    class DIContainer {
        -services: Dict[str, Any]
        -singletons: Dict[str, Any]
        -factories: Dict[str, Callable]
        
        +register_singleton(name: str, instance: Any) void
        +register_factory(name: str, factory: Callable) void
        +resolve(service_name: str) Any
        +_create_instance(service_name: str) Any
        +_inject_dependencies(instance: Any) void
    }
    
    class ServiceRegistry {
        -container: DIContainer
        
        +setup_services() void
        +get_unified_workflow_engine() UnifiedWorkflowEngine
        +get_database_manager() DatabaseManager
        +get_gemini_api_manager() GeminiAPIManager
        +get_google_drive_manager() GoogleDriveManager
        +_register_core_services() void
        +_register_business_services() void
        +_register_infrastructure_services() void
    }
    
    DIContainer <-- ServiceRegistry
```

---

**æœ€çµ‚æ›´æ–°**: 2025å¹´8æœˆ1æ—¥ - å®Ÿè£…çŠ¶æ³æ­£ç¢ºåæ˜ ãƒ»Gmailé€£æºæ©Ÿèƒ½çŠ¶æ³ä¿®æ­£  
**æ‰¿èªè€…**: ã‚·ã‚¹ãƒ†ãƒ è¨­è¨ˆè€…ãƒ»é–‹ç™ºãƒãƒ¼ãƒ   
**ãƒ¬ãƒ“ãƒ¥ãƒ¼äºˆå®š**: 2025å¹´9æœˆ1æ—¥  
**v3.1é‡è¦æˆæœ**: å®Ÿè£…çŠ¶æ³ã®æ­£ç¢ºåæ˜ ãƒ»Gmailé€£æºæ©Ÿèƒ½å®Ÿè£…äºˆå®šæ˜è¨˜ãƒ»å¤–è²¨æ›ç®—ã‚«ãƒ¼ãƒ‰æ˜ç´°é€£æºæœªå®Ÿè£…çŠ¶æ³åæ˜   
**v3.0é‡è¦æˆæœ**: å¤–è²¨æ›ç®—ãƒ»æ‰¿èªãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãƒ»freeeé€£æºã‚¯ãƒ©ã‚¹å®Œå…¨è¿½åŠ 

## ğŸš¨ **å®Ÿè£…çŠ¶æ³ã‚µãƒãƒªãƒ¼ï¼ˆ2025å¹´8æœˆ1æ—¥æ™‚ç‚¹ï¼‰**

### âœ… **å®Ÿè£…æ¸ˆã¿æ©Ÿèƒ½**
- **UnifiedWorkflowEngine**: çµ±ä¸€ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚¨ãƒ³ã‚¸ãƒ³å®Œå…¨å®Ÿè£…
- **40ã‚«ãƒ©ãƒ æ©Ÿèƒ½**: CurrencyConversionService, ApprovalControlService, FreeeIntegrationServiceå®Œå…¨å®Ÿè£…
- **ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°**: helperé–¢æ•°çµ±åˆã«ã‚ˆã‚‹ã‚³ãƒ¼ãƒ‰å“è³ªå‘ä¸Š

### âš ï¸ **éƒ¨åˆ†å®Ÿè£…æ©Ÿèƒ½**
- **å¤–è²¨æ›ç®—æ©Ÿèƒ½**: Exchange Rate APIå®Ÿè£…æ¸ˆã¿ã€ã‚«ãƒ¼ãƒ‰æ˜ç´°é€£æºæœªå®Ÿè£…ï¼ˆISS-009èª²é¡Œï¼‰

### âŒ **å®Ÿè£…äºˆå®šæ©Ÿèƒ½**
- **Gmailé€£æºæ©Ÿèƒ½**: GmailIntegrationServiceæœªå®Ÿè£…ï¼ˆãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ã¿æº–å‚™å®Œäº†ï¼‰
- **ã‚¢ãƒ€ãƒ—ã‚¿ãƒ¼ãƒ‘ã‚¿ãƒ¼ãƒ³**: BaseInputAdapteråŸºåº•ã‚¯ãƒ©ã‚¹æœªå®Ÿè£…ï¼ˆENH-004èª²é¡Œï¼‰

### ğŸ“‹ **æ¬¡æœŸé–‹ç™ºäºˆå®š**
1. **æœ€é«˜å„ªå…ˆåº¦**: å¤–è²¨æ›ç®—ã‚«ãƒ¼ãƒ‰æ˜ç´°é€£æºå®Ÿè£…ï¼ˆISS-009ï¼‰
2. **é«˜å„ªå…ˆåº¦**: Gmailé€£æºæ©Ÿèƒ½å®Œå…¨å®Ÿè£…
3. **ä¸­å„ªå…ˆåº¦**: ã‚¢ãƒ€ãƒ—ã‚¿ãƒ¼ãƒ‘ã‚¿ãƒ¼ãƒ³åŸºåº•ã‚¯ãƒ©ã‚¹å®Ÿè£…ï¼ˆENH-004ï¼‰

**é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ**:

### ğŸ“š çµ±åˆè¨­è¨ˆæ›¸
- [15_ã‚·ã‚¹ãƒ†ãƒ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£è¨­è¨ˆæ›¸.md](15_ã‚·ã‚¹ãƒ†ãƒ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£è¨­è¨ˆæ›¸.md) - ã‚·ã‚¹ãƒ†ãƒ å…¨ä½“è¨­è¨ˆï¼ˆçµ±åˆç‰ˆï¼‰
- [16_ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆæ›¸.md](16_ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆæ›¸.md) - ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆï¼ˆçµ±åˆç‰ˆï¼‰

### ğŸ—ï¸ è©³ç´°è¨­è¨ˆæ›¸ï¼ˆç‹¬ç«‹ç‰ˆï¼‰
- [17_ã‚·ã‚¹ãƒ†ãƒ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£UMLå›³.md](17_ã‚·ã‚¹ãƒ†ãƒ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£UMLå›³.md) - ã‚·ã‚¹ãƒ†ãƒ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£å›³é›†
- [18_ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ERå›³.md](18_ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ERå›³.md) - ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ERå›³ãƒ»é–¢ä¿‚æ€§
- [19_ãƒ†ãƒ¼ãƒ–ãƒ«è¨­è¨ˆè©³ç´°ä»•æ§˜æ›¸.md](19_ãƒ†ãƒ¼ãƒ–ãƒ«è¨­è¨ˆè©³ç´°ä»•æ§˜æ›¸.md) - ãƒ†ãƒ¼ãƒ–ãƒ«ä»•æ§˜ãƒ»åˆ¶ç´„ãƒ»ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
- [20_ã‚·ãƒ¼ã‚±ãƒ³ã‚¹å›³é›†.md](20_ã‚·ãƒ¼ã‚±ãƒ³ã‚¹å›³é›†.md) - å‡¦ç†ãƒ•ãƒ­ãƒ¼ãƒ»æ­£å¸¸ç³»ãƒ»ç•°å¸¸ç³»

### ğŸ“‹ ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆç®¡ç†
- [00_DOCS_INDEX.md](00_DOCS_INDEX.md) - å…¨ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆä¸€è¦§ãƒ»é–¢é€£æ€§ 