# 画面設計書

**バージョン:** 2.0  
**最終更新:** 2025年7月27日 - 🎉 **統一スキーマ完全再構築対応・プレビュー機能拡張**  
**作成日:** 2025/01/23  

## 1. 概要

### 1.1 設計思想
- **統一ワークフロー**: テストと本番で同一処理エンジンを使用
- **タブ統合UI**: 関連機能を同一画面でモード切り替え
- **レスポンシブ対応**: デスクトップ・タブレット対応
- **アクセシビリティ**: 直感的操作とエラーガイダンス
- **🎉 統一スキーマ設計**: 本番・OCRテーブル完全統一による一貫したデータ表示 **NEW**
- **🎉 プレビュー機能設計**: タブ分割詳細表示によるデータ検証効率化 **NEW**
- **🎉 根本修正設計**: `main_invoice_number`エラー完全解決による安定稼働 **NEW**

### 1.2 技術スタック
- **フロントエンド**: Streamlit
- **UI コンポーネント**: ag-Grid, Streamlit標準コンポーネント
- **認証**: Google OAuth 2.0
- **レスポンシブ**: Streamlit column system
- **🎉 プレビュー機能**: Streamlit tabs, ag-Grid拡張, JSON表示, PDF表示 **NEW**
- **🎉 統一スキーマ**: `main_invoice_number`, `t_number`, `receipt_number`, `key_info`対応 **NEW**
- **🎉 データ検証**: 統一フィールド検証, 明細表示, 詳細プレビュー **NEW**

## 2. 画面構成

### 2.1 メニュー構成（更新版）
```
📋 メインメニュー
├── 📤 請求書処理 ★統合ページ
│   ├── 🚀 本番アップロード（タブ）
│   └── 🔍 OCRテスト（タブ）
├── 📊 処理状況ダッシュボード
├── ⚙️ メール設定
├── 🔧 DB接続テスト
├── 🤖 Gemini APIテスト
├── ☁️ Google Drive APIテスト
├── 📊 ag-grid データグリッドテスト
└── 🔄 統合ワークフローテスト
```

### 2.2 統合請求書処理ページ（新設計）

#### 2.2.1 レイアウト構造
```
┌─────────────────────────────────────┐
│ 📤 請求書処理                       │
│ 本番アップロードとOCRテストを統一ワー│
│ クフローで処理します                 │
├─────────────────────────────────────┤
│ [🚀 本番アップロード] [🔍 OCRテスト]   │
├─────────────────────────────────────┤
│ ◆ アクティブタブ内容                 │
│   - プロンプト自動選択               │
│   - 処理設定                        │
│   - ファイル入力                    │
│   - 実行ボタン                      │
│   - 結果表示                        │
└─────────────────────────────────────┘
```

#### 2.2.2 本番アップロードタブ
```
✅ 自動選択されたプロンプト: Expert Invoice Data Extractor
📝 本番処理に最適なプロンプトが自動選択されます
✅ 互換性OK

### 📁 ファイルアップロード
[PDF選択エリア - 複数ファイル対応]

### ⚙️ 処理設定
┌─────────────┬─────────────┐
│☑️ 詳細検証実行│☑️ 自動保存   │
│統一検証システム│処理完了後に自動│
│による詳細分析  │的にDB保存    │
└─────────────┴─────────────┘

### 🚀 処理実行
[📊 本番処理開始 (X件)] [全幅ボタン]

### 📊 処理結果
- 進行状況表示
- 処理結果サマリー
- **🎉 詳細プレビュー（タブ分割）**: 基本情報・明細・JSON・PDF **NEW**
- 統一フィールド表示: `main_invoice_number`, `t_number`, `receipt_number`, `key_info`
```

#### 2.2.3 OCRテストタブ
```
✅ 自動選択されたプロンプト: Expert Invoice Data Extractor
📝 OCRテストに最適なプロンプトが自動選択されます
✅ 互換性OK

### 🔧 テスト設定
┌─────────┬─────────┬─────────┐
│テストモード│対象ファイル数│詳細検証  │
│[精度重視▼]│[5件▼]    │☑️実行   │
└─────────┴─────────┴─────────┘

### 📁 テスト対象フォルダ
Google DriveフォルダID: [入力フィールド]

### 🚀 テスト実行
[🚀 統一OCRテスト開始 (5件)] [🔄 リセット]

### 📊 テスト結果
- バッチ処理結果
- 精度分析
- **🎉 詳細プレビュー（タブ分割）**: 基本情報・明細・JSON・PDF **NEW**
- 統一フィールド検証: `main_invoice_number`, `t_number`, `receipt_number`, `key_info`
- エラー詳細
```

## 3. アーキテクチャ分離設計

### 3.1 3層アーキテクチャ
```
┌─────────────────────────────────────┐
│ プレゼンテーション層（UI）            │
│ - Streamlit コンポーネント           │
│ - タブ制御・状態管理                │
│ - ユーザーインタラクション            │
├─────────────────────────────────────┤
│ ビジネスロジック層（処理エンジン）     │
│ - 統合ワークフロー                  │
│ - アダプターパターン                │
│ - 検証・変換ロジック                │
├─────────────────────────────────────┤
│ データアクセス層（永続化）            │
│ - Supabase接続                     │
│ - クエリ実行                       │
│ - トランザクション管理              │
└─────────────────────────────────────┘
```

### 3.2 責務分離
- **UI層**: 表示・入力受付のみ
- **処理層**: ビジネスロジック・データ変換
- **DB層**: データ永続化・検索

## 4. 統合による改善効果

### 4.1 保守性向上
- ✅ **コード重複削除**: プロンプト選択・UI部品統合
- ✅ **統一エラーハンドリング**: 同一処理フローでバグ減少
- ✅ **一元管理**: 設定・状態管理の統合

### 4.2 ユーザビリティ向上
- ✅ **直感的操作**: タブ切り替えで簡単モード変更
- ✅ **機能発見性**: 関連機能が同一画面
- ✅ **一貫したUX**: 統一されたインターフェース

### 4.3 拡張性確保
- ✅ **アダプターパターン**: Google Drive・Gmail対応準備完了
- ✅ **モジュラー設計**: 新機能追加が容易
- ✅ **設定共有**: 新しい入力ソース対応が簡単

## 5. 今後の拡張計画

### 5.1 入力ソース拡張
```
📤 請求書処理（最終形）
├── 🚀 本番アップロード
│   ├── 📁 ローカルファイル
│   ├── ☁️ Google Drive
│   └── 📧 Gmail添付ファイル
└── 🔍 OCRテスト
    ├── 📁 ローカルファイル
    ├── ☁️ Google Drive
    └── 📧 Gmail添付ファイル
```

### 5.2 処理モード拡張
- **バッチ処理**: 大量ファイル一括処理
- **リアルタイム**: ストリーミング処理対応
- **スケジュール**: 定期実行機能

## 6. テスト観点

### 6.1 アーキテクチャ分離テスト
- **データベース層**: 独立性・トランザクション確認
- **ビジネスロジック層**: UI非依存での動作確認
- **UI層**: 処理層モック使用での表示確認

### 6.2 統合テスト
- **タブ切り替え**: 状態保持・設定引き継ぎ
- **エラーハンドリング**: 各層でのエラー伝播
- **パフォーマンス**: 統合による性能影響

---

## 7. 🎉 プレビュー機能詳細画面設計（2025年7月27日追加） ★NEW★

### 7.1 プレビュー機能概要
統一スキーマ完全再構築に伴い、請求書処理結果の詳細確認機能を大幅に拡張しました。

#### 7.1.1 設計原則
- **タブ分割表示**: 情報の種類別に整理して可読性向上
- **統一フィールド対応**: `main_invoice_number`, `t_number`, `receipt_number`, `key_info`完全対応
- **データ検証効率化**: 抽出結果の正確性を迅速に確認可能
- **レスポンシブ設計**: デスクトップ・タブレットで最適表示

### 7.2 プレビュー機能画面構成

#### 7.2.1 全体レイアウト
```
┌─────────────────────────────────────────────────────────────┐
│ 📊 処理結果詳細プレビュー                                    │
│ ファイル名: invoice_sample.pdf                              │
├─────────────────────────────────────────────────────────────┤
│ [📋 基本情報] [📊 明細] [🔍 JSON] [📄 PDF]                   │
├─────────────────────────────────────────────────────────────┤
│ ◆ アクティブタブ内容エリア                                   │
│                                                           │
│   （選択されたタブの詳細内容を表示）                        │
│                                                           │
└─────────────────────────────────────────────────────────────┘
```

### 7.3 📋 基本情報タブ 詳細設計

#### 7.3.1 レイアウト
```
┌─────────────────────────────────────────────────────────────┐
│ 📋 基本情報                                                 │
├─────────────────────────────────────────────────────────────┤
│ ┌─────────────────────┬─────────────────────────────────────┐ │
│ │ 📝 請求書情報        │ 💰 金額情報                         │ │
│ │                    │                                   │ │
│ │ • 請求元:           │ • 税込合計:                        │ │
│ │   株式会社○○        │   ¥108,000                       │ │
│ │ • 請求先:           │ • 税抜合計:                        │ │
│ │   △△商事           │   ¥100,000                       │ │
│ │ • 請求書番号:        │ • 消費税:                          │ │
│ │   INV-2025-001     │   ¥8,000                         │ │
│ │ • 受領書番号:        │ • 通貨:                           │ │
│ │   REC-2025-001     │   JPY                            │ │
│ │ • T番号:            │                                   │ │
│ │   T1234567890123   │                                   │ │
│ └─────────────────────┴─────────────────────────────────────┘ │
│ ┌─────────────────────┬─────────────────────────────────────┐ │
│ │ 📅 日付情報          │ 🔧 処理情報                         │ │
│ │                    │                                   │ │
│ │ • 発行日:           │ • 処理日時:                        │ │
│ │   2025-07-27       │   2025-07-27 14:30:45           │ │
│ │ • 支払期日:          │ • 処理時間:                        │ │
│ │   2025-08-31       │   2.3秒                          │ │
│ │                    │ • 信頼度:                          │ │
│ │                    │   95.6%                          │ │
│ └─────────────────────┴─────────────────────────────────────┘ │
│ ┌─────────────────────────────────────────────────────────────┐ │
│ │ 🔑 キー情報 (key_info)                                     │ │
│ │                                                           │ │
│ │ • 支払期限: 月末締翌月末支払い                              │ │
│ │ • 取引条件: 銀行振込                                       │ │
│ │ • 備考: 請求書の詳細確認済み                                │ │
│ └─────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
```

#### 7.3.2 統一フィールド表示仕様
```python
# 基本情報タブで表示される統一フィールド
unified_fields = {
    "main_invoice_number": "メイン請求書番号",  # 統一済み
    "receipt_number": "受領書番号",           # 新規追加
    "t_number": "適格請求書発行事業者登録番号", # 統一済み
    "key_info": "キー情報（JSONB）",          # 新規追加
    "issuer_name": "請求元企業名",
    "recipient_name": "請求先企業名",
    "total_amount_tax_included": "税込合計金額",
    "total_amount_tax_excluded": "税抜合計金額",
    "issue_date": "発行日",
    "due_date": "支払期日",
    "currency": "通貨"
}
```

### 7.4 📊 明細タブ 詳細設計

#### 7.4.1 ag-Grid拡張レイアウト
```
┌─────────────────────────────────────────────────────────────┐
│ 📊 請求明細                                                 │
├─────────────────────────────────────────────────────────────┤
│ 📋 明細一覧 (3件)                         [📤 エクスポート]   │
├─────────────────────────────────────────────────────────────┤
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ No │ 商品・サービス名          │ 数量 │ 単価   │ 税率 │ 合計  │ │
│ │────┼─────────────────────────┼─────┼───────┼─────┼──────│ │
│ │ 1  │ ウェブサイト制作費         │ 1    │100,000│ 10%  │110,000│ │
│ │ 2  │ 月次保守費                │ 1    │ 20,000│ 10%  │ 22,000│ │
│ │ 3  │ ドメイン更新費             │ 1    │  3,000│ 10%  │  3,300│ │
│ │────┴─────────────────────────┴─────┴───────┴─────┴──────│ │
│ │                                    合計:            135,300│ │
│ └─────────────────────────────────────────────────────────┘ │
├─────────────────────────────────────────────────────────────┤
│ 🔍 明細詳細 (選択行: 1)                                     │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ • 商品・サービス名: ウェブサイト制作費                    │ │
│ │ • 詳細説明: レスポンシブデザイン対応                     │ │
│ │ • 数量: 1.00                                           │ │
│ │ • 単価: ¥100,000                                      │ │
│ │ • 税率: 10.00%                                        │ │
│ │ • 小計（税抜）: ¥100,000                               │ │
│ │ • 消費税: ¥10,000                                     │ │
│ │ • 小計（税込）: ¥110,000                               │ │
│ └─────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
```

#### 7.4.2 統一明細フィールド仕様
```python
# 明細タブで表示される統一フィールド
line_item_unified_fields = {
    "item_description": "商品・サービス名",  # 統一済み (旧: description)
    "quantity": "数量",
    "unit_price": "単価",
    "tax_rate": "税率（DECIMAL）",          # 統一済み (VARCHAR → DECIMAL)
    "subtotal_excluding_tax": "小計（税抜）",
    "tax_amount": "消費税額",
    "subtotal_including_tax": "小計（税込）"
}
```

### 7.5 🔍 JSONタブ 詳細設計

#### 7.5.1 JSON詳細表示レイアウト
```
┌─────────────────────────────────────────────────────────────┐
│ 🔍 JSON詳細データ                                           │
├─────────────────────────────────────────────────────────────┤
│ [📋 抽出データ] [🤖 AIレスポンス] [🔑 キー情報]               │
├─────────────────────────────────────────────────────────────┤
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ 📋 抽出データ (extracted_data)                           │ │
│ │ {                                                      │ │
│ │   "main_invoice_number": "INV-2025-001",               │ │
│ │   "receipt_number": "REC-2025-001",                    │ │
│ │   "t_number": "T1234567890123",                        │ │
│ │   "issuer": "株式会社○○",                               │ │
│ │   "payer": "△△商事",                                   │ │
│ │   "issue_date": "2025-07-27",                          │ │
│ │   "due_date": "2025-08-31",                            │ │
│ │   "amount_inclusive_tax": 135300,                      │ │
│ │   "amount_exclusive_tax": 123000,                      │ │
│ │   "currency": "JPY",                                   │ │
│ │   "key_info": {                                        │ │
│ │     "payment_terms": "月末締翌月末支払い",                │ │
│ │     "payment_method": "銀行振込",                       │ │
│ │     "notes": "請求書の詳細確認済み"                      │ │
│ │   },                                                   │ │
│ │   "line_items": [                                      │ │
│ │     {                                                  │ │
│ │       "item_description": "ウェブサイト制作費",          │ │
│ │       "quantity": 1.0,                                 │ │
│ │       "unit_price": 100000,                            │ │
│ │       "tax_rate": 10.00                                │ │
│ │     }                                                  │ │
│ │   ]                                                    │ │
│ │ }                                                      │ │
│ └─────────────────────────────────────────────────────────┘ │
├─────────────────────────────────────────────────────────────┤
│ [📤 JSONダウンロード] [📋 クリップボードコピー]              │
└─────────────────────────────────────────────────────────────┘
```

#### 7.5.2 AIレスポンスタブ
```
┌─────────────────────────────────────────────────────────────┐
│ 🤖 AI生レスポンス (raw_response)                             │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ {                                                      │ │
│ │   "model": "gemini-1.5-flash",                         │ │
│ │   "response_time": 2.3,                                │ │
│ │   "confidence_score": 95.6,                            │ │
│ │   "processing_metadata": {                             │ │
│ │     "prompt_used": "Expert Invoice Data Extractor",    │ │
│ │     "extraction_method": "unified_schema",             │ │
│ │     "validation_passed": true                          │ │
│ │   },                                                   │ │
│ │   "raw_ai_output": "{ ... AI出力の完全なJSONデータ ... }" │ │
│ │ }                                                      │ │
│ └─────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
```

### 7.6 📄 PDFタブ 詳細設計

#### 7.6.1 PDFプレビューレイアウト
```
┌─────────────────────────────────────────────────────────────┐
│ 📄 PDF プレビュー                                           │
├─────────────────────────────────────────────────────────────┤
│ 📄 invoice_sample.pdf                  [📤 ダウンロード]     │
├─────────────────────────────────────────────────────────────┤
│ ┌─────────────────────────────────────────────────────────┐ │
│ │                                                        │ │
│ │                  PDF表示エリア                          │ │
│ │                                                        │ │
│ │     ┌─────────────────────────────────┐                 │ │
│ │     │                                │                 │ │
│ │     │        PDF内容表示              │                 │ │
│ │     │    （埋め込みPDFビューア）       │                 │ │
│ │     │                                │                 │ │
│ │     │                                │                 │ │
│ │     └─────────────────────────────────┘                 │ │
│ │                                                        │ │
│ │                                                        │ │
│ └─────────────────────────────────────────────────────────┘ │
├─────────────────────────────────────────────────────────────┤
│ 📊 ファイル情報                                             │
│ • ファイル名: invoice_sample.pdf                           │
│ • ファイルサイズ: 245 KB                                   │
│ • ページ数: 1                                             │
│ • アップロード日時: 2025-07-27 14:30:45                   │
│ • Google Drive ID: 1a2b3c4d5e6f7g8h9i0j                   │
└─────────────────────────────────────────────────────────────┘
```

#### 7.6.2 PDF表示技術仕様
```python
# PDF表示の技術実装
pdf_display_config = {
    "viewer_type": "streamlit_pdf_viewer",  # Streamlit PDF表示
    "embedding_support": True,              # 埋め込み表示
    "download_support": True,               # ダウンロード機能
    "zoom_control": True,                   # ズーム機能
    "page_navigation": True,                # ページ送り
    "mobile_responsive": True               # モバイル対応
}
```

### 7.7 プレビュー機能の統一スキーマ対応

#### 7.7.1 統一フィールド表示マッピング
```python
# プレビュー機能での統一フィールド表示
preview_field_mapping = {
    # 基本情報タブ
    "main_invoice_number": "請求書番号",        # 統一済み
    "receipt_number": "受領書番号",             # 新規追加
    "t_number": "T番号",                      # 統一済み
    "key_info": "キー情報",                   # 新規追加
    
    # 明細タブ
    "item_description": "商品・サービス名",      # 統一済み
    "tax_rate": "税率（DECIMAL形式）",         # 統一済み
    
    # JSON/PDF共通
    "updated_at": "更新日時",                 # 統一済み
    "extracted_data": "AI抽出データ",
    "raw_response": "AI生レスポンス"
}
```

#### 7.7.2 データ検証機能
```python
# プレビュー機能での統一スキーマ検証
validation_checks = {
    "field_presence": "必須フィールド存在確認",
    "data_type_validation": "データ型検証（DECIMAL等）",
    "field_name_consistency": "統一フィールド名確認",
    "cross_table_consistency": "本番・OCRテーブル整合性確認"
}
```

### 7.8 🎯 統一プレビュー機能 Streamlitコンポーネント仕様（毎回ブレない実装） ★NEW★

#### 7.8.1 プレビュー機能呼び出し統一関数
```python
def render_enhanced_result_tabs(result: Dict[str, Any], filename: str):
    """
    統一プレビュー機能のメイン関数
    【毎回この関数を呼び出すことで一貫したプレビュー表示を実現】
    
    Args:
        result: 処理結果データ（extracted_data, raw_response等を含む）
        filename: 処理対象ファイル名
        
    Returns:
        なし（Streamlitコンポーネントとして直接表示）
    """
    tab1, tab2, tab3, tab4 = st.tabs(["📋 基本情報", "📊 明細", "🔍 JSON", "📄 PDF"])
    
    extracted_data = result.get('extracted_data', {})
    
    with tab1:
        render_basic_info_enhanced(extracted_data)
    
    with tab2:
        render_line_items_enhanced(extracted_data)
    
    with tab3:
        render_json_preview_enhanced(result, extracted_data)
    
    with tab4:
        render_pdf_preview_enhanced(result, filename)
```

#### 7.8.2 基本情報タブ実装仕様
```python
def render_basic_info_enhanced(extracted_data: Dict[str, Any]):
    """
    基本情報タブの統一表示関数
    【統一スキーマ対応・レイアウト固定】
    """
    col1, col2 = st.columns(2)
    
    with col1:
        st.markdown("**📝 請求書情報**")
        # 統一フィールド使用（ブレない表示）
        st.write(f"• 請求元: {extracted_data.get('issuer', 'N/A')}")
        st.write(f"• 請求先: {extracted_data.get('payer', 'N/A')}")
        st.write(f"• 請求書番号: {extracted_data.get('main_invoice_number', 'N/A')}")  # 統一済み
        st.write(f"• 受領書番号: {extracted_data.get('receipt_number', 'N/A')}")      # 統一済み
        st.write(f"• T番号: {extracted_data.get('t_number', 'N/A')}")                # 統一済み
    
    with col2:
        st.markdown("**💰 金額情報**")
        # 統一フィールド・データ型使用
        st.write(f"• 税込合計: ¥{extracted_data.get('amount_inclusive_tax', 0):,}")
        st.write(f"• 税抜合計: ¥{extracted_data.get('amount_exclusive_tax', 0):,}")
        st.write(f"• 通貨: {extracted_data.get('currency', 'JPY')}")
    
    # 日付情報
    st.markdown("**📅 日付情報**")
    col3, col4 = st.columns(2)
    with col3:
        st.write(f"• 発行日: {extracted_data.get('issue_date', 'N/A')}")
    with col4:
        st.write(f"• 支払期日: {extracted_data.get('due_date', 'N/A')}")
    
    # キー情報（統一スキーマ新機能）
    if key_info := extracted_data.get('key_info'):
        st.markdown("**🔑 キー情報**")
        if isinstance(key_info, dict):
            for key, value in key_info.items():
                st.write(f"• {key}: {value}")
        else:
            st.write(f"• キー情報: {key_info}")
```

#### 7.8.3 明細タブag-Grid実装仕様
```python
def render_line_items_enhanced(extracted_data: Dict[str, Any]):
    """
    明細タブの統一ag-Grid表示関数
    【統一スキーマ対応・固定カラム定義】
    """
    line_items = extracted_data.get('line_items', [])
    
    if not line_items:
        st.info("📊 明細データがありません")
        return
    
    st.markdown(f"**📊 請求明細** ({len(line_items)}件)")
    
    # 統一スキーマ対応のag-Grid設定（毎回固定）
    column_defs = [
        {"headerName": "No", "field": "no", "width": 60, "type": "numericColumn"},
        {"headerName": "商品・サービス名", "field": "item_description", "width": 200},  # 統一済み
        {"headerName": "数量", "field": "quantity", "width": 80, "type": "numericColumn"},
        {"headerName": "単価", "field": "unit_price", "width": 100, "type": "numericColumn", 
         "valueFormatter": "value ? '¥' + value.toLocaleString() : ''"},
        {"headerName": "税率", "field": "tax_rate", "width": 80, "type": "numericColumn",
         "valueFormatter": "value ? value + '%' : ''"},  # DECIMAL対応
        {"headerName": "合計", "field": "total", "width": 120, "type": "numericColumn",
         "valueFormatter": "value ? '¥' + value.toLocaleString() : ''"}
    ]
    
    # データ変換（統一フィールド使用）
    grid_data = []
    for i, item in enumerate(line_items, 1):
        # 統一フィールド名を使用（ブレない実装）
        description = item.get("item_description", item.get("description", ""))  # 下位互換
        quantity = float(item.get("quantity", 0))
        unit_price = float(item.get("unit_price", 0))
        tax_rate = float(item.get("tax_rate", 0))  # DECIMAL対応
        total = quantity * unit_price * (1 + tax_rate / 100)
        
        grid_data.append({
            "no": i,
            "item_description": description,
            "quantity": quantity,
            "unit_price": unit_price,
            "tax_rate": tax_rate,
            "total": total
        })
    
    # ag-Grid表示（毎回同じ設定）
    AgGrid(
        grid_data,
        columns=column_defs,
        height=300,
        fit_columns_on_grid_load=True,
        enable_enterprise_modules=False,
        selection_mode="single"
    )
```

#### 7.8.4 JSONタブ実装仕様
```python
def render_json_preview_enhanced(result: Dict[str, Any], extracted_data: Dict[str, Any]):
    """
    JSONタブの統一表示関数
    【タブ分割・ダウンロード機能付き】
    """
    sub_tab1, sub_tab2, sub_tab3 = st.tabs(["📋 抽出データ", "🤖 AIレスポンス", "🔑 キー情報"])
    
    with sub_tab1:
        st.markdown("**📋 抽出データ (extracted_data)**")
        # JSON整形表示（毎回同じ形式）
        json_str = json.dumps(extracted_data, ensure_ascii=False, indent=2)
        st.code(json_str, language="json")
        
        # ダウンロード機能（毎回提供）
        st.download_button(
            label="📤 抽出データダウンロード",
            data=json_str,
            file_name=f"extracted_data_{datetime.now().strftime('%Y%m%d_%H%M%S')}.json",
            mime="application/json"
        )
    
    with sub_tab2:
        st.markdown("**🤖 AI生レスポンス (raw_response)**")
        raw_response = result.get('raw_response', {})
        json_str = json.dumps(raw_response, ensure_ascii=False, indent=2)
        st.code(json_str, language="json")
        
        # ダウンロード機能
        st.download_button(
            label="📤 AIレスポンスダウンロード", 
            data=json_str,
            file_name=f"raw_response_{datetime.now().strftime('%Y%m%d_%H%M%S')}.json",
            mime="application/json"
        )
    
    with sub_tab3:
        st.markdown("**🔑 キー情報詳細**")
        key_info = extracted_data.get('key_info', {})
        if key_info:
            json_str = json.dumps(key_info, ensure_ascii=False, indent=2)
            st.code(json_str, language="json")
        else:
            st.info("キー情報が存在しません")
```

#### 7.8.5 PDFタブ実装仕様
```python
def render_pdf_preview_enhanced(result: Dict[str, Any], filename: str):
    """
    PDFタブの統一表示関数
    【PDF表示・ダウンロード・ファイル情報】
    """
    st.markdown(f"**📄 PDF プレビュー**")
    st.markdown(f"📄 {filename}")
    
    # PDF表示（Streamlit標準機能使用）
    if pdf_data := result.get('pdf_data'):
        # PDF表示エリア
        st.markdown("**PDF内容:**")
        try:
            # base64データの場合はデコード
            if isinstance(pdf_data, str):
                pdf_bytes = base64.b64decode(pdf_data)
            else:
                pdf_bytes = pdf_data
                
            # PDF表示（毎回同じ実装）
            st.write("PDF内容を表示中...")
            # 注：実際のPDF表示はStreamlitの制限により制限的
            
            # ダウンロード機能（毎回提供）
            st.download_button(
                label="📤 PDFダウンロード",
                data=pdf_bytes,
                file_name=filename,
                mime="application/pdf"
            )
            
        except Exception as e:
            st.error(f"PDF表示エラー: {str(e)}")
    
    # ファイル情報（毎回表示）
    st.markdown("**📊 ファイル情報**")
    file_info = result.get('file_info', {})
    col1, col2 = st.columns(2)
    
    with col1:
        st.write(f"• ファイル名: {filename}")
        st.write(f"• ファイルサイズ: {file_info.get('size', 'N/A')}")
    
    with col2:
        st.write(f"• アップロード日時: {file_info.get('upload_time', 'N/A')}")
        if gdrive_id := file_info.get('gdrive_file_id'):
            st.write(f"• Google Drive ID: {gdrive_id}")
```

### 7.9 🎯 統一プレビュー機能使用ガイドライン（開発チーム向け） ★NEW★

#### 7.9.1 必須使用方法
```python
# 【必須】本番アップロード・OCRテスト共通で使用
def render_upload_results(results: List[Dict], mode: str):
    """どの画面でも必ずこの形式で呼び出し"""
    for i, result in enumerate(results):
        filename = result.get('filename', f'file_{i+1}')
        
        # 統一プレビュー機能呼び出し（毎回必須）
        render_enhanced_result_tabs(result, filename)
        
        # 区切り線（複数ファイル時）
        if i < len(results) - 1:
            st.divider()
```

#### 7.9.2 データ形式要件
```python
# 【必須】result辞書の統一形式
required_result_format = {
    "extracted_data": {
        # 統一フィールド（必須）
        "main_invoice_number": "INV-2025-001",
        "receipt_number": "REC-2025-001", 
        "t_number": "T1234567890123",
        "key_info": {},
        
        # 明細（統一フィールド）
        "line_items": [
            {
                "item_description": "商品名",  # 統一済み
                "tax_rate": 10.00            # DECIMAL形式
            }
        ]
    },
    "raw_response": {},      # AI生レスポンス
    "filename": "file.pdf",  # ファイル名
    "file_info": {},         # ファイル情報
    "pdf_data": b"..."       # PDFバイナリ（任意）
}
```

#### 7.9.3 開発時の注意事項
1. **必ず`render_enhanced_result_tabs()`を使用** - 独自実装禁止
2. **統一フィールド名を厳守** - `main_invoice_number`, `t_number`, `receipt_number`, `key_info`
3. **レイアウトの改変禁止** - タブ構成・カラム構成は固定
4. **下位互換性維持** - 旧フィールド名（`description`等）もサポート
5. **エラーハンドリング統一** - 各タブで共通のエラー表示方式

---

## 改訂履歴
- 2025-01-23: 統合UI設計（タブ方式）反映
- 2025-01-23: アーキテクチャ分離設計追加
- **2025-07-27: 🎉 統一スキーマ完全再構築対応・プレビュー機能拡張詳細設計追加** **NEW**