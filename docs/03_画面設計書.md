# 画面設計書

## 1. 概要

### 1.1 設計思想
- **統一ワークフロー**: テストと本番で同一処理エンジンを使用
- **タブ統合UI**: 関連機能を同一画面でモード切り替え
- **レスポンシブ対応**: デスクトップ・タブレット対応
- **アクセシビリティ**: 直感的操作とエラーガイダンス

### 1.2 技術スタック
- **フロントエンド**: Streamlit
- **UI コンポーネント**: ag-Grid, Streamlit標準コンポーネント
- **認証**: Google OAuth 2.0
- **レスポンシブ**: Streamlit column system

## 2. 画面構成

### 2.1 メニュー構成（更新版）
```
📋 メインメニュー
├── 📤 請求書処理 ★統合ページ
│   ├── 🚀 本番アップロード（タブ）
│   └── 🔍 OCRテスト（タブ）
├── 📊 処理状況ダッシュボード
├── ⚙️ メール設定
├── 🔧 DB接続テスト
├── 🤖 Gemini APIテスト
├── ☁️ Google Drive APIテスト
├── 📊 ag-grid データグリッドテスト
└── 🔄 統合ワークフローテスト
```

### 2.2 統合請求書処理ページ（新設計）

#### 2.2.1 レイアウト構造
```
┌─────────────────────────────────────┐
│ 📤 請求書処理                       │
│ 本番アップロードとOCRテストを統一ワー│
│ クフローで処理します                 │
├─────────────────────────────────────┤
│ [🚀 本番アップロード] [🔍 OCRテスト]   │
├─────────────────────────────────────┤
│ ◆ アクティブタブ内容                 │
│   - プロンプト自動選択               │
│   - 処理設定                        │
│   - ファイル入力                    │
│   - 実行ボタン                      │
│   - 結果表示                        │
└─────────────────────────────────────┘
```

#### 2.2.2 本番アップロードタブ
```
✅ 自動選択されたプロンプト: Expert Invoice Data Extractor
📝 本番処理に最適なプロンプトが自動選択されます
✅ 互換性OK

### 📁 ファイルアップロード
[PDF選択エリア - 複数ファイル対応]

### ⚙️ 処理設定
┌─────────────┬─────────────┐
│☑️ 詳細検証実行│☑️ 自動保存   │
│統一検証システム│処理完了後に自動│
│による詳細分析  │的にDB保存    │
└─────────────┴─────────────┘

### 🚀 処理実行
[📊 本番処理開始 (X件)] [全幅ボタン]

### 📊 処理結果
- 進行状況表示
- 処理結果サマリー
- 詳細結果（展開式）
```

#### 2.2.3 OCRテストタブ
```
✅ 自動選択されたプロンプト: Expert Invoice Data Extractor
📝 OCRテストに最適なプロンプトが自動選択されます
✅ 互換性OK

### 🔧 テスト設定
┌─────────┬─────────┬─────────┐
│テストモード│対象ファイル数│詳細検証  │
│[精度重視▼]│[5件▼]    │☑️実行   │
└─────────┴─────────┴─────────┘

### 📁 テスト対象フォルダ
Google DriveフォルダID: [入力フィールド]

### 🚀 テスト実行
[🚀 統一OCRテスト開始 (5件)] [🔄 リセット]

### 📊 テスト結果
- バッチ処理結果
- 精度分析
- エラー詳細
```

## 3. アーキテクチャ分離設計

### 3.1 3層アーキテクチャ
```
┌─────────────────────────────────────┐
│ プレゼンテーション層（UI）            │
│ - Streamlit コンポーネント           │
│ - タブ制御・状態管理                │
│ - ユーザーインタラクション            │
├─────────────────────────────────────┤
│ ビジネスロジック層（処理エンジン）     │
│ - 統合ワークフロー                  │
│ - アダプターパターン                │
│ - 検証・変換ロジック                │
├─────────────────────────────────────┤
│ データアクセス層（永続化）            │
│ - Supabase接続                     │
│ - クエリ実行                       │
│ - トランザクション管理              │
└─────────────────────────────────────┘
```

### 3.2 責務分離
- **UI層**: 表示・入力受付のみ
- **処理層**: ビジネスロジック・データ変換
- **DB層**: データ永続化・検索

## 4. 統合による改善効果

### 4.1 保守性向上
- ✅ **コード重複削除**: プロンプト選択・UI部品統合
- ✅ **統一エラーハンドリング**: 同一処理フローでバグ減少
- ✅ **一元管理**: 設定・状態管理の統合

### 4.2 ユーザビリティ向上
- ✅ **直感的操作**: タブ切り替えで簡単モード変更
- ✅ **機能発見性**: 関連機能が同一画面
- ✅ **一貫したUX**: 統一されたインターフェース

### 4.3 拡張性確保
- ✅ **アダプターパターン**: Google Drive・Gmail対応準備完了
- ✅ **モジュラー設計**: 新機能追加が容易
- ✅ **設定共有**: 新しい入力ソース対応が簡単

## 5. 今後の拡張計画

### 5.1 入力ソース拡張
```
📤 請求書処理（最終形）
├── 🚀 本番アップロード
│   ├── 📁 ローカルファイル
│   ├── ☁️ Google Drive
│   └── 📧 Gmail添付ファイル
└── 🔍 OCRテスト
    ├── 📁 ローカルファイル
    ├── ☁️ Google Drive
    └── 📧 Gmail添付ファイル
```

### 5.2 処理モード拡張
- **バッチ処理**: 大量ファイル一括処理
- **リアルタイム**: ストリーミング処理対応
- **スケジュール**: 定期実行機能

## 6. テスト観点

### 6.1 アーキテクチャ分離テスト
- **データベース層**: 独立性・トランザクション確認
- **ビジネスロジック層**: UI非依存での動作確認
- **UI層**: 処理層モック使用での表示確認

### 6.2 統合テスト
- **タブ切り替え**: 状態保持・設定引き継ぎ
- **エラーハンドリング**: 各層でのエラー伝播
- **パフォーマンス**: 統合による性能影響

---

## 改訂履歴
- 2025-01-23: 統合UI設計（タブ方式）反映
- 2025-01-23: アーキテクチャ分離設計追加