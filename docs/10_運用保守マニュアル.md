# 運用・保守マニュアル

**バージョン:** 1.0
**作成日:** 2025/07/17

## 1. 概要
本マニュアルは、請求書処理自動化システムの管理者および運用担当者が、システムを安定して運用し、基本的なトラブルシューティングを行うための手順を定義する。

## 2. システム構成要素
* **フロントエンド/バックエンド:** Google Cloud Run上のStreamlitアプリケーション
* **データベース:** Supabase (PostgreSQL)
* **ファイルストレージ:** Google Drive
* **ソースコード管理:** GitHub

## 3. 定期的な運用タスク

### 3.1. 毎日
* **ログの確認:**
    * **目的:** システムでエラーが発生していないか、予期せぬ動作がないかを確認する。
    * **手順:**
        1.  Streamlitアプリに管理者としてログインする。
        2.  サイドバーから「[管理] システムログ閲覧」を選択する。
        3.  ログレベル「ERROR」でフィルタし、エラーが発生していないか確認する。
        4.  エラーがある場合は、セクション4のトラブルシューティングに従って対応する。

### 3.2. 毎週
* **支払マスタのレビュー:**
    * **目的:** ユーザーから申請された新しい支払マスタを承認し、マスタデータを最新の状態に保つ。
    * **手順:**
        1.  「[管理] 支払マスタ管理」画面を開く。
        2.  `承認ステータス`が「承認待ち」のレコードを確認する。
        3.  内容に問題がなければ、「承認」ボタンをクリックして有効化する。

### 3.3. 毎月
* **コストの確認:**
    * **目的:** 各クラウドサービスの利用料が想定内に収まっているかを確認する。
    * **手順:**
        1.  Google Cloud Platformの請求ダッシュボードを確認する。
        2.  Supabaseの請求ダッシュボードを確認する。
        3.  利用量が急増している場合は、原因を調査する。
* **データベースのバックアップ確認:**
    * **目的:** データベースの自動バックアップが正常に行われていることを確認する。
    * **手順:** Supabaseの管理画面にログインし、バックアップ履歴を確認する。

## 4. トラブルシューティング

| 問題 | 考えられる原因 | 対処法 |
| :--- | :--- | :--- |
| **AIが情報を正しく抽出しない** | ・請求書のフォーマットが特殊で、AIが対応できていない。<br>・プロンプトの指示が不十分。 | 1. `invoice_prompt.yaml`を修正し、AIへの指示をより具体的にする。<br>2. 修正したプロンプトをシステムに反映させる（デプロイ）。 |
| **支払マスタの照合精度が低い** | ・支払マスタに登録されている企業名の表記揺れが考慮されていない。<br>・「追加条件」が正しく設定されていない。 | 1. 支払マスタの企業名や「追加条件」の記述を見直す。<br>2. 必要であれば、`master_matcher_prompt.yaml`を修正し、AIの判断基準を調整する。 |
| **アプリケーションにアクセスできない** | ・Google Cloud Runのサービスが停止している。<br>・デプロイに失敗している。 | 1. Google Cloud Runのコンソールで、サービスの稼働状況を確認する。<br>2. GitHub Actionsの実行履歴を確認し、デプロイが成功しているかチェックする。 |
| **ログインできない（streamlit-oauth）** | ・OAuth認証の設定が正しくない。<br>・GCPのOAuthクライアント設定が間違っている。<br>・リダイレクトURIが正しく設定されていない。<br>・streamlit-oauthライブラリの問題。 | 1. GCPコンソールでOAuth 2.0クライアントの設定を確認する。<br>2. リダイレクトURIが `/oauth/callback` で終わっているか確認する。<br>3. `pip install streamlit-oauth` が正常にインストールされているか確認する。<br>4. Streamlitアプリの再起動を試す。 |
| **OAuth認証フローエラー** | ・authorize_button の結果が None。<br>・トークン取得に失敗している。<br>・ユーザー情報取得API呼び出しエラー。 | 1. ブラウザの開発者ツールでネットワークエラーを確認する。<br>2. `st.session_state` の内容をデバッグ表示で確認する。<br>3. Google UserInfo API の呼び出し URL とアクセストークンを確認する。<br>4. OAuth スコープが `openid email profile` に設定されているか確認する。 |
| **セッション管理の問題** | ・ページリロード時にログアウトされる。<br>・セッション状態が保持されない。<br>・複数タブで認証状態が同期しない。 | 1. `st.session_state['auth_code']` の保存・取得ロジックを確認する。<br>2. ブラウザのローカルストレージとクッキーを確認する。<br>3. Streamlit セッションの設定（secrets.toml）を見直す。<br>4. 必要に応じて認証状態をデータベースで管理することを検討する。 |
| **データが保存されない** | ・Supabaseのデータベース接続情報（キー）が間違っている。<br>・データベースの容量制限に達している。 | 1. GCPのSecret Managerに登録されているSupabaseのキーが正しいか確認する。<br>2. Supabaseのダッシュボードで、データベースの使用状況を確認し、必要であればプランをアップグレードする。 |

## 5. システムの更新（デプロイ）
本システムはCI/CDパイプラインが構築されているため、管理者が手動でデプロイ作業を行う必要はない。

* **手順:**
    1.  開発者が、修正したコードをGitHubの`main`ブランチにプッシュする。
    2.  GitHub Actionsが自動でテスト、コンテナビルド、Cloud Runへのデプロイを実行する。
    3.  管理者は、GitHub Actionsの実行結果を確認する。