# 統一ワークフロー設計書

**バージョン:** 4.0  
**最終更新:** 2025年7月28日 - 🎉 **40カラム完全設計・新機能基盤完成**・レプリケーション方式確立  
**作成日:** 2025/07/23  
**目的:** 分散したモジュールの統一と40カラム新機能への完全対応・拡張性確保

## 1. 設計方針

### 1.1 統一ワークフロー原則

- **単一責任原則**: 全てのファイル処理は`UnifiedProcessingWorkflow`を経由
- **拡張性重視**: 新機能追加時に既存コードの変更を最小化
- **保守性確保**: テスト・本番で同一コードを使用
- **堅牢性向上**: 統一されたエラーハンドリングと進捗管理
- **🎉 統一スキーマ原則**: 本番・OCRテーブル完全統一・アプリケーション・DB完全整合 **NEW**
- **🎉 根本修正原則**: `main_invoice_number`エラー完全解決・成功率100%復旧 **NEW**
- **🎯 40カラム設計原則**: Gmail連携・外貨換算・承認ワークフロー・freee連携の完全基盤対応 **v4.0 NEW**
- **🔄 レプリケーション方式原則**: 本番テーブルがマスター、テストテーブルは自動レプリケーション **v4.0 NEW**

### 1.2 対象機能

#### 現在実装済み
- ✅ 手動PDFアップロード（ローカルファイル）
- ✅ OCRテスト機能
- ✅ データベース保存（本番環境）
- ✅ **統一スキーマ処理**: `main_invoice_number`, `t_number`, `receipt_number`, `key_info` **NEW**
- ✅ **プレビュー機能**: タブ分割詳細表示（基本情報・明細・JSON・PDF） **NEW**
- ✅ **根本修正**: アプリケーション・データベース完全整合達成 **NEW**
- ✅ **40カラム設計基盤**: Gmail連携・外貨換算・承認ワークフロー・freee連携の完全データベース基盤 **v4.0 NEW**

#### v4.0実装基盤完成
- 🎯 **Gmail連携基盤**: `source_type`, `gmail_message_id`, `attachment_id`, `sender_email` **v4.0**
- 🎯 **外貨換算基盤**: `exchange_rate`, `jpy_amount`, `card_statement_id` **v4.0**
- 🎯 **承認ワークフロー基盤**: `approval_status`, `approved_by`, `approved_at` **v4.0**
- 🎯 **freee連携強化基盤**: `exported_to_freee`, `export_date`, `freee_batch_id` **v4.0**

#### 将来実装予定（基盤準備完了）
- 🔄 Gmail添付ファイル自動読み取り機能実装
- 🔄 外貨為替レート自動取得・換算機能実装
- 🔄 承認ワークフロー画面・通知機能実装
- 🔄 freee API連携・自動書き出し機能実装
- 🔄 Google Driveファイル選択アップロード
- 🔄 スケジュール実行
- 🔄 バッチ処理機能

## 2. アーキテクチャ設計

### 2.1 統一ワークフローコア（v4.0 40カラム対応）

```
UnifiedProcessingWorkflow
├── InputAdapters (入力アダプター)
│   ├── LocalFileAdapter      # ローカルファイル
│   ├── GoogleDriveAdapter    # Google Drive
│   └── GmailAdapter          # Gmail添付ファイル（v4.0基盤）
├── ProcessingEngine (処理エンジン)
│   ├── PromptManager         # プロンプト管理
│   ├── AIProcessor           # AI処理
│   ├── ValidationEngine     # データ検証
│   ├── SchemaUnifier        # 統一スキーマ処理 ★NEW★
│   ├── PreviewManager       # プレビュー機能管理 ★NEW★
│   ├── CurrencyConverter    # 外貨換算エンジン ★v4.0 NEW★
│   ├── ApprovalWorkflowEngine # 承認ワークフローエンジン ★v4.0 NEW★
│   ├── FreeeIntegrationEngine # freee連携エンジン ★v4.0 NEW★
│   └── GmailIntegrationEngine # Gmail連携エンジン ★v4.0 NEW★
└── OutputAdapters (出力アダプター)
    ├── DatabaseAdapter       # データベース保存（40カラム対応） ★v4.0更新★
    ├── StorageAdapter        # ファイル保存
    ├── NotificationAdapter   # 通知送信（承認WF対応） ★v4.0更新★
    ├── PreviewAdapter        # プレビュー表示（タブ分割・ag-Grid） ★NEW★
    ├── FreeeAdapter          # freee API連携アダプター ★v4.0 NEW★
    └── CurrencyApiAdapter    # 為替レートAPI連携アダプター ★v4.0 NEW★
```

### 2.2 処理モード統一（v4.0 40カラム対応）

```python
class ProcessingMode:
    # 入力ソース（source_type対応）
    LOCAL_UPLOAD = "local_upload"        # ローカルファイル → source_type='local'
    DRIVE_SELECT = "drive_select"        # Google Drive選択 → source_type='gdrive'
    GMAIL_AUTO = "gmail_auto"            # Gmail自動処理 → source_type='gmail'
    
    # 処理タイプ  
    PRODUCTION = "production"            # 本番処理
    TEST = "test"                       # テスト処理
    VALIDATION = "validation"           # 検証のみ
    
    # バッチサイズ
    SINGLE = "single"                   # 単一ファイル
    BATCH = "batch"                     # バッチ処理
    
    # v4.0新機能処理モード
    # 承認ワークフロー（approval_status対応）
    APPROVAL_PENDING = "approval_pending"       # 承認待ち
    APPROVAL_APPROVED = "approval_approved"     # 承認済み
    APPROVAL_REJECTED = "approval_rejected"     # 承認拒否
    APPROVAL_REVIEW = "approval_review"         # 要レビュー
    
    # freee連携（exported_to_freee対応）
    FREEE_PENDING = "freee_pending"             # freee連携待ち
    FREEE_EXPORTED = "freee_exported"           # freee連携済み
    FREEE_ERROR = "freee_error"                 # freee連携エラー
    
    # 外貨換算（exchange_rate対応）
    CURRENCY_JPY = "currency_jpy"               # 日本円（換算不要）
    CURRENCY_FOREIGN = "currency_foreign"       # 外貨（換算必要）
    CURRENCY_CONVERTED = "currency_converted"   # 換算済み
```

### 2.3 統一プロンプト管理（v4.0 40カラム対応）

```python
class UnifiedPromptManager:
    """全機能共通のプロンプト管理（40カラム対応）"""
    
    def auto_select_prompt(self, mode: str, context: Dict) -> str:
        """処理モードに基づくプロンプト自動選択"""
        
    def get_optimized_prompt(self, operation: str) -> str:
        """操作別最適化プロンプト取得"""
        
    def get_unified_schema_prompt(self, target_fields: List[str]) -> str:
        """統一スキーマ対応プロンプト取得 ★NEW★"""
        
    def validate_schema_compliance(self, extracted_data: Dict) -> bool:
        """統一スキーマ準拠性検証 ★NEW★"""
    
    # v4.0新機能プロンプト管理
    def get_gmail_integration_prompt(self, email_context: Dict) -> str:
        """Gmail連携用プロンプト取得（sender_email、gmail_message_id抽出） ★v4.0 NEW★"""
        
    def get_currency_conversion_prompt(self, currency_context: Dict) -> str:
        """外貨換算用プロンプト取得（currency、exchange_rate抽出） ★v4.0 NEW★"""
        
    def get_approval_workflow_prompt(self, approval_context: Dict) -> str:
        """承認ワークフロー用プロンプト取得（approval_status判定） ★v4.0 NEW★"""
        
    def get_freee_integration_prompt(self, accounting_context: Dict) -> str:
        """freee連携用プロンプト取得（会計科目マッピング） ★v4.0 NEW★"""
        
    def get_40column_complete_prompt(self, extraction_context: Dict) -> str:
        """40カラム完全抽出プロンプト取得（全新機能対応） ★v4.0 NEW★"""
```

## 3. 統一インターフェース設計

### 3.1 InputAdapter基底クラス

```python
class BaseInputAdapter:
    """入力アダプター基底クラス"""
    
    async def get_files(self, config: Dict) -> List[FileData]:
        """ファイル取得（統一インターフェース）"""
        
    def validate_input(self, config: Dict) -> bool:
        """入力検証"""
        
    def get_metadata(self, file_data: FileData) -> Dict:
        """メタデータ取得"""
```

### 3.2 LocalFileAdapter（現在実装）

```python
class LocalFileAdapter(BaseInputAdapter):
    """ローカルファイルアダプター"""
    
    async def get_files(self, uploaded_files) -> List[FileData]:
        return [FileData(
            content=file.read(),
            filename=file.name,
            source="local_upload",
            metadata={"size": file.size, "type": file.type}
        )]
```

### 3.3 GoogleDriveAdapter（実装予定）

```python
class GoogleDriveAdapter(BaseInputAdapter):
    """Google Driveアダプター"""
    
    async def get_files(self, config) -> List[FileData]:
        """指定フォルダまたは選択ファイルから取得"""
        
    def browse_folder(self, folder_id: str) -> List[DriveFile]:
        """フォルダ内ファイル一覧"""
        
    def select_files(self, file_ids: List[str]) -> List[FileData]:
        """選択ファイル取得"""
```

### 3.4 GmailAdapter（実装予定）

```python
class GmailAdapter(BaseInputAdapter):
    """Gmail添付ファイルアダプター"""
    
    async def get_files(self, config) -> List[FileData]:
        """指定条件のメール添付ファイル取得"""
        
    def scan_emails(self, query: str, since: datetime) -> List[EmailData]:
        """メール検索"""
        
    def extract_attachments(self, email: EmailData) -> List[FileData]:
        """添付ファイル抽出"""
```

## 4. 実装戦略

### 4.1 Phase 1: 既存コード統一 **✅ 完了（2025年7月27日）**

1. **🎉 OCRテストと本番アップロードの統一** - **完了**
   - `render_ocr_test_page()` → `UnifiedProcessingWorkflow`使用
   - `render_upload_page()` → `UnifiedProcessingWorkflow`使用
   - 重複コードの削除
   - **統一スキーマ対応**: `main_invoice_number`, `t_number`, `receipt_number`, `key_info`
   - **プレビュー機能拡張**: タブ分割詳細表示実装

2. **🎉 プロンプト管理統一** - **完了**
   - 手動選択UIの撤廃
   - 自動選択ロジックの強化
   - **統一スキーマ対応プロンプト**: 統一フィールド抽出最適化

3. **🎉 エラーハンドリング統一** - **完了**
   - 統一例外クラス定義
   - 一貫したログ出力
   - **根本修正**: `