# 統一ワークフロー設計書

**バージョン:** 3.1  
**最終更新:** 2025年7月24日 - データ検証ステップ追加  
**作成日:** 2025/07/23  
**目的:** 分散したモジュールの統一と将来機能への拡張性確保

## 1. 設計方針

### 1.1 統一ワークフロー原則

- **単一責任原則**: 全てのファイル処理は`UnifiedProcessingWorkflow`を経由
- **拡張性重視**: 新機能追加時に既存コードの変更を最小化
- **保守性確保**: テスト・本番で同一コードを使用
- **堅牢性向上**: 統一されたエラーハンドリングと進捗管理

### 1.2 対象機能

#### 現在実装済み
- ✅ 手動PDFアップロード（ローカルファイル）
- ✅ OCRテスト機能
- ✅ データベース保存（本番環境）

#### 将来実装予定
- 🔄 Google Driveファイル選択アップロード
- 🔄 Gmail添付ファイル自動読み取り
- 🔄 スケジュール実行
- 🔄 外部API連携

## 2. アーキテクチャ設計

### 2.1 統一ワークフローコア

```
UnifiedProcessingWorkflow
├── InputAdapters (入力アダプター)
│   ├── LocalFileAdapter      # ローカルファイル
│   ├── GoogleDriveAdapter    # Google Drive
│   └── GmailAdapter          # Gmail添付ファイル
├── ProcessingEngine (処理エンジン)
│   ├── PromptManager         # プロンプト管理
│   ├── AIProcessor           # AI処理
│   └── ValidationEngine     # データ検証
└── OutputAdapters (出力アダプター)
    ├── DatabaseAdapter       # データベース保存
    ├── StorageAdapter        # ファイル保存
    └── NotificationAdapter   # 通知送信
```

### 2.2 処理モード統一

```python
class ProcessingMode:
    # 入力ソース
    LOCAL_UPLOAD = "local_upload"        # ローカルファイル
    DRIVE_SELECT = "drive_select"        # Google Drive選択
    GMAIL_AUTO = "gmail_auto"            # Gmail自動処理
    
    # 処理タイプ  
    PRODUCTION = "production"            # 本番処理
    TEST = "test"                       # テスト処理
    VALIDATION = "validation"           # 検証のみ
    
    # バッチサイズ
    SINGLE = "single"                   # 単一ファイル
    BATCH = "batch"                     # バッチ処理
```

### 2.3 統一プロンプト管理

```python
class UnifiedPromptManager:
    """全機能共通のプロンプト管理"""
    
    def auto_select_prompt(self, mode: str, context: Dict) -> str:
        """処理モードに基づくプロンプト自動選択"""
        
    def get_optimized_prompt(self, operation: str) -> str:
        """操作別最適化プロンプト取得"""
```

## 3. 統一インターフェース設計

### 3.1 InputAdapter基底クラス

```python
class BaseInputAdapter:
    """入力アダプター基底クラス"""
    
    async def get_files(self, config: Dict) -> List[FileData]:
        """ファイル取得（統一インターフェース）"""
        
    def validate_input(self, config: Dict) -> bool:
        """入力検証"""
        
    def get_metadata(self, file_data: FileData) -> Dict:
        """メタデータ取得"""
```

### 3.2 LocalFileAdapter（現在実装）

```python
class LocalFileAdapter(BaseInputAdapter):
    """ローカルファイルアダプター"""
    
    async def get_files(self, uploaded_files) -> List[FileData]:
        return [FileData(
            content=file.read(),
            filename=file.name,
            source="local_upload",
            metadata={"size": file.size, "type": file.type}
        )]
```

### 3.3 GoogleDriveAdapter（実装予定）

```python
class GoogleDriveAdapter(BaseInputAdapter):
    """Google Driveアダプター"""
    
    async def get_files(self, config) -> List[FileData]:
        """指定フォルダまたは選択ファイルから取得"""
        
    def browse_folder(self, folder_id: str) -> List[DriveFile]:
        """フォルダ内ファイル一覧"""
        
    def select_files(self, file_ids: List[str]) -> List[FileData]:
        """選択ファイル取得"""
```

### 3.4 GmailAdapter（実装予定）

```python
class GmailAdapter(BaseInputAdapter):
    """Gmail添付ファイルアダプター"""
    
    async def get_files(self, config) -> List[FileData]:
        """指定条件のメール添付ファイル取得"""
        
    def scan_emails(self, query: str, since: datetime) -> List[EmailData]:
        """メール検索"""
        
    def extract_attachments(self, email: EmailData) -> List[FileData]:
        """添付ファイル抽出"""
```

## 4. 実装戦略

### 4.1 Phase 1: 既存コード統一

1. **OCRテストと本番アップロードの統一**
   - `render_ocr_test_page()` → `UnifiedProcessingWorkflow`使用
   - `render_upload_page()` → `UnifiedProcessingWorkflow`使用
   - 重複コードの削除

2. **プロンプト管理統一**
   - 手動選択UIの撤廃
   - 自動選択ロジックの強化

3. **エラーハンドリング統一**
   - 統一例外クラス定義
   - 一貫したログ出力

### 4.2 Phase 2: Google Drive機能実装

1. **Drive選択UI追加**
   - フォルダブラウザー
   - ファイル複数選択
   - プレビュー機能

2. **GoogleDriveAdapter実装**
   - 既存`GoogleDriveManager`のラッピング
   - 統一インターフェース準拠

### 4.3 Phase 3: Gmail自動処理実装

1. **Gmail API連携**
   - OAuth認証拡張
   - メール検索・取得

2. **自動処理スケジューラ**
   - 定期実行機能
   - バックグラウンド処理

## 5. 設定管理

### 5.1 統一設定クラス

```python
class ProcessingConfig:
    """処理設定統一管理"""
    
    # 入力設定
    input_source: str = "local_upload"
    max_file_size: int = 50 * 1024 * 1024  # 50MB
    supported_formats: List[str] = ["pdf"]
    
    # 処理設定
    ai_model: str = "gemini-2.5-flash-lite-preview-06-17"
    prompt_key: str = "auto"
    validation_mode: str = "standard"
    
    # 出力設定
    save_to_database: bool = True
    save_to_storage: bool = True
    send_notifications: bool = False
```

### 5.2 環境別設定

```python
class EnvironmentConfig:
    """環境別設定"""
    
    PRODUCTION = ProcessingConfig(
        validation_mode="strict",
        send_notifications=True
    )
    
    TEST = ProcessingConfig(
        validation_mode="lenient", 
        save_to_database=False
    )
    
    DEVELOPMENT = ProcessingConfig(
        validation_mode="debug",
        ai_model="gemini-2.5-flash-lite-preview-06-17"
    )
```

## 6. 拡張ポイント

### 6.1 新入力ソース追加

```python
# 新しいアダプター実装例
class DropboxAdapter(BaseInputAdapter):
    async def get_files(self, config) -> List[FileData]:
        # Dropbox API実装
        pass
```

### 6.2 新処理タイプ追加

```python
# 新しい処理ロジック追加例
class ContractProcessingEngine(BaseProcessingEngine):
    def process_document(self, file_data: FileData) -> ProcessingResult:
        # 契約書処理ロジック
        pass
```

### 6.3 新出力先追加

```python
# 新しい出力アダプター追加例
class SlackNotificationAdapter(BaseOutputAdapter):
    async def send_output(self, result: ProcessingResult) -> bool:
        # Slack通知実装
        pass
```

## 7. 移行計画

### 7.1 既存コード影響範囲

```
影響ファイル:
├── src/app/main.py                     # UI統一
├── src/core/workflows/                 # ワークフロー統一
├── src/utils/ocr_test_helper.py        # 廃止予定
└── src/infrastructure/                 # アダプター化
```

### 7.2 移行ステップ

1. **Step 1**: 統一インターフェース定義
2. **Step 2**: LocalFileAdapterリファクタリング
3. **Step 3**: OCRテスト機能統一
4. **Step 4**: UI統一・重複削除
5. **Step 5**: GoogleDriveAdapter実装
6. **Step 6**: GmailAdapter実装

### 7.3 後方互換性

- 既存のプロンプトファイル形式維持
- データベーススキーマ変更なし
- 設定ファイル形式維持

## 8. 品質保証

### 8.1 テスト戦略

```python
class UnifiedWorkflowTest:
    """統一ワークフローテスト"""
    
    def test_local_upload_flow(self):
        """ローカルアップロードフロー"""
        
    def test_drive_select_flow(self):
        """Drive選択フロー"""
        
    def test_gmail_auto_flow(self):
        """Gmail自動フロー"""
        
    def test_error_handling(self):
        """エラーハンドリング"""
        
    def test_prompt_auto_selection(self):
        """プロンプト自動選択"""
```

### 8.2 パフォーマンス要件

- **単一ファイル処理**: 30秒以内
- **バッチ処理**: 1ファイル/分
- **Gmail自動処理**: 100件/時間
- **エラー率**: 5%以下

## 9. 運用考慮事項

### 9.1 モニタリング

- 処理成功率の監視
- エラーパターンの分析
- パフォーマンス指標の追跡

### 9.2 保守性

- 統一ログフォーマット
- 設定の外部化
- アダプターの独立性確保

---

**次アクション**: Phase 1の実装開始 - OCRテストと本番アップロードの統一 