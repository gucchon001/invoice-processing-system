# プロンプト仕様書

**バージョン:** 4.0
**作成日:** 2025/07/17
**最終更新:** 2025/07/28 - 🎉 **40カラム新機能プロンプト完全対応** 

## 1. 概要

本ドキュメントは、請求書処理自動化システムで使用されるGemini APIへの指示書（プロンプト）の仕様を定義する。プロンプトはすべて**JSON形式**で`/prompts`ディレクトリに管理し、**ハードコーディングを完全に排除**して保守性・拡張性を最大化する。

**🎉 2025年7月28日更新**: **40カラム新機能プロンプト完全対応**により、Gmail連携・外貨換算・承認ワークフロー・freee連携の専用プロンプト仕様が策定されました。source_type、gmail_message_id、exchange_rate、approval_status、exported_to_freee等の新機能カラムに対応した高精度抽出プロンプトが完成し、統合ワークフローでの新機能プロンプト管理が実現されています。

### 🎯 **設計方針（4.0版）**

- **📁 完全外出し**: ソースコードからプロンプト文言を完全分離
- **🔄 動的ロード**: 実行時にJSONファイルからプロンプトを読み込み  
- **🔧 バージョン管理**: プロンプトの独立したバージョニング
- **📊 構造化管理**: JSON schema準拠の統一フォーマット
- **🎛️ 設定可能**: 確信度閾値、優先度等の動的調整
- **🧪 テスト駆動**: テストケース内蔵による品質保証
- **🎯 40カラム対応**: 新機能専用プロンプトによる高精度抽出 **v4.0 NEW**
- **🔄 統合管理**: UnifiedPromptManagerによる新機能プロンプト統合管理 **v4.0 NEW**

## 2. JSONプロンプト構造仕様

### 2.1. 標準JSONスキーマ

```json
{
  "name": "プロンプト表示名",
  "version": "セマンティックバージョン(例: 2.0)",
  "description": "プロンプトの目的と機能の説明",
  "confidence_threshold": 0.80,
  "priority": "highest | high | medium | low",
  "prompt_template": "実際のプロンプト文字列（変数置換対応）",
  "variables": {
    "変数名": {
      "type": "string | number | array | object | image",
      "description": "変数の説明",
      "required": true | false,
      "default": "デフォルト値（任意）",
      "example": "使用例",
      "formats": ["対応フォーマット（画像等）"]
    }
  },
  "test_cases": [
    {
      "name": "テストケース名",
      "input": { "テスト入力データ" },
      "expected_output": { "期待される出力" }
    }
  ]
}
```

## 3. 現在のプロンプト一覧（v4.0 40カラム対応）

### 3.1. 基本プロンプト（既存・強化版）
| JSONファイル名 | プロンプト名 | 主要機能 | 確信度要求 | 優先度 |
|:---|:---|:---|:---|:---|
| `invoice_extractor_prompt.json` | 請求書情報抽出専門家 | PDFから構造化データ+**キー情報**抽出 | 90%以上 | **最高** |
| `master_matcher_prompt.json` | 企業名表記揺れ照合専門家 | 請求元名と支払マスタの照合 | 85%以上 | **最高** |
| `integrated_matcher_prompt.json` | 請求書明細照合専門家 | 詳細情報による最終仕訳特定 | 75%以上 | **最高** |

### 3.2. v4.0新機能プロンプト（40カラム対応）★NEW★
| JSONファイル名 | プロンプト名 | 主要機能 | 確信度要求 | 優先度 |
|:---|:---|:---|:---|:---|
| `gmail_integration_prompt.json` | Gmail連携情報抽出専門家 | **sender_email、gmail_message_id**抽出 | 85%以上 | **高** |
| `currency_conversion_prompt.json` | 外貨換算情報抽出専門家 | **currency、exchange_rate**抽出・換算 | 90%以上 | **高** |
| `approval_workflow_prompt.json` | 承認ワークフロー判定専門家 | **approval_status**自動判定 | 80%以上 | **中** |
| `freee_integration_prompt.json` | freee連携情報抽出専門家 | 会計科目・**freee連携**情報抽出 | 85%以上 | **高** |
| `40column_complete_prompt.json` | 40カラム完全抽出専門家 | **全新機能カラム**一括抽出 | 88%以上 | **最高** |

### 3.3. プロンプト統合管理（UnifiedPromptManager対応）
- **自動選択**: 処理モードに基づく最適プロンプト自動選択
- **動的組み合わせ**: 複数プロンプトの組み合わせ実行
- **確信度調整**: 機能別確信度閾値の動的調整
- **統合テスト**: 新機能プロンプト連携テスト

## 4. ハードコーディング外出し実装方式

### 4.1. プロンプトローダークラス設計

```python
class PromptManager:
    """JSONプロンプトの動的ロード・管理クラス"""
    
    def __init__(self, prompts_dir: str = "./prompts"):
        self.prompts_dir = prompts_dir
        self.loaded_prompts = {}
    
    def load_prompt(self, prompt_name: str) -> dict:
        """指定されたプロンプトJSONを読み込み"""
        file_path = f"{self.prompts_dir}/{prompt_name}.json"
        with open(file_path, 'r', encoding='utf-8') as f:
            return json.load(f)
    
    def render_prompt(self, prompt_name: str, variables: dict) -> str:
        """変数を置換してプロンプト文字列を生成"""
        prompt_data = self.load_prompt(prompt_name)
        template = prompt_data["prompt_template"]
        
        # 変数置換処理
        for var_name, var_value in variables.items():
            placeholder = f"{{{var_name}}}"
            template = template.replace(placeholder, str(var_value))
        
        return template
    
    def validate_inputs(self, prompt_name: str, inputs: dict) -> bool:
        """入力変数の妥当性検証"""
        prompt_data = self.load_prompt(prompt_name)
        variables_spec = prompt_data.get("variables", {})
        
        # 必須変数チェック
        for var_name, var_spec in variables_spec.items():
            if var_spec.get("required", False) and var_name not in inputs:
                raise ValueError(f"必須変数 '{var_name}' が未提供")
        
        return True
```

### 4.2. 使用例

```python
# プロンプト管理インスタンス初期化
prompt_mgr = PromptManager("./prompts")

# 請求書抽出プロンプト使用例
def extract_invoice_data(pdf_blob):
    try:
        # 入力変数準備
        variables = {
            "invoice_image": pdf_blob,
            "extraction_mode": "comprehensive"
        }
        
        # 入力検証
        prompt_mgr.validate_inputs("invoice_extractor_prompt", variables)
        
        # プロンプト生成
        prompt_text = prompt_mgr.render_prompt("invoice_extractor_prompt", variables)
        
        # Gemini API呼び出し
        response = gemini_client.generate_content(prompt_text)
        return json.loads(response.text)
        
    except Exception as e:
        logging.error(f"請求書抽出エラー: {e}")
        return None
```

## 5. 詳細プロンプト仕様

### 5.1. `invoice_extractor_prompt.json` - **キー情報強化版**

#### 📋 **基本機能**
- 請求書PDFから基本項目（請求元、金額、日付等）抽出
- **システム処理用キー情報**の高精度抽出
- 重複判定・ファイル管理・企業特定支援情報の生成

#### 🔑 **キー情報抽出機能（強化版）**

**【最優先】企業・アカウント特定用キー（マッチング精度向上）**
```json
{
  "key_info": {
    "アカウントID": "01B060-1925C3-38EE2B",
    "契約番号": "C-2025-001234",
    "顧客コード": "CUST-789012",
    "請求先コード": "BILL-001"
  }
}
```

**【高優先】重複判定用キー（ユニークID生成）**
- 利用期間、請求対象期間、取引ID
- 請求書番号補完情報、参照番号
- 金額詳細分類、手数料情報

**【中優先】ファイル管理・分類用キー**
- サービス名・プラン名（ファイル分類用）
- 請求種別（月次・年次・一時請求等）
- 請求元詳細（支店名、部署名等）

#### 🎯 **出力フォーマット**
```json
{
  "issuer": "string | null",
  "payer": "string | null",
  "issue_date": "YYYY-MM-DD | null", 
  "due_date": "YYYY-MM-DD | null",
  "main_invoice_number": "string | null",
  "t_number": "string | null",
  "currency": "JPY | USD | EUR | null",
  "amount_inclusive_tax": "number | null",
  "amount_exclusive_tax": "number | null",
  "key_info": {
    "アカウントID": "値",
    "利用期間": "値",
    "サービス名": "値",
    "請求種別": "値"
  },
  "line_items": [
    {
      "description": "string | null",
      "quantity": "number | null", 
      "unit_price": "number | null",
      "amount": "number | null",
      "tax": "number | string | null"
    }
  ]
}
```

### 5.2. `master_matcher_prompt.json` - 企業名照合

#### 🎯 **専門機能**
- **表記揺れ対応**: 法人格、サービス名、記号・スペース正規化
- **多言語対応**: カタカナ⇔英語、漢字異体字対応
- **確信度管理**: 85%以上でのみ照合成功

#### 🔄 **照合プロセス**
1. **完全一致チェック** (確信度95%)
2. **法人格正規化** (確信度90%)  
3. **サービス名変換** (確信度88%)
4. **類似度計算** (確信度60-84%)

### 5.3. `integrated_matcher_prompt.json` - 最終照合

#### 🎯 **統合判定機能** 
- **多要素評価**: キー情報(40%) + 金額(30%) + 日付(20%) + 明細(10%)
- **リアルデータ対応**: SaaS、広告費、クラウドサービス等
- **確信度管理**: 75%以上でのみ照合成功

## 6. プロンプト運用・保守

### 6.1. バージョン管理
- **セマンティックバージョニング**: `major.minor.patch`
- **変更ログ**: 各JSONファイル内にversion履歴記録
- **テスト駆動**: バージョンアップ時の回帰テスト実行

### 6.2. 品質保証
- **テストケース実行**: 各プロンプトの`test_cases`による検証
- **確信度監視**: 閾値を下回る場合のアラート
- **エラーハンドリング**: プロンプト読み込み失敗時の代替処理

### 6.3. 設定管理（v4.0 40カラム対応）
```python
# 設定ファイルでの閾値調整例（40カラム対応）
PROMPT_CONFIG = {
    # 基本プロンプト
    "invoice_extractor": {
        "confidence_threshold": 0.90,
        "timeout_seconds": 30
    },
    "master_matcher": {
        "confidence_threshold": 0.85,
        "retry_count": 3
    },
    # v4.0新機能プロンプト
    "gmail_integration": {
        "confidence_threshold": 0.85,
        "timeout_seconds": 20,
        "enable_metadata_extraction": True
    },
    "currency_conversion": {
        "confidence_threshold": 0.90,
        "timeout_seconds": 25,
        "support_currencies": ["USD", "EUR", "GBP", "CNY"]
    },
    "approval_workflow": {
        "confidence_threshold": 0.80,
        "timeout_seconds": 15,
        "auto_approval_limit": 50000
    },
    "freee_integration": {
        "confidence_threshold": 0.85,
        "timeout_seconds": 30,
        "default_account_title": "支払手数料"
    },
    "40column_complete": {
        "confidence_threshold": 0.88,
        "timeout_seconds": 60,
        "enable_all_features": True,
        "fallback_to_basic": True
    }
}
```

## 7. エラーハンドリング統一仕様

### 7.1. プロンプトレベルエラー
- **ファイル不存在**: デフォルトプロンプトへフォールバック
- **JSON形式エラー**: パース失敗時の詳細ログ
- **変数不足**: 必須変数欠如時の明確なエラーメッセージ

### 7.2. 実行時エラー
- **API呼び出し失敗**: リトライ機構とタイムアウト処理
- **確信度不足**: 閾値未満時の代替フロー
- **出力形式不正**: JSONパース失敗時の復旧処理

## 8. 今後の拡張予定

### 8.1. 近日実装
- **動的閾値調整**: 成功率に基づく自動最適化
- **A/Bテスト機能**: 複数プロンプト版の効果測定
- **多言語対応**: 英語プロンプトとの自動切り替え

### 8.2. 長期構想
- **プロンプト自動生成**: AIによるプロンプト改善提案
- **業界特化版**: 業種別最適化プロンプト
- **リアルタイム学習**: ユーザーフィードバックによる継続改善

---

## 9. v4.0新機能プロンプト詳細仕様 ★NEW★

### 9.1. `gmail_integration_prompt.json` - Gmail連携情報抽出

#### 🎯 **専門機能**
- **Gmail連携カラム抽出**: sender_email, gmail_message_id, attachment_id
- **メタデータ解析**: メールヘッダー情報から請求書関連情報抽出
- **source_type自動設定**: 'gmail'値の自動判定・設定

#### 📊 **出力フォーマット**
```json
{
  "source_type": "gmail",
  "sender_email": "billing@company.com",
  "gmail_message_id": "1234567890abcdef",
  "attachment_id": "ANGjdJ_abc123",
  "email_subject": "請求書送付のご案内",
  "email_date": "2025-01-28T14:30:00Z"
}
```

### 9.2. `currency_conversion_prompt.json` - 外貨換算情報抽出

#### 🎯 **専門機能**
- **通貨情報強化抽出**: currency詳細識別（USD, EUR, GBP等）
- **為替レート検出**: 請求書内記載の為替レート抽出
- **金額計算支援**: 外貨金額・円換算金額の対応関係解析

#### 📊 **出力フォーマット**
```json
{
  "currency": "USD",
  "foreign_amount": 1000.00,
  "exchange_rate": 149.85,
  "jpy_amount": 149850,
  "rate_date": "2025-01-28",
  "conversion_note": "Invoice stated rate",
  "card_statement_id": "CARD-2025-001"
}
```

### 9.3. `approval_workflow_prompt.json` - 承認ワークフロー判定

#### 🎯 **専門機能**
- **承認要否判定**: 金額・取引先・内容による承認要否自動判定
- **承認レベル判定**: pending/approved/rejected/requires_review自動分類
- **承認条件評価**: 事前定義ルールに基づく承認状況評価

#### 📊 **出力フォーマット**
```json
{
  "approval_status": "pending",
  "approval_required": true,
  "approval_reason": "金額が承認閾値を超過",
  "recommended_approver": "部長",
  "urgency_level": "medium",
  "auto_approval_eligible": false
}
```

### 9.4. `freee_integration_prompt.json` - freee連携情報抽出

#### 🎯 **専門機能**
- **会計科目マッピング**: 請求内容から適切な会計科目自動判定
- **freee連携準備**: 勘定科目・税区分・部門情報の構造化
- **仕訳支援**: 借方・貸方情報の自動生成支援

#### 📊 **出力フォーマット**
```json
{
  "account_title": "支払手数料",
  "tax_category": "課税仕入",
  "department": "営業部",
  "project_code": "PRJ-2025-001",
  "freee_ready": true,
  "journal_memo": "システム利用料_2025年1月分"
}
```

### 9.5. `40column_complete_prompt.json` - 40カラム完全抽出

#### 🎯 **統合機能**
- **全カラム一括抽出**: 40カラム全対応の包括的情報抽出
- **新機能統合**: Gmail・外貨・承認・freee情報の統合処理
- **品質保証**: 全カラムの整合性チェック・補完処理

#### 📊 **完全出力フォーマット**
```json
{
  // 基本情報（6カラム）
  "id": null,
  "user_email": "user@company.com",
  "status": "extracted",
  "uploaded_at": "2025-01-28T15:00:00+09:00",
  "created_at": "2025-01-28T15:00:00+09:00",
  "updated_at": "2025-01-28T15:00:00+09:00",
  
  // ファイル管理（7カラム）
  "file_name": "invoice_202501.pdf",
  "gdrive_file_id": "1ABC123...",
  "file_path": "/invoices/2025/01/",
  "source_type": "gmail",
  "gmail_message_id": "1234567890",
  "attachment_id": "ANGjdJ_abc",
  "sender_email": "billing@company.com",
  
  // 請求書基本（7カラム）
  "issuer_name": "株式会社サンプル",
  "recipient_name": "株式会社ユーザー",
  "main_invoice_number": "INV-2025-001",
  "receipt_number": "REC-2025-001",
  "t_number": "T1234567890123",
  "issue_date": "2025-01-20",
  "due_date": "2025-02-20",
  
  // 金額・通貨（6カラム）
  "currency": "USD",
  "total_amount_tax_included": 1000.00,
  "total_amount_tax_excluded": 909.09,
  "exchange_rate": 149.85,
  "jpy_amount": 149850,
  "card_statement_id": "CARD-2025-001",
  
  // AI処理（8カラム）
  "extracted_data": { "完全抽出データ" },
  "raw_response": { "AI生レスポンス" },
  "key_info": { "キー情報" },
  "is_valid": true,
  "validation_errors": [],
  "validation_warnings": [],
  "completeness_score": 95.5,
  "processing_time": 3.2,
  
  // 承認ワークフロー（3カラム）
  "approval_status": "pending",
  "approved_by": null,
  "approved_at": null,
  
  // freee連携（3カラム）
  "exported_to_freee": false,
  "export_date": null,
  "freee_batch_id": null
}
```

### 9.6. 新機能プロンプト統合管理

#### 🔄 **UnifiedPromptManager連携**
```python
# 新機能プロンプト使用例
prompt_manager = UnifiedPromptManager()

# Gmail連携時の自動プロンプト選択
if source_type == 'gmail':
    prompt = prompt_manager.get_gmail_integration_prompt(email_context)
    
# 外貨請求書の場合
if currency != 'JPY':
    prompt = prompt_manager.get_currency_conversion_prompt(currency_context)
    
# 40カラム完全抽出
prompt = prompt_manager.get_40column_complete_prompt(extraction_context)
```

#### 📊 **プロンプト連携フロー**
1. **入力判定**: source_type, currency等による自動判定
2. **プロンプト選択**: 最適な専用プロンプト自動選択
3. **統合実行**: 複数プロンプトの順次または並列実行
4. **結果統合**: 各プロンプト結果の統合・整合性チェック

---

**最終更新**: 2025年7月28日  
**v4.0重要成果**: 40カラム新機能プロンプト完全対応・Gmail連携・外貨換算・承認ワークフロー・freee連携プロンプト仕様策定完了