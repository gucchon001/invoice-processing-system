# ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆä»•æ§˜æ›¸

**ãƒãƒ¼ã‚¸ãƒ§ãƒ³:** 4.0
**ä½œæˆæ—¥:** 2025/07/17
**æœ€çµ‚æ›´æ–°:** 2025/07/28 - ğŸ‰ **40ã‚«ãƒ©ãƒ æ–°æ©Ÿèƒ½ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆå®Œå…¨å¯¾å¿œ** 

## 1. æ¦‚è¦

æœ¬ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯ã€è«‹æ±‚æ›¸å‡¦ç†è‡ªå‹•åŒ–ã‚·ã‚¹ãƒ†ãƒ ã§ä½¿ç”¨ã•ã‚Œã‚‹Gemini APIã¸ã®æŒ‡ç¤ºæ›¸ï¼ˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼‰ã®ä»•æ§˜ã‚’å®šç¾©ã™ã‚‹ã€‚ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã¯ã™ã¹ã¦**JSONå½¢å¼**ã§`/prompts`ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ç®¡ç†ã—ã€**ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚’å®Œå…¨ã«æ’é™¤**ã—ã¦ä¿å®ˆæ€§ãƒ»æ‹¡å¼µæ€§ã‚’æœ€å¤§åŒ–ã™ã‚‹ã€‚

**ğŸ‰ 2025å¹´7æœˆ28æ—¥æ›´æ–°**: **40ã‚«ãƒ©ãƒ æ–°æ©Ÿèƒ½ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆå®Œå…¨å¯¾å¿œ**ã«ã‚ˆã‚Šã€Gmailé€£æºãƒ»å¤–è²¨æ›ç®—ãƒ»æ‰¿èªãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãƒ»freeeé€£æºã®å°‚ç”¨ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆä»•æ§˜ãŒç­–å®šã•ã‚Œã¾ã—ãŸã€‚source_typeã€gmail_message_idã€exchange_rateã€approval_statusã€exported_to_freeeç­‰ã®æ–°æ©Ÿèƒ½ã‚«ãƒ©ãƒ ã«å¯¾å¿œã—ãŸé«˜ç²¾åº¦æŠ½å‡ºãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãŒå®Œæˆã—ã€çµ±åˆãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã§ã®æ–°æ©Ÿèƒ½ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç®¡ç†ãŒå®Ÿç¾ã•ã‚Œã¦ã„ã¾ã™ã€‚

### ğŸ¯ **è¨­è¨ˆæ–¹é‡ï¼ˆ4.0ç‰ˆï¼‰**

- **ğŸ“ å®Œå…¨å¤–å‡ºã—**: ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‹ã‚‰ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆæ–‡è¨€ã‚’å®Œå…¨åˆ†é›¢
- **ğŸ”„ å‹•çš„ãƒ­ãƒ¼ãƒ‰**: å®Ÿè¡Œæ™‚ã«JSONãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’èª­ã¿è¾¼ã¿  
- **ğŸ”§ ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç®¡ç†**: ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®ç‹¬ç«‹ã—ãŸãƒãƒ¼ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°
- **ğŸ“Š æ§‹é€ åŒ–ç®¡ç†**: JSON schemaæº–æ‹ ã®çµ±ä¸€ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
- **ğŸ›ï¸ è¨­å®šå¯èƒ½**: ç¢ºä¿¡åº¦é–¾å€¤ã€å„ªå…ˆåº¦ç­‰ã®å‹•çš„èª¿æ•´
- **ğŸ§ª ãƒ†ã‚¹ãƒˆé§†å‹•**: ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹å†…è”µã«ã‚ˆã‚‹å“è³ªä¿è¨¼
- **ğŸ¯ 40ã‚«ãƒ©ãƒ å¯¾å¿œ**: æ–°æ©Ÿèƒ½å°‚ç”¨ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã«ã‚ˆã‚‹é«˜ç²¾åº¦æŠ½å‡º **v4.0 NEW**
- **ğŸ”„ çµ±åˆç®¡ç†**: UnifiedPromptManagerã«ã‚ˆã‚‹æ–°æ©Ÿèƒ½ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆçµ±åˆç®¡ç† **v4.0 NEW**

## 2. JSONãƒ—ãƒ­ãƒ³ãƒ—ãƒˆæ§‹é€ ä»•æ§˜

### 2.1. æ¨™æº–JSONã‚¹ã‚­ãƒ¼ãƒ

```json
{
  "name": "ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆè¡¨ç¤ºå",
  "version": "ã‚»ãƒãƒ³ãƒ†ã‚£ãƒƒã‚¯ãƒãƒ¼ã‚¸ãƒ§ãƒ³(ä¾‹: 2.0)",
  "description": "ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®ç›®çš„ã¨æ©Ÿèƒ½ã®èª¬æ˜",
  "confidence_threshold": 0.80,
  "priority": "highest | high | medium | low",
  "prompt_template": "å®Ÿéš›ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆæ–‡å­—åˆ—ï¼ˆå¤‰æ•°ç½®æ›å¯¾å¿œï¼‰",
  "variables": {
    "å¤‰æ•°å": {
      "type": "string | number | array | object | image",
      "description": "å¤‰æ•°ã®èª¬æ˜",
      "required": true | false,
      "default": "ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ï¼ˆä»»æ„ï¼‰",
      "example": "ä½¿ç”¨ä¾‹",
      "formats": ["å¯¾å¿œãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼ˆç”»åƒç­‰ï¼‰"]
    }
  },
  "test_cases": [
    {
      "name": "ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹å",
      "input": { "ãƒ†ã‚¹ãƒˆå…¥åŠ›ãƒ‡ãƒ¼ã‚¿" },
      "expected_output": { "æœŸå¾…ã•ã‚Œã‚‹å‡ºåŠ›" }
    }
  ]
}
```

## 3. ç¾åœ¨ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆä¸€è¦§ï¼ˆv4.0 40ã‚«ãƒ©ãƒ å¯¾å¿œï¼‰

### 3.1. åŸºæœ¬ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼ˆæ—¢å­˜ãƒ»å¼·åŒ–ç‰ˆï¼‰
| JSONãƒ•ã‚¡ã‚¤ãƒ«å | ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆå | ä¸»è¦æ©Ÿèƒ½ | ç¢ºä¿¡åº¦è¦æ±‚ | å„ªå…ˆåº¦ |
|:---|:---|:---|:---|:---|
| `invoice_extractor_prompt.json` | è«‹æ±‚æ›¸æƒ…å ±æŠ½å‡ºå°‚é–€å®¶ | PDFã‹ã‚‰æ§‹é€ åŒ–ãƒ‡ãƒ¼ã‚¿+**ã‚­ãƒ¼æƒ…å ±**æŠ½å‡º | 90%ä»¥ä¸Š | **æœ€é«˜** |
| `master_matcher_prompt.json` | ä¼æ¥­åè¡¨è¨˜æºã‚Œç…§åˆå°‚é–€å®¶ | è«‹æ±‚å…ƒåã¨æ”¯æ‰•ãƒã‚¹ã‚¿ã®ç…§åˆ | 85%ä»¥ä¸Š | **æœ€é«˜** |
| `integrated_matcher_prompt.json` | è«‹æ±‚æ›¸æ˜ç´°ç…§åˆå°‚é–€å®¶ | è©³ç´°æƒ…å ±ã«ã‚ˆã‚‹æœ€çµ‚ä»•è¨³ç‰¹å®š | 75%ä»¥ä¸Š | **æœ€é«˜** |

### 3.2. v4.0æ–°æ©Ÿèƒ½ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼ˆ40ã‚«ãƒ©ãƒ å¯¾å¿œï¼‰â˜…NEWâ˜…
| JSONãƒ•ã‚¡ã‚¤ãƒ«å | ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆå | ä¸»è¦æ©Ÿèƒ½ | ç¢ºä¿¡åº¦è¦æ±‚ | å„ªå…ˆåº¦ |
|:---|:---|:---|:---|:---|
| `gmail_integration_prompt.json` | Gmailé€£æºæƒ…å ±æŠ½å‡ºå°‚é–€å®¶ | **sender_emailã€gmail_message_id**æŠ½å‡º | 85%ä»¥ä¸Š | **é«˜** |
| `currency_conversion_prompt.json` | å¤–è²¨æ›ç®—æƒ…å ±æŠ½å‡ºå°‚é–€å®¶ | **currencyã€exchange_rate**æŠ½å‡ºãƒ»æ›ç®— | 90%ä»¥ä¸Š | **é«˜** |
| `approval_workflow_prompt.json` | æ‰¿èªãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼åˆ¤å®šå°‚é–€å®¶ | **approval_status**è‡ªå‹•åˆ¤å®š | 80%ä»¥ä¸Š | **ä¸­** |
| `freee_integration_prompt.json` | freeeé€£æºæƒ…å ±æŠ½å‡ºå°‚é–€å®¶ | ä¼šè¨ˆç§‘ç›®ãƒ»**freeeé€£æº**æƒ…å ±æŠ½å‡º | 85%ä»¥ä¸Š | **é«˜** |
| `40column_complete_prompt.json` | 40ã‚«ãƒ©ãƒ å®Œå…¨æŠ½å‡ºå°‚é–€å®¶ | **å…¨æ–°æ©Ÿèƒ½ã‚«ãƒ©ãƒ **ä¸€æ‹¬æŠ½å‡º | 88%ä»¥ä¸Š | **æœ€é«˜** |

### 3.3. ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆçµ±åˆç®¡ç†ï¼ˆUnifiedPromptManagerå¯¾å¿œï¼‰
- **è‡ªå‹•é¸æŠ**: å‡¦ç†ãƒ¢ãƒ¼ãƒ‰ã«åŸºã¥ãæœ€é©ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆè‡ªå‹•é¸æŠ
- **å‹•çš„çµ„ã¿åˆã‚ã›**: è¤‡æ•°ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®çµ„ã¿åˆã‚ã›å®Ÿè¡Œ
- **ç¢ºä¿¡åº¦èª¿æ•´**: æ©Ÿèƒ½åˆ¥ç¢ºä¿¡åº¦é–¾å€¤ã®å‹•çš„èª¿æ•´
- **çµ±åˆãƒ†ã‚¹ãƒˆ**: æ–°æ©Ÿèƒ½ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆé€£æºãƒ†ã‚¹ãƒˆ

## 4. ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°å¤–å‡ºã—å®Ÿè£…æ–¹å¼

### 4.1. ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ­ãƒ¼ãƒ€ãƒ¼ã‚¯ãƒ©ã‚¹è¨­è¨ˆ

```python
class PromptManager:
    """JSONãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®å‹•çš„ãƒ­ãƒ¼ãƒ‰ãƒ»ç®¡ç†ã‚¯ãƒ©ã‚¹"""
    
    def __init__(self, prompts_dir: str = "./prompts"):
        self.prompts_dir = prompts_dir
        self.loaded_prompts = {}
    
    def load_prompt(self, prompt_name: str) -> dict:
        """æŒ‡å®šã•ã‚ŒãŸãƒ—ãƒ­ãƒ³ãƒ—ãƒˆJSONã‚’èª­ã¿è¾¼ã¿"""
        file_path = f"{self.prompts_dir}/{prompt_name}.json"
        with open(file_path, 'r', encoding='utf-8') as f:
            return json.load(f)
    
    def render_prompt(self, prompt_name: str, variables: dict) -> str:
        """å¤‰æ•°ã‚’ç½®æ›ã—ã¦ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆæ–‡å­—åˆ—ã‚’ç”Ÿæˆ"""
        prompt_data = self.load_prompt(prompt_name)
        template = prompt_data["prompt_template"]
        
        # å¤‰æ•°ç½®æ›å‡¦ç†
        for var_name, var_value in variables.items():
            placeholder = f"{{{var_name}}}"
            template = template.replace(placeholder, str(var_value))
        
        return template
    
    def validate_inputs(self, prompt_name: str, inputs: dict) -> bool:
        """å…¥åŠ›å¤‰æ•°ã®å¦¥å½“æ€§æ¤œè¨¼"""
        prompt_data = self.load_prompt(prompt_name)
        variables_spec = prompt_data.get("variables", {})
        
        # å¿…é ˆå¤‰æ•°ãƒã‚§ãƒƒã‚¯
        for var_name, var_spec in variables_spec.items():
            if var_spec.get("required", False) and var_name not in inputs:
                raise ValueError(f"å¿…é ˆå¤‰æ•° '{var_name}' ãŒæœªæä¾›")
        
        return True
```

### 4.2. ä½¿ç”¨ä¾‹

```python
# ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç®¡ç†ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹åˆæœŸåŒ–
prompt_mgr = PromptManager("./prompts")

# è«‹æ±‚æ›¸æŠ½å‡ºãƒ—ãƒ­ãƒ³ãƒ—ãƒˆä½¿ç”¨ä¾‹
def extract_invoice_data(pdf_blob):
    try:
        # å…¥åŠ›å¤‰æ•°æº–å‚™
        variables = {
            "invoice_image": pdf_blob,
            "extraction_mode": "comprehensive"
        }
        
        # å…¥åŠ›æ¤œè¨¼
        prompt_mgr.validate_inputs("invoice_extractor_prompt", variables)
        
        # ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç”Ÿæˆ
        prompt_text = prompt_mgr.render_prompt("invoice_extractor_prompt", variables)
        
        # Gemini APIå‘¼ã³å‡ºã—
        response = gemini_client.generate_content(prompt_text)
        return json.loads(response.text)
        
    except Exception as e:
        logging.error(f"è«‹æ±‚æ›¸æŠ½å‡ºã‚¨ãƒ©ãƒ¼: {e}")
        return None
```

## 5. è©³ç´°ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆä»•æ§˜

### 5.1. `invoice_extractor_prompt.json` - **ã‚­ãƒ¼æƒ…å ±å¼·åŒ–ç‰ˆ**

#### ğŸ“‹ **åŸºæœ¬æ©Ÿèƒ½**
- è«‹æ±‚æ›¸PDFã‹ã‚‰åŸºæœ¬é …ç›®ï¼ˆè«‹æ±‚å…ƒã€é‡‘é¡ã€æ—¥ä»˜ç­‰ï¼‰æŠ½å‡º
- **ã‚·ã‚¹ãƒ†ãƒ å‡¦ç†ç”¨ã‚­ãƒ¼æƒ…å ±**ã®é«˜ç²¾åº¦æŠ½å‡º
- é‡è¤‡åˆ¤å®šãƒ»ãƒ•ã‚¡ã‚¤ãƒ«ç®¡ç†ãƒ»ä¼æ¥­ç‰¹å®šæ”¯æ´æƒ…å ±ã®ç”Ÿæˆ

#### ğŸ”‘ **ã‚­ãƒ¼æƒ…å ±æŠ½å‡ºæ©Ÿèƒ½ï¼ˆå¼·åŒ–ç‰ˆï¼‰**

**ã€æœ€å„ªå…ˆã€‘ä¼æ¥­ãƒ»ã‚¢ã‚«ã‚¦ãƒ³ãƒˆç‰¹å®šç”¨ã‚­ãƒ¼ï¼ˆãƒãƒƒãƒãƒ³ã‚°ç²¾åº¦å‘ä¸Šï¼‰**
```json
{
  "key_info": {
    "ã‚¢ã‚«ã‚¦ãƒ³ãƒˆID": "01B060-1925C3-38EE2B",
    "å¥‘ç´„ç•ªå·": "C-2025-001234",
    "é¡§å®¢ã‚³ãƒ¼ãƒ‰": "CUST-789012",
    "è«‹æ±‚å…ˆã‚³ãƒ¼ãƒ‰": "BILL-001"
  }
}
```

**ã€é«˜å„ªå…ˆã€‘é‡è¤‡åˆ¤å®šç”¨ã‚­ãƒ¼ï¼ˆãƒ¦ãƒ‹ãƒ¼ã‚¯IDç”Ÿæˆï¼‰**
- åˆ©ç”¨æœŸé–“ã€è«‹æ±‚å¯¾è±¡æœŸé–“ã€å–å¼•ID
- è«‹æ±‚æ›¸ç•ªå·è£œå®Œæƒ…å ±ã€å‚ç…§ç•ªå·
- é‡‘é¡è©³ç´°åˆ†é¡ã€æ‰‹æ•°æ–™æƒ…å ±

**ã€ä¸­å„ªå…ˆã€‘ãƒ•ã‚¡ã‚¤ãƒ«ç®¡ç†ãƒ»åˆ†é¡ç”¨ã‚­ãƒ¼**
- ã‚µãƒ¼ãƒ“ã‚¹åãƒ»ãƒ—ãƒ©ãƒ³åï¼ˆãƒ•ã‚¡ã‚¤ãƒ«åˆ†é¡ç”¨ï¼‰
- è«‹æ±‚ç¨®åˆ¥ï¼ˆæœˆæ¬¡ãƒ»å¹´æ¬¡ãƒ»ä¸€æ™‚è«‹æ±‚ç­‰ï¼‰
- è«‹æ±‚å…ƒè©³ç´°ï¼ˆæ”¯åº—åã€éƒ¨ç½²åç­‰ï¼‰

#### ğŸ¯ **å‡ºåŠ›ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ**
```json
{
  "issuer": "string | null",
  "payer": "string | null",
  "issue_date": "YYYY-MM-DD | null", 
  "due_date": "YYYY-MM-DD | null",
  "main_invoice_number": "string | null",
  "t_number": "string | null",
  "currency": "JPY | USD | EUR | null",
  "amount_inclusive_tax": "number | null",
  "amount_exclusive_tax": "number | null",
  "key_info": {
    "ã‚¢ã‚«ã‚¦ãƒ³ãƒˆID": "å€¤",
    "åˆ©ç”¨æœŸé–“": "å€¤",
    "ã‚µãƒ¼ãƒ“ã‚¹å": "å€¤",
    "è«‹æ±‚ç¨®åˆ¥": "å€¤"
  },
  "line_items": [
    {
      "description": "string | null",
      "quantity": "number | null", 
      "unit_price": "number | null",
      "amount": "number | null",
      "tax": "number | string | null"
    }
  ]
}
```

### 5.2. `master_matcher_prompt.json` - ä¼æ¥­åç…§åˆ

#### ğŸ¯ **å°‚é–€æ©Ÿèƒ½**
- **è¡¨è¨˜æºã‚Œå¯¾å¿œ**: æ³•äººæ ¼ã€ã‚µãƒ¼ãƒ“ã‚¹åã€è¨˜å·ãƒ»ã‚¹ãƒšãƒ¼ã‚¹æ­£è¦åŒ–
- **å¤šè¨€èªå¯¾å¿œ**: ã‚«ã‚¿ã‚«ãƒŠâ‡”è‹±èªã€æ¼¢å­—ç•°ä½“å­—å¯¾å¿œ
- **ç¢ºä¿¡åº¦ç®¡ç†**: 85%ä»¥ä¸Šã§ã®ã¿ç…§åˆæˆåŠŸ

#### ğŸ”„ **ç…§åˆãƒ—ãƒ­ã‚»ã‚¹**
1. **å®Œå…¨ä¸€è‡´ãƒã‚§ãƒƒã‚¯** (ç¢ºä¿¡åº¦95%)
2. **æ³•äººæ ¼æ­£è¦åŒ–** (ç¢ºä¿¡åº¦90%)  
3. **ã‚µãƒ¼ãƒ“ã‚¹åå¤‰æ›** (ç¢ºä¿¡åº¦88%)
4. **é¡ä¼¼åº¦è¨ˆç®—** (ç¢ºä¿¡åº¦60-84%)

### 5.3. `integrated_matcher_prompt.json` - æœ€çµ‚ç…§åˆ

#### ğŸ¯ **çµ±åˆåˆ¤å®šæ©Ÿèƒ½** 
- **å¤šè¦ç´ è©•ä¾¡**: ã‚­ãƒ¼æƒ…å ±(40%) + é‡‘é¡(30%) + æ—¥ä»˜(20%) + æ˜ç´°(10%)
- **ãƒªã‚¢ãƒ«ãƒ‡ãƒ¼ã‚¿å¯¾å¿œ**: SaaSã€åºƒå‘Šè²»ã€ã‚¯ãƒ©ã‚¦ãƒ‰ã‚µãƒ¼ãƒ“ã‚¹ç­‰
- **ç¢ºä¿¡åº¦ç®¡ç†**: 75%ä»¥ä¸Šã§ã®ã¿ç…§åˆæˆåŠŸ

## 6. ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆé‹ç”¨ãƒ»ä¿å®ˆ

### 6.1. ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç®¡ç†
- **ã‚»ãƒãƒ³ãƒ†ã‚£ãƒƒã‚¯ãƒãƒ¼ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°**: `major.minor.patch`
- **å¤‰æ›´ãƒ­ã‚°**: å„JSONãƒ•ã‚¡ã‚¤ãƒ«å†…ã«versionå±¥æ­´è¨˜éŒ²
- **ãƒ†ã‚¹ãƒˆé§†å‹•**: ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚¢ãƒƒãƒ—æ™‚ã®å›å¸°ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ

### 6.2. å“è³ªä¿è¨¼
- **ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹å®Ÿè¡Œ**: å„ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®`test_cases`ã«ã‚ˆã‚‹æ¤œè¨¼
- **ç¢ºä¿¡åº¦ç›£è¦–**: é–¾å€¤ã‚’ä¸‹å›ã‚‹å ´åˆã®ã‚¢ãƒ©ãƒ¼ãƒˆ
- **ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°**: ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆèª­ã¿è¾¼ã¿å¤±æ•—æ™‚ã®ä»£æ›¿å‡¦ç†

### 6.3. è¨­å®šç®¡ç†ï¼ˆv4.0 40ã‚«ãƒ©ãƒ å¯¾å¿œï¼‰
```python
# è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã§ã®é–¾å€¤èª¿æ•´ä¾‹ï¼ˆ40ã‚«ãƒ©ãƒ å¯¾å¿œï¼‰
PROMPT_CONFIG = {
    # åŸºæœ¬ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
    "invoice_extractor": {
        "confidence_threshold": 0.90,
        "timeout_seconds": 30
    },
    "master_matcher": {
        "confidence_threshold": 0.85,
        "retry_count": 3
    },
    # v4.0æ–°æ©Ÿèƒ½ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
    "gmail_integration": {
        "confidence_threshold": 0.85,
        "timeout_seconds": 20,
        "enable_metadata_extraction": True
    },
    "currency_conversion": {
        "confidence_threshold": 0.90,
        "timeout_seconds": 25,
        "support_currencies": ["USD", "EUR", "GBP", "CNY"]
    },
    "approval_workflow": {
        "confidence_threshold": 0.80,
        "timeout_seconds": 15,
        "auto_approval_limit": 50000
    },
    "freee_integration": {
        "confidence_threshold": 0.85,
        "timeout_seconds": 30,
        "default_account_title": "æ”¯æ‰•æ‰‹æ•°æ–™"
    },
    "40column_complete": {
        "confidence_threshold": 0.88,
        "timeout_seconds": 60,
        "enable_all_features": True,
        "fallback_to_basic": True
    }
}
```

## 7. ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°çµ±ä¸€ä»•æ§˜

### 7.1. ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ¬ãƒ™ãƒ«ã‚¨ãƒ©ãƒ¼
- **ãƒ•ã‚¡ã‚¤ãƒ«ä¸å­˜åœ¨**: ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã¸ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
- **JSONå½¢å¼ã‚¨ãƒ©ãƒ¼**: ãƒ‘ãƒ¼ã‚¹å¤±æ•—æ™‚ã®è©³ç´°ãƒ­ã‚°
- **å¤‰æ•°ä¸è¶³**: å¿…é ˆå¤‰æ•°æ¬ å¦‚æ™‚ã®æ˜ç¢ºãªã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸

### 7.2. å®Ÿè¡Œæ™‚ã‚¨ãƒ©ãƒ¼
- **APIå‘¼ã³å‡ºã—å¤±æ•—**: ãƒªãƒˆãƒ©ã‚¤æ©Ÿæ§‹ã¨ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆå‡¦ç†
- **ç¢ºä¿¡åº¦ä¸è¶³**: é–¾å€¤æœªæº€æ™‚ã®ä»£æ›¿ãƒ•ãƒ­ãƒ¼
- **å‡ºåŠ›å½¢å¼ä¸æ­£**: JSONãƒ‘ãƒ¼ã‚¹å¤±æ•—æ™‚ã®å¾©æ—§å‡¦ç†

## 8. ä»Šå¾Œã®æ‹¡å¼µäºˆå®š

### 8.1. è¿‘æ—¥å®Ÿè£…
- **å‹•çš„é–¾å€¤èª¿æ•´**: æˆåŠŸç‡ã«åŸºã¥ãè‡ªå‹•æœ€é©åŒ–
- **A/Bãƒ†ã‚¹ãƒˆæ©Ÿèƒ½**: è¤‡æ•°ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç‰ˆã®åŠ¹æœæ¸¬å®š
- **å¤šè¨€èªå¯¾å¿œ**: è‹±èªãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã¨ã®è‡ªå‹•åˆ‡ã‚Šæ›¿ãˆ

### 8.2. é•·æœŸæ§‹æƒ³
- **ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆè‡ªå‹•ç”Ÿæˆ**: AIã«ã‚ˆã‚‹ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆæ”¹å–„ææ¡ˆ
- **æ¥­ç•Œç‰¹åŒ–ç‰ˆ**: æ¥­ç¨®åˆ¥æœ€é©åŒ–ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
- **ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ å­¦ç¿’**: ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã«ã‚ˆã‚‹ç¶™ç¶šæ”¹å–„

---

## 9. v4.0æ–°æ©Ÿèƒ½ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆè©³ç´°ä»•æ§˜ â˜…NEWâ˜…

### 9.1. `gmail_integration_prompt.json` - Gmailé€£æºæƒ…å ±æŠ½å‡º

#### ğŸ¯ **å°‚é–€æ©Ÿèƒ½**
- **Gmailé€£æºã‚«ãƒ©ãƒ æŠ½å‡º**: sender_email, gmail_message_id, attachment_id
- **ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿è§£æ**: ãƒ¡ãƒ¼ãƒ«ãƒ˜ãƒƒãƒ€ãƒ¼æƒ…å ±ã‹ã‚‰è«‹æ±‚æ›¸é–¢é€£æƒ…å ±æŠ½å‡º
- **source_typeè‡ªå‹•è¨­å®š**: 'gmail'å€¤ã®è‡ªå‹•åˆ¤å®šãƒ»è¨­å®š

#### ğŸ“Š **å‡ºåŠ›ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ**
```json
{
  "source_type": "gmail",
  "sender_email": "billing@company.com",
  "gmail_message_id": "1234567890abcdef",
  "attachment_id": "ANGjdJ_abc123",
  "email_subject": "è«‹æ±‚æ›¸é€ä»˜ã®ã”æ¡ˆå†…",
  "email_date": "2025-01-28T14:30:00Z"
}
```

### 9.2. `currency_conversion_prompt.json` - å¤–è²¨æ›ç®—æƒ…å ±æŠ½å‡º

#### ğŸ¯ **å°‚é–€æ©Ÿèƒ½**
- **é€šè²¨æƒ…å ±å¼·åŒ–æŠ½å‡º**: currencyè©³ç´°è­˜åˆ¥ï¼ˆUSD, EUR, GBPç­‰ï¼‰
- **ç‚ºæ›¿ãƒ¬ãƒ¼ãƒˆæ¤œå‡º**: è«‹æ±‚æ›¸å†…è¨˜è¼‰ã®ç‚ºæ›¿ãƒ¬ãƒ¼ãƒˆæŠ½å‡º
- **é‡‘é¡è¨ˆç®—æ”¯æ´**: å¤–è²¨é‡‘é¡ãƒ»å††æ›ç®—é‡‘é¡ã®å¯¾å¿œé–¢ä¿‚è§£æ

#### ğŸ“Š **å‡ºåŠ›ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ**
```json
{
  "currency": "USD",
  "foreign_amount": 1000.00,
  "exchange_rate": 149.85,
  "jpy_amount": 149850,
  "rate_date": "2025-01-28",
  "conversion_note": "Invoice stated rate",
  "card_statement_id": "CARD-2025-001"
}
```

### 9.3. `approval_workflow_prompt.json` - æ‰¿èªãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼åˆ¤å®š

#### ğŸ¯ **å°‚é–€æ©Ÿèƒ½**
- **æ‰¿èªè¦å¦åˆ¤å®š**: é‡‘é¡ãƒ»å–å¼•å…ˆãƒ»å†…å®¹ã«ã‚ˆã‚‹æ‰¿èªè¦å¦è‡ªå‹•åˆ¤å®š
- **æ‰¿èªãƒ¬ãƒ™ãƒ«åˆ¤å®š**: pending/approved/rejected/requires_reviewè‡ªå‹•åˆ†é¡
- **æ‰¿èªæ¡ä»¶è©•ä¾¡**: äº‹å‰å®šç¾©ãƒ«ãƒ¼ãƒ«ã«åŸºã¥ãæ‰¿èªçŠ¶æ³è©•ä¾¡

#### ğŸ“Š **å‡ºåŠ›ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ**
```json
{
  "approval_status": "pending",
  "approval_required": true,
  "approval_reason": "é‡‘é¡ãŒæ‰¿èªé–¾å€¤ã‚’è¶…é",
  "recommended_approver": "éƒ¨é•·",
  "urgency_level": "medium",
  "auto_approval_eligible": false
}
```

### 9.4. `freee_integration_prompt.json` - freeeé€£æºæƒ…å ±æŠ½å‡º

#### ğŸ¯ **å°‚é–€æ©Ÿèƒ½**
- **ä¼šè¨ˆç§‘ç›®ãƒãƒƒãƒ”ãƒ³ã‚°**: è«‹æ±‚å†…å®¹ã‹ã‚‰é©åˆ‡ãªä¼šè¨ˆç§‘ç›®è‡ªå‹•åˆ¤å®š
- **freeeé€£æºæº–å‚™**: å‹˜å®šç§‘ç›®ãƒ»ç¨åŒºåˆ†ãƒ»éƒ¨é–€æƒ…å ±ã®æ§‹é€ åŒ–
- **ä»•è¨³æ”¯æ´**: å€Ÿæ–¹ãƒ»è²¸æ–¹æƒ…å ±ã®è‡ªå‹•ç”Ÿæˆæ”¯æ´

#### ğŸ“Š **å‡ºåŠ›ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ**
```json
{
  "account_title": "æ”¯æ‰•æ‰‹æ•°æ–™",
  "tax_category": "èª²ç¨ä»•å…¥",
  "department": "å–¶æ¥­éƒ¨",
  "project_code": "PRJ-2025-001",
  "freee_ready": true,
  "journal_memo": "ã‚·ã‚¹ãƒ†ãƒ åˆ©ç”¨æ–™_2025å¹´1æœˆåˆ†"
}
```

### 9.5. `40column_complete_prompt.json` - 40ã‚«ãƒ©ãƒ å®Œå…¨æŠ½å‡º

#### ğŸ¯ **çµ±åˆæ©Ÿèƒ½**
- **å…¨ã‚«ãƒ©ãƒ ä¸€æ‹¬æŠ½å‡º**: 40ã‚«ãƒ©ãƒ å…¨å¯¾å¿œã®åŒ…æ‹¬çš„æƒ…å ±æŠ½å‡º
- **æ–°æ©Ÿèƒ½çµ±åˆ**: Gmailãƒ»å¤–è²¨ãƒ»æ‰¿èªãƒ»freeeæƒ…å ±ã®çµ±åˆå‡¦ç†
- **å“è³ªä¿è¨¼**: å…¨ã‚«ãƒ©ãƒ ã®æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯ãƒ»è£œå®Œå‡¦ç†

#### ğŸ“Š **å®Œå…¨å‡ºåŠ›ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ**
```json
{
  // åŸºæœ¬æƒ…å ±ï¼ˆ6ã‚«ãƒ©ãƒ ï¼‰
  "id": null,
  "user_email": "user@company.com",
  "status": "extracted",
  "uploaded_at": "2025-01-28T15:00:00+09:00",
  "created_at": "2025-01-28T15:00:00+09:00",
  "updated_at": "2025-01-28T15:00:00+09:00",
  
  // ãƒ•ã‚¡ã‚¤ãƒ«ç®¡ç†ï¼ˆ7ã‚«ãƒ©ãƒ ï¼‰
  "file_name": "invoice_202501.pdf",
  "gdrive_file_id": "1ABC123...",
  "file_path": "/invoices/2025/01/",
  "source_type": "gmail",
  "gmail_message_id": "1234567890",
  "attachment_id": "ANGjdJ_abc",
  "sender_email": "billing@company.com",
  
  // è«‹æ±‚æ›¸åŸºæœ¬ï¼ˆ7ã‚«ãƒ©ãƒ ï¼‰
  "issuer_name": "æ ªå¼ä¼šç¤¾ã‚µãƒ³ãƒ—ãƒ«",
  "recipient_name": "æ ªå¼ä¼šç¤¾ãƒ¦ãƒ¼ã‚¶ãƒ¼",
  "main_invoice_number": "INV-2025-001",
  "receipt_number": "REC-2025-001",
  "t_number": "T1234567890123",
  "issue_date": "2025-01-20",
  "due_date": "2025-02-20",
  
  // é‡‘é¡ãƒ»é€šè²¨ï¼ˆ6ã‚«ãƒ©ãƒ ï¼‰
  "currency": "USD",
  "total_amount_tax_included": 1000.00,
  "total_amount_tax_excluded": 909.09,
  "exchange_rate": 149.85,
  "jpy_amount": 149850,
  "card_statement_id": "CARD-2025-001",
  
  // AIå‡¦ç†ï¼ˆ8ã‚«ãƒ©ãƒ ï¼‰
  "extracted_data": { "å®Œå…¨æŠ½å‡ºãƒ‡ãƒ¼ã‚¿" },
  "raw_response": { "AIç”Ÿãƒ¬ã‚¹ãƒãƒ³ã‚¹" },
  "key_info": { "ã‚­ãƒ¼æƒ…å ±" },
  "is_valid": true,
  "validation_errors": [],
  "validation_warnings": [],
  "completeness_score": 95.5,
  "processing_time": 3.2,
  
  // æ‰¿èªãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ï¼ˆ3ã‚«ãƒ©ãƒ ï¼‰
  "approval_status": "pending",
  "approved_by": null,
  "approved_at": null,
  
  // freeeé€£æºï¼ˆ3ã‚«ãƒ©ãƒ ï¼‰
  "exported_to_freee": false,
  "export_date": null,
  "freee_batch_id": null
}
```

### 9.6. æ–°æ©Ÿèƒ½ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆçµ±åˆç®¡ç†

#### ğŸ”„ **UnifiedPromptManageré€£æº**
```python
# æ–°æ©Ÿèƒ½ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆä½¿ç”¨ä¾‹
prompt_manager = UnifiedPromptManager()

# Gmailé€£æºæ™‚ã®è‡ªå‹•ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆé¸æŠ
if source_type == 'gmail':
    prompt = prompt_manager.get_gmail_integration_prompt(email_context)
    
# å¤–è²¨è«‹æ±‚æ›¸ã®å ´åˆ
if currency != 'JPY':
    prompt = prompt_manager.get_currency_conversion_prompt(currency_context)
    
# 40ã‚«ãƒ©ãƒ å®Œå…¨æŠ½å‡º
prompt = prompt_manager.get_40column_complete_prompt(extraction_context)
```

#### ğŸ“Š **ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆé€£æºãƒ•ãƒ­ãƒ¼**
1. **å…¥åŠ›åˆ¤å®š**: source_type, currencyç­‰ã«ã‚ˆã‚‹è‡ªå‹•åˆ¤å®š
2. **ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆé¸æŠ**: æœ€é©ãªå°‚ç”¨ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆè‡ªå‹•é¸æŠ
3. **çµ±åˆå®Ÿè¡Œ**: è¤‡æ•°ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®é †æ¬¡ã¾ãŸã¯ä¸¦åˆ—å®Ÿè¡Œ
4. **çµæœçµ±åˆ**: å„ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆçµæœã®çµ±åˆãƒ»æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯

---

**æœ€çµ‚æ›´æ–°**: 2025å¹´7æœˆ28æ—¥  
**v4.0é‡è¦æˆæœ**: 40ã‚«ãƒ©ãƒ æ–°æ©Ÿèƒ½ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆå®Œå…¨å¯¾å¿œãƒ»Gmailé€£æºãƒ»å¤–è²¨æ›ç®—ãƒ»æ‰¿èªãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãƒ»freeeé€£æºãƒ—ãƒ­ãƒ³ãƒ—ãƒˆä»•æ§˜ç­–å®šå®Œäº†