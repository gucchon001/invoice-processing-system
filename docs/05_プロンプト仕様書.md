# プロンプト仕様書

**バージョン:** 3.0
**作成日:** 2025/07/17
**最終更新:** 2025/01/20 (JSON外出し・キー情報強化版)

## 1. 概要

本ドキュメントは、請求書処理自動化システムで使用されるGemini APIへの指示書（プロンプト）の仕様を定義する。プロンプトはすべて**JSON形式**で`/prompts`ディレクトリに管理し、**ハードコーディングを完全に排除**して保守性・拡張性を最大化する。

### 🎯 **設計方針（3.0版）**

- **📁 完全外出し**: ソースコードからプロンプト文言を完全分離
- **🔄 動的ロード**: 実行時にJSONファイルからプロンプトを読み込み  
- **🔧 バージョン管理**: プロンプトの独立したバージョニング
- **📊 構造化管理**: JSON schema準拠の統一フォーマット
- **🎛️ 設定可能**: 確信度閾値、優先度等の動的調整
- **🧪 テスト駆動**: テストケース内蔵による品質保証

## 2. JSONプロンプト構造仕様

### 2.1. 標準JSONスキーマ

```json
{
  "name": "プロンプト表示名",
  "version": "セマンティックバージョン(例: 2.0)",
  "description": "プロンプトの目的と機能の説明",
  "confidence_threshold": 0.80,
  "priority": "highest | high | medium | low",
  "prompt_template": "実際のプロンプト文字列（変数置換対応）",
  "variables": {
    "変数名": {
      "type": "string | number | array | object | image",
      "description": "変数の説明",
      "required": true | false,
      "default": "デフォルト値（任意）",
      "example": "使用例",
      "formats": ["対応フォーマット（画像等）"]
    }
  },
  "test_cases": [
    {
      "name": "テストケース名",
      "input": { "テスト入力データ" },
      "expected_output": { "期待される出力" }
    }
  ]
}
```

## 3. 現在のプロンプト一覧

| JSONファイル名 | プロンプト名 | 主要機能 | 確信度要求 | 優先度 |
|:---|:---|:---|:---|:---|
| `invoice_extractor_prompt.json` | 請求書情報抽出専門家 | PDFから構造化データ+**キー情報**抽出 | 90%以上 | **最高** |
| `master_matcher_prompt.json` | 企業名表記揺れ照合専門家 | 請求元名と支払マスタの照合 | 85%以上 | **最高** |
| `integrated_matcher_prompt.json` | 請求書明細照合専門家 | 詳細情報による最終仕訳特定 | 75%以上 | **最高** |

## 4. ハードコーディング外出し実装方式

### 4.1. プロンプトローダークラス設計

```python
class PromptManager:
    """JSONプロンプトの動的ロード・管理クラス"""
    
    def __init__(self, prompts_dir: str = "./prompts"):
        self.prompts_dir = prompts_dir
        self.loaded_prompts = {}
    
    def load_prompt(self, prompt_name: str) -> dict:
        """指定されたプロンプトJSONを読み込み"""
        file_path = f"{self.prompts_dir}/{prompt_name}.json"
        with open(file_path, 'r', encoding='utf-8') as f:
            return json.load(f)
    
    def render_prompt(self, prompt_name: str, variables: dict) -> str:
        """変数を置換してプロンプト文字列を生成"""
        prompt_data = self.load_prompt(prompt_name)
        template = prompt_data["prompt_template"]
        
        # 変数置換処理
        for var_name, var_value in variables.items():
            placeholder = f"{{{var_name}}}"
            template = template.replace(placeholder, str(var_value))
        
        return template
    
    def validate_inputs(self, prompt_name: str, inputs: dict) -> bool:
        """入力変数の妥当性検証"""
        prompt_data = self.load_prompt(prompt_name)
        variables_spec = prompt_data.get("variables", {})
        
        # 必須変数チェック
        for var_name, var_spec in variables_spec.items():
            if var_spec.get("required", False) and var_name not in inputs:
                raise ValueError(f"必須変数 '{var_name}' が未提供")
        
        return True
```

### 4.2. 使用例

```python
# プロンプト管理インスタンス初期化
prompt_mgr = PromptManager("./prompts")

# 請求書抽出プロンプト使用例
def extract_invoice_data(pdf_blob):
    try:
        # 入力変数準備
        variables = {
            "invoice_image": pdf_blob,
            "extraction_mode": "comprehensive"
        }
        
        # 入力検証
        prompt_mgr.validate_inputs("invoice_extractor_prompt", variables)
        
        # プロンプト生成
        prompt_text = prompt_mgr.render_prompt("invoice_extractor_prompt", variables)
        
        # Gemini API呼び出し
        response = gemini_client.generate_content(prompt_text)
        return json.loads(response.text)
        
    except Exception as e:
        logging.error(f"請求書抽出エラー: {e}")
        return None
```

## 5. 詳細プロンプト仕様

### 5.1. `invoice_extractor_prompt.json` - **キー情報強化版**

#### 📋 **基本機能**
- 請求書PDFから基本項目（請求元、金額、日付等）抽出
- **システム処理用キー情報**の高精度抽出
- 重複判定・ファイル管理・企業特定支援情報の生成

#### 🔑 **キー情報抽出機能（強化版）**

**【最優先】企業・アカウント特定用キー（マッチング精度向上）**
```json
{
  "key_info": {
    "アカウントID": "01B060-1925C3-38EE2B",
    "契約番号": "C-2025-001234",
    "顧客コード": "CUST-789012",
    "請求先コード": "BILL-001"
  }
}
```

**【高優先】重複判定用キー（ユニークID生成）**
- 利用期間、請求対象期間、取引ID
- 請求書番号補完情報、参照番号
- 金額詳細分類、手数料情報

**【中優先】ファイル管理・分類用キー**
- サービス名・プラン名（ファイル分類用）
- 請求種別（月次・年次・一時請求等）
- 請求元詳細（支店名、部署名等）

#### 🎯 **出力フォーマット**
```json
{
  "issuer": "string | null",
  "payer": "string | null",
  "issue_date": "YYYY-MM-DD | null", 
  "due_date": "YYYY-MM-DD | null",
  "main_invoice_number": "string | null",
  "t_number": "string | null",
  "currency": "JPY | USD | EUR | null",
  "amount_inclusive_tax": "number | null",
  "amount_exclusive_tax": "number | null",
  "key_info": {
    "アカウントID": "値",
    "利用期間": "値",
    "サービス名": "値",
    "請求種別": "値"
  },
  "line_items": [
    {
      "description": "string | null",
      "quantity": "number | null", 
      "unit_price": "number | null",
      "amount": "number | null",
      "tax": "number | string | null"
    }
  ]
}
```

### 5.2. `master_matcher_prompt.json` - 企業名照合

#### 🎯 **専門機能**
- **表記揺れ対応**: 法人格、サービス名、記号・スペース正規化
- **多言語対応**: カタカナ⇔英語、漢字異体字対応
- **確信度管理**: 85%以上でのみ照合成功

#### 🔄 **照合プロセス**
1. **完全一致チェック** (確信度95%)
2. **法人格正規化** (確信度90%)  
3. **サービス名変換** (確信度88%)
4. **類似度計算** (確信度60-84%)

### 5.3. `integrated_matcher_prompt.json` - 最終照合

#### 🎯 **統合判定機能** 
- **多要素評価**: キー情報(40%) + 金額(30%) + 日付(20%) + 明細(10%)
- **リアルデータ対応**: SaaS、広告費、クラウドサービス等
- **確信度管理**: 75%以上でのみ照合成功

## 6. プロンプト運用・保守

### 6.1. バージョン管理
- **セマンティックバージョニング**: `major.minor.patch`
- **変更ログ**: 各JSONファイル内にversion履歴記録
- **テスト駆動**: バージョンアップ時の回帰テスト実行

### 6.2. 品質保証
- **テストケース実行**: 各プロンプトの`test_cases`による検証
- **確信度監視**: 閾値を下回る場合のアラート
- **エラーハンドリング**: プロンプト読み込み失敗時の代替処理

### 6.3. 設定管理
```python
# 設定ファイルでの閾値調整例
PROMPT_CONFIG = {
    "invoice_extractor": {
        "confidence_threshold": 0.90,
        "timeout_seconds": 30
    },
    "master_matcher": {
        "confidence_threshold": 0.85,
        "retry_count": 3
    }
}
```

## 7. エラーハンドリング統一仕様

### 7.1. プロンプトレベルエラー
- **ファイル不存在**: デフォルトプロンプトへフォールバック
- **JSON形式エラー**: パース失敗時の詳細ログ
- **変数不足**: 必須変数欠如時の明確なエラーメッセージ

### 7.2. 実行時エラー
- **API呼び出し失敗**: リトライ機構とタイムアウト処理
- **確信度不足**: 閾値未満時の代替フロー
- **出力形式不正**: JSONパース失敗時の復旧処理

## 8. 今後の拡張予定

### 8.1. 近日実装
- **動的閾値調整**: 成功率に基づく自動最適化
- **A/Bテスト機能**: 複数プロンプト版の効果測定
- **多言語対応**: 英語プロンプトとの自動切り替え

### 8.2. 長期構想
- **プロンプト自動生成**: AIによるプロンプト改善提案
- **業界特化版**: 業種別最適化プロンプト
- **リアルタイム学習**: ユーザーフィードバックによる継続改善