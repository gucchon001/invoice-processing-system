# エラーハンドリング仕様書

**バージョン:** 1.0
**作成日:** 2025/07/17

## 1. 概要
本ドキュメントは、請求書処理自動化システムで発生しうるエラーを分類し、それぞれの検知、記録、通知、および復旧方法に関する仕様を定義する。適切なエラーハンドリングにより、システムの堅牢性を高め、問題発生時の迅速な原因究明と対応を可能にすることを目的とする。

## 2. エラー分類
システムで発生するエラーは、以下の3つに大別される。

| 分類 | 説明 | 具体例 |
| :--- | :--- | :--- |
| **ユーザー起因エラー** | ユーザーの不正な入力や操作によって発生する、予測可能なエラー。 | ・PDF以外のファイルをアップロード<br>・必須項目が未入力のまま保存しようとする |
| **外部APIエラー** | 連携している外部サービス（Gemini, Supabase, Google API等）の障害や仕様変更、認証失敗によって発生するエラー。 | ・Gemini APIがタイムアウトする<br>・SupabaseのAPIキーが無効<br>・Google Driveのアクセス権限がない |
| **システム内部エラー** | プログラムのバグや、予期せぬデータ形式など、アプリケーション内部のロジックに起因する予期せぬエラー。 | ・データベースから取得したデータが\`null\`であることを想定していない<br>・特定の請求書フォーマットで処理が停止する |

## 3. エラーハンドリング仕様

### 3.1. 基本方針
* すべてのエラーは、\`try...catch\`（Pythonでは\`try...except\`）ブロックで捕捉する。
* 捕捉したエラーは、必ずログに記録する。
* ユーザーにエラーをフィードバックする際は、技術的な詳細を隠蔽し、分かりやすいメッセージを表示する。

### 3.2. エラー処理フロー

\`\`\`mermaid
graph TD
    A[処理実行] --> B{エラー発生};
    B -->|Yes| C[エラーを捕捉];
    C --> D[ログに詳細を記録];
    D --> E{エラー分類};
    E -->|ユーザー起因| F[UIに分かりやすい<br>エラーメッセージを表示];
    E -->|外部API/システム内部| G[UIに汎用的な<br>エラーメッセージを表示];
    G --> H[管理者にメールで<br>緊急通知];
    B -->|No| I[正常終了];
\`\`\`

### 3.3. ログ記録仕様

#### 3.3.1. ログ設定
* **設定ファイル:** `config/settings.ini` で統一管理
* **ログファイル:** `logs/app.log` (自動ローテーション対応)
* **エンコーディング:** UTF-8
* **ローテーション:** 10MB超過時に自動実行、5世代保持

#### 3.3.2. ログレベル定義
* **DEBUG:** デバッグ用詳細情報（開発・検証時のみ有効）
* **INFO:** 通常の処理フロー（例：\`ファイルアップロード成功\`、\`ユーザーログイン\`）
* **WARNING:** 処理は続行できるが、注意が必要な事象（例：\`支払マスタの候補が複数あり、AIが判断\`、\`API応答遅延\`）
* **ERROR:** 処理が中断されたエラー（例：\`ファイル処理失敗\`、\`API呼び出しエラー\`）
* **CRITICAL:** システム停止レベルの重大エラー

#### 3.3.3. 記録内容
* **基本情報:**
  - **タイムスタンプ:** エラー発生日時 (YYYY-MM-DD HH:MM:SS形式)
  - **ログレベル:** DEBUG / INFO / WARNING / ERROR / CRITICAL
  - **モジュール名:** ログを出力したPythonモジュール名
  - **メッセージ:** ログメッセージ本文

* **エラー時の追加情報:**
  - **関連ID:** 請求書ID (\`invoice_id\`)、ユーザーEmail (\`user_email\`)
  - **関数名:** エラーが発生した関数名 (詳細モード時)
  - **ファイル名・行番号:** エラー発生箇所 (詳細モード時)
  - **エラーメッセージ:** エラーオブジェクトのメッセージ
  - **スタックトレース:** エラー発生箇所の詳細な追跡情報（システム内部エラーの場合）

#### 3.3.4. カテゴリ別デバッグログ
デバッグモード時に、機能別の詳細ログを出力：
* **[DATABASE]** データベース操作の詳細
* **[AI]** Gemini API処理の詳細
* **[GDRIVE]** Google Drive API操作の詳細
* **[STREAMLIT]** Streamlit関連の詳細

### 3.4. ユーザーへの通知
* **ユーザー起因エラーの場合:**
    * **例:** 「PDFファイルのみアップロードできます。」「必須項目『内容』を入力してください。」
    * **UI:** Streamlitの\`st.error()\`コンポーネントを使用し、該当の操作エリアの近くにメッセージを表示する。
* **システム/APIエラーの場合:**
    * **例:** 「エラーが発生しました。しばらくしてからもう一度お試しください。問題が解決しない場合は、管理者に連絡してください。(エラーコード: XXXXX)」
    * **UI:** 汎用的なエラーメッセージを表示し、ユーザーを混乱させないようにする。

### 3.5. 管理者への通知
* **トリガー:** ログレベルが\`ERROR\`のログが記録された場合。
* **手段:** メール
* **通知内容:**
    * **件名:** \`【要対応】請求書処理システムでエラーが発生しました\`
    * **本文:** ログに記録された内容（タイムスタンプ、関連ID、エラーメッセージ等）を記載し、迅速な原因調査を促す。