# Googleèªè¨¼Ã—ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒ èªè¨¼æ–¹å¼æ¯”è¼ƒæ¤œè¨è³‡æ–™

**ä½œæˆæ—¥:** 2025å¹´1æœˆ15æ—¥  
**ãƒãƒ¼ã‚¸ãƒ§ãƒ³:** 1.0  
**å¯¾è±¡ã‚·ã‚¹ãƒ†ãƒ :** è«‹æ±‚æ›¸å‡¦ç†è‡ªå‹•åŒ–ã‚·ã‚¹ãƒ†ãƒ   
**æ¤œè¨è€…:** é–‹ç™ºãƒãƒ¼ãƒ   

---

## ğŸ“‹ ç›®æ¬¡

1. [æ¦‚è¦](#æ¦‚è¦)
2. [èªè¨¼æ–¹å¼ã®é¸æŠè‚¢](#èªè¨¼æ–¹å¼ã®é¸æŠè‚¢)
3. [è©³ç´°æ¯”è¼ƒè¡¨](#è©³ç´°æ¯”è¼ƒè¡¨)
4. [æ¡ä»¶åˆ†å²ãƒ•ãƒ­ãƒ¼](#æ¡ä»¶åˆ†å²ãƒ•ãƒ­ãƒ¼)
5. [å®Ÿè£…ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ](#å®Ÿè£…ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ)
6. [æ¨å¥¨æ±ºå®šãƒ—ãƒ­ã‚»ã‚¹](#æ¨å¥¨æ±ºå®šãƒ—ãƒ­ã‚»ã‚¹)
7. [å®Ÿè£…ä¾‹ã¨ã‚³ãƒ¼ãƒ‰](#å®Ÿè£…ä¾‹ã¨ã‚³ãƒ¼ãƒ‰)
8. [ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚¬ã‚¤ãƒ‰](#ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚¬ã‚¤ãƒ‰)
9. [ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°](#ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°)
10. [å°†æ¥ã¸ã®å½±éŸ¿ã¨è€ƒæ…®äº‹é …](#å°†æ¥ã¸ã®å½±éŸ¿ã¨è€ƒæ…®äº‹é …)

---

## æ¦‚è¦

### èƒŒæ™¯
Streamlitã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§ã®Googleèªè¨¼å®Ÿè£…ã«ãŠã„ã¦ã€ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºç’°å¢ƒã¨æœ¬ç•ªç’°å¢ƒã§ã®èªè¨¼æ–¹å¼é¸æŠãŒé‡è¦ãªæŠ€è¡“åˆ¤æ–­ã¨ãªã‚‹ã€‚æœ¬è³‡æ–™ã§ã¯ã€å„é¸æŠè‚¢ã®ç‰¹å¾´ã€ãƒ¡ãƒªãƒƒãƒˆãƒ»ãƒ‡ãƒ¡ãƒªãƒƒãƒˆã€å®Ÿè£…ã‚³ã‚¹ãƒˆã‚’è©³ç´°ã«æ¯”è¼ƒã—ã€æœ€é©ãªèªè¨¼æˆ¦ç•¥ã‚’æç¤ºã™ã‚‹ã€‚

### æ¤œè¨å¯¾è±¡
- **é–‹ç™ºç’°å¢ƒ**: ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºï¼ˆWindows PowerShellç’°å¢ƒï¼‰
- **æœ¬ç•ªç’°å¢ƒ**: Google Cloud Run
- **èªè¨¼ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼**: Google OAuth 2.0
- **ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯**: Streamlit

---

## èªè¨¼æ–¹å¼ã®é¸æŠè‚¢

### 1. Streamlitãƒã‚¤ãƒ†ã‚£ãƒ–èªè¨¼ â­â­â­â­â­

**æ¦‚è¦**: Streamlit v1.47.0ä»¥é™ã§æä¾›ã•ã‚Œã‚‹å…¬å¼èªè¨¼æ©Ÿèƒ½

**ç‰¹å¾´**:
- Streamlitå…¬å¼ã‚µãƒãƒ¼ãƒˆ
- è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿ã§å‹•ä½œ
- é–‹ç™ºè€…ä½“é¨“ãŒæœ€é«˜
- **åˆ¶ç´„**: ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒå°‚ç”¨

**å®Ÿè£…ä¾‹**:
```python
import streamlit as st

# ã‚·ãƒ³ãƒ—ãƒ«ãªèªè¨¼ãƒã‚§ãƒƒã‚¯
if not st.user:
    st.info("Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„")
    st.login()
    st.stop()

# èªè¨¼å¾Œã®å‡¦ç†
st.write(f"ã“ã‚“ã«ã¡ã¯ã€{st.user.name}ã•ã‚“")
```

### 2. streamlit-oauth â­â­â­â­

**æ¦‚è¦**: ã‚µãƒ¼ãƒ‰ãƒ‘ãƒ¼ãƒ†ã‚£ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã«ã‚ˆã‚‹OAuth 2.0å®Ÿè£…

**ç‰¹å¾´**:
- é–‹ç™ºãƒ»æœ¬ç•ªç’°å¢ƒçµ±ä¸€å¯èƒ½
- æŸ”è»Ÿãªè¨­å®šã‚ªãƒ—ã‚·ãƒ§ãƒ³
- OAuthæ¨™æº–æº–æ‹ 
- ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹

**å®Ÿè£…ä¾‹**:
```python
from streamlit_oauth import OAuth2Component

oauth2 = OAuth2Component(
    client_id=st.secrets["auth"]["client_id"],
    client_secret=st.secrets["auth"]["client_secret"],
    authorize_endpoint="https://accounts.google.com/o/oauth2/auth",
    token_endpoint="https://oauth2.googleapis.com/token",
)

result = oauth2.authorize_button(
    "Googleã§ãƒ­ã‚°ã‚¤ãƒ³",
    redirect_uri=st.secrets["auth"]["redirect_uri"],
    scope="openid email profile"
)
```

### 3. google-auth + ã‚«ã‚¹ã‚¿ãƒ å®Ÿè£… â­â­

**æ¦‚è¦**: Googleå…¬å¼ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ä½¿ç”¨ã—ãŸç‹¬è‡ªå®Ÿè£…

**ç‰¹å¾´**:
- å®Œå…¨ãªåˆ¶å¾¡ãŒå¯èƒ½
- Googleå…¬å¼ãƒ©ã‚¤ãƒ–ãƒ©ãƒªä½¿ç”¨
- **æ¬ ç‚¹**: å®Ÿè£…ã‚³ã‚¹ãƒˆãŒé«˜ã„
- **æ¬ ç‚¹**: OAuth ãƒ•ãƒ­ãƒ¼ã®æ‰‹å‹•å®Ÿè£…ãŒå¿…è¦

### 4. streamlit-authenticator + OAuth â­â­â­

**æ¦‚è¦**: æ±ç”¨èªè¨¼ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¨OAuthã®çµ„ã¿åˆã‚ã›

**ç‰¹å¾´**:
- è±Šå¯Œãªèªè¨¼ã‚ªãƒ—ã‚·ãƒ§ãƒ³
- JWT ãƒˆãƒ¼ã‚¯ãƒ³ç®¡ç†
- **æ¬ ç‚¹**: éå‰°æ©Ÿèƒ½ã§ã‚ªãƒ¼ãƒãƒ¼ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ãƒªãƒ³ã‚°
- **æ¬ ç‚¹**: Googleèªè¨¼ã«ç‰¹åŒ–ã—ã¦ã„ãªã„

---

## è©³ç´°æ¯”è¼ƒè¡¨

| é …ç›® | Streamlitãƒã‚¤ãƒ†ã‚£ãƒ– | streamlit-oauth | google-auth + ã‚«ã‚¹ã‚¿ãƒ  | streamlit-authenticator |
|------|-------------------|-----------------|----------------------|------------------------|
| **å®Ÿè£…é›£æ˜“åº¦** | â­â­â­â­â­ (æœ€æ˜“) | â­â­â­â­ (æ˜“) | â­â­ (å›°é›£) | â­â­â­ (ä¸­) |
| **é–‹ç™ºæ™‚é–“** | 30åˆ† | 2-3æ™‚é–“ | 1-2æ—¥ | åŠæ—¥ |
| **æœ¬ç•ªå¯¾å¿œ** | âŒ (ä¸å¯) | âœ… (å¯¾å¿œ) | âœ… (å¯¾å¿œ) | âœ… (å¯¾å¿œ) |
| **ä¿å®ˆæ€§** | â­â­â­â­â­ | â­â­â­â­ | â­â­ | â­â­â­ |
| **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£** | â­â­â­â­ | â­â­â­â­ | â­â­â­ | â­â­â­â­ |
| **ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºæ€§** | â­â­ (åˆ¶é™) | â­â­â­â­ (é«˜) | â­â­â­â­â­ (æœ€é«˜) | â­â­â­â­ (é«˜) |
| **ä¾å­˜é–¢ä¿‚** | ãªã— | è»½é‡ | ä¸­ç¨‹åº¦ | é‡ã„ |
| **ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ** | å…¬å¼è±Šå¯Œ | å……å®Ÿ | è‡ªä½œå¿…è¦ | å……å®Ÿ |
| **ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£** | å¤§ | ä¸­ | å° | ä¸­ |
| **å°†æ¥æ€§** | é«˜ | ä¸­ | ä½ | ä¸­ |
| **ç·åˆè©•ä¾¡** | é–‹ç™º: â­â­â­â­â­<br/>æœ¬ç•ª: âŒ | â­â­â­â­ | â­â­ | â­â­â­ |

---

## æ¡ä»¶åˆ†å²ãƒ•ãƒ­ãƒ¼

### ğŸ”„ èªè¨¼æ–¹å¼é¸æŠãƒ•ãƒ­ãƒ¼ãƒãƒ£ãƒ¼ãƒˆ

```mermaid
graph TD
    A[Googleèªè¨¼ãŒå¿…è¦] --> B{æœ¬ç•ªç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤ãŒå¿…è¦ï¼Ÿ}
    
    B -->|No<br/>ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºã®ã¿| C[Streamlit<br/>ãƒã‚¤ãƒ†ã‚£ãƒ–èªè¨¼]
    B -->|Yes| D{é–‹ç™ºå·¥æ•°ã®åˆ¶ç´„ã¯ï¼Ÿ}
    
    D -->|çŸ­æœŸé–“<br/>2-3æ™‚é–“ä»¥å†…| E[streamlit-oauth]
    D -->|ä¸­æœŸé–“<br/>æ•°æ—¥å¯èƒ½| F{ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºè¦ä»¶ã¯ï¼Ÿ}
    
    F -->|é«˜ã„<br/>ç‹¬è‡ªè¦ä»¶å¤šæ•°| G[google-auth +<br/>ã‚«ã‚¹ã‚¿ãƒ å®Ÿè£…]
    F -->|æ¨™æº–çš„| H[streamlit-oauth]
    
    C --> C1[âœ… æœ€é€Ÿé–‹ç™º<br/>âœ… å…¬å¼ã‚µãƒãƒ¼ãƒˆ<br/>âŒ æœ¬ç•ªç§»è¡Œæ™‚å†å®Ÿè£…]
    E --> E1[âœ… çµ±ä¸€ã‚³ãƒ¼ãƒ‰ãƒ™ãƒ¼ã‚¹<br/>âœ… æœ¬ç•ªå¯¾å¿œ<br/>âš¡ 2-3æ™‚é–“ã§å®Œæˆ]
    G --> G1[âœ… å®Œå…¨åˆ¶å¾¡<br/>âŒ é«˜å®Ÿè£…ã‚³ã‚¹ãƒˆ<br/>âŒ ä¿å®ˆè² æ‹…]
    H --> H1[âœ… ãƒãƒ©ãƒ³ã‚¹è‰¯å¥½<br/>âœ… æœ¬ç•ªå¯¾å¿œ<br/>âœ… é©åº¦ãªæŸ”è»Ÿæ€§]
    
    style C fill:#c8e6c9
    style E fill:#81c784
    style H fill:#81c784
    style G fill:#ffcc02
```

### ğŸ¯ æ®µéšçš„ã‚¢ãƒ—ãƒ­ãƒ¼ãƒï¼ˆéæ¨å¥¨â†’æ¨å¥¨ï¼‰

```mermaid
graph LR
    A[é–‹ç™ºé–‹å§‹<br/>ãƒ•ã‚§ãƒ¼ã‚º1-2] --> B[Streamlit<br/>ãƒã‚¤ãƒ†ã‚£ãƒ–èªè¨¼]
    B --> C[æœ¬ç•ªæº–å‚™<br/>ãƒ•ã‚§ãƒ¼ã‚º3-4] 
    C --> D[streamlit-oauth<br/>ã«ç§»è¡Œ]
    
    B --> B1[âš¡ è¶…é«˜é€Ÿé–‹ç™º<br/>âš¡ å³åº§ã«å‹•ä½œ<br/>âš¡ ãƒ‡ãƒãƒƒã‚°ç°¡å˜]
    D --> D1[ğŸš€ æœ¬ç•ªå¯¾å¿œ<br/>ğŸš€ çµ±ä¸€ã‚³ãƒ¼ãƒ‰<br/>ğŸš€ ã‚¹ã‚±ãƒ¼ãƒ©ãƒ–ãƒ«]
    
    style A fill:#e1f5fe
    style B fill:#ffccbc  
    style C fill:#fff3e0
    style D fill:#c8e6c9
    
    B -.->|âŒ éæ¨å¥¨<br/>ç§»è¡Œã‚³ã‚¹ãƒˆç™ºç”Ÿ| X[æ®µéšçš„ç§»è¡Œã®<br/>ãƒ‡ãƒ¡ãƒªãƒƒãƒˆ]
    X -.-> X1[âš ï¸ äºŒé‡å®Ÿè£…<br/>âš ï¸ ãƒ†ã‚¹ãƒˆå·¥æ•°å¢—<br/>âš ï¸ ãƒã‚°ãƒªã‚¹ã‚¯]
    
    style X fill:#ffcdd2
    style X1 fill:#ffcdd2
```

### âœ… çµ±ä¸€ã‚¢ãƒ—ãƒ­ãƒ¼ãƒï¼ˆæ¨å¥¨ï¼‰

```mermaid
graph LR
    A[é–‹ç™ºé–‹å§‹] --> B[streamlit-oauth<br/>çµ±ä¸€èªè¨¼]
    B --> C[é–‹ç™ºç’°å¢ƒ<br/>localhost:8501]
    B --> D[æœ¬ç•ªç’°å¢ƒ<br/>your-app.run.app]
    
    C --> C1[âœ… åŒä¸€ã‚³ãƒ¼ãƒ‰<br/>âœ… æœ¬ç•ªã¨åŒã˜å‹•ä½œ<br/>âœ… æ—©æœŸå•é¡Œç™ºè¦‹]
    D --> D1[âœ… èªè¨¼åˆ‡ã‚Šæ›¿ãˆä¸è¦<br/>âœ… ãƒ‡ãƒãƒƒã‚°æ¸ˆã¿<br/>âœ… å®‰å®šé‹ç”¨]
    
    B --> E[URLè¨­å®šã®ã¿å¤‰æ›´]
    E --> E1[redirect_uri:<br/>localhost â†’ production]
    
    style A fill:#e3f2fd
    style B fill:#4caf50,color:#fff
    style C fill:#e8f5e8
    style D fill:#e8f5e8
    style E fill:#fff3e0
```

---

## å®Ÿè£…ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ

### ğŸ† æœ€çµ‚æ¨å¥¨: streamlit-oauthçµ±ä¸€æ–¹å¼

#### é¸å®šç†ç”±
1. **çµ±ä¸€ã‚³ãƒ¼ãƒ‰ãƒ™ãƒ¼ã‚¹**: é–‹ç™ºãƒ»æœ¬ç•ªã§åŒã˜ã‚³ãƒ¼ãƒ‰
2. **æ—©æœŸå•é¡Œç™ºè¦‹**: ãƒ­ãƒ¼ã‚«ãƒ«ã§æœ¬ç•ªã¨åŒã˜OAuthãƒ•ãƒ­ãƒ¼
3. **ç§»è¡Œãƒªã‚¹ã‚¯æ’é™¤**: èªè¨¼ãƒ­ã‚¸ãƒƒã‚¯åˆ‡ã‚Šæ›¿ãˆä¸è¦
4. **ä¿å®ˆæ€§**: å˜ä¸€å®Ÿè£…ã®ç®¡ç†
5. **ã‚¹ã‚±ãƒ¼ãƒ©ãƒ“ãƒªãƒ†ã‚£**: æœ¬ç•ªç’°å¢ƒã§ã®ç¢ºå®Ÿãªå‹•ä½œ

#### å®Ÿè£…å·¥æ•°æ¯”è¼ƒ

| ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ | åˆæœŸå®Ÿè£… | ç§»è¡Œä½œæ¥­ | ãƒ†ã‚¹ãƒˆå·¥æ•° | ç·å·¥æ•° |
|-----------|----------|----------|------------|--------|
| **æ®µéšçš„æ–¹å¼** | 30åˆ† + 3æ™‚é–“ | 2æ™‚é–“ | 4æ™‚é–“ | **9æ™‚é–“30åˆ†** |
| **çµ±ä¸€æ–¹å¼** | 3æ™‚é–“ | 0æ™‚é–“ | 2æ™‚é–“ | **5æ™‚é–“** |

**çµè«–**: çµ±ä¸€æ–¹å¼ãŒ **4æ™‚é–“30åˆ†ã®çŸ­ç¸®** ã¨ **ãƒªã‚¹ã‚¯è»½æ¸›** ã‚’å®Ÿç¾

---

## æ¨å¥¨æ±ºå®šãƒ—ãƒ­ã‚»ã‚¹

### Step 1: è¦ä»¶ç¢ºèª
- [ ] æœ¬ç•ªãƒ‡ãƒ—ãƒ­ã‚¤ãŒå¿…è¦ã‹ï¼Ÿ
- [ ] é–‹ç™ºæœŸé–“ã®åˆ¶ç´„ã¯ï¼Ÿ
- [ ] ãƒãƒ¼ãƒ ã®ã‚¹ã‚­ãƒ«ãƒ¬ãƒ™ãƒ«ã¯ï¼Ÿ
- [ ] ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºè¦ä»¶ã¯ï¼Ÿ

### Step 2: æ¡ä»¶åˆ†å²
```
IF æœ¬ç•ªãƒ‡ãƒ—ãƒ­ã‚¤ä¸è¦ THEN
    Streamlitãƒã‚¤ãƒ†ã‚£ãƒ–èªè¨¼
ELSE IF é–‹ç™ºå·¥æ•°é‡è¦– AND ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºä¸è¦ THEN
    streamlit-oauthçµ±ä¸€æ–¹å¼
ELSE IF ç‰¹æ®Šè¦ä»¶å¤šæ•° THEN
    google-auth + ã‚«ã‚¹ã‚¿ãƒ å®Ÿè£…
ELSE
    streamlit-oauthçµ±ä¸€æ–¹å¼ (ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆæ¨å¥¨)
```

### Step 3: æœ€çµ‚åˆ¤æ–­
- **95%ã®ã‚±ãƒ¼ã‚¹**: streamlit-oauthçµ±ä¸€æ–¹å¼
- **ç‰¹æ®Šã‚±ãƒ¼ã‚¹**: è¦ä»¶ã«å¿œã˜ã¦ã‚«ã‚¹ã‚¿ãƒ å®Ÿè£…

---

## å®Ÿè£…ä¾‹ã¨ã‚³ãƒ¼ãƒ‰

### 1. ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ§‹æˆ

```
project_root/
â”œâ”€â”€ app.py                     # ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³
â”œâ”€â”€ auth/
â”‚   â”œâ”€â”€ __init__.py           # ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸åˆæœŸåŒ–
â”‚   â””â”€â”€ oauth_handler.py      # èªè¨¼ãƒãƒ³ãƒ‰ãƒ©ãƒ¼
â”œâ”€â”€ .streamlit/
â”‚   â”œâ”€â”€ secrets.toml          # èªè¨¼è¨­å®šï¼ˆGité™¤å¤–ï¼‰
â”‚   â””â”€â”€ secrets.toml.example  # è¨­å®šãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ
â”œâ”€â”€ requirements.txt          # ä¾å­˜é–¢ä¿‚
â””â”€â”€ .gitignore               # Gité™¤å¤–è¨­å®š
```

### 2. å¿…è¦ãªãƒ©ã‚¤ãƒ–ãƒ©ãƒª

```bash
# requirements.txt
streamlit>=1.28.0
streamlit-oauth>=0.3.0
requests>=2.31.0
```

### 3. èªè¨¼ãƒãƒ³ãƒ‰ãƒ©ãƒ¼å®Ÿè£…

```python
# auth/oauth_handler.py
import streamlit as st
from streamlit_oauth import OAuth2Component
import requests

class OAuthHandler:
    def __init__(self):
        self.oauth2 = OAuth2Component(
            client_id=st.secrets["auth"]["client_id"],
            client_secret=st.secrets["auth"]["client_secret"],
            authorize_endpoint="https://accounts.google.com/o/oauth2/auth",
            token_endpoint="https://oauth2.googleapis.com/token",
        )
    
    def require_auth(self):
        """èªè¨¼ã‚’å¿…é ˆã¨ã—ã€æœªèªè¨¼æ™‚ã¯ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã‚’è¡¨ç¤º"""
        if not self.is_authenticated():
            return self.login()
        return self.get_current_user()
    
    def is_authenticated(self):
        return 'auth_token' in st.session_state
    
    def login(self):
        result = self.oauth2.authorize_button(
            "Googleã§ãƒ­ã‚°ã‚¤ãƒ³",
            redirect_uri=st.secrets["auth"]["redirect_uri"],
            scope="openid email profile"
        )
        if result and 'token' in result:
            st.session_state['auth_token'] = result['token']
            user_info = self.get_user_info(result['token'])
            st.session_state['user_info'] = user_info
            st.rerun()
        return False
    
    def get_user_info(self, token):
        headers = {'Authorization': f'Bearer {token["access_token"]}'}
        response = requests.get(
            'https://www.googleapis.com/oauth2/v2/userinfo',
            headers=headers
        )
        return response.json() if response.status_code == 200 else None
```

### 4. ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³

```python
# app.py
import streamlit as st
from auth.oauth_handler import OAuthHandler

def main():
    st.set_page_config(
        page_title="èªè¨¼ãƒ†ã‚¹ãƒˆã‚¢ãƒ—ãƒª",
        page_icon="ğŸ”"
    )
    
    # èªè¨¼ãƒã‚§ãƒƒã‚¯
    auth = OAuthHandler()
    user = auth.require_auth()
    
    if user:
        st.success(f"ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸ: {user['name']}")
        st.json(user)
        
        if st.button("ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ"):
            del st.session_state['auth_token']
            del st.session_state['user_info']
            st.rerun()

if __name__ == "__main__":
    main()
```

### 5. è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«

```toml
# .streamlit/secrets.toml.example
[auth]
client_id = "your-client-id.apps.googleusercontent.com"
client_secret = "GOCSPX-your-client-secret"

# ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºç’°å¢ƒ
redirect_uri = "http://localhost:8501/oauth/callback"

# æœ¬ç•ªç’°å¢ƒï¼ˆãƒ‡ãƒ—ãƒ­ã‚¤æ™‚ã«å¤‰æ›´ï¼‰
# redirect_uri = "https://your-app.run.app/oauth/callback"

cookie_secret = "your-32-char-secret-key"
```

---

## ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚¬ã‚¤ãƒ‰

### ğŸš€ ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆï¼ˆ15åˆ†ï¼‰

#### Step 1: ç’°å¢ƒæ§‹ç¯‰ï¼ˆ5åˆ†ï¼‰
```bash
# 1. ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
pip install streamlit streamlit-oauth requests

# 2. ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ§‹é€ ä½œæˆ
mkdir -p auth .streamlit
touch auth/__init__.py auth/oauth_handler.py
touch app.py .streamlit/secrets.toml.example
```

#### Step 2: GCPè¨­å®šï¼ˆ5åˆ†ï¼‰
1. **GCP Console** â†’ ã€Œèªè¨¼æƒ…å ±ã€â†’ ã€Œèªè¨¼æƒ…å ±ã‚’ä½œæˆã€
2. **OAuthåŒæ„ç”»é¢**:
   - ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å: ä»»æ„
   - ã‚¹ã‚³ãƒ¼ãƒ—: `openid`, `email`, `profile`
3. **OAuth 2.0ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆID**:
   - ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ç¨®é¡: ã‚¦ã‚§ãƒ–ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³
   - ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆURI: `http://localhost:8501/oauth/callback`

#### Step 3: ãƒ­ãƒ¼ã‚«ãƒ«è¨­å®šï¼ˆ3åˆ†ï¼‰
```bash
# 1. è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ
cp .streamlit/secrets.toml.example .streamlit/secrets.toml

# 2. èªè¨¼æƒ…å ±ã‚’è¨­å®šï¼ˆå®Ÿéš›ã®å€¤ã«ç½®ãæ›ãˆï¼‰
# client_id = "ã‚ãªãŸã®ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆID"
# client_secret = "ã‚ãªãŸã®ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆ"
```

#### Step 4: èµ·å‹•ç¢ºèªï¼ˆ2åˆ†ï¼‰
```bash
# ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³èµ·å‹•
streamlit run app.py

# ãƒ–ãƒ©ã‚¦ã‚¶ã§ http://localhost:8501 ã«ã‚¢ã‚¯ã‚»ã‚¹
# ã€ŒGoogleã§ãƒ­ã‚°ã‚¤ãƒ³ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦å‹•ä½œç¢ºèª
```

### ğŸ“ æœ¬ç•ªç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤è¨­å®š

#### 1. ç’°å¢ƒå¤‰æ•°ã®æ›´æ–°
```toml
# æœ¬ç•ªç’°å¢ƒç”¨ .streamlit/secrets.toml
[auth]
redirect_uri = "https://your-production-domain.run.app/oauth/callback"
# ãã®ä»–ã®è¨­å®šã¯åŒã˜
```

#### 2. GCPè¨­å®šã®æ›´æ–°
- OAuth 2.0ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®ã€Œæ‰¿èªæ¸ˆã¿ã®ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆURIã€ã«æœ¬ç•ªURLã‚’è¿½åŠ 

#### 3. ãƒ‡ãƒ—ãƒ­ã‚¤
```bash
# Google Cloud Runã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤ä¾‹
gcloud run deploy invoice-system \
  --source . \
  --platform managed \
  --region asia-northeast1
```

---

## ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### ğŸ”§ ã‚ˆãã‚ã‚‹å•é¡Œã¨è§£æ±ºæ–¹æ³•

| å•é¡Œ | ç—‡çŠ¶ | åŸå›  | è§£æ±ºæ–¹æ³• |
|------|------|------|---------|
| **ModuleNotFoundError** | `streamlit_oauth`ãŒè¦‹ã¤ã‹ã‚‰ãªã„ | ãƒ©ã‚¤ãƒ–ãƒ©ãƒªæœªã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ« | `pip install streamlit-oauth` |
| **OAuthèªè¨¼ã‚¨ãƒ©ãƒ¼** | èªè¨¼ç”»é¢ã§ã‚¨ãƒ©ãƒ¼ | ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆURIä¸ä¸€è‡´ | GCPè¨­å®šã§æ­£ç¢ºãªURIã‚’ç¢ºèª |
| **ãƒ­ã‚°ã‚¤ãƒ³ãƒœã‚¿ãƒ³ç„¡åå¿œ** | ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã‚‚ä½•ã‚‚èµ·ã“ã‚‰ãªã„ | JavaScriptç„¡åŠ¹/ãƒ–ãƒ©ã‚¦ã‚¶äº’æ›æ€§ | ãƒ–ãƒ©ã‚¦ã‚¶è¨­å®šç¢ºèªã€åˆ¥ãƒ–ãƒ©ã‚¦ã‚¶ã§è©¦è¡Œ |
| **User infoå–å¾—å¤±æ•—** | ãƒˆãƒ¼ã‚¯ãƒ³ã‚ã‚‹ãŒãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ãªã— | ã‚¹ã‚³ãƒ¼ãƒ—ä¸è¶³/APIåˆ¶é™ | ã‚¹ã‚³ãƒ¼ãƒ—ã«`email profile`è¿½åŠ  |
| **ã‚»ãƒƒã‚·ãƒ§ãƒ³åˆ‡æ–­** | ãƒšãƒ¼ã‚¸ãƒªãƒ­ãƒ¼ãƒ‰ã§ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ | ã‚»ãƒƒã‚·ãƒ§ãƒ³è¨­å®šå•é¡Œ | `cookie_secret`ã‚’32æ–‡å­—ä»¥ä¸Šã«è¨­å®š |

### ğŸ› ãƒ‡ãƒãƒƒã‚°æ‰‹é †

#### 1. åŸºæœ¬ç¢ºèª
```python
# ãƒ‡ãƒãƒƒã‚°æƒ…å ±è¡¨ç¤º
st.write("ã‚»ãƒƒã‚·ãƒ§ãƒ³çŠ¶æ…‹:", st.session_state)
st.write("èªè¨¼è¨­å®š:", {
    "client_id": st.secrets["auth"]["client_id"][:10] + "...",
    "redirect_uri": st.secrets["auth"]["redirect_uri"]
})
```

#### 2. ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ç¢ºèª
- ãƒ–ãƒ©ã‚¦ã‚¶é–‹ç™ºè€…ãƒ„ãƒ¼ãƒ« â†’ ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¿ãƒ–
- OAuthèªè¨¼æ™‚ã®HTTPãƒªã‚¯ã‚¨ã‚¹ãƒˆ/ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’ç¢ºèª
- ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰ã‹ã‚‰åŸå› ã‚’ç‰¹å®š

#### 3. ãƒ­ã‚°ç¢ºèª
```python
import logging
logging.basicConfig(level=logging.DEBUG)
logger = logging.getLogger(__name__)

# èªè¨¼å‡¦ç†ã«ãƒ­ã‚°ã‚’è¿½åŠ 
logger.debug(f"OAuth result: {result}")
```

### ğŸš¨ ç·Šæ€¥æ™‚å¯¾å¿œ

#### èªè¨¼ã‚·ã‚¹ãƒ†ãƒ å…¨ä½“åœæ­¢æ™‚
1. **ä¸€æ™‚çš„ãªè¿‚å›ç­–**:
   ```python
   # ç·Šæ€¥æ™‚ã®èªè¨¼ã‚¹ã‚­ãƒƒãƒ—ï¼ˆé–‹ç™ºç’°å¢ƒã®ã¿ï¼‰
   if st.secrets.get("emergency_skip_auth", False):
       st.warning("ğŸš¨ ç·Šæ€¥ãƒ¢ãƒ¼ãƒ‰: èªè¨¼ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¦ã„ã¾ã™")
       st.session_state['user_info'] = {"name": "Emergency User", "email": "emergency@example.com"}
   ```

2. **ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯æ‰‹é †**:
   - ä»¥å‰ã®å‹•ä½œãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«æˆ»ã™
   - GCPè¨­å®šã‚’ä»¥å‰ã®çŠ¶æ…‹ã«å¾©å…ƒ
   - DNS/ãƒ­ãƒ¼ãƒ‰ãƒãƒ©ãƒ³ã‚µè¨­å®šç¢ºèª

---

## å°†æ¥ã¸ã®å½±éŸ¿ã¨è€ƒæ…®äº‹é …

### ğŸ“ˆ æŠ€è¡“çš„ç™ºå±•ã®è€ƒæ…®

#### 1. Streamlitèªè¨¼æ©Ÿèƒ½ã®é€²åŒ–
- **ç¾çŠ¶**: ãƒ­ãƒ¼ã‚«ãƒ«å°‚ç”¨ã®ãƒã‚¤ãƒ†ã‚£ãƒ–èªè¨¼
- **äºˆæƒ³**: å°†æ¥çš„ã«ã‚¯ãƒ©ã‚¦ãƒ‰å¯¾å¿œã®å¯èƒ½æ€§
- **å¯¾ç­–**: streamlit-oauthã§çµ±ä¸€ã™ã‚‹ã“ã¨ã§ã€å°†æ¥ã®ç§»è¡ŒãŒå®¹æ˜“

#### 2. OAuth 2.1æ¨™æº–ã¸ã®å¯¾å¿œ
- **å¤‰æ›´ç‚¹**: PKCEå¿…é ˆåŒ–ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–
- **å½±éŸ¿**: streamlit-oauthãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆå¿…è¦
- **æº–å‚™**: å®šæœŸçš„ãªãƒ©ã‚¤ãƒ–ãƒ©ãƒªæ›´æ–°ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«

#### 3. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¦ä»¶ã®å¼·åŒ–
- **äºˆæƒ³**: ã‚ˆã‚Šã‚¹ãƒˆãƒªã‚¯ãƒˆãªã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¦ä»¶
- **å¯¾ç­–**: 
  - ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã®çŸ­æœŸåŒ–
  - ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³ã®é©åˆ‡ãªç®¡ç†
  - ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ã®å¼·åŒ–

### ğŸ”„ é‹ç”¨é¢ã§ã®è€ƒæ…®

#### 1. ã‚¹ã‚±ãƒ¼ãƒ©ãƒ“ãƒªãƒ†ã‚£
```python
# å°†æ¥ã®è² è·å¯¾å¿œ
class ScalableOAuthHandler(OAuthHandler):
    def __init__(self):
        super().__init__()
        # Redis/Memcachedã§ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†
        self.session_store = self.get_external_session_store()
    
    def get_external_session_store(self):
        # å¤–éƒ¨ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¹ãƒˆã‚¢ã¨ã®é€£æº
        pass
```

#### 2. ç›£è¦–ã¨ãƒ¡ãƒˆãƒªã‚¯ã‚¹
- èªè¨¼æˆåŠŸ/å¤±æ•—ç‡ã®ç›£è¦–
- ã‚»ãƒƒã‚·ãƒ§ãƒ³æŒç¶šæ™‚é–“ã®åˆ†æ
- ã‚¨ãƒ©ãƒ¼ãƒ‘ã‚¿ãƒ¼ãƒ³ã®è¿½è·¡

#### 3. ã‚³ãƒ³ãƒ—ãƒ©ã‚¤ã‚¢ãƒ³ã‚¹å¯¾å¿œ
- GDPRå¯¾å¿œã§ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ç®¡ç†
- ãƒ­ã‚°ã®ä¿æŒæœŸé–“ã¨ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼
- ç›£æŸ»ãƒ­ã‚°ã®è¦ä»¶

### ğŸ’¡ ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹

#### 1. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£
```python
# ã‚»ã‚­ãƒ¥ã‚¢ãªå®Ÿè£…ä¾‹
class SecureOAuthHandler(OAuthHandler):
    def validate_token(self, token):
        # ãƒˆãƒ¼ã‚¯ãƒ³ã®æœ‰åŠ¹æ€§æ¤œè¨¼
        if self.is_token_expired(token):
            self.refresh_token(token)
        return self.verify_token_signature(token)
    
    def sanitize_user_data(self, user_info):
        # ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ã®ã‚µãƒ‹ã‚¿ã‚¤ã‚º
        return {k: v for k, v in user_info.items() 
                if k in self.allowed_user_fields}
```

#### 2. ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
```python
def robust_authentication(self):
    try:
        return self.standard_auth_flow()
    except OAuthException as e:
        self.log_auth_error(e)
        return self.fallback_auth_flow()
    except NetworkException as e:
        self.show_user_friendly_error()
        return self.retry_with_backoff()
```

#### 3. ãƒ†ã‚¹ãƒˆæˆ¦ç•¥
```python
# ãƒ†ã‚¹ãƒˆå¯èƒ½ãªè¨­è¨ˆ
class TestableOAuthHandler(OAuthHandler):
    def __init__(self, mock_mode=False):
        if mock_mode:
            self.oauth2 = MockOAuth2Component()
        else:
            super().__init__()
```

### ğŸ“š å­¦ç¿’ãƒªã‚½ãƒ¼ã‚¹ã¨ç¶™ç¶šçš„æ”¹å–„

#### æ¨å¥¨å­¦ç¿’æ•™æ
1. **OAuth 2.0å…¬å¼ä»•æ§˜**: RFC 6749
2. **Streamlitèªè¨¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ**: å…¬å¼ã‚¬ã‚¤ãƒ‰
3. **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹**: OWASPèªè¨¼ã‚¬ã‚¤ãƒ‰

#### ç¶™ç¶šçš„æ”¹å–„ãƒ—ãƒ­ã‚»ã‚¹
1. **å››åŠæœŸãƒ¬ãƒ“ãƒ¥ãƒ¼**: èªè¨¼ã‚·ã‚¹ãƒ†ãƒ ã®è¦‹ç›´ã—
2. **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£æŸ»**: å¹´æ¬¡ã§ã®ãƒšãƒãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ†ã‚¹ãƒˆ
3. **ãƒ©ã‚¤ãƒ–ãƒ©ãƒªæ›´æ–°**: æœˆæ¬¡ã§ã®ä¾å­˜é–¢ä¿‚ãƒã‚§ãƒƒã‚¯

---

## ğŸ“‹ ã¾ã¨ã‚

### ğŸ¯ æœ€çµ‚æ¨å¥¨äº‹é …

**streamlit-oauthçµ±ä¸€æ–¹å¼** ã‚’å¼·ãæ¨å¥¨ã™ã‚‹ç†ç”±ï¼š

1. **é–‹ç™ºåŠ¹ç‡**: åˆæœŸå®Ÿè£…3æ™‚é–“ã§å®Œäº†
2. **ä¿å®ˆæ€§**: å˜ä¸€ã‚³ãƒ¼ãƒ‰ãƒ™ãƒ¼ã‚¹ã§ç®¡ç†
3. **å®‰å®šæ€§**: æœ¬ç•ªç’°å¢ƒã§ã®å®Ÿç¸¾
4. **å°†æ¥æ€§**: OAuthæ¨™æº–æº–æ‹ ã§é•·æœŸå¯¾å¿œ
5. **ã‚³ã‚¹ãƒˆ**: æ®µéšçš„æ–¹å¼ã‚ˆã‚Š4.5æ™‚é–“ã®å·¥æ•°å‰Šæ¸›

### âœ… ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒ—ãƒ©ãƒ³

1. **å³åº§ã«é–‹å§‹**: streamlit-oauthå®Ÿè£…ï¼ˆ3æ™‚é–“ï¼‰
2. **GCPè¨­å®š**: OAuth 2.0ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆè¨­å®šï¼ˆ30åˆ†ï¼‰
3. **å‹•ä½œç¢ºèª**: ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã§ã®ãƒ†ã‚¹ãƒˆï¼ˆ30åˆ†ï¼‰
4. **æœ¬ç•ªæº–å‚™**: ç’°å¢ƒåˆ¥è¨­å®šã¨ãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆ1æ™‚é–“ï¼‰

### ğŸ“ ã‚µãƒãƒ¼ãƒˆä½“åˆ¶

- **æŠ€è¡“çš„å•é¡Œ**: æœ¬è³‡æ–™ã®ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°å‚ç…§
- **å®Ÿè£…æ”¯æ´**: é–‹ç™ºãƒãƒ¼ãƒ ã«ã‚ˆã‚‹ãƒšã‚¢ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°å¯¾å¿œ
- **ç·Šæ€¥å¯¾å¿œ**: 24æ™‚é–“ä»¥å†…ã®å•é¡Œè§£æ±ºã‚³ãƒŸãƒƒãƒˆ

---

**ã“ã®è³‡æ–™ã¯ã€Googleèªè¨¼Ã—ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã§ã®èªè¨¼å®Ÿè£…ã«ãŠã‘ã‚‹åŒ…æ‹¬çš„ãªã‚¬ã‚¤ãƒ‰ã¨ã—ã¦ã€ä»Šå¾Œã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ã‚‚å‚è€ƒè³‡æ–™ã¨ã—ã¦æ´»ç”¨ã§ãã¾ã™ã€‚** 