# テストケース設計書

**バージョン**: 2.0  
**作成日**: 2025-01-XX  
**最終更新**: 2025-01-XX  
**更新内容**: GAS実データ分析結果を反映した実践的テストケース設計

## 1. 概要

### 1.1. 目的
請求書処理自動化システムの2段階照合プロセスについて、実際のGASデータで発生したパターンを基に包括的なテストケースを設計し、システムの信頼性と精度を保証する。

### 1.2. テスト戦略
- **実データベース**: GAS運用で実際に処理された請求書パターンを活用
- **段階別テスト**: 第1段階（企業名照合）と第2段階（詳細照合）を分離してテスト
- **エラーパターン重視**: 実際に発生した問題パターンを優先的にカバー
- **確信度検証**: 各段階での確信度計算の妥当性を検証
- **エッジケース対応**: null値、負値、異常データの処理を確認

## 2. 第1段階テストケース（企業名照合）

### 2.1. 正常系テストケース

#### TC-S1-001: 完全一致ケース
```yaml
test_case_id: "TC-S1-001"
description: "企業名が完全に一致する場合"
category: "第1段階_正常系"
input:
  issuer_name: "パーソルキャリア株式会社"
  master_list: 
    - "パーソルキャリア株式会社"
    - "株式会社トモノカイ"
    - "日本マイクロソフト株式会社"
expected_output:
  matched_company_name: "パーソルキャリア株式会社"
  confidence_score: 0.95
  matching_reason: "完全一致"
priority: "高"
```

#### TC-S1-002: 法人格正規化一致
```yaml
test_case_id: "TC-S1-002"
description: "法人格表記の違いを正規化して一致"
category: "第1段階_正常系"
input:
  issuer_name: "OpenAI, LLC"
  master_list:
    - "OpenAI合同会社"
    - "Google Japan G.K."
    - "Microsoft Corporation"
expected_output:
  matched_company_name: "OpenAI合同会社"
  confidence_score: 0.90
  matching_reason: "法人格正規化一致"
priority: "高"
```

#### TC-S1-003: サービス名→正式名称変換
```yaml
test_case_id: "TC-S1-003"
description: "サービス名から正式名称への変換"
category: "第1段階_正常系"
input:
  issuer_name: "Yahoo! JAPAN広告"
  master_list:
    - "LINEヤフー株式会社"
    - "Google Japan G.K."
    - "Meta Japan"
expected_output:
  matched_company_name: "LINEヤフー株式会社"
  confidence_score: 0.88
  matching_reason: "サービス名変換一致"
priority: "高"
```

### 2.2. 表記揺れパターンテストケース

#### TC-S1-011: 大文字小文字混在
```yaml
test_case_id: "TC-S1-011"
description: "大文字小文字の表記揺れ"
category: "第1段階_表記揺れ"
input:
  issuer_name: "GAMMA"
  master_list:
    - "Gamma"
    - "株式会社GIG"
    - "Canva Pty. Ltd."
expected_output:
  matched_company_name: "Gamma"
  confidence_score: 0.92
  matching_reason: "大文字小文字正規化一致"
priority: "中"
```

#### TC-S1-012: 句読点・記号の違い
```yaml
test_case_id: "TC-S1-012"
description: "句読点や記号の有無による表記揺れ"
category: "第1段階_表記揺れ"
input:
  issuer_name: "Canva Pty Ltd"
  master_list:
    - "Canva Pty. Ltd."
    - "Google LLC"
    - "Microsoft Ireland Operations Limited"
expected_output:
  matched_company_name: "Canva Pty. Ltd."
  confidence_score: 0.90
  matching_reason: "記号正規化一致"
priority: "中"
```

#### TC-S1-013: スペースの違い
```yaml
test_case_id: "TC-S1-013"
description: "スペースの有無や全角半角の違い"
category: "第1段階_表記揺れ"
input:
  issuer_name: "Google　Japan　G.K."  # 全角スペース
  master_list:
    - "Google Japan G.K."  # 半角スペース
    - "Yahoo Japan"
    - "Amazon Japan"
expected_output:
  matched_company_name: "Google Japan G.K."
  confidence_score: 0.93
  matching_reason: "スペース正規化一致"
priority: "中"
```

### 2.3. 異常系・エラーテストケース

#### TC-S1-021: 確信度不足（照合失敗）
```yaml
test_case_id: "TC-S1-021"
description: "類似企業名が複数あり確信度が閾値未満"
category: "第1段階_異常系"
input:
  issuer_name: "Microsoft Asia"
  master_list:
    - "Microsoft Corporation"
    - "Microsoft Ireland Operations Limited"
    - "日本マイクロソフト株式会社"
expected_output:
  matched_company_name: null
  confidence_score: 0.72
  matching_reason: "確信度閾値未達"
  alternative_candidates:
    - name: "Microsoft Corporation"
      score: 0.72
    - name: "Microsoft Ireland Operations Limited"
      score: 0.70
priority: "高"
```

#### TC-S1-022: 企業名null/空文字
```yaml
test_case_id: "TC-S1-022"
description: "請求元企業名がnullまたは空文字"
category: "第1段階_異常系"
input:
  issuer_name: ""
  master_list:
    - "株式会社トモノカイ"
    - "パーソルキャリア株式会社"
expected_output:
  error: true
  error_code: "DATA_001"
  error_message: "必須フィールド（企業名）が欠損しています"
priority: "高"
```

#### TC-S1-023: マスタリスト空
```yaml
test_case_id: "TC-S1-023"
description: "マスタデータが空の場合"
category: "第1段階_異常系"
input:
  issuer_name: "株式会社テスト"
  master_list: []
expected_output:
  error: true
  error_code: "DATA_002"
  error_message: "マスタデータが空です"
priority: "中"
```

## 3. 第2段階テストケース（詳細照合）

### 3.1. 正常系テストケース

#### TC-S2-001: キー情報完全一致
```yaml
test_case_id: "TC-S2-001"
description: "請求書番号による完全一致"
category: "第2段階_正常系"
input:
  invoice_data:
    issuer_name: "OpenAI, LLC"
    invoice_number: "FAE56ACC-0002"
    total_amount: 220
    currency: "USD"
    line_items:
      - description: "ChatGPT Pro Subscription"
        amount: 200
        tax: "10%"
  master_records:
    - id: "entry_001"
      company_name: "OpenAI, LLC"
      content: "ChatGPT Pro利用料"
      amount: 220
      additional_condition: "FAE56ACC-0002"
    - id: "entry_002"
      company_name: "OpenAI, LLC"
      content: "ChatGPT API利用料"
      amount: 150
      additional_condition: "FAE56ACC-0001"
expected_output:
  matched_entry_id: "entry_001"
  confidence_score: 0.95
  selection_reason: "請求書番号完全一致"
priority: "高"
```

#### TC-S2-002: 金額照合優先
```yaml
test_case_id: "TC-S2-002"
description: "金額完全一致による選択"
category: "第2段階_正常系"
input:
  invoice_data:
    issuer_name: "Google Japan G.K."
    total_amount: 38418538
    currency: "JPY"
    line_items:
      - description: "Google Ads広告費"
        amount: 38418538
  master_records:
    - id: "entry_003"
      company_name: "Google Japan G.K."
      content: "Google広告費"
      amount: 38400000
    - id: "entry_004"
      company_name: "Google Japan G.K."
      content: "Google Cloud費用"
      amount: 38418538
expected_output:
  matched_entry_id: "entry_004"
  confidence_score: 0.92
  selection_reason: "金額完全一致 + 企業名一致"
priority: "高"
```

#### TC-S2-003: セマンティック照合
```yaml
test_case_id: "TC-S2-003"
description: "明細内容のセマンティック類似度による照合"
category: "第2段階_正常系"
input:
  invoice_data:
    issuer_name: "日本マイクロソフト株式会社"
    total_amount: 46169
    currency: "JPY"
    line_items:
      - description: "Power BI Pro - One-Year commitment"
        quantity: 28
        unit_price: 1499
        amount: 41972
        tax: "10%"
  master_records:
    - id: "entry_005"
      company_name: "日本マイクロソフト株式会社"
      content: "Power BI Pro ライセンス"
      amount: 46169
    - id: "entry_006"
      company_name: "日本マイクロソフト株式会社"
      content: "Office 365 ライセンス"
      amount: 45000
expected_output:
  matched_entry_id: "entry_005"
  confidence_score: 0.89
  selection_reason: "セマンティック類似度高 + 金額一致"
priority: "高"
```

### 3.2. 実データパターンテストケース

#### TC-S2-011: 負値金額（返金）
```yaml
test_case_id: "TC-S2-011"
description: "負値金額（返金・調整）の処理"
category: "第2段階_実データパターン"
input:
  invoice_data:
    issuer_name: "OpenAI, LLC"
    total_amount: -39.62
    currency: "USD"
    line_items:
      - description: "ChatGPT Pro Subscription Refund"
        amount: -36.02
        tax: "10%"
  master_records:
    - id: "entry_007"
      company_name: "OpenAI, LLC"
      content: "ChatGPT返金"
      amount: -39.62
expected_output:
  matched_entry_id: "entry_007"
  confidence_score: 0.90
  validation_flags:
    negative_amount_detected: true
    refund_transaction: true
priority: "中"
```

#### TC-S2-012: 金額null
```yaml
test_case_id: "TC-S2-012"
description: "金額情報がnullの場合"
category: "第2段階_実データパターン"
input:
  invoice_data:
    issuer_name: "Yahoo! JAPAN"
    total_amount: null
    currency: "JPY"
    line_items:
      - description: "Yahoo広告"
        amount: null
  master_records:
    - id: "entry_008"
      company_name: "LINEヤフー株式会社"
      content: "Yahoo広告費"
      amount: 50000
expected_output:
  error: true
  error_code: "DATA_002"
  error_message: "金額情報が不正です"
  suggested_actions:
    - "請求書PDFの再確認を行ってください"
    - "手動で金額情報を補完してください"
priority: "高"
```

#### TC-S2-013: 通貨換算
```yaml
test_case_id: "TC-S2-013"
description: "USD→JPY通貨換算が必要な場合"
category: "第2段階_実データパターン"
input:
  invoice_data:
    issuer_name: "OpenAI, LLC"
    total_amount: 220
    currency: "USD"
    line_items:
      - description: "ChatGPT Pro Subscription"
        amount: 200
  master_records:
    - id: "entry_009"
      company_name: "OpenAI, LLC"
      content: "ChatGPT利用料"
      amount: 33000  # JPY換算
expected_output:
  matched_entry_id: "entry_009"
  confidence_score: 0.85
  matching_details:
    currency_conversion_applied: true
    exchange_rate: 150.0
    converted_amount: 33000
priority: "中"
```

### 3.3. 異常系・エラーテストケース

#### TC-S2-021: 確信度不足（詳細照合失敗）
```yaml
test_case_id: "TC-S2-021"
description: "複数候補の確信度が全て閾値未満"
category: "第2段階_異常系"
input:
  invoice_data:
    issuer_name: "Unknown Company"
    total_amount: 50000
    line_items:
      - description: "Unknown Service"
        amount: 50000
  master_records:
    - id: "entry_010"
      company_name: "Different Company"
      content: "Different Service"
      amount: 100000
    - id: "entry_011"
      company_name: "Another Company"
      content: "Another Service"
      amount: 75000
expected_output:
  matched_entry_id: null
  confidence_score: 0.35
  selection_reason: "確信度不足により照合失敗"
  alternative_candidates:
    - entry_id: "entry_010"
      score: 0.35
      weakness: "金額差異100%"
priority: "高"
```

#### TC-S2-022: 候補レコード空
```yaml
test_case_id: "TC-S2-022"
description: "対象企業の候補レコードが存在しない"
category: "第2段階_異常系"
input:
  invoice_data:
    issuer_name: "新規企業"
    total_amount: 10000
  master_records: []
expected_output:
  error: true
  error_code: "DATA_003"
  error_message: "該当企業の仕訳候補が見つかりません"
  suggested_actions:
    - "新規企業のマスタデータ登録を行ってください"
priority: "中"
```

## 4. 統合ワークフローテストケース

### 4.1. エンドツーエンドテストケース

#### TC-E2E-001: 完全自動処理成功
```yaml
test_case_id: "TC-E2E-001"
description: "第1段階→第2段階の完全自動処理"
category: "統合テスト_正常系"
input:
  pdf_file: "sample_invoice_persol.pdf"
  extracted_data:
    請求元: "パーソルキャリア株式会社"
    請求書番号: "489753-00"
    税込金額: 1178485
    明細: '[{"description": "報酬 S0516342-01", "amount": 1071350}]'
expected_workflow:
  stage1_result:
    success: true
    matched_company: "パーソルキャリア株式会社"
    confidence: 0.95
  stage2_result:
    success: true
    matched_entry_id: "entry_persol_001"
    confidence: 0.92
  final_status: "auto_completed"
priority: "最高"
```

#### TC-E2E-002: 第1段階のみ成功（部分自動化）
```yaml
test_case_id: "TC-E2E-002"
description: "企業名照合成功、詳細照合は手動確認"
category: "統合テスト_部分成功"
input:
  pdf_file: "sample_invoice_new_service.pdf"
  extracted_data:
    請求元: "株式会社GIG"
    税込金額: 3214200
    明細: '[{"description": "新サービス開発", "amount": 3214200}]'
expected_workflow:
  stage1_result:
    success: true
    matched_company: "株式会社GIG"
    confidence: 0.88
  stage2_result:
    success: false
    confidence: 0.65
    reason: "新サービスのため既存パターンなし"
  final_status: "manual_review_required"
  assistance_data:
    similar_past_transactions: true
    suggested_account_items: ["外注費", "システム開発費"]
priority: "高"
```

### 4.2. エラー処理統合テストケース

#### TC-E2E-011: OCR抽出失敗
```yaml
test_case_id: "TC-E2E-011"
description: "PDF読み取り不可によるワークフロー停止"
category: "統合テスト_異常系"
input:
  pdf_file: "corrupted_invoice.pdf"
expected_workflow:
  extraction_result:
    success: false
    error_code: "FILE_001"
    error_message: "PDFファイルが破損しています"
  final_status: "extraction_failed"
  recovery_actions:
    - "PDFファイルの再アップロードを試してください"
    - "別の形式でのファイル提供を検討してください"
priority: "中"
```

## 5. 性能テストケース

### 5.1. 処理時間テストケース

#### TC-PERF-001: 標準処理時間
```yaml
test_case_id: "TC-PERF-001"
description: "標準的な請求書の処理時間測定"
category: "性能テスト"
input:
  file_size: "2MB以下"
  page_count: "5ページ以下"
  master_record_count: "100件以下"
expected_performance:
  stage1_time: "< 10秒"
  stage2_time: "< 15秒"
  total_time: "< 30秒"
priority: "中"
```

### 5.2. 大量データテストケース

#### TC-PERF-011: 大量マスタデータ
```yaml
test_case_id: "TC-PERF-011"
description: "1000件以上のマスタデータでの処理"
category: "性能テスト"
input:
  master_record_count: "1000件"
  candidate_count: "50件"
expected_performance:
  stage1_time: "< 20秒"
  stage2_time: "< 30秒"
  memory_usage: "< 512MB"
priority: "低"
```

## 6. テスト実行計画

### 6.1. テスト実行順序
1. **単体テスト**: 第1段階、第2段階を個別にテスト
2. **統合テスト**: ワークフロー全体のテスト
3. **性能テスト**: 処理時間・リソース使用量の測定
4. **ユーザビリティテスト**: Streamlit UIの操作性確認

### 6.2. 自動化対象
- 第1段階・第2段階の機能テスト（優先度：高・中）
- 基本的な統合テストケース
- 性能テストの一部

### 6.3. 手動テスト対象
- ユーザビリティテスト
- エラーメッセージの適切性確認
- エッジケースの動作確認

## 7. 成功基準

### 7.1. 機能要件
- 第1段階照合成功率：85%以上
- 第2段階照合成功率：75%以上
- 完全自動処理率：65%以上

### 7.2. 非機能要件
- 平均処理時間：30秒以内
- エラー復旧率：90%以上
- システム可用性：99.5%以上

### 7.3. ユーザビリティ要件
- エラーメッセージの理解度：95%以上
- 手動操作の完了率：90%以上
- ユーザー満足度：4.0/5.0以上

## 8. まとめ

本テストケース設計により以下を実現：
- **実データベース**: GAS運用で発生した実際のパターンを網羅
- **段階別検証**: 各段階の機能を詳細に検証
- **信頼性保証**: エラーパターンと復旧処理の確認
- **性能保証**: 実用的な処理時間の確保
- **ユーザビリティ**: 実際の運用を想定した操作性確認

実データパターンに基づくテストにより、実運用での信頼性を確保する。 