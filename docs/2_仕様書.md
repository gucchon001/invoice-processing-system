# 請求書処理自動化システム 仕様書 (最終版)

**バージョン:** 2.7
**作成日:** 2025/07/17

## 1. 概要

本ドキュメントは、「請求書処理自動化システム 要件定義書」に基づき、PythonおよびStreamlitで構築する新しいシステムの技術的な仕様を定義するものである。

## 2. 画面仕様

### 2.1. 基本レイアウト

アプリケーションは単一ページで構成され、画面は大きく分けて「サイドバー」と「メインコンテンツエリア」の2つの領域で構成される。

### 2.2. サイドバー (`st.sidebar`)

* **役割:** アプリケーション全体のナビゲーションメニューとして機能する。
* **表示制御:** ログインしたユーザーの権限に応じて、表示されるメニュー項目が動的に変化する。

| 権限 | 表示メニュー |
| :--- | :--- |
| **一般ユーザー** | ・請求書アップロード<br>・処理状況ダッシュボード<br>・メール設定 |
| **管理者** | ・請求書アップロード<br>・処理状況ダッシュボード<br>・メール設定<br>--- (区切り線) ---<br>・**[管理]** 全データ閲覧<br>・**[管理]** 支払マスタ管理<br>・**[管理]** カード明細アップロード<br>・**[管理]** システムログ閲覧 |

### 2.3. メインコンテンツエリア

#### 2.3.1. 請求書アップロード画面

* **UIコンポーネント:** `st.file_uploader`
* **機能:** PDFファイルのドラッグ＆ドロップおよびファイル選択による複数同時アップロード機能を提供する。

#### 2.3.2. 処理状況ダッシュボード

* **UIコンポーネント:** **`AgGrid (streamlit-aggrid)`**
* **機能:**
    * **データ表示:** ログインユーザーがアップロードした請求書データの一覧をグリッド表示する。
    * **PDF確認:** 各行に「PDF確認」ボタンを設置。クリックすると、該当の請求書PDFが**ポップアップ（モーダルダイアログ）**で表示される。
    * **高度なインライン編集:**
        * セル単位での直接編集（テキスト入力）。
        * プルダウン選択（勘定科目など）。
        * コピー＆ペーストによる複数セルへの一括入力。
    * **行選択と一括操作:**
        * 各行のチェックボックスで、単一または複数のレコードを選択できる。
        * グリッドの外に配置された「選択した項目を削除」ボタンで、選択したレコードを一括削除できる。
    * **手動再照合:** 外貨請求で照合に失敗した行には「外貨明細と再照合」ボタンを表示し、手動で再照合を実行できる。
    * **支払マスタ新規作成:** マスタ不一致の行には「支払マスタを新規作成」ボタンを表示し、新規登録画面を呼び出す。

#### 2.3.3. 支払マスタ管理画面（管理者向け）

* **UIコンポーネント:** **`AgGrid (streamlit-aggrid)`**
* **機能:**
    * **データ表示と編集:** 支払マスタの全データをグリッド形式で表示し、管理者は直接編集・追加・削除できる。
    * **承認ワークフロー:** ユーザーから申請された「承認待ち」のマスタレコードをフィルタ表示し、「承認」ボタンで有効化できる。

#### 2.3.4. カード明細アップロード画面（管理者向け）

* **UIコンポーネント:** `st.file_uploader`
* **機能:** 管理者がカード会社の利用明細PDFをアップロードするための専用画面。

#### 2.3.5. メール設定画面（ユーザー/管理者共通）

* **機能:** ユーザーが自身のメール通知設定（処理完了時、エラー発生時）をON/OFFできる。

#### 2.3.6. 全データ閲覧画面（管理者向け）

* **UIコンポーネント:** **`AgGrid (streamlit-aggrid)`**, `st.button`, `st.progress`, `st.expander`
* **機能:**
    * 全ユーザーの請求書データを横断的に閲覧・編集できる。
    * **freee連携:** 「freee連携シートへ書き出し」ボタンを設置し、承認済みの全データを指定のGoogleスプレッドシートに書き出す。
    * **経理ルールチェック機能:**
        * **経理ハンドブック取得:** 「最新ハンドブックを取得」ボタンで Google Slides API から経理ルールを更新
        * **チェック実行:** 「ルール準拠チェックを実行」ボタンで表示中の請求書データの照合を開始
        * **進捗表示:** プログレスバーでチェック進捗をリアルタイム表示
        * **結果統合表示:**
            * グリッドに準拠状況列を追加（✅準拠 / ⚠警告 / ❌違反）
            * 不整合項目のクリックで詳細説明をポップアップ表示
        * **フィルタリング:** 準拠状況別（全て/準拠/警告/違反）でデータを絞り込み
        * **詳細確認:** 各請求書の「詳細」ボタンで個別の照合結果を展開表示
        * **一括アクション:**
            * 「違反項目を修正」ボタンで AI による修正案を提示
            * 「freee連携除外」ボタンで違反項目を連携対象から除外
        * **履歴管理:** 過去のチェック結果履歴を参照可能

#### 2.3.7. システムログ閲覧画面（管理者向け）

* **機能:** システムの動作ログを閲覧・検索・フィルタリングできる。


## 3. データ仕様（データベース設計）

### 3.0. 採用技術

* **データベース:** Supabase (PostgreSQL)
* **ファイルストレージ:** Google Drive

### 3.1. テーブル定義

* **`invoices` (請求書データ):** アップロードされた請求書の一次情報、処理ステータス、最終的な仕訳情報を格納。
* **`payment_masters` (支払マスタ):** 企業ごとの仕訳ルール、追加条件、個別処理ルールを格納。ユーザーによる申請と管理者による承認のステータスを持つ。
* **`users` (ユーザー):** ユーザー情報と役割（管理者/一般）を管理。
* **`card_statements` (カード明細):** AIで解析したカード利用明細データを格納。
* **`user_preferences` (ユーザー設定):** メール通知などの個人設定を保存。


#### `invoices` (請求書データテーブル)
| カラム名 | データ型 | 説明 |
| :--- | :--- | :--- |
| `id` | `SERIAL PRIMARY KEY` | 一意なID (自動採番) |
| `user_email` | `VARCHAR(255)` | アップロードしたユーザーのEmail |
| `status` | `VARCHAR(50)` | 処理ステータス |
| `file_name` | `VARCHAR(255)` | 元のPDFファイル名 |
| `gdrive_file_id` | `VARCHAR(255)` | Google Driveに保存したファイルのID |
| `uploaded_at` | `TIMESTAMP` | アップロード日時 |
| `issuer` | `VARCHAR(255)` | (AI抽出) 請求元 |
| `payer` | `VARCHAR(255)` | **(新規追加)** (AI抽出) 請求先 |
| `main_invoice_number` | `VARCHAR(255)` | **(新規追加)** (AI抽出) 請求書番号 |
| `receipt_number` | `VARCHAR(255)` | **(新規追加)** (AI抽出) 領収書番号 |
| `t_number` | `VARCHAR(50)` | **(新規追加)** (AI抽出) 登録番号 |
| `issue_date` | `DATE` | (AI抽出) 発行日 |
| `due_date` | `DATE` | (AI/ロジック決定) 支払期日 |
| `currency` | `VARCHAR(10)` | (AI抽出) 通貨 |
| `amount_inclusive_tax`| `DECIMAL(12, 2)` | (AI抽出) 税込金額 |
| `amount_exclusive_tax`| `DECIMAL(12, 2)` | **(新規追加)** (AI抽出) 税抜金額 |
| `key_info` | `JSONB` | (AI抽出) アカウントIDなどのキー情報 |
| `line_items` | `JSONB` | (AI抽出) 明細情報 |
| `final_accounting_info` | `JSONB` | (ユーザー確定後) 最終的な仕訳情報 |

#### `payment_masters` (支払マスタテーブル)
| カラム名 | データ型 | 説明 |
| :--- | :--- | :--- |
| `id` | `SERIAL PRIMARY KEY` | 一意なID |
| `company_name` | `VARCHAR(255)` | 企業名 |
| `content` | `VARCHAR(255)` | 内容 |
| `additional_condition` | `VARCHAR(255)` | 絞り込みのための追加条件 |
| `processing_rules` | `JSONB` | 個別処理ルール |
| `account_title` | `VARCHAR(100)` | 勘定科目 |
| `item` | `VARCHAR(100)` | 品目 |
| `payment_method` | `VARCHAR(50)` | 支払方法 |
| `department` | `VARCHAR(100)` | 部門 |
| `approval_status`| `VARCHAR(20)` | 承認ステータス (`approved`, `pending`) |
| `created_by` | `VARCHAR(255)` | このレコードを作成したユーザーのEmail |

#### `users` (ユーザーテーブル)
| カラム名 | データ型 | 説明 |
| :--- | :--- | :--- |
| `email` | `VARCHAR(255) PRIMARY KEY` | ユーザーのEmail |
| `name` | `VARCHAR(100)` | ユーザー名 |
| `role` | `VARCHAR(20)` | 権限 (`admin` または `user`) |

#### `card_statements` (カード明細データテーブル)
| カラム名 | データ型 | 説明 |
| :--- | :--- | :--- |
| `id` | `SERIAL PRIMARY KEY` | 一意なID |
| `transaction_date`| `DATE` | 利用日 |
| `merchant_name` | `VARCHAR(255)` | 利用先 |
| `jpy_amount` | `DECIMAL(12, 2)` | 日本円での支払額 |
| `foreign_currency_amount` | `DECIMAL(12, 2)` | 外貨での支払額 |
| `foreign_currency_code` | `VARCHAR(10)` | 外貨の通貨コード |

#### `user_preferences` (ユーザー設定テーブル)
| カラム名 | データ型 | 説明 |
| :--- | :--- | :--- |
| `user_email` | `VARCHAR(255) PRIMARY KEY` | ユーザーのEmail（`users`テーブルへの外部キー） |
| `notify_on_success` | `BOOLEAN` | 処理成功時にメール通知するか |
| `notify_on_error` | `BOOLEAN` | 処理失敗時にメール通知するか |

#### `accounting_rules` (経理ルールテーブル)
| カラム名 | データ型 | 説明 |
| :--- | :--- | :--- |
| `id` | `SERIAL PRIMARY KEY` | 一意なID (自動採番) |
| `rule_category` | `VARCHAR(100)` | ルールカテゴリ（勘定科目、支払期日、申請タイトル等） |
| `rule_name` | `VARCHAR(255)` | ルール名 |
| `rule_description` | `TEXT` | ルール内容の詳細説明 |
| `rule_conditions` | `JSONB` | ルール適用条件（JSON形式） |
| `rule_values` | `JSONB` | 期待値・許可値（JSON形式） |
| `severity` | `VARCHAR(20)` | 重要度（error, warning, info） |
| `handbook_url` | `VARCHAR(500)` | 経理ハンドブックのURL |
| `slide_number` | `INTEGER` | 該当スライド番号 |
| `extracted_at` | `TIMESTAMP` | ルール抽出日時 |
| `updated_at` | `TIMESTAMP` | 最終更新日時 |

#### `rule_check_sessions` (ルールチェック実行セッションテーブル)
| カラム名 | データ型 | 説明 |
| :--- | :--- | :--- |
| `id` | `SERIAL PRIMARY KEY` | 一意なID (自動採番) |
| `executed_by` | `VARCHAR(255)` | 実行者のEmail |
| `started_at` | `TIMESTAMP` | チェック開始日時 |
| `completed_at` | `TIMESTAMP` | チェック完了日時 |
| `status` | `VARCHAR(50)` | 実行状況（running, completed, failed） |
| `total_invoices` | `INTEGER` | チェック対象請求書数 |
| `compliant_count` | `INTEGER` | 準拠件数 |
| `warning_count` | `INTEGER` | 警告件数 |
| `violation_count` | `INTEGER` | 違反件数 |
| `handbook_version` | `VARCHAR(100)` | 使用した経理ハンドブックのバージョン |

#### `rule_check_results` (ルールチェック結果テーブル)
| カラム名 | データ型 | 説明 |
| :--- | :--- | :--- |
| `id` | `SERIAL PRIMARY KEY` | 一意なID (自動採番) |
| `session_id` | `INTEGER` | チェックセッションID（`rule_check_sessions`への外部キー） |
| `invoice_id` | `INTEGER` | 請求書ID（`invoices`への外部キー） |
| `rule_id` | `INTEGER` | 適用ルールID（`accounting_rules`への外部キー） |
| `check_result` | `VARCHAR(20)` | チェック結果（compliant, warning, violation） |
| `current_value` | `TEXT` | 請求書の現在値 |
| `expected_value` | `TEXT` | 期待値 |
| `violation_reason` | `TEXT` | 違反理由の詳細説明 |
| `suggestion` | `TEXT` | 修正提案 |
| `checked_at` | `TIMESTAMP` | チェック実行日時 |

## 4. ビジネスロジック仕様

### 4.1. 請求書処理フロー

1.  **ファイル受付・保存:** アップロードされたPDFをGoogle Driveに保存し、`invoices`テーブルにレコードを作成する。
2.  **一次情報抽出:** Gemini APIを呼び出し、請求書から一次情報（請求元, キー情報, 明細等）を抽出する。
3.  **仕訳提案:** 抽出した情報と支払マスタを照合し、仕訳を提案。外貨の場合はカード明細との照合も試みる。
4.  **データ更新:** 提案結果を`invoices`テーブルに書き込み、ステータスを更新する。

### 4.2. 支払マスタ作成・承認フロー

1.  **ユーザー申請:** ユーザーがUIから新しいマスタ情報を入力すると、`payment_masters`に`approval_status: 'pending'`でレコードが作成される。
2.  **管理者通知:** 管理者に承認依頼メールが送信される。
3.  **管理者承認:** 管理者がUIで「承認」すると、`approval_status`が`approved`に更新される。
4.  **関連データ再処理:** 承認をトリガーに、この新しいマスタを必要としていた請求書の仕訳提案ロジックが自動で再実行される。

### 4.3. 経理ルールチェック処理フロー

1.  **経理ハンドブック取得:** Google Slides API を使用して最新の経理ハンドブックを取得する。
2.  **ルール抽出・保存:** 
    * 各スライドのコンテンツを Gemini API で解析し、経理ルールを構造化データとして抽出する。
    * 抽出したルールを `accounting_rules` テーブルに保存または更新する。
3.  **チェックセッション開始:** 
    * `rule_check_sessions` テーブルに新しいセッションレコードを作成する。
    * チェック対象の請求書データ（承認待ち・承認済み）を特定する。
4.  **個別チェック実行:**
    * 各請求書データに対して適用可能なルールを特定する。
    * 請求書の各項目（勘定科目、支払期日、金額等）とルールを照合する。
    * チェック結果を `rule_check_results` テーブルに保存する。
5.  **結果集計・完了:**
    * セッション全体の集計結果（準拠・警告・違反の件数）を計算する。
    * `rule_check_sessions` テーブルのステータスを完了に更新する。
6.  **結果表示:** UI でチェック結果をダッシュボード形式で表示する。

## 5. 非機能要件

* **ユーザビリティ:** マニュアル不要で直感的に操作できるUI/UX。
* **パフォーマンス:** 大量データでも快適な表示・検索速度。
* **セキュリティ:** ユーザー間のデータ分離と、適切な権限管理。
* **拡張性:** 将来的な機能追加が容易なアーキテクチャ。
* **運用性:** システム動作状況の監視、デバッグ機能、ログ管理機能。

## 6. ログ・デバッグ機能仕様

### 6.1. ログ機能

#### 6.1.1. ログ設定管理
* **設定ファイル:** `config/settings.ini` でログ動作を統一管理
* **設定項目:**
  - ログレベル (DEBUG, INFO, WARNING, ERROR, CRITICAL)
  - ログファイル出力の有効/無効
  - ログファイル保存先パス
  - ファイルローテーション設定（最大サイズ、バックアップ数）
  - コンソール出力の有効/無効
  - 詳細ログフォーマットの有効/無効

#### 6.1.2. ログ出力仕様
* **ファイル出力:**
  - 保存先: `logs/app.log`
  - エンコーディング: UTF-8
  - ローテーション: 10MB超過時に自動実行
  - 保持ファイル数: 5世代 (`app.log`, `app.log.1`～`app.log.5`)
* **コンソール出力:**
  - 開発時のリアルタイム監視用
  - 本番環境では無効化可能
* **ログフォーマット:**
  - 標準: `%(asctime)s - %(levelname)s - %(name)s - %(message)s`
  - 詳細: `%(asctime)s - %(name)s - %(levelname)s - %(filename)s:%(lineno)d - %(funcName)s() - %(message)s`

#### 6.1.3. ログレベル別記録内容
* **DEBUG:** デバッグ用詳細情報（開発・検証時のみ）
* **INFO:** 正常な処理フロー（ユーザー操作、処理完了等）
* **WARNING:** 注意が必要な事象（マスタ不一致、API応答遅延等）
* **ERROR:** エラー発生（処理失敗、例外発生等）
* **CRITICAL:** システム停止レベルの重大エラー

### 6.2. デバッグ機能

#### 6.2.1. デバッグモード
* **一般デバッグモード:** システム全体のデバッグ情報表示
* **カテゴリ別デバッグ:** 機能別の詳細デバッグ情報
  - `database_debug`: データベース操作の詳細
  - `ai_debug`: AI処理（Gemini API）の詳細  
  - `gdrive_debug`: Google Drive API操作の詳細
  - `streamlit_debug`: Streamlit関連の詳細

#### 6.2.2. デバッグパネル（管理者向け）
Streamlitアプリ内でのログ・デバッグ設定管理機能：

* **現在設定表示:** 動作中のログレベル、デバッグモード状況
* **一時設定変更:** セッション中の設定変更（再起動不要）
* **ログファイル表示:** リアルタイムログ閲覧（指定行数表示）
* **設定ファイル編集:** `settings.ini` の直接編集機能
* **デバッグ情報表示:** セッション状態、環境変数等の確認

#### 6.2.3. 動的設定変更
* アプリケーション実行中の設定変更をサポート
* 設定変更後の即座の反映（一部設定は再起動が必要）
* 設定変更履歴の記録

### 6.3. 運用監視支援

#### 6.3.1. ログ監視
* エラーレベルログの自動検知
* 管理者への通知機能（メール等）
* ログファイルの容量監視

#### 6.3.2. デバッグ支援
* 問題発生時の詳細ログ出力
* ユーザー操作の追跡
* API呼び出し履歴の記録