# 📊 取込データダッシュボード　アクティビティ図

**作成日**: 2025年8月1日  
**バージョン**: 1.0  
**対象システム**: 請求書処理自動化システム  
**対象機能**: 取込データダッシュボード

## 📋 概要

本ドキュメントは取込データダッシュボード機能のアクティビティ図を定義します。  
**一般ユーザー**と**管理者**の2つの権限レベルに対応したダッシュボード操作フローと、システム全体の権限制御フローを詳細に記載しています。

### 🎯 アクティビティ図一覧

| **図番号** | **対象** | **機能概要** | **主要操作** |
|-----------|---------|-------------|-------------|
| **図1** | **一般ユーザー** | 個人データ管理・表示・編集 | フィルタリング・詳細表示・編集・エクスポート・申請 |
| **図2** | **管理者** | 全データ管理・承認・連携 | 全データ管理・承認・freee連携・ルールチェック |
| **図3** | **権限制御** | アクセス制御・画面遷移 | 認証・権限判定・セキュリティ制御 |

---

## 📊 図1: 一般ユーザー向けダッシュボード　アクティビティ図

### 対象ユーザー
- **一般ユーザー**: 各部門の担当者
- **権限**: 自分がアップロードした請求書データのみアクセス可能
- **制限**: `user_email`による自分のデータのみ表示・編集

### 主要機能フロー

```mermaid
flowchart TD
    A["🚀 ダッシュボードアクセス"] --> B{"🔐 ログイン済み？"}
    B -->|No| C["📝 Googleアカウントログイン"]
    C --> D["✅ 認証完了"]
    B -->|Yes| D
    
    D --> E["📊 ダッシュボード表示"]
    E --> F["💾 自分の請求書データ取得<br/>(user_email制限)"]
    
    F --> G{"📄 データ存在？"}
    G -->|No| H["📤 アップロード画面へ誘導"]
    H --> I["📋 ファイルアップロード"]
    I --> J["🤖 AI処理実行"]
    J --> E
    
    G -->|Yes| K["📋 請求書一覧表示<br/>(ag-grid)"]
    
    K --> L["🔍 操作選択"]
    
    L --> M1["🔎 フィルタリング・検索"]
    L --> M2["📝 詳細表示・編集"]
    L --> M3["📊 エクスポート"]
    L --> M4["➕ 新規登録申請"]
    L --> M5["🔄 データ更新"]
    
    %% フィルタリング・検索フロー
    M1 --> N1["📅 期間フィルタ設定"]
    N1 --> N2["💰 金額範囲指定"]
    N2 --> N3["📊 ステータス選択"]
    N3 --> N4["🏢 発行者検索"]
    N4 --> N5["🔍 フィルタ実行"]
    N5 --> K
    
    %% 詳細表示・編集フロー
    M2 --> O1["📋 行選択"]
    O1 --> O2["👁️ 詳細プレビュー表示"]
    O2 --> O3{"📝 編集権限？"}
    O3 -->|Yes| O4["✏️ セル編集"]
    O3 -->|No| O5["👁️ 読み取り専用表示"]
    O4 --> O6["💾 変更保存"]
    O6 --> O7["✅ 更新完了通知"]
    O5 --> O7
    O7 --> K
    
    %% エクスポートフロー
    M3 --> P1["📑 エクスポート形式選択"]
    P1 --> P2{"📋 全データ/フィルタ結果？"}
    P2 -->|全データ| P3["📄 全請求書データ取得"]
    P2 -->|フィルタ結果| P4["🔍 現在のフィルタ結果取得"]
    P3 --> P5["📊 Excel/CSV生成"]
    P4 --> P5
    P5 --> P6["⬇️ ダウンロード開始"]
    P6 --> K
    
    %% 新規登録申請フロー
    M4 --> Q1["📝 申請フォーム表示"]
    Q1 --> Q2["🏢 取引先情報入力"]
    Q2 --> Q3["📋 必須項目チェック"]
    Q3 --> Q4{"✅ 入力完了？"}
    Q4 -->|No| Q2
    Q4 -->|Yes| Q5["📤 申請送信"]
    Q5 --> Q6["⏳ 承認待ちステータス"]
    Q6 --> Q7["📧 申請完了通知"]
    Q7 --> K
    
    %% データ更新フロー
    M5 --> R1["🔄 最新データ取得"]
    R1 --> R2["📊 表示更新"]
    R2 --> R3["✅ 更新完了表示"]
    R3 --> K
    
    %% エラーハンドリング
    F --> S1{"❌ エラー発生？"}
    S1 -->|Yes| S2["🚨 エラーメッセージ表示"]
    S2 --> S3["🔄 再試行ボタン"]
    S3 --> F
    S1 -->|No| K
    
    style A fill:#e1f5fe
    style K fill:#f3e5f5
    style O6 fill:#e8f5e8
    style Q5 fill:#fff3e0
```

### 🔧 技術実装ポイント
- **データ制限**: `WHERE user_email = current_user.email`によるデータアクセス制限
- **UI表示**: ag-gridによるインタラクティブな表示・編集
- **フィルタリング**: SQLクエリとクライアントサイドフィルタの組み合わせ
- **エクスポート**: pandas DataFrame → Excel/CSV変換

---

## 👑 図2: 管理者向けダッシュボード　アクティビティ図

### 対象ユーザー
- **管理者**: 経理担当者
- **権限**: 全ユーザーのデータアクセス可能・システム管理機能利用可能
- **制限**: なし（全データアクセス）

### 主要機能フロー

```mermaid
flowchart TD
    A["🚀 管理者ダッシュボードアクセス"] --> B{"🔐 管理者権限確認"}
    B -->|権限なし| C["❌ アクセス拒否"]
    B -->|権限あり| D["👑 管理者ダッシュボード表示"]
    
    D --> E["📊 統合統計表示"]
    E --> F["🔧 管理機能選択"]
    
    F --> G1["📋 全データ管理"]
    F --> G2["⚙️ 支払マスタ管理"]
    F --> G3["✅ 申請承認管理"]
    F --> G4["📊 freee連携管理"]
    F --> G5["📏 ルール準拠チェック"]
    F --> G6["📜 システムログ閲覧"]
    F --> G7["🎯 課題・進捗管理"]
    
    %% 全データ管理フロー
    G1 --> H1["🌐 全ユーザーデータ取得<br/>(権限制限なし)"]
    H1 --> H2["📊 統合一覧表示<br/>(ユーザー別・ステータス別)"]
    H2 --> H3["🔍 管理者操作選択"]
    
    H3 --> H4["🔎 高度フィルタリング"]
    H3 --> H5["📝 データ一括編集"]
    H3 --> H6["🗑️ データ削除"]
    H3 --> H7["📊 詳細分析"]
    H3 --> H8["📤 一括エクスポート"]
    
    H4 --> I1["👤 ユーザー別フィルタ"]
    I1 --> I2["📅 期間フィルタ"]
    I2 --> I3["💰 金額範囲"]
    I3 --> I4["📊 処理ステータス"]
    I4 --> I5["🔍 フィルタ実行"]
    I5 --> H2
    
    H5 --> J1["📋 複数行選択"]
    J1 --> J2["🏷️ ステータス一括変更"]
    J2 --> J3["✅ 承認一括処理"]
    J3 --> J4["💾 変更保存"]
    J4 --> J5["📧 関係者通知"]
    J5 --> H2
    
    %% 支払マスタ管理フロー
    G2 --> K1["🏢 支払マスタ一覧表示"]
    K1 --> K2["⚙️ マスタ操作選択"]
    
    K2 --> K3["➕ 新規追加"]
    K2 --> K4["✏️ 編集"]
    K2 --> K5["🗑️ 削除"]
    K2 --> K6["🔍 検索"]
    K2 --> K7["📤 インポート/エクスポート"]
    
    K3 --> L1["📝 新規マスタ情報入力"]
    L1 --> L2["🔍 重複チェック"]
    L2 --> L3{"❓ 重複あり？"}
    L3 -->|Yes| L4["⚠️ 重複警告表示"]
    L4 --> L1
    L3 -->|No| L5["💾 新規マスタ保存"]
    L5 --> L6["✅ 登録完了通知"]
    L6 --> K1
    
    %% 申請承認管理フロー
    G3 --> M1["📋 承認待ち一覧表示"]
    M1 --> M2["📝 申請詳細確認"]
    M2 --> M3{"⚖️ 承認判定"}
    
    M3 -->|承認| M4["✅ 承認処理"]
    M3 -->|却下| M5["❌ 却下処理"]
    M3 -->|保留| M6["⏳ 保留処理"]
    
    M4 --> M7["💾 承認データ保存"]
    M7 --> M8["📧 申請者通知(承認)"]
    M8 --> M1
    
    M5 --> M9["📝 却下理由入力"]
    M9 --> M10["💾 却下データ保存"]
    M10 --> M11["📧 申請者通知(却下)"]
    M11 --> M1
    
    %% freee連携管理フロー
    G4 --> N1["📊 連携対象データ確認"]
    N1 --> N2{"✅ 承認済みデータ？"}
    N2 -->|No| N3["⚠️ 未承認データ警告"]
    N3 --> N1
    N2 -->|Yes| N4["📋 連携データ選択"]
    
    N4 --> N5["🔧 freee連携設定確認"]
    N5 --> N6{"⚙️ 設定OK？"}
    N6 -->|No| N7["❌ 設定エラー表示"]
    N7 --> N5
    N6 -->|Yes| N8["📤 freee連携実行"]
    
    N8 --> N9["⏳ 連携処理中"]
    N9 --> N10{"✅ 連携成功？"}
    N10 -->|Yes| N11["✅ 連携完了通知"]
    N10 -->|No| N12["❌ 連携エラー表示"]
    N11 --> N13["📊 連携結果表示"]
    N12 --> N13
    N13 --> G4
    
    %% ルール準拠チェックフロー
    G5 --> O1["📏 経理ルール取得"]
    O1 --> O2["🤖 AI準拠チェック実行"]
    O2 --> O3["📊 チェック結果表示"]
    O3 --> O4["🚨 不整合項目ハイライト"]
    O4 --> O5["📝 修正提案表示"]
    O5 --> O6["✏️ 修正実行/承認"]
    O6 --> G5
    
    %% システムログ閲覧フロー
    G6 --> P1["📜 ログレベル選択"]
    P1 --> P2["📅 期間指定"]
    P2 --> P3["👤 ユーザー指定"]
    P3 --> P4["🔍 ログ検索実行"]
    P4 --> P5["📋 ログ一覧表示"]
    P5 --> P6["📊 ログ詳細表示"]
    P6 --> G6
    
    %% 課題・進捗管理フロー
    G7 --> Q1["🎯 課題一覧表示"]
    Q1 --> Q2["📊 進捗状況確認"]
    Q2 --> Q3["⚙️ 課題管理操作"]
    
    Q3 --> Q4["➕ 新規課題登録"]
    Q3 --> Q5["✏️ 課題更新"]
    Q3 --> Q6["✅ 課題完了"]
    Q3 --> Q7["📊 レポート生成"]
    
    Q4 --> Q8["📝 課題詳細入力"]
    Q8 --> Q9["👤 担当者割当"]
    Q9 --> Q10["📅 期日設定"]
    Q10 --> Q11["💾 課題保存"]
    Q11 --> Q1
    
    %% エラーハンドリング
    H1 --> R1{"❌ データ取得エラー？"}
    R1 -->|Yes| R2["🚨 エラーメッセージ表示"]
    R2 --> R3["🔄 再試行ボタン"]
    R3 --> H1
    R1 -->|No| H2
    
    style A fill:#fce4ec
    style D fill:#e8f5e8
    style L5 fill:#fff3e0
    style M7 fill:#e3f2fd
    style N11 fill:#f1f8e9
```

### 🔧 技術実装ポイント
- **権限チェック**: `user.role == 'admin'`による管理者権限確認
- **全データアクセス**: 権限制限なしのSQLクエリ実行
- **承認ワークフロー**: ステータス更新 + 通知機能
- **一括操作**: トランザクション処理による安全な一括更新

---

## 🛡️ 図3: 権限制御・画面遷移フロー　アクティビティ図

### システム全体のセキュリティ制御
- **認証**: Google OAuth認証
- **権限管理**: user/admin の2段階権限
- **アクセス制御**: 機能別・データ別のきめ細かいアクセス制御

### 権限制御フロー

```mermaid
flowchart TD
    A["🚀 システムアクセス"] --> B["🔐 Google OAuth認証"]
    B --> C{"✅ 認証成功？"}
    C -->|No| D["❌ 認証失敗<br/>ログイン画面へ"]
    D --> B
    C -->|Yes| E["👤 ユーザー情報取得"]
    
    E --> F["📊 データベースからuser情報取得"]
    F --> G{"👑 権限レベル確認"}
    
    G -->|user| H["🧑‍💼 一般ユーザーダッシュボード"]
    G -->|admin| I["👑 管理者ダッシュボード"]
    G -->|未登録| J["📝 初回登録画面"]
    
    J --> K["🔧 デフォルト権限設定(user)"]
    K --> H
    
    %% 一般ユーザー権限制御
    H --> L["🔒 データアクセス制限設定<br/>(user_email = 自分のみ)"]
    L --> M["📋 利用可能機能表示"]
    
    M --> M1["📊 自分の請求書閲覧"]
    M --> M2["📝 データ編集(自分のみ)"]
    M --> M3["📤 ファイルアップロード"]
    M --> M4["➕ 新規登録申請"]
    M --> M5["📊 個人エクスポート"]
    M --> M6["⚙️ 個人設定"]
    
    %% 管理者権限制御
    I --> N["🔓 全データアクセス権限設定<br/>(制限なし)"]
    N --> O["👑 管理者機能表示"]
    
    O --> O1["🌐 全ユーザーデータ閲覧"]
    O --> O2["⚙️ 支払マスタ管理"]
    O --> O3["✅ 申請承認"]
    O --> O4["📊 freee連携実行"]
    O --> O5["📏 ルール準拠チェック"]
    O --> O6["📜 システムログ閲覧"]
    O --> O7["🎯 課題管理"]
    O --> O8["📊 統計・レポート"]
    O --> O9["🔧 システム設定"]
    
    %% 画面遷移制御
    M1 --> P1["📊 個人ダッシュボード画面"]
    M2 --> P2["✏️ 個人データ編集画面"]
    M3 --> P3["📤 ファイルアップロード画面"]
    M4 --> P4["📝 申請フォーム画面"]
    M5 --> P5["📊 個人エクスポート画面"]
    M6 --> P6["⚙️ 個人設定画面"]
    
    O1 --> Q1["🌐 全体統計ダッシュボード画面"]
    O2 --> Q2["⚙️ 支払マスタ管理画面"]
    O3 --> Q3["✅ 申請承認管理画面"]
    O4 --> Q4["📊 freee連携管理画面"]
    O5 --> Q5["📏 ルール準拠チェック画面"]
    O6 --> Q6["📜 システムログ画面"]
    O7 --> Q7["🎯 課題管理画面"]
    O8 --> Q8["📊 レポート・分析画面"]
    O9 --> Q9["🔧 システム設定画面"]
    
    %% セキュリティチェック
    P2 --> R1{"🔒 編集権限チェック"}
    R1 -->|権限なし| R2["❌ アクセス拒否"]
    R1 -->|権限あり| R3["✅ 編集画面表示"]
    R2 --> P1
    
    Q2 --> S1{"👑 管理者権限チェック"}
    S1 -->|権限なし| S2["❌ 管理者権限エラー"]
    S1 -->|権限あり| S3["✅ 管理画面表示"]
    S2 --> H
    
    %% 横断的機能アクセス制御
    T1["🔄 データ更新"] --> T2{"👤 権限レベル確認"}
    T2 -->|user| T3["📊 個人データのみ更新"]
    T2 -->|admin| T4["🌐 全データ更新可能"]
    
    U1["📤 エクスポート"] --> U2{"👤 権限レベル確認"}
    U2 -->|user| U3["📊 個人データのみエクスポート"]
    U2 -->|admin| U4["🌐 全データエクスポート可能"]
    
    V1["🗑️ データ削除"] --> V2{"👤 権限レベル確認"}
    V2 -->|user| V3["⚠️ 削除権限なし"]
    V2 -->|admin| V4["🗑️ 削除実行可能"]
    V3 --> V5["❌ 削除不可通知"]
    
    %% セッション管理
    W1["⏱️ セッション監視"] --> W2{"🕐 セッション有効？"}
    W2 -->|無効| W3["🔐 再認証要求"]
    W2 -->|有効| W4["✅ アクセス継続"]
    W3 --> B
    
    %% エラーハンドリング
    X1["❌ 権限エラー発生"] --> X2["🚨 エラーメッセージ表示"]
    X2 --> X3["🔙 前画面に戻る"]
    X3 --> X4{"👤 現在の権限"}
    X4 -->|user| H
    X4 -->|admin| I
    
    style A fill:#e3f2fd
    style H fill:#e8f5e8
    style I fill:#fce4ec
    style R2 fill:#ffebee
    style S2 fill:#ffebee
    style V5 fill:#fff3e0
```

### 🔧 技術実装ポイント
- **OAuth認証**: Google OAuth 2.0による認証
- **セッション管理**: Streamlit session stateによる状態管理
- **権限チェック**: デコレータパターンによる機能別権限制御
- **エラーハンドリング**: ユーザーフレンドリーなエラー表示

---

## 🚀 実装ガイドライン

### 📋 開発優先順位

#### **Phase 1: 基本フロー実装（1週間）**
1. **権限制御基盤** - 図3の認証・権限判定部分
2. **一般ユーザー基本フロー** - 図1のデータ表示・基本操作
3. **管理者基本フロー** - 図2の全データ表示・基本管理

#### **Phase 2: 高度機能実装（2週間）**
1. **フィルタリング・検索** - 図1, 2の詳細検索機能
2. **編集・承認機能** - 図1の編集、図2の承認ワークフロー
3. **エクスポート機能** - 図1, 2のデータエクスポート

#### **Phase 3: 管理者専用機能（3週間）**
1. **支払マスタ管理** - 図2のマスタCRUD操作
2. **freee連携管理** - 図2のfreee連携実行・監視
3. **システム管理** - 図2のログ閲覧・課題管理

### 🔧 技術実装マップ

| **機能** | **実装方法** | **主要コンポーネント** |
|---------|-------------|---------------------|
| **権限制御** | `get_current_user()`による動的権限判定 | `oauth_handler.py` |
| **データフィルタリング** | SQLクエリ + ag-gridフィルタ | `DatabaseManager` + `AgGridManager` |
| **画面遷移** | Streamlit `st.session_state`による状態管理 | `st.rerun()` |
| **エラーハンドリング** | try-catch + ユーザーフレンドリーエラー表示 | `st.error()`, `st.warning()` |
| **一括操作** | トランザクション処理による安全な一括更新 | PostgreSQL Transaction |
| **リアルタイム更新** | 定期的データ取得 + 差分更新 | `st.rerun()` + caching |

### 📝 テストシナリオ

#### **一般ユーザーテスト**
1. ログイン → 自分のデータのみ表示確認
2. フィルタリング機能の動作確認
3. 詳細表示・編集機能の確認
4. エクスポート機能の確認
5. 新規登録申請機能の確認

#### **管理者テスト**
1. 管理者権限での全データアクセス確認
2. 支払マスタ管理機能の確認
3. 申請承認ワークフローの確認
4. freee連携機能の確認
5. システムログ機能の確認

#### **権限制御テスト**
1. 未認証アクセスの拒否確認
2. 権限レベル別機能制限の確認
3. 不正アクセス試行時のエラーハンドリング確認
4. セッション管理の確認

---

**最終更新**: 2025年8月1日  
**承認者**: システム設計者・開発チーム  
**レビュー予定**: 2025年9月1日

**関連ドキュメント**:
- [01_要件定義書.md](01_要件定義書.md) - システム要件・ユーザー役割定義
- [21_クラス図.md](21_クラス図.md) - システムアーキテクチャ・クラス設計
- [20_シーケンス図集.md](20_シーケンス図集.md) - 処理フロー・データ連携