# 請求書処理自動化システム デプロイ設計書

**バージョン:** 1.0
**作成日:** 2025/07/17

## 1. 概要
本ドキュメントは、Streamlitで開発された請求書処理自動化アプリケーションを、Google Cloud Platform (GCP) 上に展開（デプロイ）し、安定的に運用するための設計を定義する。

## 2. システム構成
（仕様書より再掲）
\`\`\`
+----------------+      +-------------------------+      +-------------------+
|                |      |                         |      |                   |
|   ユーザー      | <=>  |  Streamlit フロントエンド  | <=>  |  Python バックエンド  |
| (ブラウザ)      |      |  (UI, ダッシュボード)     |      |  (ビジネスロジック)   |
|                |      |                         |      |                   |
+----------------+      +-------------------------+      +----------+--------+
                                                                    |
                               +------------------------------------+------------------------------------+
                               |                                    |                                    |
                               v                                    v                                    v
                      +----------+--------+               +----------+--------+               +----------+--------+
                      |                   |               |                   |               |                   |
                      |     データベース      |               |     Gemini API    |               |   Google Drive    |
                      | (Supabase)        |               | (情報抽出)        |               | (PDFストレージ)     |
                      |                   |               |                   |               |                   |
                      +-------------------+               +-------------------+               +-------------------+
\`\`\`

## 3. インフラストラクチャ

### 3.1. アプリケーションサーバー
* **サービス:** **Google Cloud Run**
* **採用理由:**
    * コンテナベースのサーバーレス環境であり、インフラ管理の手間がほとんどない。
    * リクエストがない時はスケールダウンしてゼロになるため、コスト効率が非常に高い。
    * トラフィックに応じて自動でスケールアップ/ダウンするため、安定したパフォーマンスを提供できる。
* **コンテナイメージ:** Dockerfileを用いてStreamlitアプリケーションをコンテナ化し、Google Artifact Registryに保存する。

### 3.2. データベース
* **サービス:** **Supabase**
* **採用理由:**
    * フルマネージドのPostgreSQLであり、データベースの専門知識がなくても容易に運用開始できる。
    * 認証、ストレージなど、開発を加速させる機能が統合されている。
    * 無料プランから始められ、ビジネスの成長に合わせてスケールアップが可能。

### 3.3. ファイルストレージ
* **サービス:** **Google Drive**
* **採用理由:**
    * 大容量のファイルを低コストで保管できる。
    * 既存のGoogle Workspace環境との親和性が高く、ユーザーがアクセスしやすい。

## 4. CI/CD (継続的インテグレーション/継続的デプロイ)
* **ツール:** **GitHub Actions**
* **パイプライン概要:**
    1.  **トリガー:** 開発者がGitHubの`main`ブランチにコードをプッシュする。
    2.  **テスト:** 自動で`pytest`による単体テストが実行される。
    3.  **ビルド:** テストが成功すると、Dockerfileを基にコンテナイメージがビルドされる。
    4.  **プッシュ:** ビルドされたコンテナイメージがGoogle Artifact Registryにプッシュされる。
    5.  **デプロイ:** 新しいイメージを使用して、Google Cloud Runサービスが自動で更新される。
* **効果:** このパイプラインにより、手動でのデプロイ作業が不要になり、迅速かつ安全にアプリケーションを更新できる。

## 5. デプロイ手順

### 5.1. 初回デプロイ
1.  **Supabaseプロジェクトセットアップ**
    * Supabaseプロジェクトを作成し、データベースを初期化する。
    * 必要なテーブルを作成し、初期データを投入する。

2.  **GCPプロジェクトセットアップ**
    * GCPプロジェクトを作成し、必要なAPIを有効化する：
      * Cloud Run API
      * Artifact Registry API  
      * Secret Manager API
      * Identity and Access Management (IAM) API

3.  **OAuth 2.0認証設定**
    * **OAuth同意画面の設定:**
      * アプリケーション名: "請求書処理自動化システム"
      * 承認済みドメイン: デプロイ先ドメインを追加
      * スコープ: `openid`, `email`, `profile`
    * **OAuth 2.0クライアントIDの作成:**
      * アプリケーションの種類: "ウェブアプリケーション"
      * 承認済みのリダイレクトURI: 
        * 開発: `http://localhost:8501`
        * 本番: `https://your-app-domain.run.app/oauth/callback`

4.  **Secret Manager設定**
    * 以下のシークレットをSecret Managerに登録:
      ```
      SUPABASE_URL: Supabaseプロジェクトのurl
      SUPABASE_ANON_KEY: Supabaseのanonymous key
      GEMINI_API_KEY: Gemini APIキー
      GOOGLE_SERVICE_ACCOUNT_KEY: Google APIサービスアカウントキー
      OAUTH_CLIENT_ID: OAuthクライアントID
      OAUTH_CLIENT_SECRET: OAuthクライアントシークレット
      COOKIE_SECRET: セッション暗号化用シークレット（32文字以上）
      ```

5.  **GitHub Actions CI/CD設定**
    * ワークフローファイル `.github/workflows/deploy.yml` を作成
    * GCPサービスアカウントキーをGitHub Secretsに設定
    * 環境別デプロイ設定（staging/production）

6.  **初回デプロイ実行**
    * コードを`main`ブランチにプッシュし、CI/CDパイプラインを起動
    * デプロイ完了後、認証動作確認を実施

### 5.2. 更新デプロイ
* 開発者は、修正したコードをGitHubにプッシュするだけ。CI/CDパイプラインが自動でテストとデプロイを実行する。

## 6. 監視・運用計画

### 6.1. ログ設定・監視
* **ログ設定管理:**
  - `config/settings.ini` でログレベル、出力先、ローテーション設定を管理
  - 本番環境: INFO レベル以上のログを出力
  - 開発環境: DEBUG レベルからの詳細ログを出力
  - ログファイル: `logs/app.log` (10MB毎にローテーション、5世代保持)

* **ログ監視:**
  - **Cloud Logging:** Google Cloud Loggingを利用し、Cloud Runから出力されるアプリケーションログ（標準出力、エラー）を収集・監視する
  - **アプリケーションログ:** ローカルファイル (`logs/app.log`) とコンソール出力の両方でログを記録
  - **アラート設定:** エラーレベルのログ発生時には管理者に自動で通知されるようにする
  - **デバッグパネル:** Streamlitアプリ内でリアルタイムログ確認、設定変更が可能

* **カテゴリ別ログ:**
  - `[DATABASE]` Supabase操作ログ
  - `[AI]` Gemini API処理ログ  
  - `[GDRIVE]` Google Drive API操作ログ
  - `[STREAMLIT]` UI操作・セッション管理ログ

### 6.2. 設定ファイル管理
* **本番環境設定:**
  ```ini
  [logging]
  log_level = INFO
  enable_file_logging = true
  enable_console_logging = true
  
  [debug]
  debug_mode = false
  
  [system]
  environment = production
  ```

* **開発環境設定:**
  ```ini
  [logging]
  log_level = DEBUG
  detailed_logging = true
  
  [debug]
  debug_mode = true
  database_debug = true
  ai_debug = true
  ```

### 6.3. パフォーマンス監視
* **Google Cloud Monitoring:** Cloud Runのレスポンス時間やCPU使用率などを監視する。
* **アプリケーション監視:** デバッグパネルでセッション状態、システム情報をリアルタイム確認。

### 6.4. バックアップ・復旧
* **データベース:** Supabaseの自動バックアップ機能を利用し、データベースを定期的にバックアップする。
* **ログファイル:** Cloud Runの永続化ストレージまたは定期的な外部保存を検討。
* **設定ファイル:** Git管理により設定履歴を保持。