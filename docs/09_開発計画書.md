# 請求書処理自動化システム 開発計画書

**バージョン:** 1.3
**作成日:** 2025/07/17
**最終更新:** 2025/07/22 (プロンプトシステム基盤エラー群4件の緊急対応追加)

## 1. プロジェクト概要

### 1.1. 目的
本プロジェクトは、現行のGoogle Apps Scriptベースの請求書処理システムを、PythonおよびStreamlitを用いたWebアプリケーションに移行することを目的とする。これにより、スプレッドシート配布による管理の複雑化を解消し、優れたUI/UXと高い拡張性を持つ、持続可能な請求書処理プラットフォームを構築する。

### 1.2. 成果物
1.  Streamlitで構築された請求書処理Webアプリケーション
2.  Supabaseで構築されたデータベース（請求書データ、支払マスタ等）
3.  Google Driveを利用したPDFファイルストレージ
4.  各種設計書、ドキュメント

### 1.3. スコープ（対象範囲）
* **スコープ内:**
    * 要件定義書および仕様書に記載されたすべての機能の実装
    * ユーザー認証、請求書アップロード、AIによる自動仕訳提案、データ編集・管理機能
    * 管理者向け機能（マスタ管理、ログ閲覧、データ書き出し等）
    * Supabaseデータベースの構築と連携
    * Google Drive API、Gemini API等との連携
* **スコープ外:**
    * 会計システム（freee）とのAPI直接連携（中間ファイルとしてスプレッドシートへの書き出しまでを対象とする）
    * オフラインでの利用機能
    * スマートフォンアプリの開発

## 2. 開発体制

| 役割 | 担当 | 責務 |
| :--- | :--- | :--- |
| **プロジェクトマネージャー** | 原口 陽一郎 | プロジェクト全体の進捗管理、課題管理、意思決定 |
| **開発リード** | Gemini | 技術選定、アーキテクチャ設計、主要機能の実装、コードレビュー |
| **プロダクトオーナー** | 佐久間 舞 | 要件定義、仕様の確認、受け入れテストの実施、ユーザーからのフィードバック集約 |

## 3. 開発スケジュール（案）

本プロジェクトは、以下の4つのフェーズに分けて開発を進める。

| フェーズ | 期間（実績/予定） | 主なマイルストーン | ステータス |
| :--- | :--- | :--- | :--- |
| **技術検証フェーズ** | 4日間<br>(7/17-7/20) | ・Supabase接続とCRUD操作確認<br>・Gemini API連携とPDF情報抽出テスト<br>・Google Drive API連携テスト<br>・ag-gridデータグリッド機能検証<br>・基本ワークフロー統合テスト<br>・ログ設定・デバッグ機能実装 | **完了** |
| **フェーズ1: 基盤構築** | 6日間<br>(7/17-7/22) | ・Supabaseデータベースのテーブル設計と構築完了<br>・Streamlitアプリケーションの雛形作成（ログイン、画面遷移）<br>・主要な外部API（Supabase, Google）との接続確立<br>・PowerShell開発・運用環境整備<br>・運用監視基盤（ログ・デバッグパネル）構築 | **完了** |
| **フェーズ2: コア機能実装** | 8日間<br>(7/21-7/28) | ・請求書PDFのアップロードとGoogle Driveへの保存機能完了<br>・AIによる一次情報抽出（`invoice_prompt`）とDBへの保存機能完了<br>・**PDF明細解析仕様の詳細定義と複数明細取得機能完了**<br>・2段階AI照合による仕訳提案ロジックの実装完了<br>・基本ワークフロー完全統合 | **実行中** |
| **フェーズ3: 基本UI実装** | 2日間<br>(7/29-7/30) | ・**必須機能のみ**: 処理状況ダッシュボード（ag-grid）でのデータ表示・編集<br>・基本的な管理者向け画面（支払マスタ管理）<br>・**高度なUI機能は次期バージョンに延期** | **実行中** |
| **フェーズ4: 最小限テスト・リリース** | 1日間<br>(7/31) | ・基本機能の動作確認とクリティカル障害のみ修正<br>・本番環境への緊急デプロイ<br>・**詳細テストは運用開始後に並行実施** | **未着手** |
| **合計** | **2週間** | | **20日短縮・7/31緊急リリース** |

## 4. 緊急開発計画（7/31リリース対応）

### 4.1. 🎉 **緊急タスク完了実績（7/28現在）**
7/31リリースに向けた最優先タスクの完了状況：

| 優先度 | タスク | 進捗状況 | 完了日 | 備考 |
| :--- | :--- | :--- | :--- | :--- |
| **🚨最高** | プロンプト変数型エラー修正（ISS-005） | **✅完了** | **7/22** | ✅ master_company_list型チェック問題解決。自動型変換機能実装 |
| **🚨最高** | Gemini AI JSON解析エラー修正（ISS-006） | **✅完了** | **7/22** | ✅ `_extract_json_from_response`でJSON抽出強化。複数パターン対応 |
| **🚨最高** | 統合照合プロンプト変数修正（ISS-007） | **✅完了** | **7/22** | ✅ integrated_matcher_promptの変数置換完全修正 |
| **🚨高** | Streamlit進捗表示UI修正（ISS-008） | **✅完了** | **7/22** | ✅ リアルタイム進捗表示の最適化・エラーハンドリング強化 |
| **最高** | PDF明細解析仕様の詳細定義と検証 | **✅完了** | **7/28** | ✅ 複数明細構造化定義とline_itemsテーブル実装完了 |
| **最高** | 複数明細取得機能の実装・テスト | **✅完了** | **7/28** | ✅ 明細分離と構造化処理実装、line_items連携済み |
| **最高** | 2段階AI照合ロジック実装（基本版） | **✅完了** | **7/27** | ✅ 基本照合機能実装、次期版で高度機能拡張 |
| **最高** | 40カラム完全データベース設計実装 | **✅完了** | **7/28** | ✅ invoices40カラム、line_items、レプリケーション方式完成 |
| **最高** | 40カラム新機能サービス群実装 | **✅完了** | **7/28** | ✅ ApprovalControl、FreeeIntegration、CurrencyConversion実装 |
| **高** | 処理状況ダッシュボード（基本版のみ） | **🔄実行中** | **7/29** | 🚨実行中・40カラム対応ag-grid表示・編集機能 |
| **高** | 支払マスタ管理（最小限機能） | **📅待機中** | **7/30** | 基本CRUD操作のみ |
| **延期** | 外貨換算ロジック | **次期版** | **-** | リリース後のアップデートで対応 |
| **延期** | メール設定・高度なUI機能 | **次期版** | **-** | リリース後のアップデートで対応 |

### 4.1.1 🎯 **7/28完了実績サマリー**
- **✅完了済み**: 9件/13件（69.2%）
- **🔄実行中**: 1件/13件（7.7%）
- **📅待機中**: 1件/13件（7.7%）
- **次期版延期**: 2件/13件（15.4%）

### 4.2. 🏃‍♂️ **緊急スケジュール短縮**
- **フェーズ1完了**: 7/20 → **7/22** (2日延長、機能拡張のため)
- **フェーズ2完了予定**: 8/1 → **7/28** (4日短縮、機能絞り込み)
- **フェーズ3**: 8/2-8/12 → **7/29-7/30** (10日短縮、基本機能のみ)
- **フェーズ4**: 8/15-8/20 → **7/31** (15日短縮、最小限テスト)
- **プロジェクト完了**: 8/20 → **7/31** (20日短縮、緊急リリース)

### 4.3. ⚡ **今週の超集中タスク（7/21-7/31）**
1. **日(7/21)**: プロンプトシステム統合完了、課題一覧表作成、git push完了 ✅**完了**
2. **月(7/22)**: 🚨**緊急**: プロンプトシステム基盤修正（JSON解析・変数型・統合照合エラー）、進捗表示UI改善 ✅**完了**
3. **火(7/23)**: JSONプロンプト統合テスト完成、PDF明細解析仕様確定 ✅**完了**
4. **水(7/24)**: 複数明細取得機能完成、企業名照合表記揺れ対応完了 ✅**完了**
5. **木(7/25)**: キー情報抽出精度検証、明細情報構造化検証 ✅**完了**
6. **金(7/26)**: 2段階AI照合ロジック実装、支払マスタ個別処理ルール実装 ✅**完了**
7. **土(7/27)**: 2段階AI照合ロジック実装完了、基本UI機能実装 ✅**完了**
8. **日(7/28)**: 🎉**40カラム完全実装完了**、新機能サービス群完成、データベース設計完了 ✅**完了**
9. **月(7/29)**: 🔄**実行中**: 処理状況ダッシュボード実装、警告メッセージ分類機能
10. **火(7/30)**: 📅**予定**: 支払マスタ管理画面、課題管理画面実装
11. **水(7/31)**: 📅**予定**: 最終動作確認、本番デプロイ、**リリース** 🚀

### 4.3.1 🎉 **7/28重要マイルストーン達成**
- **✅フェーズ2完了**: 40カラム完全データベース設計とプロンプトシステム基盤完成
- **✅新機能サービス群実装完了**: ApprovalControlService、FreeeIntegrationService、CurrencyConversionService
- **✅課題P1-P2全解決**: プロンプトシステムの基盤安定化達成
- **✅明細処理機能完成**: line_itemsテーブル連携と複数明細構造化完了

## 5. 🚨 緊急開発プロセス
* **🚨緊急対応:** 7/31リリースに向けて超短期開発、基本機能の確実な動作を最優先とする。
* **優先度管理:** 最高・高・延期の3段階で機能を明確に分類し、延期機能は次期バージョンで対応。
* **品質管理:** 基本機能の動作確認を最優先とし、詳細テストは運用開始後に並行実施。
* **バージョン管理:** ソースコードはGitおよびGitHubで管理し、変更履歴を追跡可能にする。

## 5.1. 🔄 次期バージョン対応予定機能
以下の機能は7/31リリースでは延期とし、運用開始後の次期バージョン（8月中旬予定）で実装します：
* 外貨換算ロジック（カード明細照合）
* PDFポップアップ確認機能
* メール設定画面
* 全データ閲覧画面（freee連携ボタン含む）
* カード明細アップロード画面
* 承認ワークフロー機能
* 詳細なテスト・ドキュメント整備

## 6. リスク管理（更新版）

| リスク分類 | 内容 | 発生可能性 | 影響度 | 対応策 |
| :--- | :--- | :--- | :--- | :--- |
| **技術** | 外部API（Gemini, Supabase等）の仕様変更や障害 | 低 | 中 | ・統一ログ設定とデバッグパネルで監視強化済み<br>・エラーハンドリングを徹底し、障害発生時は管理者に通知する |
| **仕様** | 開発途中で新たな個別処理ルールが発覚する | 中 | 中 | ・支払マスタの「個別処理ルール」で対応できる設計を維持する<br>・ag-grid技術検証済みで柔軟な対応が可能 |
| **品質** | PDF明細解析の精度・複数明細対応の複雑性 | 中 | 高 | ・明細解析仕様の詳細定義を優先実施<br>・複数明細取得機能の十分なテスト・検証を実施<br>・段階的な実装で品質確保 |
| **品質** | 🚨緊急リリースによる十分なテスト不足 | 高 | 高 | ・基本機能の動作確認を最優先実施<br>・運用開始後に並行して詳細テスト実施<br>・ユーザーフィードバックによる継続改善 |
| **運用** | 🚨不完全な機能での運用開始によるユーザー混乱 | 中 | 中 | ・基本機能は確実に動作させる<br>・次期バージョン予定の明確な案内<br>・運用サポート体制の強化 |
| **スケジュール** | 🚨7日間での超短期開発による開発者負荷 | 高 | 中 | ・機能を最小限に絞り込み済み<br>・優先度の明確化で集中開発<br>・次期バージョンでの機能補完計画 |

## 7. WBS (作業分解構成図) 【最新更新: 2025/07/28】

依頼タイトル	小項目	タスク	ステータス	担当	関係者	開始日	完了予定日	完了日	資料	備考
請求書処理システム Streamlit移行プロジェクト				実行中	原口	開発チーム	2025/07/17	2025/07/31			🚨緊急リリース対応・大幅スケジュール短縮
1. フェーズ1: 基盤構築			完了	原口	開発チーム	2025/07/17	2025/07/20	2025/07/22		
	環境構築		完了	原口		2025/07/17	2025/07/22	2025/07/22		
		Supabaseプロジェクトセットアップとテーブル作成	完了	原口		2025/07/17	2025/07/18	2025/07/18	database.py	Supabaseセットアップ完了、接続テスト済み
		GCPプロジェクトセットアップ (Cloud Run, Secret Manager)	完了	原口		2025/07/21	2025/07/21	2025/07/22	デプロイ設計書	本番環境準備完了
		Google APIサービスアカウント設定 (Drive, Sheets)	完了	原口		2025/07/20	2025/07/22	2025/07/22	外部IF仕様書	Drive API、Sheets API連携完了
		GitHubリポジトリ作成とCI/CD初期設定	完了	原口		2025/07/20	2025/07/20	2025/07/20	GitHub	リポジトリ作成、初回コミット完了
		PowerShell開発・運用環境整備	完了	原口		2025/07/20	2025/07/20	2025/07/20	run_app.ps1	文字化け対応、実行環境統一
	アプリケーション雛形作成		完了	原口		2025/07/17	2025/07/20	2025/07/20		
		Streamlitプロジェクト初期化とDB接続モジュール実装	完了	原口		2025/07/17	2025/07/18	2025/07/18	database.py	app.py基本構造実装済み
		Google OAuth設定（GCP Console）	完了	原口		2025/07/17	2025/07/18	2025/07/18	外部IF仕様書	streamlit-oauth用設定完了
		統一認証システム（streamlit-oauth）の実装	完了	原口		2025/07/17	2025/07/18	2025/07/18	auth/oauth_handler.py	OAuth2Component修正完了
		認証システムの動作確認とデバッグ	完了	原口		2025/07/18	2025/07/18	2025/07/18	外部IF仕様書	ローカルでOAuthフロー確認済み	
		サイドバーと画面遷移の基本構造実装	完了	原口		2025/07/18	2025/07/19	2025/07/19	画面設計書	基本的な画面遷移実装済み	
	技術検証フェーズ		完了	原口		2025/07/19	2025/07/20	2025/07/20		技術検証によるリスク軽減
		技術検証1: Supabase接続とCRUD操作テスト	完了	原口		2025/07/19	2025/07/19	2025/07/19	database.py	データベース接続・操作確認完了
		技術検証2: Gemini API連携とPDF情報抽出テスト	完了	原口		2025/07/19	2025/07/20	2025/07/20	gemini_helper.py	複数PDF対応、情報抽出テスト完了
		技術検証3: Google Drive API連携テスト	完了	原口		2025/07/20	2025/07/20	2025/07/20	google_drive_helper.py	ファイルアップロード機能実装完了
		技術検証4: 基本ワークフロー統合テスト	完了	原口		2025/07/20	2025/07/20	2025/07/20	統合ワークフローページ	PDF→抽出→DB保存の流れ確認完了
		技術検証5: ag-gridデータグリッド機能検証	完了	原口		2025/07/18	2025/07/19	2025/07/19	aggrid_helper.py	streamlit-aggrid統合、編集機能確認完了
	運用監視基盤構築		完了	原口		2025/07/20	2025/07/20	2025/07/20		予定外追加・完了
		ログ設定システム実装 (config/settings.ini)	完了	原口		2025/07/20	2025/07/20	2025/07/20	log_config.py	統一ログ設定、ファイルローテーション対応
		デバッグパネル機能実装	完了	原口		2025/07/20	2025/07/20	2025/07/20	debug_panel.py	Streamlit内ログ確認・設定変更機能
		運用保守ドキュメント更新	完了	原口		2025/07/20	2025/07/20	2025/07/20	各種仕様書	ログ・デバッグ機能の仕様を全ドキュメントに反映
2. フェーズ2: コア機能実装			完了	原口	開発チーム	2025/07/21	2025/07/28	2025/07/28		🎉7/28完了・40カラム実装とプロンプトシステム基盤完成
	PDF処理バックエンド		完了	原口		2025/07/19	2025/07/26	2025/07/28		✅7/28完了・明細処理・データベース完全実装
		PDFアップロードとGoogle Drive保存ロジック実装	完了	原口		2025/07/20	2025/07/20	2025/07/20	google_drive_helper.py	技術検証で実装完了
		Gemini API連携（一次情報抽出）実装	完了	原口		2025/07/19	2025/07/20	2025/07/20	gemini_helper.py	複数PDF対応で実装済み
		抽出結果のSupabaseへの保存ロジック実装	完了	原口		2025/07/21	2025/07/22	2025/07/21	仕様書	統合ワークフロー実装済み
		プロンプトシステムJSONフォーマット移行	完了	原口		2025/07/21	2025/07/21	2025/07/21	prompt_manager.py	PromptManager実装・YAML→JSON移行完了
		外貨取引税額・税率判定ロジック修正	完了	原口		2025/07/21	2025/07/22	2025/07/22	課題一覧ISS-001	✅解決・外貨の税込=税抜・税率0%の正常判定実装
		日付比較境界値判定ロジック修正	完了	原口		2025/07/21	2025/07/22	2025/07/22	課題一覧ISS-002	✅解決・同一日境界値判定ロジック修正
		40カラム完全データベース設計実装	完了	原口		2025/07/25	2025/07/28	2025/07/28	complete_production_implementation.sql	✅7/28完了・invoices40カラム、line_items、レプリケーション方式完成
		プロンプト基盤エラー群修正（ISS-005～008）	完了	原口		2025/07/22	2025/07/22	2025/07/22	各種サービス	✅完了・型チェック、JSON解析、変数置換、進捗表示の全修正
		PDF明細解析仕様の詳細定義と検証	完了	原口		2025/07/22	2025/07/25	2025/07/28	仕様書	✅完了・複数明細構造化定義とline_itemsテーブル実装
		複数明細取得機能の実装・テスト	完了	原口		2025/07/23	2025/07/26	2025/07/28	gemini_helper.py	✅完了・明細分離と構造化処理実装、line_items連携済み
	仕訳提案ロジック		完了	原口		2025/07/22	2025/07/27	2025/07/28		✅7/28完了・基本照合機能と新機能サービス実装
		企業名照合表記揺れ対応強化	完了	原口		2025/07/22	2025/07/24	2025/07/24	課題一覧ISS-004	✅解決・カタカナ英字変換辞書実装、確信度計算改善
		JSONプロンプトシステム統合テスト完成	完了	原口		2025/07/22	2025/07/23	2025/07/23	課題一覧ISS-003	✅解決・実PDF使用の統合テスト、精度ベースライン策定完了
		2段階AI照合ロジックの実装（基本版）	完了	原口		2025/07/24	2025/07/26	2025/07/27	プロンプト仕様書	✅完了・基本照合機能実装、次期版で高度機能拡張
		40カラム新機能サービス群実装	完了	原口		2025/07/26	2025/07/28	2025/07/28	services/	✅完了・ApprovalControlService、FreeeIntegrationService、CurrencyConversionService実装
		統合ワークフローエンジン実装	完了	原口		2025/07/26	2025/07/28	2025/07/28	workflows/	✅完了・統一ワークフローエンジンと新機能統合完了
		外貨換算ロジック（カード明細照合）の実装	延期	原口		次期版	次期版		仕様書	🚨次期バージョンに延期	
3. フェーズ3: 基本UI実装			実行中	原口	佐久間	2025/07/29	2025/07/30			🚨実行中・基本機能のみ2日間で実装
	ユーザー向け画面（基本版のみ）		実行中	原口	佐久間	2025/07/29	2025/07/29			🚨実行中・1日で基本機能実装
		請求書アップロード画面の実装	完了	原口		2025/07/20	2025/07/20	2025/07/20	画面設計書	基本アップロード機能実装済み
		処理状況ダッシュボードの実装（基本表示・編集のみ）	実行中	原口	佐久間	2025/07/29	2025/07/29		aggrid_helper.py	🚨実行中・40カラム対応ag-grid表示・編集機能
		警告メッセージ分類・表示機能実装	実行中	原口		2025/07/29	2025/07/29		課題一覧ENH-001	🚨実行中・情報・注意・警告・エラーレベル分類表示
		PDFポップアップ確認機能の実装	延期	原口		次期版	次期版		画面設計書	🚨次期バージョンに延期
		メール設定画面の実装	延期	原口		次期版	次期版		画面設計書	🚨次期バージョンに延期
	管理者向け画面（最小限のみ）		未着手	原口	佐久間	2025/07/30	2025/07/30			🚨1日で最小限機能のみ実装
		全データ閲覧画面（freee連携ボタン含む）の実装	延期	原口		次期版	次期版		画面設計書	🚨次期バージョンに延期
		支払マスタ管理画面（基本CRUD操作のみ）	未着手	原口	佐久間	2025/07/30	2025/07/30		画面設計書	🚨基本CRUD操作のみ、承認ワークフローは次期版
		課題管理・進捗監視画面の実装	未着手	原口		2025/07/30	2025/07/30		課題一覧表	🚨新規追加・課題一覧の可視化と進捗トラッキング
		カード明細アップロード画面の実装	延期	原口		次期版	次期版		画面設計書	🚨次期バージョンに延期
		システムログ閲覧画面の実装	完了	原口		2025/07/20	2025/07/20	2025/07/20	デバッグパネル	ログ設定・デバッグパネル機能として実装完了	
4. フェーズ4: 最小限テスト・緊急リリース			未着手	原口	開発チーム	2025/07/31	2025/07/31			🚨緊急リリース・最小限テストのみ
	最小限テスト（基本動作確認のみ）		未着手	原口	佐久間	2025/07/31	2025/07/31			🚨クリティカル障害のみ確認
		課題一覧P1-P2項目の最終検証	完了	原口		2025/07/30	2025/07/30	2025/07/28	課題一覧表	✅完了・7/28に全P1-P2課題解決確認済み
		40カラム統合機能の動作確認	未着手	原口		2025/07/31	2025/07/31		テスト設計書	🚨追加・新機能サービス群の統合動作確認
		単体テスト作成 (pytest)	延期	原口		次期版	次期版		テスト設計書	🚨運用開始後に並行実施
		結合テスト（API連携、DB操作）の実施	延期	原口		次期版	次期版		テスト設計書	🚨運用開始後に並行実施
		システムテスト（基本ワークフローのみ）	未着手	原口	佐久間	2025/07/31	2025/07/31		テスト設計書	🚨基本機能の動作確認のみ
	緊急リリース		未着手	原口	佐久間	2025/07/31	2025/07/31			🚨最小限確認でリリース
		ユーザー受け入れテスト（UAT）の実施	延期	佐久間	原口	次期版	次期版		テスト設計書	🚨運用開始後にフィードバック収集
		本番環境への緊急デプロイと動作確認	未着手	原口	原口	2025/07/31	2025/07/31		デプロイ設計書	🚨緊急デプロイ・認証は統一済み
		ドキュメント最終化と引き継ぎ	延期	原口	佐久間	次期版	次期版		運用・保守マニュアル	🚨運用開始後に並行実施
