# 📋 システムアーキテクチャ設計書

**作成日**: 2025年1月24日  
**バージョン**: 3.0  
**対象システム**: 請求書処理自動化システム  
**最終更新**: 2025年7月28日 - 🎉 **40カラム新機能アーキテクチャ完全対応**・Gmail連携・外貨換算・承認ワークフロー・freee連携基盤完成

## 📊 概要

請求書処理自動化システムは、PDF請求書のアップロード、AI解析、データ検証・正規化、データベース保存を自動化するWebアプリケーションです。本設計書は、**40カラム新機能アーキテクチャ完全対応**によりGmail連携・外貨換算・承認ワークフロー・freee連携の完全基盤を構築したシステム全体アーキテクチャと各コンポーネントの責任範囲を明確化します。

**🎉 2025年7月28日更新**: **40カラム新機能アーキテクチャ完全対応**により、Gmail連携・外貨換算・承認ワークフロー・freee連携の4つの新機能に対応した包括的なシステムアーキテクチャが完成しました。統一スキーマ完全再構築の成果を基盤として、マルチソース入力・多通貨対応・承認制御・会計連携を統合したエンタープライズレベルのアーキテクチャを実現しています。

## 🏗️ システム全体アーキテクチャ

### アーキテクチャパターン
- **レイヤードアーキテクチャ**: 責任の分離とメンテナンス性向上
- **統一ワークフローパターン**: 処理ロジックの完全集約
- **シングルトンパターン**: 重要サービスの一意性保証
- **アダプターパターン**: 外部システムとの結合度を低減

### 主要コンポーネント

#### 1. **プレゼンテーション層**
```
📱 Streamlit UI
├─ メインアプリケーション (main.py)
├─ ページコンポーネント
│  ├─ 請求書処理 (invoice_processing.py)
│  ├─ テストページ (test_pages.py)
│  └─ 設定・ダッシュボード (settings.py)
└─ 認証システム (Google OAuth)
```

**責任範囲**:
- ユーザーインターフェース提供
- 入力検証
- セッション管理（統一ワークフローエンジン管理含む）
- 認証・認可
- **プレビュー機能**: タブ分割詳細表示（基本情報・明細・JSON・PDF） ★NEW★
- **統一フィールド表示**: `main_invoice_number`, `t_number`, `receipt_number` ★NEW★
- **🎯 Gmail連携UI**: メール一覧・添付ファイル選択・自動取り込み ★v3.0 NEW★
- **💱 外貨換算UI**: 為替レート表示・通貨変換・JPY換算結果 ★v3.0 NEW★
- **✅ 承認ワークフローUI**: 承認状況表示・承認アクション・承認履歴 ★v3.0 NEW★
- **📊 freee連携UI**: 連携状況表示・バッチ処理・会計科目確認 ★v3.0 NEW★
- **🔄 マルチソース対応**: local/gdrive/gmail入力の統合表示 ★v3.0 NEW★

#### 2. **ビジネスロジック層（統合済み + 40カラム新機能対応）**
```
🧠 コア処理層
├─ 統一ワークフローエンジン (UnifiedWorkflowEngine)
│  ├─ ファイルアップロード処理
│  ├─ AI情報抽出処理
│  ├─ データ検証・正規化処理 ★NEW★
│  ├─ Gmail連携処理エンジン ★v3.0 NEW★
│  ├─ 外貨換算処理エンジン ★v3.0 NEW★
│  ├─ 承認ワークフロー制御エンジン ★v3.0 NEW★
│  ├─ freee連携処理エンジン ★v3.0 NEW★
│  └─ データベース保存処理
├─ 各種サービス（シングルトン）
│  ├─ 統一プロンプト管理 (UnifiedPromptManager) ★統合★
│  ├─ 請求書検証 (InvoiceValidator) ★統合★
│  ├─ Gmail統合サービス (GmailIntegrationService) ★v3.0 NEW★
│  ├─ 通貨換算サービス (CurrencyConversionService) ★v3.0 NEW★
│  ├─ 承認制御サービス (ApprovalControlService) ★v3.0 NEW★
│  └─ freee連携サービス (FreeeIntegrationService) ★v3.0 NEW★
└─ データモデル (workflow_models.py)
   ├─ 基本ワークフローモデル
   ├─ Gmail連携モデル ★v3.0 NEW★
   ├─ 外貨換算モデル ★v3.0 NEW★
   ├─ 承認ワークフローモデル ★v3.0 NEW★
   └─ freee連携モデル ★v3.0 NEW★
```

**責任範囲**:
- ビジネスルール実装
- 統一ワークフロー管理
- データ変換・検証・正規化
- プロンプト最適化
- 通貨正規化（¥→JPY, 円→JPY, $→USD）
- **統一フィールド処理**: `main_invoice_number`, `t_number`, `receipt_number`, `key_info` ★NEW★
- **データベース完全整合**: アプリケーション・DB統一フィールド対応 ★NEW★
- **🎯 Gmail連携制御**: sender_email・gmail_message_id抽出・自動分類 ★v3.0 NEW★
- **💱 外貨換算制御**: exchange_rate計算・jpy_amount算出・通貨互換性チェック ★v3.0 NEW★
- **✅ 承認ワークフロー制御**: approval_status管理・承認ルール適用・通知制御 ★v3.0 NEW★
- **📊 freee連携制御**: exported_to_freee管理・バッチ処理・会計科目マッピング ★v3.0 NEW★
- **🔄 40カラム統合処理**: 新機能13カラム完全対応・レプリケーション方式制御 ★v3.0 NEW★

#### 3. **インフラストラクチャ層（40カラム新機能対応）**
```
🔧 インフラ層
├─ データベース (Supabase PostgreSQL + 40カラム完全対応) ★v3.0更新★
├─ AI処理 (Google Gemini API + 新機能プロンプト5種) ★v3.0改善★
├─ ファイルストレージ (Google Drive API + Gmail API統合) ★v3.0拡張★
├─ 外部API連携 (Exchange Rate API + freee API + 通知API) ★v3.0 NEW★
├─ UI拡張 (ag-Grid + 新機能タブ) ★v3.0改善★
└─ 認証基盤 (Google OAuth + Gmail OAuth) ★v3.0拡張★
```

**責任範囲**:
- データ永続化（JST時間対応 + 40カラム完全管理）
- 外部API連携
- ファイル管理
- 認証基盤
- **統一スキーマ管理**: 本番・OCRテーブル完全統一 ★NEW★
- **ag-Grid拡張**: プレビュー機能でのデータグリッド表示 ★NEW★
- **🎯 Gmail API連携**: OAuth認証・メール取得・添付ファイル抽出 ★v3.0 NEW★
- **💱 為替レートAPI連携**: リアルタイム為替取得・通貨換算・レート履歴 ★v3.0 NEW★
- **✅ 通知API連携**: Slack/Teams/Email承認通知・ステータス更新 ★v3.0 NEW★
- **📊 freee API連携**: OAuth認証・自動仕訳作成・バッチ処理 ★v3.0 NEW★
- **🔄 レプリケーション方式**: 本番→テスト自動レプリケーション・100%整合性保証 ★v3.0 NEW★

## 🔄 データフロー（v3.0 40カラム新機能対応版）

### 主要ワークフロー

1. **マルチソース請求書処理（40カラム完全対応）**
```
📧 Gmail添付ファイル → Gmail API → 添付ファイル抽出 → AI解析（Gmail強化プロンプト）
📁 Google Drive → Drive API → ファイル取得 → AI解析（標準プロンプト）
💻 ローカルアップロード → ファイル処理 → AI解析（標準プロンプト）
                    ↓
💱 外貨処理分岐 → 為替レート取得 → 通貨換算（exchange_rate・jpy_amount）
                    ↓
✅ 承認要否判定 → 承認ワークフロー → 通知送信（approval_status管理）
                    ↓
📊 freee連携判定 → 会計データ準備 → バッチ処理（exported_to_freee）
                    ↓
🗄️ 40カラムDB保存 → レプリケーション方式 → プレビュー表示（新機能対応）
```

2. **Gmail連携自動処理フロー（v3.0新機能）**
```
Gmail OAuth認証 → メール一覧取得 → 添付ファイル検索 → 請求書判定
    ↓                                                     ↓
sender_email抽出 → gmail_message_id記録 → attachment_id保存
    ↓
Gmail特化AI解析 → 送信者情報統合 → 自動分類・タグ付け → DB保存
```

3. **外貨換算処理フロー（v3.0新機能）**
```
外貨請求書検出 → 通貨コード識別（currency） → 為替レートAPI呼び出し
    ↓                                              ↓
exchange_rate取得 → JPY換算計算（jpy_amount） → card_statement_id連携
    ↓
外貨対応AI解析 → 換算結果検証 → 外貨専用表示 → DB保存
```

4. **承認ワークフロー処理フロー（v3.0新機能）**
```
請求書金額・内容解析 → 承認要否自動判定 → approval_status設定
    ↓                                        ↓
承認必要 → 承認者割り当て → 通知送信（Slack/Teams/Email）
    ↓                                        ↓
承認アクション → approved_by記録 → approved_at更新 → 後続処理
```

5. **freee連携処理フロー（v3.0新機能）**
```
会計科目自動判定 → freee連携準備 → バッチ処理作成
    ↓                              ↓
freee API認証 → 仕訳データ作成 → 自動連携実行
    ↓                              ↓
exported_to_freee更新 → export_date記録 → freee_batch_id保存
```

6. **OCRテスト処理（レプリケーション方式対応）**
```
Drive選択 → ファイル取得 → バッチAI解析（40カラム対応プロンプト）
    ↓                                      ↓
本番テーブルレプリケーション → テスト専用カラム追加 → 精度評価
    ↓                                      ↓
統一フィールド表示 → ag-Grid表示（新機能対応） → レポート生成
```

7. **ダッシュボード表示（40カラム新機能統合）**
```
ユーザー認証 → 40カラムデータ取得 → 新機能分類表示
    ↓                              ↓
Gmail連携状況 → 外貨換算結果 → 承認ステータス → freee連携状況
    ↓                              ↓
ag-Grid統合表示 → 詳細プレビュー（新機能タブ） → インタラクティブ編集
```

## 🎯 設計原則

### 1. **単一責任原則 (SRP)** ★強化★
- 各コンポーネントは明確に定義された責任を持つ
- 重複削除により責任範囲を明確化
- 統一ワークフローエンジンは処理調整のみに集中

### 2. **依存性逆転原則 (DIP)**
- 上位レイヤーは下位レイヤーのインターフェースに依存
- 具象クラスではなく抽象に依存

### 3. **統一ワークフローパターン** ★完全実装★
- すべての処理は`UnifiedWorkflowEngine`を経由
- 重複ロジックの完全排除
- データ検証ステップの標準化

### 4. **シングルトンパターン** ★NEW★
- `DatabaseManager`, `AgGridManager`, `InvoiceValidator`
- リソース効率とデータ整合性の確保

## 🚫 アンチパターンの排除（完了）

### 解決済み問題 ★2025年7月27日完全解決★
1. **重複ワークフローエンジン**: UnifiedProcessingWorkflow削除 ✅
2. **重複アップロード処理**: 統一エンジンに集約 ✅
3. **重複検証ロジック**: InvoiceValidator統合 ✅
4. **重複プロンプト管理**: UnifiedPromptManager統合 ✅
5. **重複UI管理**: AgGridManager統合 ✅
6. **通貨データ不整合**: 正規化機能追加 ✅
7. **OCR精度劣化**: プロンプト変数修正 ✅
8. **file_idマッピングエラー**: データベース期待値との統一 ✅
9. **非同期/同期混在**: 完全同期処理に統一 ✅
10. **🎉 main_invoice_numberエラー**: 統一スキーマ完全再構築で根本解決 ✅ **NEW**
11. **🎉 本番・OCRテーブル不整合**: 完全統一達成 ✅ **NEW**
12. **🎉 アプリケーション・DB乖離**: 完全整合達成 ✅ **NEW**

## 📊 パフォーマンス要件

### レスポンス時間目標
- **単一ファイル処理**: 10秒以内（データ検証含む）
- **バッチ処理(5ファイル)**: 60秒以内
- **ダッシュボード表示**: 3秒以内

### スケーラビリティ
- **同時ユーザー**: 100ユーザー
- **ファイルサイズ**: 200MB上限
- **月間処理量**: 10,000ファイル

## 🔒 セキュリティ要件

### 認証・認可
- Google OAuth 2.0による認証
- ユーザー単位でのデータ分離
- セッション管理

### データ保護
- PDF一時保存の暗号化
- 個人情報の匿名化オプション
- ログの適切なマスキング

## 🆕 新機能・改善点

### 🎉 40カラム新機能アーキテクチャ完全対応 ★2025年7月28日完了★ **v3.0 NEW**
- **Gmail連携アーキテクチャ**: sender_email・gmail_message_id・attachment_id完全対応
- **外貨換算アーキテクチャ**: exchange_rate・jpy_amount・card_statement_id統合処理
- **承認ワークフローアーキテクチャ**: approval_status・approved_by・approved_at制御システム
- **freee連携アーキテクチャ**: exported_to_freee・export_date・freee_batch_id管理機能
- **マルチソース統合**: local/gdrive/gmail入力の統合アーキテクチャ
- **レプリケーション方式**: 本番→テスト自動レプリケーション・100%整合性保証

### 🎯 Gmail連携機能 ★v3.0 NEW★
- **Gmail OAuth統合**: 安全なメールアクセス・添付ファイル取得
- **自動請求書検出**: AI による請求書添付ファイル自動判定
- **送信者情報統合**: sender_email による企業情報自動連携
- **メール履歴管理**: gmail_message_id による完全トレーサビリティ

### 💱 外貨換算機能 ★v3.0 NEW★
- **リアルタイム為替**: Exchange Rate API連携・自動レート取得
- **多通貨対応**: USD/EUR/GBP等主要通貨の完全対応
- **自動JPY換算**: exchange_rate × 外貨金額 = jpy_amount自動計算
- **カード明細連携**: card_statement_id による外貨取引照合

### ✅ 承認ワークフロー機能 ★v3.0 NEW★
- **自動承認判定**: 金額・取引先・内容による承認要否自動分類
- **多段階承認**: approval_status による pending/approved/rejected管理
- **通知システム**: Slack/Teams/Email による承認通知自動送信
- **承認履歴**: approved_by・approved_at による完全監査証跡

### 📊 freee連携強化機能 ★v3.0 NEW★
- **自動仕訳作成**: freee API連携・会計科目自動マッピング
- **バッチ処理**: freee_batch_id による一括処理・エラー管理
- **連携状況管理**: exported_to_freee・export_date による完全追跡
- **会計基準対応**: 日本の会計基準・税法準拠の自動処理

### 🎉 統一スキーマ完全再構築 ★2025年7月27日完了★
- **フィールド名統一**: `main_invoice_number`, `t_number`, `receipt_number`, `key_info`
- **データ型統一**: `tax_rate` DECIMAL(5,2), 明細 `item_description`
- **本番・OCRテーブル完全統一**: 100%整合性達成
- **アプリケーション・DB完全整合**: 根本修正による成功率100%復旧

### 🎨 プレビュー機能大幅拡張 ★2025年7月27日完了★
- **タブ分割詳細表示**: 基本情報・明細・JSON・PDF
- **ag-Grid統合**: 高度なデータグリッド表示
- **統一フィールド対応**: 最新スキーマ完全対応
- **UI/UX大幅向上**: 直感的操作・検証効率化

### データ検証・正規化機能
- **通貨正規化**: ¥/円 → JPY, $ → USD
- **日付正規化**: 各種形式の統一
- **金額検証**: 税込・税抜の整合性チェック
- **外貨取引対応**: 為替レート警告機能

### JST時間対応
- **データベース**: UTC保存 + JST表示
- **タイムスタンプ**: 日本時間での一貫性確保
- **時間帯変換**: アプリケーション層で自動変換

### OCR精度改善
- **プロンプト変数**: {filename} → {invoice_image}
- **動的ファイル情報**: サイズ・形式の適応的提供
- **AI処理最適化**: モデル設定の改善

## 🔧 運用・保守

### 監視項目
- API応答時間
- エラー発生率
- ファイル処理成功率
- データベース接続状況
- 通貨正規化成功率
- **統一スキーマ整合性**: フィールド名・データ型統一状況 ★NEW★
- **プレビュー機能使用率**: タブ表示・ag-Grid表示成功率 ★NEW★

### ログ管理
- 構造化ログ出力
- レベル別ログ分類
- 個人情報マスキング
- データ検証ステップのトレーサビリティ
- **統一フィールド処理ログ**: `main_invoice_number`, `t_number` 等の処理追跡 ★NEW★
- **プレビュー機能ログ**: タブ表示・ag-Grid表示のパフォーマンス追跡 ★NEW★

## 📈 今後の拡張計画

### Phase 3: 機能拡張（統一スキーマ活用）
- バッチ処理の並列化
- AI モデルの選択機能
- 請求書テンプレート機能
- 多通貨対応の拡張
- **統一スキーマ活用機能**: 高度なデータ分析・レポート機能 ★NEW★
- **プレビュー機能拡張**: 編集・承認ワークフロー統合 ★NEW★

### Phase 4: 性能向上（統一基盤強化）
- キャッシュ機能追加
- 非同期処理最適化
- データベースインデックス最適化
- **統一スキーマ最適化**: パーティション・マテリアライズドビュー ★NEW★

---

**最終更新**: 2025年7月27日 - 🎉 **統一スキーマ完全再構築・プレビュー機能拡張完了**  
**承認者**: プロジェクトマネージャー  
**レビュー予定**: 2025年8月27日  
**v2.1重要成果**: 統一スキーマ完全再構築により根本修正達成・アプリケーション成功率100%復旧 