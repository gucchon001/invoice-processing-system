# 📋 システムアーキテクチャ設計書

**作成日**: 2025年1月24日  
**バージョン**: 2.0  
**対象システム**: 請求書処理自動化システム  
**最終更新**: 2025年7月24日 - 重複削除・モジュール統合・通貨正規化機能対応

## 📊 概要

請求書処理自動化システムは、PDF請求書のアップロード、AI解析、データ検証・正規化、データベース保存を自動化するWebアプリケーションです。本設計書は、重複削除とモジュール統合完了後のシステム全体アーキテクチャと各コンポーネントの責任範囲を明確化します。

## 🏗️ システム全体アーキテクチャ

### アーキテクチャパターン
- **レイヤードアーキテクチャ**: 責任の分離とメンテナンス性向上
- **統一ワークフローパターン**: 処理ロジックの完全集約
- **シングルトンパターン**: 重要サービスの一意性保証
- **アダプターパターン**: 外部システムとの結合度を低減

### 主要コンポーネント

#### 1. **プレゼンテーション層**
```
📱 Streamlit UI
├─ メインアプリケーション (main.py)
├─ ページコンポーネント
│  ├─ 請求書処理 (invoice_processing.py)
│  ├─ テストページ (test_pages.py)
│  └─ 設定・ダッシュボード (settings.py)
└─ 認証システム (Google OAuth)
```

**責任範囲**:
- ユーザーインターフェース提供
- 入力検証
- セッション管理（統一ワークフローエンジン管理含む）
- 認証・認可

#### 2. **ビジネスロジック層（統合済み）**
```
🧠 コア処理層
├─ 統一ワークフローエンジン (UnifiedWorkflowEngine)
│  ├─ ファイルアップロード処理
│  ├─ AI情報抽出処理
│  ├─ データ検証・正規化処理 ★NEW★
│  └─ データベース保存処理
├─ 各種サービス（シングルトン）
│  ├─ 統一プロンプト管理 (UnifiedPromptManager) ★統合★
│  └─ 請求書検証 (InvoiceValidator) ★統合★
└─ データモデル (workflow_models.py)
```

**責任範囲**:
- ビジネスルール実装
- 統一ワークフロー管理
- データ変換・検証・正規化 ★NEW★
- プロンプト最適化
- 通貨正規化（¥→JPY, 円→JPY, $→USD） ★NEW★

#### 3. **インフラストラクチャ層**
```
🔧 インフラ層
├─ データベース (Supabase PostgreSQL + JST対応) ★更新★
├─ AI処理 (Google Gemini API + OCR精度改善) ★改善★
├─ ファイルストレージ (Google Drive API)
├─ UI拡張 (ag-Grid + シングルトン管理) ★改善★
└─ 認証基盤 (Google OAuth)
```

**責任範囲**:
- データ永続化（JST時間対応） ★NEW★
- 外部API連携
- ファイル管理
- 認証基盤

## 🔄 データフロー（最新版）

### 主要ワークフロー

1. **請求書アップロード処理（統一フロー）**
```
PDF Upload → Google Drive → AI解析 → データ検証・正規化 → データベース保存 → 結果表示
                                           ↗ 通貨正規化 ★NEW★
                                           ↗ JST時間変換 ★NEW★
```

2. **OCRテスト処理（最適化済み）**
```
Drive選択 → ファイル取得 → バッチAI解析 → 精度評価 → レポート生成（ag-Grid）
                              ↗ プロンプト変数修正 ★改善★
```

3. **ダッシュボード表示（統合済み）**
```
ユーザー認証 → データ取得 → ag-Grid表示 → インタラクティブ編集
                    ↗ シングルトン管理 ★改善★
```

## 🎯 設計原則

### 1. **単一責任原則 (SRP)** ★強化★
- 各コンポーネントは明確に定義された責任を持つ
- 重複削除により責任範囲を明確化
- 統一ワークフローエンジンは処理調整のみに集中

### 2. **依存性逆転原則 (DIP)**
- 上位レイヤーは下位レイヤーのインターフェースに依存
- 具象クラスではなく抽象に依存

### 3. **統一ワークフローパターン** ★完全実装★
- すべての処理は`UnifiedWorkflowEngine`を経由
- 重複ロジックの完全排除
- データ検証ステップの標準化

### 4. **シングルトンパターン** ★NEW★
- `DatabaseManager`, `AgGridManager`, `InvoiceValidator`
- リソース効率とデータ整合性の確保

## 🚫 アンチパターンの排除（完了）

### 解決済み問題 ★更新★
1. **重複ワークフローエンジン**: UnifiedProcessingWorkflow削除 ✅
2. **重複アップロード処理**: 統一エンジンに集約 ✅
3. **重複検証ロジック**: InvoiceValidator統合 ✅
4. **重複プロンプト管理**: UnifiedPromptManager統合 ✅
5. **重複UI管理**: AgGridManager統合 ✅
6. **通貨データ不整合**: 正規化機能追加 ✅
7. **OCR精度劣化**: プロンプト変数修正 ✅
8. **file_idマッピングエラー**: データベース期待値との統一 ✅
9. **非同期/同期混在**: 完全同期処理に統一 ✅

## 📊 パフォーマンス要件

### レスポンス時間目標
- **単一ファイル処理**: 10秒以内（データ検証含む）
- **バッチ処理(5ファイル)**: 60秒以内
- **ダッシュボード表示**: 3秒以内

### スケーラビリティ
- **同時ユーザー**: 100ユーザー
- **ファイルサイズ**: 200MB上限
- **月間処理量**: 10,000ファイル

## 🔒 セキュリティ要件

### 認証・認可
- Google OAuth 2.0による認証
- ユーザー単位でのデータ分離
- セッション管理

### データ保護
- PDF一時保存の暗号化
- 個人情報の匿名化オプション
- ログの適切なマスキング

## 🆕 新機能・改善点

### データ検証・正規化機能 ★NEW★
- **通貨正規化**: ¥/円 → JPY, $ → USD
- **日付正規化**: 各種形式の統一
- **金額検証**: 税込・税抜の整合性チェック
- **外貨取引対応**: 為替レート警告機能

### JST時間対応 ★NEW★
- **データベース**: UTC保存 + JST表示
- **タイムスタンプ**: 日本時間での一貫性確保
- **時間帯変換**: アプリケーション層で自動変換

### OCR精度改善 ★改善★
- **プロンプト変数**: {filename} → {invoice_image}
- **動的ファイル情報**: サイズ・形式の適応的提供
- **AI処理最適化**: モデル設定の改善

## 🔧 運用・保守

### 監視項目
- API応答時間
- エラー発生率
- ファイル処理成功率
- データベース接続状況
- 通貨正規化成功率 ★NEW★

### ログ管理
- 構造化ログ出力
- レベル別ログ分類
- 個人情報マスキング
- データ検証ステップのトレーサビリティ ★NEW★

## 📈 今後の拡張計画

### Phase 3: 機能拡張
- バッチ処理の並列化
- AI モデルの選択機能
- 請求書テンプレート機能
- 多通貨対応の拡張 ★NEW★

### Phase 4: 性能向上
- キャッシュ機能追加
- 非同期処理最適化
- データベースインデックス最適化

---

**最終更新**: 2025年7月24日 - 重複削除・統合・通貨正規化対応完了  
**承認者**: プロジェクトマネージャー  
**レビュー予定**: 2025年8月24日 