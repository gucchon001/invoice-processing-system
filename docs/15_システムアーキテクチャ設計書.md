# 📋 システムアーキテクチャ設計書

**作成日**: 2025年1月24日  
**バージョン**: 2.1  
**対象システム**: 請求書処理自動化システム  
**最終更新**: 2025年7月27日 - 🎉 **統一スキーマ完全再構築完了**・根本修正達成

## 📊 概要

請求書処理自動化システムは、PDF請求書のアップロード、AI解析、データ検証・正規化、データベース保存を自動化するWebアプリケーションです。本設計書は、**統一スキーマ完全再構築**によりアプリケーション・データベース間の完全整合を達成したシステム全体アーキテクチャと各コンポーネントの責任範囲を明確化します。

**🎉 2025年7月27日更新**: **統一スキーマ完全再構築**により、`main_invoice_number`エラーが完全解決され、本番・OCRテストテーブル間の完全統一が実現されました。プレビュー機能の大幅拡張とともに、システム全体の整合性と保守性が飛躍的に向上しています。

## 🏗️ システム全体アーキテクチャ

### アーキテクチャパターン
- **レイヤードアーキテクチャ**: 責任の分離とメンテナンス性向上
- **統一ワークフローパターン**: 処理ロジックの完全集約
- **シングルトンパターン**: 重要サービスの一意性保証
- **アダプターパターン**: 外部システムとの結合度を低減

### 主要コンポーネント

#### 1. **プレゼンテーション層**
```
📱 Streamlit UI
├─ メインアプリケーション (main.py)
├─ ページコンポーネント
│  ├─ 請求書処理 (invoice_processing.py)
│  ├─ テストページ (test_pages.py)
│  └─ 設定・ダッシュボード (settings.py)
└─ 認証システム (Google OAuth)
```

**責任範囲**:
- ユーザーインターフェース提供
- 入力検証
- セッション管理（統一ワークフローエンジン管理含む）
- 認証・認可
- **プレビュー機能**: タブ分割詳細表示（基本情報・明細・JSON・PDF） ★NEW★
- **統一フィールド表示**: `main_invoice_number`, `t_number`, `receipt_number` ★NEW★

#### 2. **ビジネスロジック層（統合済み）**
```
🧠 コア処理層
├─ 統一ワークフローエンジン (UnifiedWorkflowEngine)
│  ├─ ファイルアップロード処理
│  ├─ AI情報抽出処理
│  ├─ データ検証・正規化処理 ★NEW★
│  └─ データベース保存処理
├─ 各種サービス（シングルトン）
│  ├─ 統一プロンプト管理 (UnifiedPromptManager) ★統合★
│  └─ 請求書検証 (InvoiceValidator) ★統合★
└─ データモデル (workflow_models.py)
```

**責任範囲**:
- ビジネスルール実装
- 統一ワークフロー管理
- データ変換・検証・正規化
- プロンプト最適化
- 通貨正規化（¥→JPY, 円→JPY, $→USD）
- **統一フィールド処理**: `main_invoice_number`, `t_number`, `receipt_number`, `key_info` ★NEW★
- **データベース完全整合**: アプリケーション・DB統一フィールド対応 ★NEW★

#### 3. **インフラストラクチャ層**
```
🔧 インフラ層
├─ データベース (Supabase PostgreSQL + JST対応) ★更新★
├─ AI処理 (Google Gemini API + OCR精度改善) ★改善★
├─ ファイルストレージ (Google Drive API)
├─ UI拡張 (ag-Grid + シングルトン管理) ★改善★
└─ 認証基盤 (Google OAuth)
```

**責任範囲**:
- データ永続化（JST時間対応）
- 外部API連携
- ファイル管理
- 認証基盤
- **統一スキーマ管理**: 本番・OCRテーブル完全統一 ★NEW★
- **ag-Grid拡張**: プレビュー機能でのデータグリッド表示 ★NEW★

## 🔄 データフロー（最新版）

### 主要ワークフロー

1. **請求書アップロード処理（統一フロー - 完全統一対応）**
```
PDF Upload → Google Drive → AI解析 → データ検証・正規化 → データベース保存 → プレビュー表示
                                           ↗ 通貨正規化               ↗ 統一フィールド保存 ★NEW★
                                           ↗ JST時間変換              ↗ タブ分割プレビュー ★NEW★
                                           ↗ 統一フィールド処理 ★NEW★
```

2. **OCRテスト処理（統一スキーマ対応）**
```
Drive選択 → ファイル取得 → バッチAI解析 → 精度評価 → レポート生成（ag-Grid）
                              ↗ プロンプト変数修正        ↗ 統一フィールド表示 ★NEW★
                              ↗ 統一フィールド抽出 ★NEW★
```

3. **ダッシュボード表示（プレビュー機能拡張）**
```
ユーザー認証 → データ取得 → ag-Grid表示 → インタラクティブ編集 → 詳細プレビュー
                    ↗ シングルトン管理              ↗ タブ分割表示 ★NEW★
                    ↗ 統一フィールド取得 ★NEW★      ↗ 明細・JSON・PDF ★NEW★
```

## 🎯 設計原則

### 1. **単一責任原則 (SRP)** ★強化★
- 各コンポーネントは明確に定義された責任を持つ
- 重複削除により責任範囲を明確化
- 統一ワークフローエンジンは処理調整のみに集中

### 2. **依存性逆転原則 (DIP)**
- 上位レイヤーは下位レイヤーのインターフェースに依存
- 具象クラスではなく抽象に依存

### 3. **統一ワークフローパターン** ★完全実装★
- すべての処理は`UnifiedWorkflowEngine`を経由
- 重複ロジックの完全排除
- データ検証ステップの標準化

### 4. **シングルトンパターン** ★NEW★
- `DatabaseManager`, `AgGridManager`, `InvoiceValidator`
- リソース効率とデータ整合性の確保

## 🚫 アンチパターンの排除（完了）

### 解決済み問題 ★2025年7月27日完全解決★
1. **重複ワークフローエンジン**: UnifiedProcessingWorkflow削除 ✅
2. **重複アップロード処理**: 統一エンジンに集約 ✅
3. **重複検証ロジック**: InvoiceValidator統合 ✅
4. **重複プロンプト管理**: UnifiedPromptManager統合 ✅
5. **重複UI管理**: AgGridManager統合 ✅
6. **通貨データ不整合**: 正規化機能追加 ✅
7. **OCR精度劣化**: プロンプト変数修正 ✅
8. **file_idマッピングエラー**: データベース期待値との統一 ✅
9. **非同期/同期混在**: 完全同期処理に統一 ✅
10. **🎉 main_invoice_numberエラー**: 統一スキーマ完全再構築で根本解決 ✅ **NEW**
11. **🎉 本番・OCRテーブル不整合**: 完全統一達成 ✅ **NEW**
12. **🎉 アプリケーション・DB乖離**: 完全整合達成 ✅ **NEW**

## 📊 パフォーマンス要件

### レスポンス時間目標
- **単一ファイル処理**: 10秒以内（データ検証含む）
- **バッチ処理(5ファイル)**: 60秒以内
- **ダッシュボード表示**: 3秒以内

### スケーラビリティ
- **同時ユーザー**: 100ユーザー
- **ファイルサイズ**: 200MB上限
- **月間処理量**: 10,000ファイル

## 🔒 セキュリティ要件

### 認証・認可
- Google OAuth 2.0による認証
- ユーザー単位でのデータ分離
- セッション管理

### データ保護
- PDF一時保存の暗号化
- 個人情報の匿名化オプション
- ログの適切なマスキング

## 🆕 新機能・改善点

### 🎉 統一スキーマ完全再構築 ★2025年7月27日完了★
- **フィールド名統一**: `main_invoice_number`, `t_number`, `receipt_number`, `key_info`
- **データ型統一**: `tax_rate` DECIMAL(5,2), 明細 `item_description`
- **本番・OCRテーブル完全統一**: 100%整合性達成
- **アプリケーション・DB完全整合**: 根本修正による成功率100%復旧

### 🎨 プレビュー機能大幅拡張 ★2025年7月27日完了★
- **タブ分割詳細表示**: 基本情報・明細・JSON・PDF
- **ag-Grid統合**: 高度なデータグリッド表示
- **統一フィールド対応**: 最新スキーマ完全対応
- **UI/UX大幅向上**: 直感的操作・検証効率化

### データ検証・正規化機能
- **通貨正規化**: ¥/円 → JPY, $ → USD
- **日付正規化**: 各種形式の統一
- **金額検証**: 税込・税抜の整合性チェック
- **外貨取引対応**: 為替レート警告機能

### JST時間対応
- **データベース**: UTC保存 + JST表示
- **タイムスタンプ**: 日本時間での一貫性確保
- **時間帯変換**: アプリケーション層で自動変換

### OCR精度改善
- **プロンプト変数**: {filename} → {invoice_image}
- **動的ファイル情報**: サイズ・形式の適応的提供
- **AI処理最適化**: モデル設定の改善

## 🔧 運用・保守

### 監視項目
- API応答時間
- エラー発生率
- ファイル処理成功率
- データベース接続状況
- 通貨正規化成功率
- **統一スキーマ整合性**: フィールド名・データ型統一状況 ★NEW★
- **プレビュー機能使用率**: タブ表示・ag-Grid表示成功率 ★NEW★

### ログ管理
- 構造化ログ出力
- レベル別ログ分類
- 個人情報マスキング
- データ検証ステップのトレーサビリティ
- **統一フィールド処理ログ**: `main_invoice_number`, `t_number` 等の処理追跡 ★NEW★
- **プレビュー機能ログ**: タブ表示・ag-Grid表示のパフォーマンス追跡 ★NEW★

## 📈 今後の拡張計画

### Phase 3: 機能拡張（統一スキーマ活用）
- バッチ処理の並列化
- AI モデルの選択機能
- 請求書テンプレート機能
- 多通貨対応の拡張
- **統一スキーマ活用機能**: 高度なデータ分析・レポート機能 ★NEW★
- **プレビュー機能拡張**: 編集・承認ワークフロー統合 ★NEW★

### Phase 4: 性能向上（統一基盤強化）
- キャッシュ機能追加
- 非同期処理最適化
- データベースインデックス最適化
- **統一スキーマ最適化**: パーティション・マテリアライズドビュー ★NEW★

---

**最終更新**: 2025年7月27日 - 🎉 **統一スキーマ完全再構築・プレビュー機能拡張完了**  
**承認者**: プロジェクトマネージャー  
**レビュー予定**: 2025年8月27日  
**v2.1重要成果**: 統一スキーマ完全再構築により根本修正達成・アプリケーション成功率100%復旧 