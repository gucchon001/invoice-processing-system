# 📋 システムアーキテクチャ設計書

**作成日**: 2025年1月24日  
**バージョン**: 1.0  
**対象システム**: 請求書処理自動化システム

## 📊 概要

請求書処理自動化システムは、PDF請求書のアップロード、AI解析、データベース保存を自動化するWebアプリケーションです。本設計書は、システム全体のアーキテクチャと各コンポーネントの責任範囲を明確化します。

## 🏗️ システム全体アーキテクチャ

### アーキテクチャパターン
- **レイヤードアーキテクチャ**: 責任の分離とメンテナンス性向上
- **統一ワークフローパターン**: 処理ロジックの集約
- **アダプターパターン**: 外部システムとの結合度を低減

### 主要コンポーネント

#### 1. **プレゼンテーション層**
```
📱 Streamlit UI
├─ メインアプリケーション (app.py)
├─ ページコンポーネント
│  ├─ 請求書処理 (invoice_processing.py)
│  ├─ テストページ (test_pages.py)
│  └─ 設定・ダッシュボード (settings.py)
└─ 認証システム (Google OAuth)
```

**責任範囲**:
- ユーザーインターフェース提供
- 入力検証
- セッション管理
- 認証・認可

#### 2. **ビジネスロジック層**
```
🧠 コア処理層
├─ 統一ワークフローエンジン (UnifiedWorkflowEngine)
├─ 各種サービス
│  ├─ プロンプト管理 (UnifiedPromptManager)
│  ├─ プロンプト選択 (PromptSelector)
│  └─ バリデーション (InvoiceValidator)
└─ データモデル (workflow_models.py)
```

**責任範囲**:
- ビジネスルール実装
- ワークフロー管理
- データ変換・検証
- プロンプト最適化

#### 3. **インフラストラクチャ層**
```
🔧 インフラ層
├─ データベース (Supabase PostgreSQL)
├─ AI処理 (Google Gemini API)
├─ ファイルストレージ (Google Drive API)
├─ UI拡張 (ag-Grid)
└─ 認証基盤 (Google OAuth)
```

**責任範囲**:
- データ永続化
- 外部API連携
- ファイル管理
- 認証基盤

## 🔄 データフロー

### 主要ワークフロー

1. **請求書アップロード処理**
```
PDF Upload → Google Drive → AI解析 → データベース保存 → 結果表示
```

2. **OCRテスト処理**
```
Drive選択 → ファイル取得 → バッチAI解析 → 精度評価 → レポート生成
```

3. **ダッシュボード表示**
```
ユーザー認証 → データ取得 → ag-Grid表示 → インタラクティブ編集
```

## 🎯 設計原則

### 1. **単一責任原則 (SRP)**
- 各コンポーネントは明確に定義された責任を持つ
- ワークフローエンジンは処理調整のみに集中

### 2. **依存性逆転原則 (DIP)**
- 上位レイヤーは下位レイヤーのインターフェースに依存
- 具象クラスではなく抽象に依存

### 3. **統一ワークフローパターン**
- すべての処理は`UnifiedWorkflowEngine`を経由
- 重複ロジックの排除

## 🚫 アンチパターンの排除

### 解決済み問題
1. **重複ワークフローエンジン**: UnifiedProcessingWorkflow削除
2. **重複アップロード処理**: 統一エンジンに集約
3. **file_idマッピングエラー**: データベース期待値との統一
4. **非同期/同期混在**: 完全同期処理に統一

## 📊 パフォーマンス要件

### レスポンス時間目標
- **単一ファイル処理**: 10秒以内
- **バッチ処理(5ファイル)**: 60秒以内
- **ダッシュボード表示**: 3秒以内

### スケーラビリティ
- **同時ユーザー**: 100ユーザー
- **ファイルサイズ**: 200MB上限
- **月間処理量**: 10,000ファイル

## 🔒 セキュリティ要件

### 認証・認可
- Google OAuth 2.0による認証
- ユーザー単位でのデータ分離
- セッション管理

### データ保護
- PDF一時保存の暗号化
- 個人情報の匿名化オプション
- ログの適切なマスキング

## 🔧 運用・保守

### 監視項目
- API応答時間
- エラー発生率
- ファイル処理成功率
- データベース接続状況

### ログ管理
- 構造化ログ出力
- レベル別ログ分類
- 個人情報マスキング

## 📈 今後の拡張計画

### Phase 3: 機能拡張
- バッチ処理の並列化
- AI モデルの選択機能
- 請求書テンプレート機能

### Phase 4: 性能向上
- キャッシュ機能追加
- 非同期処理最適化
- データベースインデックス最適化

---

**最終更新**: 2025年1月24日  
**承認者**: プロジェクトマネージャー  
**レビュー予定**: 2025年2月24日 