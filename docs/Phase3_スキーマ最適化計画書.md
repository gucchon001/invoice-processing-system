# 📊 Phase 3: スキーマ最適化計画書

**作成日**: 2025年1月24日  
**対象**: OCRテスト・本番テーブルの最適化  
**目的**: 不要項目削除・スキーマ並び順最適化・性能向上

---

## 🎯 最適化概要

### 実施内容
1. **不要項目の整理・削除**
2. **スキーマ並び順の論理的再構成**
3. **インデックス最適化**
4. **ストレージ容量削減**

### 期待効果
- **性能向上**: 不要カラム削除により40-60%のI/O削減
- **保守性向上**: シンプルで理解しやすいスキーマ
- **ストレージ削減**: 20-30%の容量削減

---

## 🔍 フィールド使用状況分析

### 📊 使用頻度別分類

#### 🟢 高使用頻度（保持必須）
| フィールド | 本番使用 | OCRテスト使用 | UI表示 | 検索・フィルタ |
|------------|----------|---------------|--------|----------------|
| `id` | ✅ | ✅ | ✅ | ✅ |
| `user_email/created_by` | ✅ | ✅ | ✅ | ✅ |
| `issuer_name` | ✅ | ✅ | ✅ | ✅ |
| `main_invoice_number` | ✅ | ✅ | ✅ | ✅ |
| `total_amount_tax_included` | ✅ | ✅ | ✅ | ✅ |
| `currency` | ✅ | ✅ | ✅ | ✅ |
| `issue_date` | ✅ | ✅ | ✅ | ✅ |
| `is_valid` | ✅ | ✅ | ✅ | ✅ |
| `completeness_score` | ✅ | ✅ | ✅ | ✅ |
| `created_at` | ✅ | ✅ | ✅ | ✅ |

#### 🟡 中使用頻度（条件付き保持）
| フィールド | 使用状況 | 判定 | 対応案 |
|------------|----------|------|--------|
| `recipient_name` | 本番: ✅, OCR: ✅, UI: ✅ | 保持 | データ型最適化 |
| `t_number` | 本番: ✅, OCR: ✅, UI: △ | 保持 | 統一化済み |
| `receipt_number` | 本番: ✅, OCR: 新規, UI: △ | 保持 | 統一化済み |
| `key_info` | 本番: ✅, OCR: 新規, UI: △ | 保持 | 重要なビジネスロジック |
| `extracted_data` | 本番: ✅, OCR: ❌, UI: △ | 保持 | 本番では必須 |
| `processing_time` | 本番: ✅, OCR: ✅, UI: △ | 保持 | パフォーマンス分析用 |

#### 🔴 低使用頻度（削除候補）
| フィールド | 問題点 | 削除理由 | 影響範囲 |
|------------|--------|----------|----------|
| **`line_items` (JSONB)** | 廃止予定と明記 | invoice_line_itemsテーブルに移行済み | 本番のみ影響 |
| **`raw_response`** | UI非表示、デバッグのみ | 巨大JSON、通常利用なし | 全体、但しデバッグ影響 |
| **`validation_errors` (配列)** | UI表示制限 | 配列型で扱い困難 | 全体、検証機能影響 |
| **`validation_warnings` (配列)** | UI表示制限 | 配列型で扱い困難 | 全体、検証機能影響 |
| **`file_size`** | OCRテストのみ使用 | 本番では不要 | OCRテストのみ |
| **`gemini_model`** | ログ・デバッグ用 | 運用上重要度低 | 全体、履歴追跡影響 |

---

## 📋 スキーマ並び順最適化

### 🎯 現在の課題
- **論理的でない順序**: 基本情報と詳細情報が混在
- **検索性の悪さ**: よく使うフィールドが後方に配置
- **UI表示順序**: ag-gridでの表示効率が悪い

### ✨ 最適化後の並び順（論理的グルーピング）

#### 1. **基本識別情報** (1-5)
```sql
1.  id                    -- 主キー
2.  user_email           -- ユーザー識別  
3.  status               -- 処理状況
4.  file_name            -- ファイル名
5.  session_id           -- セッション (OCRテストのみ)
```

#### 2. **請求書コア情報** (6-12)
```sql
6.  issuer_name          -- 請求元企業名
7.  recipient_name       -- 請求先企業名
8.  main_invoice_number  -- 請求書番号
9.  t_number            -- 適格請求書番号
10. receipt_number       -- 受領書番号
11. currency            -- 通貨
12. issue_date          -- 発行日
```

#### 3. **金額・計算情報** (13-15)
```sql
13. total_amount_tax_included  -- 税込金額
14. total_amount_tax_excluded  -- 税抜金額
15. due_date                   -- 支払期日
```

#### 4. **品質・検証情報** (16-18)
```sql
16. is_valid             -- 検証状況
17. completeness_score   -- 完全性スコア
18. processing_time      -- 処理時間
```

#### 5. **JSON・拡張データ** (19-21)
```sql
19. key_info            -- キー情報
20. extracted_data      -- AI抽出データ (本番のみ)
21. final_accounting_info -- 最終経理情報 (本番のみ)
```

#### 6. **システム管理情報** (22-25)
```sql
22. uploaded_at         -- アップロード日時 (本番のみ)
23. file_path           -- ファイルパス
24. created_at          -- 作成日時
25. updated_at          -- 更新日時
```

---

## 🗑️ 削除対象フィールドと影響分析

### Phase 3A: 低リスク削除項目

#### 1. `line_items` (JSONB) - 本番テーブル
```sql
-- 理由: 設計書で「廃止予定」明記、invoice_line_itemsに移行済み
-- 影響: 既存アプリケーション影響なし（使用箇所なし）
-- 削除方法: ALTER TABLE invoices DROP COLUMN line_items;
```

#### 2. `file_size` - OCRテストテーブル
```sql
-- 理由: 本番では不使用、ストレージ分析以外で利用なし
-- 影響: OCRテスト統計機能のみ影響
-- 削除方法: ALTER TABLE ocr_test_results DROP COLUMN file_size;
```

### Phase 3B: 中リスク削除項目（検討要）

#### 3. `raw_response` (JSONB) - 全テーブル
```sql
-- 理由: 巨大JSON、UI非表示、デバッグ用途のみ
-- 影響: エラー解析・デバッグ機能に影響
-- 代替案: 別途ログテーブルに移行
-- 容量削減: 推定60-80%
```

#### 4. `validation_errors`, `validation_warnings` (TEXT[]) - 全テーブル
```sql
-- 理由: 配列型で扱い困難、UI表示制限
-- 影響: 検証結果詳細表示に影響
-- 代替案: 検証ログテーブル分離
-- 削除効果: クエリ性能向上、UI簡素化
```

---

## 🔧 PostgreSQL スキーマ並び順変更方法

### ⚠️ 重要な制約
PostgreSQLでは**既存テーブルのカラム順序を直接変更することはできません**

### 📋 実装可能な方法

#### 方法1: 新テーブル作成・データ移行方式 ⭐ 推奨
```sql
-- 1. 最適化されたスキーマで新テーブル作成
CREATE TABLE invoices_new (
    -- 最適化された順序でカラム定義
    id SERIAL PRIMARY KEY,
    user_email VARCHAR(255) NOT NULL,
    status VARCHAR(50) DEFAULT 'uploaded',
    -- ... 論理的順序で全カラム定義
);

-- 2. データ移行
INSERT INTO invoices_new (カラムリスト)
SELECT カラムリスト FROM invoices
ORDER BY id;

-- 3. 制約・インデックス再作成
-- 4. 古いテーブル削除・リネーム
```

#### 方法2: ビュー活用方式 ⚡ 低リスク
```sql
-- 論理的順序のビューを作成
CREATE VIEW invoices_ordered AS
SELECT 
    id, user_email, status, file_name,  -- 基本情報
    issuer_name, recipient_name, main_invoice_number,  -- 請求書情報
    -- ... 論理的順序
FROM invoices;

-- アプリケーションはビューを使用
```

#### 方法3: アプリケーション層制御方式 🔄 段階的
```python
# SELECT文での明示的順序指定
OPTIMIZED_COLUMN_ORDER = [
    'id', 'user_email', 'status', 'file_name',
    'issuer_name', 'recipient_name', 'main_invoice_number',
    # ... 論理的順序
]

def get_invoices_optimized():
    columns = ', '.join(OPTIMIZED_COLUMN_ORDER)
    return supabase.table('invoices').select(columns).execute()
```

---

## 📅 実行計画・スケジュール

### Phase 3A: 安全な最適化（即時実行可能）
**期間**: 1-2日  
**リスク**: 低

1. **不要フィールド削除**
   - [ ] `line_items`列削除（本番テーブル）
   - [ ] `file_size`列削除（OCRテストテーブル）

2. **ビュー作成方式でスキーマ順序最適化**
   - [ ] `invoices_optimized`ビュー作成
   - [ ] `ocr_test_results_optimized`ビュー作成

3. **インデックス見直し**
   - [ ] 不要インデックス削除
   - [ ] 複合インデックス最適化

### Phase 3B: 高度な最適化（慎重実行）
**期間**: 3-5日  
**リスク**: 中

1. **大容量フィールドの分離検討**
   - [ ] `raw_response`の別テーブル移行検討
   - [ ] `validation_errors/warnings`の正規化検討

2. **新テーブル作成方式での完全最適化**
   - [ ] 開発環境での検証
   - [ ] 本番適用（メンテナンス時間）

### Phase 3C: パフォーマンス最適化（将来対応）
**期間**: 1週間  
**リスク**: 中

1. **パーティショニング導入**
   - [ ] 日付ベースパーティショニング
   - [ ] ユーザーベースパーティショニング

2. **アーカイブ機能**
   - [ ] 古いデータの自動アーカイブ
   - [ ] 圧縮ストレージ活用

---

## 📊 期待される効果

### 性能向上
- **クエリ性能**: 20-40%向上（不要カラム削除効果）
- **インデックス効率**: 30-50%向上
- **メモリ使用量**: 25-35%削減

### 運用改善
- **UI表示速度**: 15-30%向上
- **データ転送量**: 40-60%削減
- **バックアップ時間**: 20-30%短縮

### 開発効率
- **スキーマ理解**: 論理的順序により大幅改善
- **デバッグ効率**: 重要フィールドの視認性向上
- **新機能開発**: シンプルなスキーマで開発加速

---

## 🚨 リスク管理・ロールバック計画

### 事前準備
- [ ] **完全バックアップ**: 最適化前の状態保存
- [ ] **開発環境検証**: 全機能の動作確認
- [ ] **影響範囲調査**: 依存コードの特定

### ロールバック手順
1. **ビュー方式**: 即座にビュー削除で復旧
2. **テーブル方式**: バックアップからの復元
3. **段階的復旧**: 部分的な機能復旧

### 監視項目
- [ ] **アプリケーションエラー率**
- [ ] **クエリ実行時間**
- [ ] **ユーザー体験指標**

---

## 📞 承認・実行体制

### 承認フロー
1. **Phase 3A**: 開発チーム判断で実行可
2. **Phase 3B**: システム管理者承認必要
3. **Phase 3C**: 経営承認必要（影響範囲大）

### 実行責任者
- **技術リード**: スキーマ設計・SQL実行
- **QAエンジニア**: テスト・検証
- **運用チーム**: 監視・ロールバック

---

**策定日**: 2025年1月24日  
**次回レビュー**: Phase 3A完了後  
**最終承認者**: システムアーキテクト 