# 📊 テーブル設計詳細仕様書

**作成日**: 2025年1月24日  
**バージョン**: 1.0  
**対象システム**: 請求書処理自動化システム  
**データベース**: Supabase PostgreSQL

## 📋 概要

本ドキュメントは請求書処理自動化システムの全テーブルの詳細仕様を定義し、カラム定義、制約、インデックス、業務ルールを包括的に記載します。

## 📑 目次

1. [ユーザー管理系テーブル](#ユーザー管理系テーブル)
2. [請求書処理系テーブル](#請求書処理系テーブル)
3. [OCRテスト系テーブル](#ocrテスト系テーブル)
4. [ルール検証系テーブル](#ルール検証系テーブル)
5. [決済系テーブル](#決済系テーブル)
6. [インデックス仕様](#インデックス仕様)
7. [制約・トリガー仕様](#制約トリガー仕様)

---

## 📧 ユーザー管理系テーブル

### 1. **users（ユーザーテーブル）**

#### テーブル定義

```sql
CREATE TABLE public.users (
    email VARCHAR(255) PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    role VARCHAR(20) DEFAULT 'user' CHECK (role IN ('user', 'admin'))
);
```

#### カラム仕様

| カラム名 | データ型 | NOT NULL | デフォルト値 | 制約 | 説明 |
|----------|----------|----------|-------------|------|------|
| email | VARCHAR(255) | ✅ | - | PK, EMAIL形式 | ユーザーメールアドレス（主キー） |
| name | VARCHAR(100) | ✅ | - | - | ユーザー表示名 |
| role | VARCHAR(20) | ❌ | 'user' | CHECK制約 | ユーザー権限（'user', 'admin'） |

#### 業務ルール

- **email**: Google OAuth認証のメールアドレスと完全一致する必要がある
- **name**: Google プロフィールから自動取得、手動変更可能
- **role**: デフォルトは'user'、管理者のみ'admin'に変更可能

#### RLS（Row Level Security）

```sql
-- ユーザーは自分のデータのみ参照可能
CREATE POLICY "Users can view their own data" 
ON public.users FOR SELECT 
USING (auth.email() = email);

-- ユーザーは自分のデータのみ更新可能
CREATE POLICY "Users can update their own data" 
ON public.users FOR UPDATE 
USING (auth.email() = email);
```

---

### 2. **user_preferences（ユーザー設定テーブル）**

#### テーブル定義

```sql
CREATE TABLE public.user_preferences (
    user_email VARCHAR(255) PRIMARY KEY REFERENCES users(email),
    notify_on_success BOOLEAN DEFAULT true,
    notify_on_error BOOLEAN DEFAULT true
);
```

#### カラム仕様

| カラム名 | データ型 | NOT NULL | デフォルト値 | 制約 | 説明 |
|----------|----------|----------|-------------|------|------|
| user_email | VARCHAR(255) | ✅ | - | PK, FK→users.email | ユーザーメールアドレス |
| notify_on_success | BOOLEAN | ❌ | true | - | 処理成功時の通知設定 |
| notify_on_error | BOOLEAN | ❌ | true | - | エラー発生時の通知設定 |

#### 業務ルール

- **user_email**: users.emailと1対1の関係
- **通知設定**: デフォルトは全通知ON、ユーザーが個別に設定可能

---

## 📄 請求書処理系テーブル

### 3. **invoices（請求書メインテーブル）**

#### テーブル定義

```sql
CREATE TABLE public.invoices (
    id SERIAL PRIMARY KEY,
    user_email VARCHAR(255) NOT NULL REFERENCES users(email),
    status VARCHAR(50) DEFAULT 'uploaded',
    file_name VARCHAR(255) NOT NULL,
    gdrive_file_id VARCHAR(255),
    uploaded_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    issuer_name VARCHAR(255),
    recipient_name VARCHAR(255),
    main_invoice_number VARCHAR(255),
    receipt_number VARCHAR(255),
    t_number VARCHAR(50),
    issue_date DATE,
    due_date DATE,
    currency VARCHAR(10) DEFAULT 'JPY',
    total_amount_tax_included DECIMAL(15,2),
    total_amount_tax_excluded DECIMAL(15,2),
    key_info JSONB,
    line_items JSONB,
    final_accounting_info JSONB,
    extracted_data JSONB,
    raw_response JSONB,
    is_valid BOOLEAN DEFAULT TRUE,
    validation_errors TEXT[],
    validation_warnings TEXT[],
    completeness_score DECIMAL(5,2),
    processing_time DECIMAL(8,2),
    file_path VARCHAR(500),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT timezone('Asia/Tokyo', NOW()),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT timezone('Asia/Tokyo', NOW())
);
```

#### カラム仕様詳細

##### **基本情報**

| カラム名 | データ型 | NOT NULL | デフォルト値 | 制約 | 説明 |
|----------|----------|----------|-------------|------|------|
| id | SERIAL | ✅ | AUTO_INCREMENT | PK | 請求書一意ID |
| user_email | VARCHAR(255) | ✅ | - | FK→users.email | 作成ユーザー |
| status | VARCHAR(50) | ❌ | 'uploaded' | ENUM値 | 処理状況 |
| file_name | VARCHAR(255) | ✅ | - | - | 元ファイル名 |
| gdrive_file_id | VARCHAR(255) | ❌ | - | UNIQUE | Google DriveファイルID |
| uploaded_at | TIMESTAMPTZ | ❌ | NOW() | - | アップロード日時 |

##### **請求書情報**

| カラム名 | データ型 | NOT NULL | 範囲・形式 | 説明 |
|----------|----------|----------|-----------|------|
| issuer_name | VARCHAR(255) | ❌ | - | 請求書発行者名 |
| recipient_name | VARCHAR(255) | ❌ | - | 請求先企業名 |
| main_invoice_number | VARCHAR(255) | ❌ | - | メイン請求書番号 |
| receipt_number | VARCHAR(255) | ❌ | - | 受領書番号 |
| t_number | VARCHAR(50) | ❌ | T + 13桁 | 適格請求書発行事業者登録番号 |
| issue_date | DATE | ❌ | YYYY-MM-DD | 請求書発行日 |
| due_date | DATE | ❌ | YYYY-MM-DD | 支払期日 |

##### **金額情報**

| カラム名 | データ型 | NOT NULL | 範囲 | 説明 |
|----------|----------|----------|------|------|
| currency | VARCHAR(10) | ❌ | ISO 4217 | 通貨コード（JPY, USD, EUR等） |
| total_amount_tax_included | DECIMAL(15,2) | ❌ | 0〜99,999,999,999.99 | 税込合計金額 |
| total_amount_tax_excluded | DECIMAL(15,2) | ❌ | 0〜99,999,999,999.99 | 税抜合計金額 |

##### **JSON形式データ**

| カラム名 | データ型 | 構造 | 説明 |
|----------|----------|------|------|
| key_info | JSONB | 自由形式 | キー情報（任意のメタデータ） |
| line_items | JSONB | 配列形式 | 明細情報（旧形式との互換性） |
| final_accounting_info | JSONB | 構造化 | 最終経理情報 |
| extracted_data | JSONB | 標準構造 | AI抽出データ（統一形式） |
| raw_response | JSONB | API応答形式 | 生のAI応答データ |

##### **品質管理**

| カラム名 | データ型 | NOT NULL | 範囲 | 説明 |
|----------|----------|----------|------|------|
| is_valid | BOOLEAN | ❌ | true/false | 全体検証結果フラグ |
| validation_errors | TEXT[] | ❌ | - | 検証エラーメッセージ配列 |
| validation_warnings | TEXT[] | ❌ | - | 検証警告メッセージ配列 |
| completeness_score | DECIMAL(5,2) | ❌ | 0.00〜100.00 | データ完全性スコア（%） |
| processing_time | DECIMAL(8,2) | ❌ | 0.00〜99999.99 | AI処理時間（秒） |

##### **システム管理**

| カラム名 | データ型 | NOT NULL | デフォルト値 | 説明 |
|----------|----------|----------|-------------|------|
| file_path | VARCHAR(500) | ❌ | - | ファイルパス（内部管理用） |
| created_at | TIMESTAMPTZ | ❌ | NOW() JST | レコード作成日時 |
| updated_at | TIMESTAMPTZ | ❌ | NOW() JST | レコード更新日時 |

#### 業務ルール

##### **status値の定義**

| status値 | 説明 | 次の状態 |
|----------|------|----------|
| 'uploaded' | ファイルアップロード完了 | 'processing' |
| 'processing' | AI処理中 | 'extracted', 'failed' |
| 'extracted' | AI抽出完了 | 'validated', 'manual_review' |
| 'validated' | 検証完了 | 'approved', 'rejected' |
| 'manual_review' | 手動レビュー中 | 'approved', 'rejected' |
| 'approved' | 承認済み | 'archived' |
| 'rejected' | 却下 | 'archived' |
| 'failed' | 処理失敗 | 'uploaded' |

##### **extracted_data標準構造**

```json
{
  "issuer": "発行者名",
  "payer": "支払者名", 
  "issue_date": "YYYY-MM-DD",
  "due_date": "YYYY-MM-DD",
  "main_invoice_number": "請求書番号",
  "receipt_number": "受領書番号",
  "t_number": "T1234567890123",
  "currency": "JPY",
  "amount_inclusive_tax": 10800.00,
  "amount_exclusive_tax": 10000.00,
  "key_info": {
    "contract_number": "契約番号",
    "service_period": "サービス期間"
  },
  "line_items": [
    {
      "description": "商品・サービス名",
      "quantity": 1,
      "unit_price": 10000.00,
      "amount": 10000.00,
      "tax": 800.00
    }
  ]
}
```

---

### 4. **invoice_line_items（請求書明細テーブル）**

#### テーブル定義

```sql
CREATE TABLE public.invoice_line_items (
    id SERIAL PRIMARY KEY,
    invoice_id INTEGER NOT NULL REFERENCES invoices(id) ON DELETE CASCADE,
    line_number INTEGER NOT NULL,
    item_description TEXT,
    quantity DECIMAL(10,3),
    unit_price DECIMAL(15,2),
    amount DECIMAL(15,2),
    tax_rate DECIMAL(5,2),
    created_at TIMESTAMP DEFAULT timezone('Asia/Tokyo', NOW()),
    updated_at TIMESTAMP DEFAULT timezone('Asia/Tokyo', NOW()),
    UNIQUE(invoice_id, line_number)
);
```

#### カラム仕様

| カラム名 | データ型 | NOT NULL | 制約 | 説明 |
|----------|----------|----------|------|------|
| id | SERIAL | ✅ | PK | 明細一意ID |
| invoice_id | INTEGER | ✅ | FK→invoices.id, CASCADE DELETE | 請求書ID |
| line_number | INTEGER | ✅ | UNIQUE(invoice_id, line_number) | 請求書内での明細行番号 |
| item_description | TEXT | ❌ | - | 商品・サービス名 |
| quantity | DECIMAL(10,3) | ❌ | ≥ 0 | 数量（小数点以下3桁まで） |
| unit_price | DECIMAL(15,2) | ❌ | ≥ 0 | 単価 |
| amount | DECIMAL(15,2) | ❌ | ≥ 0 | 金額 |
| tax_rate | DECIMAL(5,2) | ❌ | 0.00〜100.00 | 税率（%） |

#### 業務ルール

- **line_number**: 1から開始、請求書内で連番
- **金額計算**: amount = quantity × unit_price（基本）
- **CASCADE DELETE**: 請求書削除時に関連明細も自動削除
- **データ整合性**: amount値とquantity×unit_priceの差異は±1円以内

---

### 5. **payment_masters（支払マスタテーブル）**

#### テーブル定義

```sql
CREATE TABLE public.payment_masters (
    id SERIAL PRIMARY KEY,
    company_name VARCHAR(255) NOT NULL,
    content VARCHAR(255),
    additional_condition VARCHAR(255),
    processing_rules JSONB,
    account_title VARCHAR(100),
    item VARCHAR(100),
    payment_method VARCHAR(50),
    department VARCHAR(100),
    approval_status VARCHAR(20) DEFAULT 'pending' CHECK (approval_status IN ('approved', 'pending')),
    created_by VARCHAR(255) NOT NULL REFERENCES users(email)
);
```

#### カラム仕様

| カラム名 | データ型 | NOT NULL | デフォルト値 | 制約 | 説明 |
|----------|----------|----------|-------------|------|------|
| id | SERIAL | ✅ | AUTO_INCREMENT | PK | マスタ一意ID |
| company_name | VARCHAR(255) | ✅ | - | - | 支払先企業名 |
| content | VARCHAR(255) | ❌ | - | - | 支払内容 |
| additional_condition | VARCHAR(255) | ❌ | - | - | 追加条件 |
| processing_rules | JSONB | ❌ | - | - | 処理ルール（JSON形式） |
| account_title | VARCHAR(100) | ❌ | - | - | 勘定科目 |
| item | VARCHAR(100) | ❌ | - | - | 項目 |
| payment_method | VARCHAR(50) | ❌ | - | - | 支払方法 |
| department | VARCHAR(100) | ❌ | - | - | 担当部門 |
| approval_status | VARCHAR(20) | ❌ | 'pending' | CHECK制約 | 承認状況 |
| created_by | VARCHAR(255) | ✅ | - | FK→users.email | 作成者 |

#### processing_rules JSON構造

```json
{
  "auto_approval_threshold": 100000,
  "require_receipt": true,
  "payment_terms": 30,
  "notification_emails": ["finance@company.com"],
  "custom_fields": {
    "cost_center": "required",
    "project_code": "optional"
  }
}
```

---

## 🧪 OCRテスト系テーブル

### 6. **ocr_test_sessions（OCRテストセッション）**

#### テーブル定義

```sql
CREATE TABLE ocr_test_sessions (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    session_name VARCHAR(255) NOT NULL,
    folder_id VARCHAR(255) NOT NULL,
    total_files INTEGER NOT NULL DEFAULT 0,
    processed_files INTEGER NOT NULL DEFAULT 0,
    success_files INTEGER NOT NULL DEFAULT 0,
    failed_files INTEGER NOT NULL DEFAULT 0,
    average_completeness DECIMAL(5,2),
    success_rate DECIMAL(5,2),
    processing_duration DECIMAL(10,2),
    created_by VARCHAR(255) NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

#### カラム仕様

| カラム名 | データ型 | NOT NULL | 制約 | 説明 |
|----------|----------|----------|------|------|
| id | UUID | ✅ | PK, DEFAULT uuid_generate_v4() | セッション一意ID |
| session_name | VARCHAR(255) | ✅ | - | セッション名（ユーザー指定） |
| folder_id | VARCHAR(255) | ✅ | - | Google DriveフォルダID |
| total_files | INTEGER | ✅ | ≥ 0 | 総ファイル数 |
| processed_files | INTEGER | ✅ | ≥ 0 | 処理済ファイル数 |
| success_files | INTEGER | ✅ | ≥ 0 | 成功ファイル数 |
| failed_files | INTEGER | ✅ | ≥ 0 | 失敗ファイル数 |
| average_completeness | DECIMAL(5,2) | ❌ | 0.00〜100.00 | 平均完全性スコア |
| success_rate | DECIMAL(5,2) | ❌ | 0.00〜100.00 | 成功率（%） |
| processing_duration | DECIMAL(10,2) | ❌ | ≥ 0 | 処理時間（秒） |
| created_by | VARCHAR(255) | ✅ | - | 実行者メールアドレス |

#### 業務ルール

- **ファイル数制約**: processed_files = success_files + failed_files
- **成功率計算**: success_rate = (success_files / processed_files) × 100
- **UUID使用理由**: 外部システムとの連携時の安全性向上

---

### 7. **ocr_test_results（OCRテスト結果）**

#### テーブル定義

```sql
CREATE TABLE ocr_test_results (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    session_id UUID REFERENCES ocr_test_sessions(id) ON DELETE CASCADE,
    file_id VARCHAR(255) NOT NULL,
    filename VARCHAR(255) NOT NULL,
    file_size BIGINT,
    issuer_name VARCHAR(255),
    recipient_name VARCHAR(255),
    invoice_number VARCHAR(100),
    registration_number VARCHAR(50),
    currency VARCHAR(10),
    total_amount_tax_included DECIMAL(15,2),
    total_amount_tax_excluded DECIMAL(15,2),
    issue_date DATE,
    due_date DATE,
    is_valid BOOLEAN DEFAULT FALSE,
    completeness_score DECIMAL(5,2),
    validation_errors TEXT[],
    validation_warnings TEXT[],
    processing_time DECIMAL(8,2),
    gemini_model VARCHAR(50) DEFAULT 'gemini-2.0-flash-exp',
    raw_response JSONB,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

#### カラム仕様

| カラム名 | データ型 | NOT NULL | 制約 | 説明 |
|----------|----------|----------|------|------|
| id | UUID | ✅ | PK | 結果一意ID |
| session_id | UUID | ❌ | FK→ocr_test_sessions.id | セッションID |
| file_id | VARCHAR(255) | ✅ | - | Google DriveファイルID |
| filename | VARCHAR(255) | ✅ | - | ファイル名 |
| file_size | BIGINT | ❌ | ≥ 0 | ファイルサイズ（バイト） |
| gemini_model | VARCHAR(50) | ❌ | - | 使用Geminiモデル名 |
| raw_response | JSONB | ❌ | - | 生のGemini応答 |

※他のカラムは基本的にinvoicesテーブルと同じ構造

---

## 📏 ルール検証系テーブル

### 8. **accounting_rules（経理ルール）**

#### テーブル定義

```sql
CREATE TABLE accounting_rules (
    id SERIAL PRIMARY KEY,
    rule_category VARCHAR(100) NOT NULL,
    rule_name VARCHAR(255) NOT NULL,
    rule_description TEXT,
    rule_conditions JSONB,
    rule_values JSONB,
    severity VARCHAR(20) DEFAULT 'info' CHECK (severity IN ('error', 'warning', 'info')),
    handbook_url VARCHAR(500),
    slide_number INTEGER,
    extracted_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

#### rule_conditions JSON構造例

```json
{
  "target_field": "total_amount_tax_included",
  "operator": "greater_than",
  "threshold": 100000,
  "conditions": [
    {
      "field": "issuer_name", 
      "operator": "contains",
      "value": ["株式会社", "有限会社"]
    }
  ]
}
```

#### rule_values JSON構造例

```json
{
  "expected_format": "YYYY-MM-DD",
  "valid_range": {
    "min": "2020-01-01",
    "max": "2030-12-31"
  },
  "required_fields": ["issuer_name", "total_amount", "issue_date"],
  "validation_regex": "^T[0-9]{13}$"
}
```

---

## 💳 決済系テーブル

### 9. **card_statements（カード明細）**

#### テーブル定義

```sql
CREATE TABLE card_statements (
    id SERIAL PRIMARY KEY,
    transaction_date DATE,
    merchant_name VARCHAR(255),
    jpy_amount DECIMAL(12, 2),
    foreign_currency_amount DECIMAL(12, 2),
    foreign_currency_code VARCHAR(10),
    exchange_rate DECIMAL(10, 4)
);
```

#### カラム仕様

| カラム名 | データ型 | NOT NULL | 制約 | 説明 |
|----------|----------|----------|------|------|
| id | SERIAL | ✅ | PK | 明細一意ID |
| transaction_date | DATE | ❌ | - | 取引日 |
| merchant_name | VARCHAR(255) | ❌ | - | 加盟店名 |
| jpy_amount | DECIMAL(12,2) | ❌ | - | 日本円金額 |
| foreign_currency_amount | DECIMAL(12,2) | ❌ | - | 外貨金額 |
| foreign_currency_code | VARCHAR(10) | ❌ | ISO 4217 | 外貨コード |
| exchange_rate | DECIMAL(10,4) | ❌ | > 0 | 為替レート |

---

## 🔍 インデックス仕様

### パフォーマンス最適化インデックス

#### 基本インデックス

```sql
-- invoicesテーブル基本インデックス
CREATE INDEX idx_invoices_user_email ON invoices(user_email);
CREATE INDEX idx_invoices_status ON invoices(status);
CREATE INDEX idx_invoices_uploaded_at ON invoices(uploaded_at);
CREATE INDEX idx_invoices_issuer_name ON invoices(issuer_name);
CREATE INDEX idx_invoices_invoice_number ON invoices(main_invoice_number);
CREATE INDEX idx_invoices_issue_date ON invoices(issue_date);
CREATE INDEX idx_invoices_total_amount ON invoices(total_amount_tax_included);
CREATE INDEX idx_invoices_currency ON invoices(currency);
CREATE INDEX idx_invoices_is_valid ON invoices(is_valid);
```

#### JSON専用GINインデックス

```sql
-- JSONB高速検索用
CREATE INDEX idx_invoices_extracted_data_gin ON invoices USING GIN (extracted_data);
CREATE INDEX idx_invoices_key_info_gin ON invoices USING GIN (key_info);
CREATE INDEX idx_invoices_raw_response_gin ON invoices USING GIN (raw_response);
```

#### 複合インデックス

```sql
-- よく使用される組み合わせ
CREATE INDEX idx_invoices_user_status_date ON invoices(user_email, status, uploaded_at);
CREATE INDEX idx_invoices_issuer_amount ON invoices(issuer_name, total_amount_tax_included);
CREATE INDEX idx_line_items_invoice_line ON invoice_line_items(invoice_id, line_number);
```

#### OCRテスト系インデックス

```sql
CREATE INDEX idx_ocr_test_sessions_created_by ON ocr_test_sessions(created_by);
CREATE INDEX idx_ocr_test_sessions_created_at ON ocr_test_sessions(created_at);
CREATE INDEX idx_ocr_test_results_session_id ON ocr_test_results(session_id);
CREATE INDEX idx_ocr_test_results_filename ON ocr_test_results(filename);
```

### インデックス使用状況監視

```sql
-- インデックス使用状況確認クエリ
SELECT 
    schemaname,
    tablename,
    indexname,
    idx_scan as index_scans,
    idx_tup_read as tuples_read,
    idx_tup_fetch as tuples_fetched
FROM pg_stat_user_indexes 
WHERE schemaname = 'public'
ORDER BY idx_scan DESC;
```

---

## 🔒 制約・トリガー仕様

### CHECK制約

```sql
-- ユーザー権限制約
ALTER TABLE users ADD CONSTRAINT chk_users_role 
CHECK (role IN ('user', 'admin'));

-- 支払マスタ承認状況制約
ALTER TABLE payment_masters ADD CONSTRAINT chk_payment_approval 
CHECK (approval_status IN ('approved', 'pending'));

-- 金額制約
ALTER TABLE invoices ADD CONSTRAINT chk_invoices_amounts 
CHECK (total_amount_tax_included >= 0 AND total_amount_tax_excluded >= 0);

-- 完全性スコア制約
ALTER TABLE invoices ADD CONSTRAINT chk_invoices_completeness 
CHECK (completeness_score >= 0.00 AND completeness_score <= 100.00);
```

### 外部キー制約

```sql
-- カスケード削除設定
ALTER TABLE invoice_line_items 
ADD CONSTRAINT fk_line_items_invoice 
FOREIGN KEY (invoice_id) REFERENCES invoices(id) ON DELETE CASCADE;

-- 参照整合性
ALTER TABLE invoices 
ADD CONSTRAINT fk_invoices_user 
FOREIGN KEY (user_email) REFERENCES users(email);

ALTER TABLE user_preferences 
ADD CONSTRAINT fk_preferences_user 
FOREIGN KEY (user_email) REFERENCES users(email);
```

### 自動更新トリガー

```sql
-- updated_at自動更新トリガー関数
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = timezone('Asia/Tokyo', NOW());
    RETURN NEW;
END;
$$ language 'plpgsql';

-- トリガー設定
CREATE TRIGGER trigger_invoices_updated_at 
    BEFORE UPDATE ON invoices 
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER trigger_invoice_line_items_updated_at 
    BEFORE UPDATE ON invoice_line_items 
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();
```

### データ整合性チェックトリガー

```sql
-- 請求書明細の金額整合性チェック
CREATE OR REPLACE FUNCTION check_line_item_amount()
RETURNS TRIGGER AS $$
BEGIN
    -- quantity × unit_price と amount の差異チェック
    IF ABS((NEW.quantity * NEW.unit_price) - NEW.amount) > 1.00 THEN
        RAISE EXCEPTION 'Amount calculation error: % × % ≠ %', 
            NEW.quantity, NEW.unit_price, NEW.amount;
    END IF;
    RETURN NEW;
END;
$$ language 'plpgsql';

CREATE TRIGGER trigger_line_item_amount_check 
    BEFORE INSERT OR UPDATE ON invoice_line_items 
    FOR EACH ROW EXECUTE FUNCTION check_line_item_amount();
```

---

## 📊 データ品質管理

### 完全性スコア計算ロジック

```sql
-- 完全性スコア自動計算関数
CREATE OR REPLACE FUNCTION calculate_completeness_score(invoice_data JSONB)
RETURNS DECIMAL(5,2) AS $$
DECLARE
    score DECIMAL(5,2) := 0.00;
    total_fields INTEGER := 10;
    completed_fields INTEGER := 0;
BEGIN
    -- 必須フィールドの存在チェック
    IF invoice_data->>'issuer' IS NOT NULL AND invoice_data->>'issuer' != '' THEN
        completed_fields := completed_fields + 1;
    END IF;
    
    IF invoice_data->>'payer' IS NOT NULL AND invoice_data->>'payer' != '' THEN
        completed_fields := completed_fields + 1;
    END IF;
    
    IF invoice_data->>'issue_date' IS NOT NULL THEN
        completed_fields := completed_fields + 1;
    END IF;
    
    IF invoice_data->>'main_invoice_number' IS NOT NULL AND invoice_data->>'main_invoice_number' != '' THEN
        completed_fields := completed_fields + 1;
    END IF;
    
    IF invoice_data->>'amount_inclusive_tax' IS NOT NULL THEN
        completed_fields := completed_fields + 1;
    END IF;
    
    -- スコア計算
    score := (completed_fields::DECIMAL / total_fields::DECIMAL) * 100.00;
    
    RETURN score;
END;
$$ LANGUAGE plpgsql;
```

### データ検証ルール

```sql
-- データ検証関数
CREATE OR REPLACE FUNCTION validate_invoice_data(invoice_id INTEGER)
RETURNS TABLE(error_type TEXT, error_message TEXT) AS $$
BEGIN
    -- 金額の妥当性チェック
    RETURN QUERY
    SELECT 'amount_validation'::TEXT, '税込金額が税抜金額より小さい'::TEXT
    FROM invoices 
    WHERE id = invoice_id 
    AND total_amount_tax_included < total_amount_tax_excluded;
    
    -- 日付の妥当性チェック
    RETURN QUERY
    SELECT 'date_validation'::TEXT, '発行日が未来の日付'::TEXT
    FROM invoices 
    WHERE id = invoice_id 
    AND issue_date > CURRENT_DATE;
    
    -- T番号の形式チェック
    RETURN QUERY
    SELECT 't_number_validation'::TEXT, 'T番号の形式が不正'::TEXT
    FROM invoices 
    WHERE id = invoice_id 
    AND t_number IS NOT NULL 
    AND t_number !~ '^T[0-9]{13}$';
    
END;
$$ LANGUAGE plpgsql;
```

---

## 📈 パフォーマンス監視

### 定期実行監視クエリ

```sql
-- テーブルサイズ監視
SELECT 
    schemaname,
    tablename,
    pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) as size,
    pg_total_relation_size(schemaname||'.'||tablename) as size_bytes
FROM pg_tables 
WHERE schemaname = 'public'
ORDER BY pg_total_relation_size(schemaname||'.'||tablename) DESC;

-- スロークエリ検出
SELECT 
    query,
    calls,
    total_time,
    mean_time,
    rows
FROM pg_stat_statements 
WHERE mean_time > 1000  -- 1秒以上のクエリ
ORDER BY mean_time DESC;
```

---

**最終更新**: 2025年1月24日  
**承認者**: データベース設計者・開発チーム  
**レビュー予定**: 2025年2月24日

**関連ドキュメント**:
- [17_システムアーキテクチャUML図.md](17_システムアーキテクチャUML図.md)
- [18_データベースER図.md](18_データベースER図.md)
- [20_シーケンス図集.md](20_シーケンス図集.md)
- [21_クラス図.md](21_クラス図.md) 