# ğŸ“Š ãƒ†ãƒ¼ãƒ–ãƒ«è¨­è¨ˆè©³ç´°ä»•æ§˜æ›¸

**ä½œæˆæ—¥**: 2025å¹´1æœˆ24æ—¥  
**æœ€çµ‚æ›´æ–°**: 2025å¹´7æœˆ28æ—¥  
**ãƒãƒ¼ã‚¸ãƒ§ãƒ³**: 4.0  
**å¯¾è±¡ã‚·ã‚¹ãƒ†ãƒ **: è«‹æ±‚æ›¸å‡¦ç†è‡ªå‹•åŒ–ã‚·ã‚¹ãƒ†ãƒ   
**ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹**: Supabase PostgreSQL

**v4.0æ›´æ–°å†…å®¹**: ğŸ‰ **å®Œå…¨è¨­è¨ˆæ›¸æº–æ‹ 40ã‚«ãƒ©ãƒ ä»•æ§˜ç¢ºå®š** - ãƒ¬ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³æ–¹å¼æ¡ç”¨ã€æ–°æ©Ÿèƒ½ã‚«ãƒ©ãƒ 13å€‹è¿½åŠ æ±ºå®š

---

## ğŸ“‹ æ¦‚è¦

æœ¬ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯è«‹æ±‚æ›¸å‡¦ç†è‡ªå‹•åŒ–ã‚·ã‚¹ãƒ†ãƒ ã®å…¨ãƒ†ãƒ¼ãƒ–ãƒ«ã®è©³ç´°ä»•æ§˜ã‚’å®šç¾©ã—ã¾ã™ã€‚  
**OCRãƒ†ã‚¹ãƒˆç³»**ã¨**æœ¬ç•ªç³»**ã®2ã¤ã®ãƒ†ãƒ¼ãƒ–ãƒ«ç¾¤ãŒå­˜åœ¨ã—ã€**çµ±ä¸€ã‚¹ã‚­ãƒ¼ãƒå®Œå…¨å†æ§‹ç¯‰**ã«ã‚ˆã‚Šå®Œå…¨ã«çµ±ä¸€ã•ã‚Œã¦ã„ã¾ã™ã€‚

**ğŸ‰ v4.0ã®é‡è¦ãªå¤‰æ›´**:
- âœ… **ãƒ¬ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³æ–¹å¼æ¡ç”¨**: æœ¬ç•ªãƒ†ãƒ¼ãƒ–ãƒ«ã‚’å®Œå…¨è¨­è¨ˆã€ãƒ†ã‚¹ãƒˆãƒ†ãƒ¼ãƒ–ãƒ«ã¯æœ¬ç•ªã‚’ãƒ¬ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³
- âœ… **40ã‚«ãƒ©ãƒ å®Œå…¨è¨­è¨ˆ**: Gmailé€£æºã€å¤–è²¨æ›ç®—ã€æ‰¿èªãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã€freeeé€£æºå¼·åŒ–
- âœ… **æ–°æ©Ÿèƒ½åŸºç›¤å®Œæˆ**: 13å€‹ã®æ–°æ©Ÿèƒ½ã‚«ãƒ©ãƒ è¿½åŠ ï¼ˆsource_type, gmail_message_idç­‰ï¼‰
- âœ… **è¦ä»¶ãƒ™ãƒ¼ã‚¹æœ€é©åŒ–**: ã‚¹ãƒ†ãƒƒãƒ—ãƒã‚¤ã‚¹ãƒ†ãƒƒãƒ—è¦ä»¶ç¢ºèªã«ã‚ˆã‚‹å¿…è¦ã‚«ãƒ©ãƒ ç²¾é¸

**v4.0è¨­è¨ˆåŸå‰‡**:
- **ãƒã‚¹ã‚¿ãƒ¼ãƒ»ãƒ¬ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³**: invoicesï¼ˆæœ¬ç•ªï¼‰ãŒãƒã‚¹ã‚¿ãƒ¼ã€ocr_test_resultsï¼ˆãƒ†ã‚¹ãƒˆï¼‰ã¯ãƒ¬ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ + ãƒ†ã‚¹ãƒˆå°‚ç”¨ã‚«ãƒ©ãƒ 
- **æ©Ÿèƒ½å®Œå…¨å¯¾å¿œ**: Gmailè‡ªå‹•å–ã‚Šè¾¼ã¿ã€å¤šé€šè²¨å¯¾å¿œã€æ‰¿èªãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã€freeeé€£æºã®å®Œå…¨å®Ÿè£…åŸºç›¤
- **è¦ä»¶é§†å‹•è¨­è¨ˆ**: å…¨ã‚«ãƒ©ãƒ ã®å¿…è¦æ€§ã‚’ã‚¹ãƒ†ãƒƒãƒ—ãƒã‚¤ã‚¹ãƒ†ãƒƒãƒ—ã§æ¤œè¨¼ãƒ»ç¢ºå®š

## ğŸ—‚ï¸ ãƒ†ãƒ¼ãƒ–ãƒ«æ§‹æˆä¸€è¦§

### æœ¬ç•ªç³»ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆProductionï¼‰
| ãƒ†ãƒ¼ãƒ–ãƒ«å | èª¬æ˜ | ã‚«ãƒ©ãƒ æ•° | å‚ç…§SQL |
|------------|------|----------|---------|
| `invoices` | è«‹æ±‚æ›¸ãƒ¡ã‚¤ãƒ³ãƒ†ãƒ¼ãƒ–ãƒ« | **40** | `invoices_gap_fix_step_by_step.sql` |
| `invoice_line_items` | è«‹æ±‚æ›¸æ˜ç´°ãƒ†ãƒ¼ãƒ–ãƒ« | 10 | `create_tables.sql` |
| `users` | ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç† | 3 | `create_tables.sql` |
| `payment_masters` | æ”¯æ‰•ãƒã‚¹ã‚¿ | 11 | `create_tables.sql` |

### OCRãƒ†ã‚¹ãƒˆç³»ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆTestingï¼‰
| ãƒ†ãƒ¼ãƒ–ãƒ«å | èª¬æ˜ | ã‚«ãƒ©ãƒ æ•° | å‚ç…§SQL |
|------------|------|----------|---------|
| `ocr_test_sessions` | OCRãƒ†ã‚¹ãƒˆå®Ÿè¡Œå±¥æ­´ | 12 | `create_ocr_test_tables.sql` |
| `ocr_test_results` | OCRå‡¦ç†çµæœè©³ç´°ï¼ˆinvoicesãƒ¬ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ + ãƒ†ã‚¹ãƒˆå°‚ç”¨ï¼‰ | **43** | `replicated_test_table_design.sql` |
| `ocr_test_line_items` | OCRæŠ½å‡ºæ˜ç´°ï¼ˆinvoice_line_itemsãƒ¬ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰ | 10 | `replicated_test_table_design.sql` |

---

## ğŸ‰ v4.0å®Œå…¨è¨­è¨ˆæ›¸æº–æ‹ 40ã‚«ãƒ©ãƒ ä»•æ§˜ç¢ºå®šæˆæœ

### âœ… **40ã‚«ãƒ©ãƒ å®Œå…¨è¨­è¨ˆæˆæœï¼ˆ2025å¹´7æœˆ28æ—¥é”æˆï¼‰**

#### 1. **è¦ä»¶ãƒ™ãƒ¼ã‚¹å®Œå…¨ã‚«ãƒ©ãƒ è¨­è¨ˆ**

| æ©Ÿèƒ½åˆ†é¡ | ã‚«ãƒ©ãƒ æ•° | ä¸»è¦ã‚«ãƒ©ãƒ  | æ–°è¦è¿½åŠ  | ç”¨é€” |
|----------|----------|-----------|----------|------|
| **ğŸ”‘ åŸºæœ¬ç®¡ç†** | 6 | id, user_email, status, *_at | - | åŸºæœ¬IDãƒ»çŠ¶æ…‹ç®¡ç† |
| **ğŸ“ ãƒ•ã‚¡ã‚¤ãƒ«ç®¡ç†** | 7 | file_name, gdrive_file_id, **source_type**, **gmail_message_id** | **4å€‹** | **Gmailé€£æºå¯¾å¿œ** |
| **ğŸ“„ è«‹æ±‚æ›¸åŸºæœ¬** | 7 | issuer_name, main_invoice_number, receipt_number, t_number | - | è«‹æ±‚æ›¸åŸºæœ¬æƒ…å ± |
| **ğŸ’° é‡‘é¡ãƒ»é€šè²¨** | 6 | currency, total_amount_*, **exchange_rate**, **jpy_amount** | **3å€‹** | **å¤–è²¨æ›ç®—å¯¾å¿œ** |
| **ğŸ¤– AIå‡¦ç†** | 8 | extracted_data, key_info, is_valid, completeness_score | - | AIå‡¦ç†ãƒ»æ¤œè¨¼ |
| **âœ… æ‰¿èªWF** | 3 | **approval_status**, **approved_by**, **approved_at** | **3å€‹** | **æ‰¿èªãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼** |
| **ğŸ“Š freeeé€£æº** | 3 | **exported_to_freee**, **export_date**, **freee_batch_id** | **3å€‹** | **freeeé€£æºå¼·åŒ–** |

#### 2. **ãƒ¬ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³æ–¹å¼æ¡ç”¨åŠ¹æœ**

| è¨­è¨ˆæ–¹é‡ | å¾“æ¥ | v4.0æ–°æ–¹å¼ | åŠ¹æœ |
|----------|------|-----------|------|
| **ãƒã‚¹ã‚¿ãƒ¼å®šç¾©** | âŒ ä¸¡ãƒ†ãƒ¼ãƒ–ãƒ«ç‹¬ç«‹è¨­è¨ˆ | âœ… invoicesï¼ˆæœ¬ç•ªï¼‰ãŒãƒã‚¹ã‚¿ãƒ¼ | **è¨­è¨ˆä¸€å…ƒåŒ–** |
| **ãƒ†ã‚¹ãƒˆãƒ†ãƒ¼ãƒ–ãƒ«** | âŒ ç‹¬è‡ªä»•æ§˜ | âœ… æœ¬ç•ªãƒ¬ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ + ãƒ†ã‚¹ãƒˆå°‚ç”¨ã‚«ãƒ©ãƒ  | **100%æ•´åˆæ€§ä¿è¨¼** |
| **æ–°æ©Ÿèƒ½è¿½åŠ ** | âŒ ä¸¡ãƒ†ãƒ¼ãƒ–ãƒ«å€‹åˆ¥å¯¾å¿œ | âœ… ãƒã‚¹ã‚¿ãƒ¼ã®ã¿æ›´æ–°â†’è‡ªå‹•ãƒ¬ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ | **ä¿å®ˆåŠ¹ç‡åŒ–** |
| **ã‚¹ã‚­ãƒ¼ãƒé½Ÿé½¬** | âŒ é »ç™ºï¼ˆgemini_modelç­‰ï¼‰ | âœ… æ§‹é€ çš„ã«ç™ºç”Ÿä¸å¯ | **ã‚¨ãƒ©ãƒ¼æ ¹çµ¶** |

#### 3. **å‰Šé™¤ãƒ»è¿½åŠ ã‚«ãƒ©ãƒ æ˜ç´°**

| ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ | ã‚«ãƒ©ãƒ å | ç†ç”± | åŠ¹æœ |
|------------|----------|------|------|
| **âŒ å‰Šé™¤** | final_accounting_info | ãƒ¦ãƒ¼ã‚¶ãƒ¼ç¢ºèªï¼šä¸è¦ | ã‚·ãƒ³ãƒ—ãƒ«åŒ– |
| **âœ… è¿½åŠ ** | source_type, gmail_message_idç­‰ | Gmailé€£æºå¿…é ˆ | **æ–°æ©Ÿèƒ½åŸºç›¤** |
| **âœ… è¿½åŠ ** | exchange_rate, jpy_amountç­‰ | å¤–è²¨å¯¾å¿œå¿…é ˆ | **å¤šé€šè²¨å¯¾å¿œ** |
| **âœ… è¿½åŠ ** | approval_statusç­‰ | æ‰¿èªWFå¿…é ˆ | **æ¥­å‹™WFå¯¾å¿œ** |
| **âœ… è¿½åŠ ** | exported_to_freeeç­‰ | freeeé€£æºå¼·åŒ– | **ä¼šè¨ˆé€£æºå¼·åŒ–** |

---

## ğŸ“‹ ãƒ†ãƒ¼ãƒ–ãƒ«è©³ç´°ä»•æ§˜

### 1. **invoicesï¼ˆè«‹æ±‚æ›¸ãƒ¡ã‚¤ãƒ³ãƒ†ãƒ¼ãƒ–ãƒ«ï¼‰**

- **ãƒã‚¹ã‚¿ãƒ¼å®šç¾©**: `master_data/tables.yml -> tables.invoices`
- **å®Ÿè£…SQL**: `sql/invoices_gap_fix_step_by_step.sql`
- **èª¬æ˜**: è«‹æ±‚æ›¸å‡¦ç†ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®ä¸­æ ¸ã¨ãªã‚‹ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆ40ã‚«ãƒ©ãƒ å®Œå…¨è¨­è¨ˆï¼‰

#### 40ã‚«ãƒ©ãƒ å®Œå…¨ç‰ˆSQLå®šç¾©
```sql
CREATE TABLE public.invoices (
    -- ğŸ”‘ åŸºæœ¬ç®¡ç†ï¼ˆ6ã‚«ãƒ©ãƒ ï¼‰
    id SERIAL PRIMARY KEY,
    user_email VARCHAR(255) NOT NULL REFERENCES users(email),
    status VARCHAR(50) DEFAULT 'uploaded',
    uploaded_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT timezone('Asia/Tokyo', NOW()),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT timezone('Asia/Tokyo', NOW()),
    
    -- ğŸ“ ãƒ•ã‚¡ã‚¤ãƒ«ç®¡ç†ï¼ˆ7ã‚«ãƒ©ãƒ ï¼‰
    file_name VARCHAR(255) NOT NULL,
    gdrive_file_id VARCHAR(255),
    file_path VARCHAR(500),
    source_type VARCHAR(20) DEFAULT 'local' CHECK (source_type IN ('local', 'gdrive', 'gmail')),
    gmail_message_id VARCHAR(255),
    attachment_id VARCHAR(255),
    sender_email VARCHAR(255),
    
    -- ğŸ“„ è«‹æ±‚æ›¸åŸºæœ¬æƒ…å ±ï¼ˆ7ã‚«ãƒ©ãƒ ï¼‰
    issuer_name VARCHAR(255),
    recipient_name VARCHAR(255),
    main_invoice_number VARCHAR(255),
    receipt_number VARCHAR(255),
    t_number VARCHAR(50),
    issue_date DATE,
    due_date DATE,
    
    -- ğŸ’° é‡‘é¡ãƒ»é€šè²¨æƒ…å ±ï¼ˆ6ã‚«ãƒ©ãƒ ï¼‰
    currency VARCHAR(10) DEFAULT 'JPY',
    total_amount_tax_included DECIMAL(15,2),
    total_amount_tax_excluded DECIMAL(15,2),
    exchange_rate DECIMAL(10,4),
    jpy_amount DECIMAL(15,2),
    card_statement_id VARCHAR(255),
    
    -- ğŸ¤– AIå‡¦ç†ãƒ»æ¤œè¨¼çµæœï¼ˆ8ã‚«ãƒ©ãƒ ï¼‰
    extracted_data JSONB,
    raw_response JSONB,
    key_info JSONB,
    is_valid BOOLEAN DEFAULT TRUE,
    validation_errors TEXT[],
    validation_warnings TEXT[],
    completeness_score DECIMAL(5,2),
    processing_time DECIMAL(8,2),
    
    -- âœ… æ‰¿èªãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ï¼ˆ3ã‚«ãƒ©ãƒ ï¼‰
    approval_status VARCHAR(50) DEFAULT 'pending' CHECK (approval_status IN ('pending', 'approved', 'rejected', 'requires_review')),
    approved_by VARCHAR(255),
    approved_at TIMESTAMPTZ,
    
    -- ğŸ“Š freeeé€£æºï¼ˆ3ã‚«ãƒ©ãƒ ï¼‰
    exported_to_freee BOOLEAN DEFAULT FALSE,
    export_date TIMESTAMPTZ,
    freee_batch_id VARCHAR(255)
);

-- ğŸ”§ ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹å®šç¾©
CREATE INDEX idx_invoices_user_email ON invoices(user_email);
CREATE INDEX idx_invoices_status ON invoices(status);
CREATE INDEX idx_invoices_source_type ON invoices(source_type);
CREATE INDEX idx_invoices_gmail_message_id ON invoices(gmail_message_id) WHERE gmail_message_id IS NOT NULL;
CREATE INDEX idx_invoices_approval_status ON invoices(approval_status);
CREATE INDEX idx_invoices_exported_to_freee ON invoices(exported_to_freee);
CREATE INDEX idx_invoices_key_info_gin ON invoices USING gin(key_info);
CREATE INDEX idx_invoices_extracted_data_gin ON invoices USING gin(extracted_data);

-- ğŸ¤– updated_atè‡ªå‹•æ›´æ–°ãƒˆãƒªã‚¬ãƒ¼
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = timezone('Asia/Tokyo', NOW());
    RETURN NEW;
END;
$$ language 'plpgsql';

CREATE TRIGGER update_invoices_updated_at BEFORE UPDATE ON invoices
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();
```

### 2. **ocr_test_resultsï¼ˆOCRå‡¦ç†çµæœè©³ç´°ãƒ†ãƒ¼ãƒ–ãƒ«ï¼‰**

- **å®Ÿè£…SQL**: `sql/replicated_test_table_design.sql`
- **èª¬æ˜**: invoicesãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ãƒ¬ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ + ãƒ†ã‚¹ãƒˆå°‚ç”¨ã‚«ãƒ©ãƒ è¿½åŠ ï¼ˆ43ã‚«ãƒ©ãƒ ï¼‰

#### ãƒ¬ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³æ–¹å¼è¨­è¨ˆ
```sql
-- ğŸ¯ ã‚¹ãƒ†ãƒƒãƒ—1: invoicesãƒ†ãƒ¼ãƒ–ãƒ«å®Œå…¨ãƒ¬ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆ40ã‚«ãƒ©ãƒ ï¼‰
CREATE TABLE ocr_test_results AS SELECT * FROM invoices WHERE FALSE;

-- ğŸ¯ ã‚¹ãƒ†ãƒƒãƒ—2: ãƒ†ã‚¹ãƒˆå°‚ç”¨ã‚«ãƒ©ãƒ è¿½åŠ ï¼ˆ3ã‚«ãƒ©ãƒ ï¼‰
ALTER TABLE ocr_test_results 
    ADD COLUMN session_id UUID REFERENCES ocr_test_sessions(id) ON DELETE CASCADE,
    ADD COLUMN gemini_model VARCHAR(50) DEFAULT 'gemini-2.5-flash-lite-preview-06-17',
    ADD COLUMN test_batch_name VARCHAR(100);

-- ğŸ¯ ã‚¹ãƒ†ãƒƒãƒ—3: IDå‹å¤‰æ›´ï¼ˆãƒ†ã‚¹ãƒˆç’°å¢ƒç”¨UUIDï¼‰
ALTER TABLE ocr_test_results DROP COLUMN id;
ALTER TABLE ocr_test_results ADD COLUMN id UUID PRIMARY KEY DEFAULT uuid_generate_v4();

-- ğŸ¯ ã‚¹ãƒ†ãƒƒãƒ—4: ãƒ†ã‚¹ãƒˆå°‚ç”¨ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
CREATE INDEX idx_ocr_test_results_session_id ON ocr_test_results(session_id);
CREATE INDEX idx_ocr_test_results_gemini_model ON ocr_test_results(gemini_model);
CREATE INDEX idx_ocr_test_results_test_batch_name ON ocr_test_results(test_batch_name);
```

#### ãƒ¬ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³åŠ¹æœ
| é …ç›® | å¾“æ¥æ–¹å¼ | v4.0ãƒ¬ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³æ–¹å¼ | åŠ¹æœ |
|------|----------|-------------------------|------|
| **ã‚¹ã‚­ãƒ¼ãƒæ•´åˆæ€§** | âŒ æ‰‹å‹•ç®¡ç†â†’é½Ÿé½¬ç™ºç”Ÿ | âœ… è‡ªå‹•ãƒ¬ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³â†’100%æ•´åˆ | **ã‚¨ãƒ©ãƒ¼æ ¹çµ¶** |
| **æ–°æ©Ÿèƒ½è¿½åŠ ** | âŒ ä¸¡ãƒ†ãƒ¼ãƒ–ãƒ«å€‹åˆ¥å¯¾å¿œ | âœ… ãƒã‚¹ã‚¿ãƒ¼æ›´æ–°â†’è‡ªå‹•åæ˜  | **ä¿å®ˆåŠ¹ç‡åŒ–** |
| **ã‚«ãƒ©ãƒ æ•°ç®¡ç†** | âŒ 21ã‚«ãƒ©ãƒ ï¼ˆç‹¬è‡ªè¨­è¨ˆï¼‰ | âœ… 43ã‚«ãƒ©ãƒ ï¼ˆ40+3ãƒ†ã‚¹ãƒˆå°‚ç”¨ï¼‰ | **æ©Ÿèƒ½å®Œå…¨å¯¾å¿œ** |
| **ãƒ‡ãƒ¼ã‚¿ç§»è¡Œ** | âŒ ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ä¸æ•´åˆ | âœ… å®Œå…¨äº’æ›æ€§ | **ã‚·ãƒ¼ãƒ ãƒ¬ã‚¹ç§»è¡Œ** |
    validation_errors TEXT[],
    validation_warnings TEXT[],
    -- ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿
    processing_time DECIMAL(8,2),
    gemini_model VARCHAR(50) DEFAULT 'gemini-2.5-flash-lite-preview-06-17',
    raw_response JSONB,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

### 3. **invoice_line_itemsï¼ˆè«‹æ±‚æ›¸æ˜ç´°ãƒ†ãƒ¼ãƒ–ãƒ«ï¼‰**

#### SQLå®šç¾©
```sql
CREATE TABLE public.invoice_line_items (
    id SERIAL PRIMARY KEY,
    invoice_id INTEGER NOT NULL REFERENCES invoices(id) ON DELETE CASCADE,
    line_number INTEGER NOT NULL,
    item_description TEXT,                       -- å•†å“ãƒ»ã‚µãƒ¼ãƒ“ã‚¹å
    quantity DECIMAL(10,3),
    unit_price DECIMAL(15,2), 
    amount DECIMAL(15,2),
    tax_rate DECIMAL(5,2),                       -- ç¨ç‡ï¼ˆæ•°å€¤ï¼‰
    created_at TIMESTAMP DEFAULT timezone('Asia/Tokyo', NOW()),
    updated_at TIMESTAMP DEFAULT timezone('Asia/Tokyo', NOW()),  -- âœ…
    UNIQUE(invoice_id, line_number)
);
```

### 4. **ocr_test_line_itemsï¼ˆOCRæŠ½å‡ºæ˜ç´°ãƒ†ãƒ¼ãƒ–ãƒ«ï¼‰**

#### SQLå®šç¾©
```sql
CREATE TABLE IF NOT EXISTS ocr_test_line_items (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    result_id UUID REFERENCES ocr_test_results(id) ON DELETE CASCADE,
    line_number INTEGER NOT NULL,
    description TEXT,                            -- âŒ item_descriptionã¨ä¸ä¸€è‡´
    quantity DECIMAL(10,3),
    unit_price DECIMAL(15,2),
    amount DECIMAL(15,2),
    tax_rate VARCHAR(10),                        -- âŒ DECIMAL(5,2)ã¨ä¸ä¸€è‡´
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
    -- âŒ æ¬ æé …ç›®: updated_at
);
```

---

## âœ… çµ±ä¸€åŒ–å®Ÿè£…å®Œäº†å ±å‘Š

### ğŸ‰ Phase 1: ç·Šæ€¥çµ±ä¸€é …ç›® - **å®Œäº†ï¼ˆ2025å¹´7æœˆ27æ—¥ï¼‰**
1. âœ… **çµ±ä¸€ã‚¹ã‚­ãƒ¼ãƒå®Œå…¨å†æ§‹ç¯‰**: `sql/unified_schema_rebuild.sql`å®Ÿè¡Œå®Œäº†
2. âœ… **ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰åçµ±ä¸€**: `main_invoice_number`, `t_number`, `receipt_number`, `key_info`
3. âœ… **æ˜ç´°ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰çµ±ä¸€**: `item_description`, `tax_rate` DECIMAL(5,2)
4. âœ… **è‡ªå‹•æ›´æ–°æ©Ÿèƒ½**: `updated_at`ãƒˆãƒªã‚¬ãƒ¼è¨­å®šå®Œäº†
5. âœ… **ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å¯¾å¿œ**: çµ±ä¸€åŒ–ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å®Œå…¨é©ç”¨
6. âœ… **æ ¹æœ¬ä¿®æ­£å®Œäº†**: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ»ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å®Œå…¨æ•´åˆ

### ğŸš€ Phase 2: é‹ç”¨æœ€é©åŒ–é …ç›® - **å®Ÿè£…æ¸ˆã¿**
1. âœ… **ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹æœ€é©åŒ–**: çµ±ä¸€åŒ–ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å¯¾å¿œã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ä½œæˆ
2. âœ… **RLSå¼·åŒ–**: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒãƒªã‚·ãƒ¼çµ±ä¸€è¨­å®š
3. âœ… **ãƒˆãƒªã‚¬ãƒ¼çµ±ä¸€**: å…¨ãƒ†ãƒ¼ãƒ–ãƒ«`updated_at`è‡ªå‹•æ›´æ–°
4. âœ… **ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ©Ÿèƒ½**: ã‚¿ãƒ–åˆ†å‰²è©³ç´°è¡¨ç¤ºæ©Ÿèƒ½å®Ÿè£…

### ğŸ“Š Phase 3: å°†æ¥æ‹¡å¼µè¨ˆç”» - **è¨ˆç”»æ¸ˆã¿**
1. **Phase 3Aå®Œäº†**: ã‚¹ã‚­ãƒ¼ãƒæœ€é©åŒ–ãƒ»ä¸è¦ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å‰Šé™¤
2. **Phase 3Bè¨ˆç”»**: é«˜åº¦æœ€é©åŒ–ï¼ˆãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ³ã€ãƒãƒ†ãƒªã‚¢ãƒ©ã‚¤ã‚ºãƒ‰ãƒ“ãƒ¥ãƒ¼ç­‰ï¼‰
3. **ãƒ‡ãƒ¼ã‚¿ç§»è¡Œæ©Ÿèƒ½**: ãƒ†ã‚¹ãƒˆçµæœã®æœ¬ç•ªç§»è¡Œæ©Ÿèƒ½ï¼ˆè¨­è¨ˆå®Œäº†ï¼‰

---

## ğŸ“š é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

### ãƒã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿
- **master_data/tables.yml** - æœ¬ç•ªãƒ†ãƒ¼ãƒ–ãƒ«å®šç¾©ã®ãƒã‚¹ã‚¿ãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«

### SQLå®Ÿè£…
- **sql/unified_schema_rebuild.sql** - çµ±ä¸€ã‚¹ã‚­ãƒ¼ãƒå®Œå…¨å†æ§‹ç¯‰ï¼ˆæœ€æ–°ï¼‰
- **sql/create_tables.sql** - æœ¬ç•ªãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆï¼ˆå‚è€ƒï¼‰
- **sql/create_ocr_test_tables.sql** - OCRãƒ†ã‚¹ãƒˆãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆï¼ˆå‚è€ƒï¼‰

### çµ±ä¸€åŒ–é–¢é€£
- **master_data/tables.yml** - çµ±ä¸€ãƒ†ãƒ¼ãƒ–ãƒ«å®šç¾©ãƒã‚¹ã‚¿ãƒ¼ï¼ˆSingle Source of Truthï¼‰
- **sql/verify_unified_schema.sql** - çµ±ä¸€ã‚¹ã‚­ãƒ¼ãƒæ¤œè¨¼
- **docs/ãƒ†ãƒ¼ãƒ–ãƒ«çµ±ä¸€åŒ–ä½œæ¥­ã‚µãƒãƒªãƒ¼.md** - çµ±ä¸€åŒ–ä½œæ¥­æˆæœ

### è¨­è¨ˆæ›¸
- [16_ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆæ›¸.md](../16_ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆæ›¸.md) - ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆçµ±åˆç‰ˆï¼ˆv3.0å¯¾å¿œï¼‰
- [13_Supabaseãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­å®šãƒ»é‹ç”¨ã‚¬ã‚¤ãƒ‰.md](../13_Supabaseãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­å®šãƒ»é‹ç”¨ã‚¬ã‚¤ãƒ‰.md) - çµ±ä¸€åŒ–é‹ç”¨ã‚¬ã‚¤ãƒ‰

---

**ä½œæˆæ—¥**: 2025å¹´1æœˆ24æ—¥  
**æœ€çµ‚æ›´æ–°**: 2025å¹´7æœˆ27æ—¥  
**ãƒãƒ¼ã‚¸ãƒ§ãƒ³**: 3.0 - çµ±ä¸€ã‚¹ã‚­ãƒ¼ãƒå®Œå…¨å†æ§‹ç¯‰å®Œäº†ç‰ˆ  
**æ‹…å½“è€…**: ã‚·ã‚¹ãƒ†ãƒ é–‹ç™ºãƒãƒ¼ãƒ   
**é‡è¦ãªå¤‰æ›´**: ğŸ‰ çµ±ä¸€åŒ–å®Œå…¨æˆåŠŸ - ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ»ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å®Œå…¨æ•´åˆé”æˆ 