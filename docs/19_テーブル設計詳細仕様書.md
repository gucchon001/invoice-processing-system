# 📊 テーブル設計詳細仕様書

**作成日**: 2025年1月24日  
**バージョン**: 1.2  
**対象システム**: 請求書処理自動化システム  
**データベース**: Supabase PostgreSQL

**v1.2更新内容**: マスターデータ分離に伴い、`master_data/tables.yml`からの参照形式に変更

---

## 📋 概要

本ドキュメントは請求書処理自動化システムの全テーブルの詳細仕様を定義します。  
**唯一のマスターデータ**は `master_data/tables.yml` にあり、このドキュメントはその内容を人間が読みやすい形式で表示したものです。

**設計原則**:
- **Single Source of Truth (SSOT)**: `tables.yml` が唯一の正
- **自動生成**: 将来的にこのファイルは `tables.yml` から自動生成される
- **可読性重視**: 開発者が概要を素早く把握できる構成

## 🗂️ テーブル一覧

| テーブル名 | 説明 | カラム数 |
|------------|------|----------|
| [invoices](#1-invoices請求書メインテーブル) | 請求書処理ワークフローの中核 | 28 |
| [invoice_line_items](#2-invoice_line_items請求書明細テーブル) | 請求書明細情報 | 10 |
| *users* | *ユーザー情報* | *（定義予定）* |
| *ocr_test_sessions* | *OCRテストセッション* | *（定義予定）* |
| *payment_masters* | *支払マスタ* | *（定義予定）* |

---

## 1. **invoices（請求書メインテーブル）**

- **マスター定義**: `master_data/tables.yml -> tables.invoices`
- **説明**: 請求書処理ワークフローの中核となるテーブル。AI抽出データ、ファイル情報、検証結果などを一元管理します。

### SQL定義
```sql
-- `tables.yml` の `sql_definition` を参照
CREATE TABLE public.invoices (
    id SERIAL PRIMARY KEY,
    user_email VARCHAR(255) NOT NULL REFERENCES users(email),
    status VARCHAR(50) DEFAULT 'uploaded',
    -- ... (全28カラム) ...
    created_at TIMESTAMP WITH TIME ZONE DEFAULT timezone('Asia/Tokyo', NOW()),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT timezone('Asia/Tokyo', NOW())
);
```

### 主要カラムサマリー
| カテゴリ | 主要カラム | 説明 |
|----------|------------|------|
| **基本情報** | `id`, `user_email`, `status`, `file_name` | 識別・管理情報 |
| **請求書情報** | `issuer_name`, `main_invoice_number`, `issue_date` | 請求書固有情報 |
| **金額情報** | `total_amount_tax_included`, `currency` | 金額データ |
| **JSON形式** | `extracted_data`, `raw_response` | AI処理結果 |
| **品質管理** | `is_valid`, `completeness_score` | 検証・スコア |

### 業務ルール
- `status`値の遷移: `uploaded` → `processing` → `extracted` → `validated` → `approved`/`rejected`
- `extracted_data`は標準構造に準拠する
- `completeness_score`は必須項目充足率で計算される

---

## 2. **invoice_line_items（請求書明細テーブル）**

- **マスター定義**: `master_data/tables.yml -> tables.invoice_line_items`
- **説明**: 請求書の明細情報を格納するテーブル。invoicesテーブルと1対多の関係。

### SQL定義
```sql
-- `tables.yml` の `sql_definition` を参照
CREATE TABLE public.invoice_line_items (
    id SERIAL PRIMARY KEY,
    invoice_id INTEGER NOT NULL REFERENCES invoices(id) ON DELETE CASCADE,
    line_number INTEGER NOT NULL,
    -- ... (全10カラム) ...
    UNIQUE(invoice_id, line_number)
);
```

### 主要カラムサマリー
| カラム名 | データ型 | 説明 |
|------------|----------|------|
| `id` | SERIAL | 明細一意ID |
| `invoice_id` | INTEGER | 請求書ID（外部キー） |
| `line_number`| INTEGER | 請求書内での明細行番号 |
| `item_description` | TEXT | 商品・サービス名 |
| `amount` | DECIMAL(15,2) | 金額 |

### 業務ルール
- **カスケード削除**: 請求書削除時に、関連する全明細も自動削除される
- **金額計算の整合性**: `amount` ≈ `quantity` × `unit_price`（丸め誤差を許容）

---

## 🚀 今後の拡張

- 全テーブル定義を `master_data/tables.yml` に追加
- このMarkdownファイルを自動生成するスクリプト (`tools/doc-generator.py`) を開発

---

**関連ドキュメント**:

### 📚 マスターデータ
- **master_data/tables.yml** - 全テーブル定義のマスターファイル

### 📚 統合設計書
- [15_システムアーキテクチャ設計書.md](../15_システムアーキテクチャ設計書.md) - システム全体設計（統合版）
- [16_データベース設計書.md](../16_データベース設計書.md) - データベース設計（統合版）

### 🏗️ 詳細設計書（独立版）
- [17_システムアーキテクチャUML図.md](../17_システムアーキテクチャUML図.md) - システムアーキテクチャ図集
- [18_データベースER図.md](../18_データベースER図.md) - データベースER図・関係性
- [20_シーケンス図集.md](../20_シーケンス図集.md) - 処理フロー・正常系・異常系
- [21_クラス図.md](../21_クラス図.md) - クラス構造・コンポーネント関係

### 📋 ドキュメント管理
- [00_DOCS_INDEX.md](../00_DOCS_INDEX.md) - 全ドキュメント一覧・関連性 