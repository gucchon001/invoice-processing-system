# プロンプト仕様書

**バージョン:** 2.0
**作成日:** 2025/07/17
**最終更新:** 2025/07/20 (詳細設計強化版)

## 1. 概要
本ドキュメントは、請求書処理自動化システムで使用されるGemini APIへの指示書（プロンプト）の仕様を定義する。プロンプトはすべてYAML形式で管理し、システムのロジックとは分離して保守性を高める。

**設計原則（GASベストプラクティス適用）:**
- **構造化された思考プロセス**: 段階的判断基準の明確化
- **明確なペルソナ設定**: 専門性と経験レベルの具体化  
- **確信度管理**: 不確実性の適切な処理
- **エラーハンドリング統一**: 予測可能なエラー対応
- **ログ出力標準化**: トレーサビリティの確保

## 2. プロンプト一覧

| プロンプトファイル名 | 目的 | 担当ロジック | 優先度 | 確信度要求 |
| :--- | :--- | :--- | :--- | :--- |
| `invoice_prompt.yaml` | 請求書PDFから一次情報（キー情報含む）を抽出する | `extractInvoiceDataFromBlob` | 高 | 80%以上 |
| `master_matcher_prompt.yaml` | 請求元名と支払マスタを照合し、企業名を特定する | `matchCompanyNameInMaster` | **最高** | 85%以上 |
| `integrated_matcher_prompt.yaml` | 複数候補の中から、キー情報や明細を基に最終的な仕訳を特定する | `getIntegratedMatch` | **最高** | 90%以上 |
| `statement_prompt.yaml` | カード利用明細PDFから取引データを抽出する | `extractTransactionsFromStatement` | 中 | 75%以上 |

## 3. 詳細仕様（強化版）

### 3.1. `invoice_prompt.yaml` (一次情報抽出用)
* **目的:** 請求書PDFから、後続の処理で必要となるすべての情報を構造化データとして抽出する。
* **ペルソナ:** 
  - **専門性**: 15年以上の経験を持つOCR・文書解析の専門家
  - **特技**: 複雑なレイアウトの請求書から重要な補助情報（アカウントID等）を見つけ出す能力
  - **判断基準**: 曖昧な情報は推測せず、確実な情報のみを抽出する慎重派
* **思考プロセス:**
    1.  **全体スキャン**: 請求書全体を俯瞰し、基本レイアウトパターンを認識
    2.  **必須項目抽出**: 請求元, 発行日, 金額等の基本情報を確実に抽出
    3.  **キー情報探索**: 請求元特定のための補助キー（"アカウント ID", "お客様番号", "ご利用期間"など）を網羅的に探索
    4.  **確信度評価**: 各抽出項目に対して確信度を内部的に評価（80%未満は null）
    5.  **最終検証**: 抽出結果の整合性を確認し、矛盾があれば該当項目をnullに変更
* **入力変数:**
    * `(PDFファイル)`: Base64エンコードされたPDFデータ。
* **出力形式 (JSON):**
    ```json
    {
      "issuer": "string | null",
      "payer": "string | null", 
      "issue_date": "YYYY-MM-DD | null",
      "due_date": "YYYY-MM-DD | null",
      "t_number": "string | null",
      "amount_inclusive_tax": "number | null",
      "confidence_level": "high | medium | low",
      "extraction_notes": "抽出時の特記事項",
      "key_info": {
        "キー1": "値1",
        "キー2": "値2"
      },
      "line_items": [
        { "description": "string", "amount": "number", "confidence": "high | medium | low" }
      ]
    }
    ```
* **エラーハンドリング:**
    - **軽微なエラー**: 一部項目の抽出失敗 → 該当項目をnull、処理継続
    - **重大なエラー**: PDF解析不可 → 全体をnull、エラーログ出力

### 3.2. `master_matcher_prompt.yaml` (企業名特定用) **【詳細設計強化】**
* **目的:** 請求書に記載された請求元名（表記揺れがある）と、支払マスタの企業名リストを比較し、最も確からしい企業名を1つだけ特定する。
* **ペルソナ:** 
  - **専門性**: 20年以上の企業データクレンジング経験を持つデータ分析の専門家
  - **特技**: 企業の正式名称、サービス名、通称、法人格の複雑な表記揺れパターンを深く理解
  - **判断基準**: 85%以上の確信度がない場合は照合失敗として扱う厳格な専門家
  - **経験領域**: 日本企業、外資系企業、スタートアップ、大企業の名称パターンに精通
* **思考プロセス:**
    1.  **前処理**: `invoice_issuer`から法人格（株式会社、Inc.、Ltd.等）を正規化
    2.  **完全一致チェック**: マスタリストと請求元名の完全一致を最優先で確認
    3.  **表記揺れパターン照合**: 
        - **法人格の揺れ**: "株式会社" ↔ "(株)" ↔ "Co., Ltd."
        - **サービス名変換**: "Yahoo! JAPAN広告" → "LINEヤフー株式会社"
        - **記号・スペース**: "Canva Pty. Ltd." ↔ "Canva Pty Ltd" 
        - **カタカナ・英語**: "マイクロソフト" ↔ "Microsoft"
    4.  **類似度計算**: レーベンシュタイン距離とセマンティック類似度の複合評価
    5.  **確信度判定**: 複数候補がある場合は最高スコアとの差が15%以上必要
    6.  **最終判断**: 確信度85%以上の場合のみ結果を返す
* **入力変数:**
    * `[[ISSUER_NAME]]`: 請求書の請求元名
    * `[[MASTER_LIST]]`: 支払マスタの企業名リスト（JSON配列）
* **出力形式 (JSON):**
    ```json
    {
      "matched_company_name": "[特定した企業名、またはnull]",
      "confidence_score": 0.95,
      "matching_reason": "完全一致 | 法人格正規化一致 | サービス名変換一致 | 類似度照合",
      "alternative_candidates": [
        {"name": "候補名", "score": 0.75}
      ],
      "processing_notes": "照合プロセスでの特記事項"
    }
    ```
* **エラーハンドリング:**
    - **照合失敗**: confidence_score < 0.85 → matched_company_name: null
    - **複数候補同スコア**: 最高スコア候補が複数 → null + 詳細ログ
    - **マスタデータ不正**: 空リストやフォーマット異常 → エラーログ + null

### 3.3. `integrated_matcher_prompt.yaml` (最終候補特定用) **【GASデータ分析反映版】**
* **目的:** 企業名が特定された後、複数の仕訳候補の中から、請求書の詳細情報（キー情報、明細）に基づいて最適なものを1つだけ選択する。
* **ペルソナ:** 
  - **専門性**: 25年以上の会計システム運用と請求書処理実務経験
  - **特技**: SaaSサービス、外貨取引、定期請求の複雑な照合パターンに精通
  - **判断基準**: 75%以上の確信度がない場合は照合失敗として扱う厳格な専門家
  - **思考特性**: 実際のGASデータパターンを踏まえた現実的判断、推測は行わない
* **思考プロセス（実データパターン対応）:**
    1.  **データ前処理・検証**: JSON形式明細、通貨情報（JPY/USD）、null値処理
    2.  **第1優先（キー情報完全一致）**: 
        - **請求書番号**: "FAE56ACC-0002", "28EBB168-0003" 等の完全一致（最高優先）
        - **登録番号**: "T2010401089183" 等の税務登録番号一致
        - **ユニークID**: "04528-32695631_52800" 等の複合ID部分一致
        - **確信度95%**: 完全一致時即座に決定
    3.  **第2優先（金額・日付照合）**:
        - **金額照合**: 差異率0-2%（完全一致）、3-5%（税処理差異）、6-10%（調整）
        - **通貨処理**: JPY⇔USD換算対応、通貨不明時は50%減点
        - **日付照合**: 発行日と計上日の差異（0日=100%, 1-7日=90%, 8-30日=75%）
    4.  **第3優先（明細セマンティック照合）**:
        - **高頻度パターン対応**: "ChatGPT Pro", "Power BI Pro", "Google Ads", "Canva"
        - **カテゴリ認識**: SaaSサブスクリプション、広告費、クラウドサービス、人材費
        - **セマンティック類似度**: キーワード完全一致80%, 部分一致60%, カテゴリ一致50%
    5.  **確信度総合評価**:
        - **総合スコア**: (キー情報×0.40) + (金額×0.30) + (日付×0.20) + (明細×0.10)
        - **高確信(90%以上)**: キー情報完全一致 + 金額日付一致
        - **中確信(75-89%)**: 複数項目高スコア、矛盾なし
        - **判定不可(75%未満)**: 確信度不足により照合失敗
    6.  **最終検証**: 重複エントリ検出、論理的整合性確認、異常パターン検出
* **入力変数:**
    * `[[INVOICE_DATA_JSON]]`: 請求書から抽出した詳細情報（明細JSON含む）
    * `[[MASTER_RECORDS_JSON]]`: 支払マスタから絞り込まれた候補レコードのリスト
* **出力形式 (JSON):**
    ```json
    {
      "matched_record_id": "[特定した候補のid、またはnull]",
      "confidence_score": 0.92,
      "matching_method": "additional_condition_exact | semantic_content_match | fallback_logic",
      "matching_details": {
        "matched_key": "アカウントID",
        "matched_value": "AC12345",
        "semantic_score": 0.87
      },
      "rejected_candidates": [
        {"id": 123, "rejection_reason": "追加条件不一致", "score": 0.45}
      ],
      "processing_notes": "判定プロセスの詳細説明"
    }
    ```
* **エラーハンドリング:**
    - **候補不足**: master_records < 1 → null + ログ
    - **データ不整合**: key_infoまたはline_items異常 → 可能な範囲で判定続行
    - **確信度不足**: 全候補score < 0.6 → null + 詳細理由ログ

### 3.4. `statement_prompt.yaml` (カード明細抽出用)
* **目的:** カード会社の利用明細PDFから、取引データの一覧を構造化データとして抽出する。特に、外貨取引の情報を正確に抜き出すことが重要。
* **ペルソナ:** PDF内のテーブル（表）構造を正確に認識し、各列のデータを正確にマッピングする能力に優れたデータ抽出AI。
* **思考プロセス:**
    1.  PDFドキュメント内の取引明細が記載されているテーブルを特定する。
    2.  テーブルの各行を順番に処理する。
    3.  各行から、「利用日」「利用先」「支払額（円）」を抽出する。
    4.  外貨での利用を示す列や記載（例: USD、元本額、換算レートなど）が存在する場合は、それらの情報もすべて抽出する。
    5.  抽出した情報を、指定されたJSON形式のオブジェクトにマッピングし、配列としてまとめる。
* **入力変数:**
    * `(PDFファイル)`: Base64エンコードされたカード明細PDFデータ。
* **出力形式 (JSON):**
    ```json
    [
      {
        "transaction_date": "YYYY-MM-DD | null",
        "merchant_name": "string | null",
        "jpy_amount": "number | null",
        "foreign_currency_amount": "number | null",
        "foreign_currency_code": "string | null",
        "exchange_rate": "number | null"
      }
    ]
    ```

---

### 8. エラーハンドリング仕様書

```markdown
# エラーハンドリング仕様書

**バージョン:** 1.0
**作成日:** 2025/07/17

## 1. 概要
本ドキュメントは、請求書処理自動化システムで発生しうるエラーを分類し、それぞれの検知、記録、通知、および復旧方法に関する仕様を定義する。適切なエラーハンドリングにより、システムの堅牢性を高め、問題発生時の迅速な原因究明と対応を可能にすることを目的とする。

## 2. エラー分類
システムで発生するエラーは、以下の3つに大別される。

| 分類 | 説明 | 具体例 |
| :--- | :--- | :--- |
| **ユーザー起因エラー** | ユーザーの不正な入力や操作によって発生する、予測可能なエラー。 | ・PDF以外のファイルをアップロード<br>・必須項目が未入力のまま保存しようとする |
| **外部APIエラー** | 連携している外部サービス（Gemini, Supabase, Google API等）の障害や仕様変更、認証失敗によって発生するエラー。 | ・Gemini APIがタイムアウトする<br>・SupabaseのAPIキーが無効<br>・Google Driveのアクセス権限がない |
| **システム内部エラー** | プログラムのバグや、予期せぬデータ形式など、アプリケーション内部のロジックに起因する予期せぬエラー。 | ・データベースから取得したデータが`null`であることを想定していない<br>・特定の請求書フォーマットで処理が停止する |

## 3. エラーハンドリング仕様

### 3.1. 基本方針
* すべてのエラーは、`try...catch`（Pythonでは`try...except`）ブロックで捕捉する。
* 捕捉したエラーは、必ずログに記録する。
* ユーザーにエラーをフィードバックする際は、技術的な詳細を隠蔽し、分かりやすいメッセージを表示する。

### 3.2. エラー処理フロー

\`\`\`mermaid
graph TD
    A[処理実行] --> B{エラー発生};
    B -->|Yes| C[エラーを捕捉];
    C --> D[ログに詳細を記録];
    D --> E{エラー分類};
    E -->|ユーザー起因| F[UIに分かりやすい<br>エラーメッセージを表示];
    E -->|外部API/システム内部| G[UIに汎用的な<br>エラーメッセージを表示];
    G --> H[管理者にメールで<br>緊急通知];
    B -->|No| I[正常終了];
\`\`\`

### 3.3. ログ記録仕様
* **ログレベル:**
    * **INFO:** 通常の処理フロー（例：`ファイルアップロード成功`）
    * **WARNING:** 処理は続行できるが、注意が必要な事象（例：`支払マスタの候補が複数あり、AIが判断`）
    * **ERROR:** 処理が中断されたエラー
* **記録内容:**
    * **タイムスタンプ:** エラー発生日時
    * **ログレベル:** INFO / WARNING / ERROR
    * **関連ID:** 請求書ID (`invoice_id`)、ユーザーEmail (`user_email`)
    * **関数名:** エラーが発生した関数名
    * **エラーメッセージ:** エラーオブジェクトのメッセージ
    * **スタックトレース:** エラー発生箇所の詳細な追跡情報（システム内部エラーの場合）

### 3.4. ユーザーへの通知
* **ユーザー起因エラーの場合:**
    * **例:** 「PDFファイルのみアップロードできます。」「必須項目『内容』を入力してください。」
    * **UI:** Streamlitの`st.error()`コンポーネントを使用し、該当の操作エリアの近くにメッセージを表示する。
* **システム/APIエラーの場合:**
    * **例:** 「エラーが発生しました。しばらくしてからもう一度お試しください。問題が解決しない場合は、管理者に連絡してください。(エラーコード: XXXXX)」
    * **UI:** 汎用的なエラーメッセージを表示し、ユーザーを混乱させないようにする。

### 3.5. 管理者への通知
* **トリガー:** ログレベルが`ERROR`のログが記録された場合。
* **手段:** メール
* **通知内容:**
    * **件名:** `【要対応】請求書処理システムでエラーが発生しました`
    * **本文:** ログに記録された内容（タイムスタンプ、関連ID、エラーメッセージ等）を記載し、迅速な原因調査を促す。