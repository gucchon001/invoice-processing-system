# プロンプト仕様書

**バージョン:** 1.1
**作成日:** 2025/07/17

## 1. 概要
本ドキュメントは、請求書処理自動化システムで使用されるGemini APIへの指示書（プロンプト）の仕様を定義する。プロンプトはすべてYAML形式で管理し、システムのロジックとは分離して保守性を高める。

## 2. プロンプト一覧

| プロンプトファイル名 | 目的 | 担当ロジック |
| :--- | :--- | :--- |
| `invoice_prompt.yaml` | 請求書PDFから一次情報（キー情報含む）を抽出する | `extractInvoiceDataFromBlob` |
| `master_matcher_prompt.yaml` | 請求元名と支払マスタを照合し、企業名を特定する | `matchCompanyNameInMaster` |
| `integrated_matcher_prompt.yaml` | 複数候補の中から、キー情報や明細を基に最終的な仕訳を特定する | `getIntegratedMatch` |
| `statement_prompt.yaml` | カード利用明細PDFから取引データを抽出する | `extractTransactionsFromStatement` |

## 3. 詳細仕様

### 3.1. `invoice_prompt.yaml` (一次情報抽出用)
* **目的:** 請求書PDFから、後続の処理で必要となるすべての情報を構造化データとして抽出する。
* **ペルソナ:** 高精度なOCRと自然言語処理能力を持つAIアシスタント。特に、請求元を特定するための補助的な情報（アカウントIDなど）を見つけ出す能力に長けている。
* **思考プロセス:**
    1.  請求書全体をスキャンし、必須項目（請求元, 発行日, 金額など）を抽出する。
    2.  次に、請求元を特定するための補助キーとなり得る情報（"アカウント ID", "お客様番号", "ご利用期間"など）をすべて探し出し、「key_info」オブジェクトにキーと値のペアとして格納する。
    3.  最後に、明細項目を "line_items" 配列に抽出する。
* **入力変数:**
    * `(PDFファイル)`: Base64エンコードされたPDFデータ。
* **出力形式 (JSON):**
    ```json
    {
      "issuer": "string | null",
      "payer": "string | null",
      "issue_date": "YYYY-MM-DD | null",
      "due_date": "YYYY-MM-DD | null",
      "t_number": "string | null",
      "amount_inclusive_tax": "number | null",
      "key_info": {
        "キー1": "値1",
        "キー2": "値2"
      },
      "line_items": [
        { "description": "string", "amount": "number" }
      ]
    }
    ```

### 3.2. `master_matcher_prompt.yaml` (企業名特定用)
* **目的:** 請求書に記載された請求元名（表記揺れがある）と、支払マスタの企業名リストを比較し、最も確からしい企業名を1つだけ特定する。
* **ペルソナ:** 企業の正式名称、サービス名、通称、法人格の表記揺れを深く理解しているデータクレンジングの専門家。
* **思考プロセス:**
    1.  `invoice_issuer` の名称と、`master_company_list` の各企業名を比較する。
    2.  サービス名と正式名称の関係（例: Yahoo! JAPAN広告とLINEヤフー株式会社）や、表記の揺れ（例: Canva Pty. Ltd.とCanva Pty Ltd）を考慮する。
    3.  リストの中から最も一致する企業名を1つだけ選び出す。
* **入力変数:**
    * `[[ISSUER_NAME]]`: 請求書の請求元名
    * `[[MASTER_LIST]]`: 支払マスタの企業名リスト
* **出力形式 (JSON):**
    ```json
    {
      "matched_company_name": "[特定した企業名、またはnull]"
    }
    ```

### 3.3. `integrated_matcher_prompt.yaml` (最終候補特定用)
* **目的:** 企業名が特定された後、複数の仕訳候補の中から、請求書の詳細情報（キー情報、明細）に基づいて最適なものを1つだけ選択する。
* **ペルソナ:** 与えられた情報の中から、明確なルールに基づいて最も適合する項目を1つだけ選び出す、非常に論理的で几帳面な経理担当者。
* **思考プロセス:**
    1.  **最優先（追加条件）:** 各候補の`additional_condition`と、請求書の`invoice_data.key_info`を比較し、完全に一致するものがあれば、それを絶対的な正解とする。
    2.  **第二優先（明細内容）:** 追加条件で一致するものがなければ、請求書の`invoice_data.line_items`と、各候補の`content`を意味的に比較し、最も関連性の高い候補を選択する。
    3.  **最終判断:** 上記プロセスに基づき、最も確実性の高い候補の`id`を1つだけ返す。確信が持てなければ`null`を返す。
* **入力変数:**
    * `[[INVOICE_DATA_JSON]]`: 請求書から抽出した一次情報
    * `[[MASTER_RECORDS_JSON]]`: 支払マスタから絞り込まれた候補レコードのリスト
* **出力形式 (JSON):**
    ```json
    {
      "matched_record_id": "[特定した候補のid、またはnull]"
    }
    ```

### 3.4. `statement_prompt.yaml` (カード明細抽出用)
* **目的:** カード会社の利用明細PDFから、取引データの一覧を構造化データとして抽出する。特に、外貨取引の情報を正確に抜き出すことが重要。
* **ペルソナ:** PDF内のテーブル（表）構造を正確に認識し、各列のデータを正確にマッピングする能力に優れたデータ抽出AI。
* **思考プロセス:**
    1.  PDFドキュメント内の取引明細が記載されているテーブルを特定する。
    2.  テーブルの各行を順番に処理する。
    3.  各行から、「利用日」「利用先」「支払額（円）」を抽出する。
    4.  外貨での利用を示す列や記載（例: USD、元本額、換算レートなど）が存在する場合は、それらの情報もすべて抽出する。
    5.  抽出した情報を、指定されたJSON形式のオブジェクトにマッピングし、配列としてまとめる。
* **入力変数:**
    * `(PDFファイル)`: Base64エンコードされたカード明細PDFデータ。
* **出力形式 (JSON):**
    ```json
    [
      {
        "transaction_date": "YYYY-MM-DD | null",
        "merchant_name": "string | null",
        "jpy_amount": "number | null",
        "foreign_currency_amount": "number | null",
        "foreign_currency_code": "string | null",
        "exchange_rate": "number | null"
      }
    ]
    ```

---

### 8. エラーハンドリング仕様書

```markdown
# エラーハンドリング仕様書

**バージョン:** 1.0
**作成日:** 2025/07/17

## 1. 概要
本ドキュメントは、請求書処理自動化システムで発生しうるエラーを分類し、それぞれの検知、記録、通知、および復旧方法に関する仕様を定義する。適切なエラーハンドリングにより、システムの堅牢性を高め、問題発生時の迅速な原因究明と対応を可能にすることを目的とする。

## 2. エラー分類
システムで発生するエラーは、以下の3つに大別される。

| 分類 | 説明 | 具体例 |
| :--- | :--- | :--- |
| **ユーザー起因エラー** | ユーザーの不正な入力や操作によって発生する、予測可能なエラー。 | ・PDF以外のファイルをアップロード<br>・必須項目が未入力のまま保存しようとする |
| **外部APIエラー** | 連携している外部サービス（Gemini, Supabase, Google API等）の障害や仕様変更、認証失敗によって発生するエラー。 | ・Gemini APIがタイムアウトする<br>・SupabaseのAPIキーが無効<br>・Google Driveのアクセス権限がない |
| **システム内部エラー** | プログラムのバグや、予期せぬデータ形式など、アプリケーション内部のロジックに起因する予期せぬエラー。 | ・データベースから取得したデータが`null`であることを想定していない<br>・特定の請求書フォーマットで処理が停止する |

## 3. エラーハンドリング仕様

### 3.1. 基本方針
* すべてのエラーは、`try...catch`（Pythonでは`try...except`）ブロックで捕捉する。
* 捕捉したエラーは、必ずログに記録する。
* ユーザーにエラーをフィードバックする際は、技術的な詳細を隠蔽し、分かりやすいメッセージを表示する。

### 3.2. エラー処理フロー

\`\`\`mermaid
graph TD
    A[処理実行] --> B{エラー発生};
    B -->|Yes| C[エラーを捕捉];
    C --> D[ログに詳細を記録];
    D --> E{エラー分類};
    E -->|ユーザー起因| F[UIに分かりやすい<br>エラーメッセージを表示];
    E -->|外部API/システム内部| G[UIに汎用的な<br>エラーメッセージを表示];
    G --> H[管理者にメールで<br>緊急通知];
    B -->|No| I[正常終了];
\`\`\`

### 3.3. ログ記録仕様
* **ログレベル:**
    * **INFO:** 通常の処理フロー（例：`ファイルアップロード成功`）
    * **WARNING:** 処理は続行できるが、注意が必要な事象（例：`支払マスタの候補が複数あり、AIが判断`）
    * **ERROR:** 処理が中断されたエラー
* **記録内容:**
    * **タイムスタンプ:** エラー発生日時
    * **ログレベル:** INFO / WARNING / ERROR
    * **関連ID:** 請求書ID (`invoice_id`)、ユーザーEmail (`user_email`)
    * **関数名:** エラーが発生した関数名
    * **エラーメッセージ:** エラーオブジェクトのメッセージ
    * **スタックトレース:** エラー発生箇所の詳細な追跡情報（システム内部エラーの場合）

### 3.4. ユーザーへの通知
* **ユーザー起因エラーの場合:**
    * **例:** 「PDFファイルのみアップロードできます。」「必須項目『内容』を入力してください。」
    * **UI:** Streamlitの`st.error()`コンポーネントを使用し、該当の操作エリアの近くにメッセージを表示する。
* **システム/APIエラーの場合:**
    * **例:** 「エラーが発生しました。しばらくしてからもう一度お試しください。問題が解決しない場合は、管理者に連絡してください。(エラーコード: XXXXX)」
    * **UI:** 汎用的なエラーメッセージを表示し、ユーザーを混乱させないようにする。

### 3.5. 管理者への通知
* **トリガー:** ログレベルが`ERROR`のログが記録された場合。
* **手段:** メール
* **通知内容:**
    * **件名:** `【要対応】請求書処理システムでエラーが発生しました`
    * **本文:** ログに記録された内容（タイムスタンプ、関連ID、エラーメッセージ等）を記載し、迅速な原因調査を促す。